const bt=["EXT_color_buffer_float"],Ft=["OES_texture_float_linear"];class E extends Array{constructor(e=0,t=e,a=t){return typeof e=="string"&&([e,t,a]=E.hexToRGB(e)),e>1&&(e/=255,t/=255,a/=255),super(e,t,a),this}get isColor(){return!0}get r(){return this[0]}set r(e){this[0]=e}get g(){return this[1]}set g(e){this[1]=e}get b(){return this[2]}set b(e){this[2]=e}set(e,t,a){return typeof e=="string"&&([e,t,a]=E.hexToRGB(e)),e.length?this.copy(e):(this[0]=e,this[1]=t,this[2]=a,this)}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this}fromHex(e){const t=E.hexToRGB(e);this.fromArray(t)}getHex(){const[e,t,a]=this,i=n=>Math.round(255*n).toString(16).padStart(2,"0");return`#${i(e)}${i(t)}${i(a)}`}static hexToRGB(e){e.length===4&&(e=e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]);const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t||console.warn(`Unable to convert hex string ${e} to rgb values`),[parseInt(t[1],16)/255,parseInt(t[2],16)/255,parseInt(t[3],16)/255]}static rgbToHex(e){e.length&&e.length==3||console.error(`Unable to convert rgb array ${e} to hex value`);let t="#";for(let a=0;a<e.length;a++){let i=Number(e[a]).toString(16);i.length<2&&(i="0"+i),t+=i}return t}static hslToRGB(e,t,a){let i,n,r;if(t==0)i=n=r=a;else{let l=function(c,d,h){return h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?c+6*(d-c)*h:h<.5?d:h<.6666666666666666?c+(d-c)*(.6666666666666666-h)*6:c},o=a<.5?a*(1+t):a+t-a*t,u=2*a-o;i=l(u,o,e+1/3),n=l(u,o,e),r=l(u,o,e-1/3)}return[i,n,r]}static rgbToHsl(e,t,a){e/=255,t/=255,a/=255;let i,n,r=Math.max(e,t,a),l=Math.min(e,t,a),o=(r+l)/2;if(r==l)i=n=0;else{let u=r-l;switch(n=o>.5?u/(2-r-l):u/(r+l),r){case e:i=(t-a)/u+(t<a?6:0);break;case t:i=(a-e)/u+2;break;case a:i=(e-t)/u+4}i/=6}return[i,n,o]}static rgbToHsv(e,t,a){let i,n,r;e/=255,t/=255,a/=255;let l=Math.min(e,t,a),o=r=Math.max(e,t,a),u=o-l;if(o==l)i=0;else{switch(o){case e:i=(t-a)/u+(t<a?6:0);break;case t:i=2+(a-e)/u;break;case a:i=4+(e-t)/u}i=Math.round(60*i)}return n=o==0?0:1-l/o,n=Math.round(100*n),r=Math.round(100*r),[i,n,r]}fromArray(e,t=0){return this[0]=e[t],this[1]=e[t+1],this[2]=e[t+2],this}toArray(){return Array.from(this)}SRGBToLinearSingle(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}SRGBToLinear(){return this[0]=this.SRGBToLinearSingle(this[0]),this[1]=this.SRGBToLinearSingle(this[1]),this[2]=this.SRGBToLinearSingle(this[2]),this}LinearToSRGBSingle(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}LinearToSRGB(){return this[0]=this.LinearToSRGBSingle(this[0]),this[1]=this.LinearToSRGBSingle(this[1]),this[2]=this.LinearToSRGBSingle(this[2]),this}luminance(){return .2126*this[0]+.7152*this[1]+.0722*this[2]}addColor(e,t){return this[0]=e[0]+t[0],this[1]=e[1]+t[1],this[2]=e[2]+t[2],this}scale(e){return this[0]=this[0]*e,this[1]=this[1]*e,this[2]=this[2]*e,this}}function Fe(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Ge(s,e,t){let a=e[0],i=e[1],n=e[2],r=e[3],l=e[4],o=e[5],u=e[6],c=e[7],d=e[8],h=e[9],L=e[10],f=e[11],p=e[12],x=e[13],m=e[14],v=e[15],A=t[0],T=t[1],_=t[2],S=t[3];return s[0]=A*a+T*l+_*d+S*p,s[1]=A*i+T*o+_*h+S*x,s[2]=A*n+T*u+_*L+S*m,s[3]=A*r+T*c+_*f+S*v,A=t[4],T=t[5],_=t[6],S=t[7],s[4]=A*a+T*l+_*d+S*p,s[5]=A*i+T*o+_*h+S*x,s[6]=A*n+T*u+_*L+S*m,s[7]=A*r+T*c+_*f+S*v,A=t[8],T=t[9],_=t[10],S=t[11],s[8]=A*a+T*l+_*d+S*p,s[9]=A*i+T*o+_*h+S*x,s[10]=A*n+T*u+_*L+S*m,s[11]=A*r+T*c+_*f+S*v,A=t[12],T=t[13],_=t[14],S=t[15],s[12]=A*a+T*l+_*d+S*p,s[13]=A*i+T*o+_*h+S*x,s[14]=A*n+T*u+_*L+S*m,s[15]=A*r+T*c+_*f+S*v,s}function ye(s,e){let t=e[0]+e[5]+e[10],a=0;return t>0?(a=2*Math.sqrt(t+1),s[3]=.25*a,s[0]=(e[6]-e[9])/a,s[1]=(e[8]-e[2])/a,s[2]=(e[1]-e[4])/a):e[0]>e[5]&&e[0]>e[10]?(a=2*Math.sqrt(1+e[0]-e[5]-e[10]),s[3]=(e[6]-e[9])/a,s[0]=.25*a,s[1]=(e[1]+e[4])/a,s[2]=(e[8]+e[2])/a):e[5]>e[10]?(a=2*Math.sqrt(1+e[5]-e[0]-e[10]),s[3]=(e[8]-e[2])/a,s[0]=(e[1]+e[4])/a,s[1]=.25*a,s[2]=(e[6]+e[9])/a):(a=2*Math.sqrt(1+e[10]-e[0]-e[5]),s[3]=(e[1]-e[4])/a,s[0]=(e[8]+e[2])/a,s[1]=(e[6]+e[9])/a,s[2]=.25*a),s}function Me(s,e){let t=e[0],a=e[1],i=e[2],n=e[3],r=t+t,l=a+a,o=i+i,u=t*r,c=a*r,d=a*l,h=i*r,L=i*l,f=i*o,p=n*r,x=n*l,m=n*o;return s[0]=1-d-f,s[1]=c+m,s[2]=h-x,s[3]=0,s[4]=c-m,s[5]=1-u-f,s[6]=L+p,s[7]=0,s[8]=h+x,s[9]=L-p,s[10]=1-u-d,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}class V extends Array{constructor(e=1,t=0,a=0,i=0,n=0,r=1,l=0,o=0,u=0,c=0,d=1,h=0,L=0,f=0,p=0,x=1){return super(e,t,a,i,n,r,l,o,u,c,d,h,L,f,p,x),this}get isMatrix4(){return!0}set x(e){this[12]=e}get x(){return this[12]}set y(e){this[13]=e}get y(){return this[13]}set z(e){this[14]=e}get z(){return this[14]}set w(e){this[15]=e}get w(){return this[15]}set(e,t,a,i,n,r,l,o,u,c,d,h,L,f,p,x){return e.length?this.copy(e):(function(m,v,A,T,_,S,b,F,G,M,P,R,X,N,I,g,oe){m[0]=v,m[1]=A,m[2]=T,m[3]=_,m[4]=S,m[5]=b,m[6]=F,m[7]=G,m[8]=M,m[9]=P,m[10]=R,m[11]=X,m[12]=N,m[13]=I,m[14]=g,m[15]=oe}(this,e,t,a,i,n,r,l,o,u,c,d,h,L,f,p,x),this)}translate(e,t=this){return function(a,i,n){let r,l,o,u,c,d,h,L,f,p,x,m,v=n[0],A=n[1],T=n[2];i===a?(a[12]=i[0]*v+i[4]*A+i[8]*T+i[12],a[13]=i[1]*v+i[5]*A+i[9]*T+i[13],a[14]=i[2]*v+i[6]*A+i[10]*T+i[14],a[15]=i[3]*v+i[7]*A+i[11]*T+i[15]):(r=i[0],l=i[1],o=i[2],u=i[3],c=i[4],d=i[5],h=i[6],L=i[7],f=i[8],p=i[9],x=i[10],m=i[11],a[0]=r,a[1]=l,a[2]=o,a[3]=u,a[4]=c,a[5]=d,a[6]=h,a[7]=L,a[8]=f,a[9]=p,a[10]=x,a[11]=m,a[12]=r*v+c*A+f*T+i[12],a[13]=l*v+d*A+p*T+i[13],a[14]=o*v+h*A+x*T+i[14],a[15]=u*v+L*A+m*T+i[15])}(this,t,e),this}rotateX(e,t=this){return function(a,i,n){let r=Math.sin(n),l=Math.cos(n),o=i[4],u=i[5],c=i[6],d=i[7],h=i[8],L=i[9],f=i[10],p=i[11];i!==a&&(a[0]=i[0],a[1]=i[1],a[2]=i[2],a[3]=i[3],a[12]=i[12],a[13]=i[13],a[14]=i[14],a[15]=i[15]),a[4]=o*l+h*r,a[5]=u*l+L*r,a[6]=c*l+f*r,a[7]=d*l+p*r,a[8]=h*l-o*r,a[9]=L*l-u*r,a[10]=f*l-c*r,a[11]=p*l-d*r}(this,t,e),this}rotateY(e,t=this){return function(a,i,n){let r=Math.sin(n),l=Math.cos(n),o=i[0],u=i[1],c=i[2],d=i[3],h=i[8],L=i[9],f=i[10],p=i[11];i!==a&&(a[4]=i[4],a[5]=i[5],a[6]=i[6],a[7]=i[7],a[12]=i[12],a[13]=i[13],a[14]=i[14],a[15]=i[15]),a[0]=o*l-h*r,a[1]=u*l-L*r,a[2]=c*l-f*r,a[3]=d*l-p*r,a[8]=o*r+h*l,a[9]=u*r+L*l,a[10]=c*r+f*l,a[11]=d*r+p*l}(this,t,e),this}rotateZ(e,t=this){return function(a,i,n){let r=Math.sin(n),l=Math.cos(n),o=i[0],u=i[1],c=i[2],d=i[3],h=i[4],L=i[5],f=i[6],p=i[7];i!==a&&(a[8]=i[8],a[9]=i[9],a[10]=i[10],a[11]=i[11],a[12]=i[12],a[13]=i[13],a[14]=i[14],a[15]=i[15]),a[0]=o*l+h*r,a[1]=u*l+L*r,a[2]=c*l+f*r,a[3]=d*l+p*r,a[4]=h*l-o*r,a[5]=L*l-u*r,a[6]=f*l-c*r,a[7]=p*l-d*r}(this,t,e),this}scale(e,t=this){return function(a,i,n){let r=n[0],l=n[1],o=n[2];a[0]=i[0]*r,a[1]=i[1]*r,a[2]=i[2]*r,a[3]=i[3]*r,a[4]=i[4]*l,a[5]=i[5]*l,a[6]=i[6]*l,a[7]=i[7]*l,a[8]=i[8]*o,a[9]=i[9]*o,a[10]=i[10]*o,a[11]=i[11]*o,a[12]=i[12],a[13]=i[13],a[14]=i[14],a[15]=i[15]}(this,t,typeof e=="number"?[e,e,e]:e),this}multiply(e,t){return t?Ge(this,e,t):Ge(this,this,e),this}identity(){return Fe(this),this}copy(e){var t,a;return a=e,(t=this)[0]=a[0],t[1]=a[1],t[2]=a[2],t[3]=a[3],t[4]=a[4],t[5]=a[5],t[6]=a[6],t[7]=a[7],t[8]=a[8],t[9]=a[9],t[10]=a[10],t[11]=a[11],t[12]=a[12],t[13]=a[13],t[14]=a[14],t[15]=a[15],this}fromPerspective({fov:e,aspect:t,near:a,far:i}={}){return function(n,r,l,o,u){let c=1/Math.tan(r/2),d=1/(o-u);n[0]=c/l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=c,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=(u+o)*d,n[11]=-1,n[12]=0,n[13]=0,n[14]=2*u*o*d,n[15]=0}(this,e,t,a,i),this}fromOrthogonal({left:e,right:t,bottom:a,top:i,near:n,far:r}){return function(l,o,u,c,d,h,L){let f=1/(o-u),p=1/(c-d),x=1/(h-L);l[0]=-2*f,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=-2*p,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=2*x,l[11]=0,l[12]=(o+u)*f,l[13]=(d+c)*p,l[14]=(L+h)*x,l[15]=1}(this,e,t,a,i,n,r),this}fromQuaternion(e){return Me(this,e),this}setPosition(e){return this.x=e[0],this.y=e[1],this.z=e[2],this}transpose(e=this){return function(t,a){if(t===a){let i=a[1],n=a[2],r=a[3],l=a[6],o=a[7],u=a[11];t[1]=a[4],t[2]=a[8],t[3]=a[12],t[4]=i,t[6]=a[9],t[7]=a[13],t[8]=n,t[9]=l,t[11]=a[14],t[12]=r,t[13]=o,t[14]=u}else t[0]=a[0],t[1]=a[4],t[2]=a[8],t[3]=a[12],t[4]=a[1],t[5]=a[5],t[6]=a[9],t[7]=a[13],t[8]=a[2],t[9]=a[6],t[10]=a[10],t[11]=a[14],t[12]=a[3],t[13]=a[7],t[14]=a[11],t[15]=a[15]}(this,e),this}inverse(e=this){return function(t,a){let i=a[0],n=a[1],r=a[2],l=a[3],o=a[4],u=a[5],c=a[6],d=a[7],h=a[8],L=a[9],f=a[10],p=a[11],x=a[12],m=a[13],v=a[14],A=a[15],T=i*u-n*o,_=i*c-r*o,S=i*d-l*o,b=n*c-r*u,F=n*d-l*u,G=r*d-l*c,M=h*m-L*x,P=h*v-f*x,R=h*A-p*x,X=L*v-f*m,N=L*A-p*m,I=f*A-p*v,g=T*I-_*N+S*X+b*R-F*P+G*M;g&&(g=1/g,t[0]=(u*I-c*N+d*X)*g,t[1]=(r*N-n*I-l*X)*g,t[2]=(m*G-v*F+A*b)*g,t[3]=(f*F-L*G-p*b)*g,t[4]=(c*R-o*I-d*P)*g,t[5]=(i*I-r*R+l*P)*g,t[6]=(v*S-x*G-A*_)*g,t[7]=(h*G-f*S+p*_)*g,t[8]=(o*N-u*R+d*M)*g,t[9]=(n*R-i*N-l*M)*g,t[10]=(x*F-m*S+A*T)*g,t[11]=(L*S-h*F-p*T)*g,t[12]=(u*P-o*X-c*M)*g,t[13]=(i*X-n*P+r*M)*g,t[14]=(m*_-x*b-v*T)*g,t[15]=(h*b-L*_+f*T)*g)}(this,e),this}compose(e,t,a){return function(i,n,r,l){let o=n[0],u=n[1],c=n[2],d=n[3],h=o+o,L=u+u,f=c+c,p=o*h,x=o*L,m=o*f,v=u*L,A=u*f,T=c*f,_=d*h,S=d*L,b=d*f,F=l[0],G=l[1],M=l[2];i[0]=(1-(v+T))*F,i[1]=(x+b)*F,i[2]=(m-S)*F,i[3]=0,i[4]=(x-b)*G,i[5]=(1-(p+T))*G,i[6]=(A+_)*G,i[7]=0,i[8]=(m+S)*M,i[9]=(A-_)*M,i[10]=(1-(p+v))*M,i[11]=0,i[12]=r[0],i[13]=r[1],i[14]=r[2],i[15]=1}(this,e,t,a),this}getRotation(e){return ye(e,this),this}extractRotation(e){let t=[];return ye(t,e),Me(this,t),this}fromRotation(e,t){return function(a,i,n){let r,l,o,u=n[0],c=n[1],d=n[2],h=Math.sqrt(u*u+c*c+d*d);Math.abs(h)<1e-6||(h=1/h,u*=h,c*=h,d*=h,r=Math.sin(i),l=Math.cos(i),o=1-l,a[0]=u*u*o+l,a[1]=c*u*o+d*r,a[2]=d*u*o-c*r,a[3]=0,a[4]=u*c*o-d*r,a[5]=c*c*o+l,a[6]=d*c*o+u*r,a[7]=0,a[8]=u*d*o+c*r,a[9]=c*d*o-u*r,a[10]=d*d*o+l,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1)}(this,e,t),this}getTranslation(e){var t,a;return a=this,(t=e)[0]=a[12],t[1]=a[13],t[2]=a[14],this}getScaling(e){return function(t,a){let i=a[0],n=a[1],r=a[2],l=a[4],o=a[5],u=a[6],c=a[8],d=a[9],h=a[10];t[0]=Math.sqrt(i*i+n*n+r*r),t[1]=Math.sqrt(l*l+o*o+u*u),t[2]=Math.sqrt(c*c+d*d+h*h)}(e,this),this}getMaxScaleOnAxis(){return function(e){let t=e[0],a=e[1],i=e[2],n=e[4],r=e[5],l=e[6],o=e[8],u=e[9],c=e[10];const d=t*t+a*a+i*i,h=n*n+r*r+l*l,L=o*o+u*u+c*c;return Math.sqrt(Math.max(d,h,L))}(this)}lookAt(e,t,a){return function(i,n,r,l){let o=n[0],u=n[1],c=n[2],d=l[0],h=l[1],L=l[2],f=o-r[0],p=u-r[1],x=c-r[2],m=f*f+p*p+x*x;m>0&&(m=1/Math.sqrt(m),f*=m,p*=m,x*=m);let v=h*x-L*p,A=L*f-d*x,T=d*p-h*f;m=v*v+A*A+T*T,m>0&&(m=1/Math.sqrt(m),v*=m,A*=m,T*=m),i[0]=v,i[1]=A,i[2]=T,i[3]=0,i[4]=p*T-x*A,i[5]=x*v-f*T,i[6]=f*A-p*v,i[7]=0,i[8]=f,i[9]=p,i[10]=x,i[11]=0,i[12]=o,i[13]=u,i[14]=c,i[15]=1}(this,e,t,a),this}lookAtTarget(e,t,a){return function(i,n,r,l){let o,u,c,d,h,L,f,p,x,m,v=n[0],A=n[1],T=n[2],_=l[0],S=l[1],b=l[2],F=r[0],G=r[1],M=r[2];Math.abs(v-F)<1e-6&&Math.abs(A-G)<1e-6&&Math.abs(T-M)<1e-6?Fe(i):(f=v-F,p=A-G,x=T-M,m=1/Math.sqrt(f*f+p*p+x*x),f*=m,p*=m,x*=m,o=S*x-b*p,u=b*f-_*x,c=_*p-S*f,m=Math.sqrt(o*o+u*u+c*c),m?(m=1/m,o*=m,u*=m,c*=m):(o=0,u=0,c=0),d=p*c-x*u,h=x*o-f*c,L=f*u-p*o,m=Math.sqrt(d*d+h*h+L*L),m?(m=1/m,d*=m,h*=m,L*=m):(d=0,h=0,L=0),i[0]=o,i[1]=d,i[2]=f,i[3]=0,i[4]=u,i[5]=h,i[6]=p,i[7]=0,i[8]=c,i[9]=L,i[10]=x,i[11]=0,i[12]=-(o*v+u*A+c*T),i[13]=-(d*v+h*A+L*T),i[14]=-(f*v+p*A+x*T),i[15]=1)}(this,e,t,a),this}determinant(){return function(e){let t=e[0],a=e[1],i=e[2],n=e[3],r=e[4],l=e[5],o=e[6],u=e[7],c=e[8],d=e[9],h=e[10],L=e[11],f=e[12],p=e[13],x=e[14],m=e[15];return(t*l-a*r)*(h*m-L*x)-(t*o-i*r)*(d*m-L*p)+(t*u-n*r)*(d*x-h*p)+(a*o-i*l)*(c*m-L*f)-(a*u-n*l)*(c*x-h*f)+(i*u-n*o)*(c*p-d*f)}(this)}fromArray(e,t=0){for(var a=0;a<16;a++)this[a]=e[a+t];return this}toArray(e=[],t=0){let a=this;return e[t]=a[0],e[t+1]=a[1],e[t+2]=a[2],e[t+3]=a[3],e[t+4]=a[4],e[t+5]=a[5],e[t+6]=a[6],e[t+7]=a[7],e[t+8]=a[8],e[t+9]=a[9],e[t+10]=a[10],e[t+11]=a[11],e[t+12]=a[12],e[t+13]=a[13],e[t+14]=a[14],e[t+15]=a[15],e}static copyTo(e=[],t=[]){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]}}function Pe(s,e,t){let a=e[0],i=e[1],n=e[2],r=e[3],l=e[4],o=e[5],u=e[6],c=e[7],d=e[8],h=t[0],L=t[1],f=t[2],p=t[3],x=t[4],m=t[5],v=t[6],A=t[7],T=t[8];return s[0]=h*a+L*r+f*u,s[1]=h*i+L*l+f*c,s[2]=h*n+L*o+f*d,s[3]=p*a+x*r+m*u,s[4]=p*i+x*l+m*c,s[5]=p*n+x*o+m*d,s[6]=v*a+A*r+T*u,s[7]=v*i+A*l+T*c,s[8]=v*n+A*o+T*d,s}new V;class k extends Array{constructor(e=1,t=0,a=0,i=0,n=1,r=0,l=0,o=0,u=1){return super(e,t,a,i,n,r,l,o,u),this}get isMatrix3(){return!0}set(e,t,a,i,n,r,l,o,u){return e.length?this.copy(e):(function(c,d,h,L,f,p,x,m,v,A){c[0]=d,c[1]=h,c[2]=L,c[3]=f,c[4]=p,c[5]=x,c[6]=m,c[7]=v,c[8]=A}(this,e,t,a,i,n,r,l,o,u),this)}transpose(){return function(e){let t;t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t}(this),this}inverse(e=this){return function(t,a){let i=a[0],n=a[1],r=a[2],l=a[3],o=a[4],u=a[5],c=a[6],d=a[7],h=a[8],L=h*o-u*d,f=-h*l+u*c,p=d*l-o*c,x=i*L+n*f+r*p;x&&(x=1/x,t[0]=L*x,t[1]=(-h*n+r*d)*x,t[2]=(u*n-r*o)*x,t[3]=f*x,t[4]=(h*i-r*c)*x,t[5]=(-u*i+r*l)*x,t[6]=p*x,t[7]=(-d*i+n*c)*x,t[8]=(o*i-n*l)*x)}(this,e),this}translate(e,t=this){return function(a,i,n){let r=i[0],l=i[1],o=i[2],u=i[3],c=i[4],d=i[5],h=i[6],L=i[7],f=i[8],p=n[0],x=n[1];a[0]=r,a[1]=l,a[2]=o,a[3]=u,a[4]=c,a[5]=d,a[6]=p*r+x*u+h,a[7]=p*l+x*c+L,a[8]=p*o+x*d+f}(this,t,e),this}rotate(e,t=this){return function(a,i,n){let r=i[0],l=i[1],o=i[2],u=i[3],c=i[4],d=i[5],h=i[6],L=i[7],f=i[8],p=Math.sin(n),x=Math.cos(n);a[0]=x*r+p*u,a[1]=x*l+p*c,a[2]=x*o+p*d,a[3]=x*u-p*r,a[4]=x*c-p*l,a[5]=x*d-p*o,a[6]=h,a[7]=L,a[8]=f}(this,t,e),this}scale(e,t=this){return function(a,i,n){let r=n[0],l=n[1];a[0]=r*i[0],a[1]=r*i[1],a[2]=r*i[2],a[3]=l*i[3],a[4]=l*i[4],a[5]=l*i[5],a[6]=i[6],a[7]=i[7],a[8]=i[8]}(this,t,e),this}multiply(e,t){return t?Pe(this,e,t):Pe(this,this,e),this}identity(){var e;return(e=this)[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}copy(e){var t,a;return a=e,(t=this)[0]=a[0],t[1]=a[1],t[2]=a[2],t[3]=a[3],t[4]=a[4],t[5]=a[5],t[6]=a[6],t[7]=a[7],t[8]=a[8],this}fromMatrix4(e){var t,a;return a=e,(t=this)[0]=a[0],t[1]=a[1],t[2]=a[2],t[3]=a[4],t[4]=a[5],t[5]=a[6],t[6]=a[8],t[7]=a[9],t[8]=a[10],this}fromQuaternion(e){return function(t,a){let i=a[0],n=a[1],r=a[2],l=a[3],o=i+i,u=n+n,c=r+r,d=i*o,h=n*o,L=n*u,f=r*o,p=r*u,x=r*c,m=l*o,v=l*u,A=l*c;t[0]=1-L-x,t[3]=h-A,t[6]=f+v,t[1]=h+A,t[4]=1-d-x,t[7]=p-m,t[2]=f-v,t[5]=p+m,t[8]=1-d-L}(this,e),this}fromBasis(e,t,a){return this.set(e[0],e[1],e[2],t[0],t[1],t[2],a[0],a[1],a[2]),this}getNormalMatrix(e){return function(t,a){let i=a[0],n=a[1],r=a[2],l=a[3],o=a[4],u=a[5],c=a[6],d=a[7],h=a[8],L=a[9],f=a[10],p=a[11],x=a[12],m=a[13],v=a[14],A=a[15],T=i*u-n*o,_=i*c-r*o,S=i*d-l*o,b=n*c-r*u,F=n*d-l*u,G=r*d-l*c,M=h*m-L*x,P=h*v-f*x,R=h*A-p*x,X=L*v-f*m,N=L*A-p*m,I=f*A-p*v,g=T*I-_*N+S*X+b*R-F*P+G*M;g&&(g=1/g,t[0]=(u*I-c*N+d*X)*g,t[1]=(c*R-o*I-d*P)*g,t[2]=(o*N-u*R+d*M)*g,t[3]=(r*N-n*I-l*X)*g,t[4]=(i*I-r*R+l*P)*g,t[5]=(n*R-i*N-l*M)*g,t[6]=(m*G-v*F+A*b)*g,t[7]=(v*S-x*G-A*_)*g,t[8]=(x*F-m*S+A*T)*g)}(this,e),this}clone(){return new k().copy(this)}fromArray(e,t=0){for(var a=0;a<9;a++)this[a]=e[a+t];return this}toArray(){return Array.from(this)}toWebGPUFormat(){const e=new Float32Array(12);return e[3]=0,e[7]=0,e[11]=0,e[0]=this[0],e[1]=this[1],e[2]=this[2],e[4]=this[3],e[5]=this[4],e[6]=this[5],e[8]=this[6],e[9]=this[7],e[10]=this[8],e}}function Re(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s}function Xe(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s}function le(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s}function ie(s,e){let t=e[0],a=e[1],i=e[2],n=t*t+a*a+i*i;return n>0&&(n=1/Math.sqrt(n),s[0]=e[0]*n,s[1]=e[1]*n,s[2]=e[2]*n),s}function Ne(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]}function at(s,e,t){let a=e[0],i=e[1],n=e[2],r=t[3]*a+t[7]*i+t[11]*n+t[15];return r=r||1,s[0]=(t[0]*a+t[4]*i+t[8]*n+t[12])/r,s[1]=(t[1]*a+t[5]*i+t[9]*n+t[13])/r,s[2]=(t[2]*a+t[6]*i+t[10]*n+t[14])/r,s}function it(s,e,t){let a=e[0],i=e[1],n=e[2];return s[0]=a*t[0]+i*t[3]+n*t[6],s[1]=a*t[1]+i*t[4]+n*t[7],s[2]=a*t[2]+i*t[5]+n*t[8],s}const he=function(){let s=[];return function(e,t,a,i,n,r){let l,o;for(t||(t=3),a||(a=0),o=i?Math.min(i*t+a,e.length):e.length,l=a;l<o;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],n(s,s,r),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}}();function Ie(s,e,t){let a=e[0],i=e[1],n=e[2],r=e[3],l=t[0],o=t[1],u=t[2],c=t[3];return s[0]=a*c+r*l+i*u-n*o,s[1]=i*c+r*o+n*l-a*u,s[2]=n*c+r*u+a*o-i*l,s[3]=r*c-a*l-i*o-n*u,s}const Gt=function(s,e){return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s},yt=function(s,e,t,a,i){return s[0]=e,s[1]=t,s[2]=a,s[3]=i,s},Mt=function(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]+s[3]*e[3]},Pt=function(s,e){let t=e[0],a=e[1],i=e[2],n=e[3],r=t*t+a*a+i*i+n*n;return r>0&&(r=1/Math.sqrt(r),s[0]=t*r,s[1]=a*r,s[2]=i*r,s[3]=n*r),s};class Rt extends Array{constructor(e=0,t=0,a=0,i=1){return super(e,t,a,i),this.onChange=()=>{},this}get isQuaternion(){return!0}get x(){return this[0]}set x(e){this[0]=e,this.onChange()}get y(){return this[1]}set y(e){this[1]=e,this.onChange()}get z(){return this[2]}set z(e){this[2]=e,this.onChange()}get w(){return this[3]}set w(e){this[3]=e,this.onChange()}identity(){var e;return(e=this)[0]=0,e[1]=0,e[2]=0,e[3]=1,this.onChange(),this}set(e,t,a,i){return e.length?this.copy(e):(yt(this,e,t,a,i),this.onChange(),this)}rotateX(e){return function(t,a,i){i*=.5;let n=a[0],r=a[1],l=a[2],o=a[3],u=Math.sin(i),c=Math.cos(i);t[0]=n*c+o*u,t[1]=r*c+l*u,t[2]=l*c-r*u,t[3]=o*c-n*u}(this,this,e),this.onChange(),this}rotateY(e){return function(t,a,i){i*=.5;let n=a[0],r=a[1],l=a[2],o=a[3],u=Math.sin(i),c=Math.cos(i);t[0]=n*c-l*u,t[1]=r*c+o*u,t[2]=l*c+n*u,t[3]=o*c-r*u}(this,this,e),this.onChange(),this}rotateZ(e){return function(t,a,i){i*=.5;let n=a[0],r=a[1],l=a[2],o=a[3],u=Math.sin(i),c=Math.cos(i);t[0]=n*c+r*u,t[1]=r*c-n*u,t[2]=l*c+o*u,t[3]=o*c-l*u}(this,this,e),this.onChange(),this}inverse(e=this){return function(t,a){let i=a[0],n=a[1],r=a[2],l=a[3],o=i*i+n*n+r*r+l*l,u=o?1/o:0;t[0]=-i*u,t[1]=-n*u,t[2]=-r*u,t[3]=l*u}(this,e),this.onChange(),this}conjugate(e=this){var t,a;return a=e,(t=this)[0]=-a[0],t[1]=-a[1],t[2]=-a[2],t[3]=a[3],this.onChange(),this}copy(e){return Gt(this,e),this.onChange(),this}normalize(e=this){return Pt(this,e),this.onChange(),this}multiply(e,t){return t?Ie(this,e,t):Ie(this,this,e),this.onChange(),this}dot(e){return Mt(this,e)}fromMatrix3(e){return function(t,a){let i,n=a[0]+a[4]+a[8];if(n>0)i=Math.sqrt(n+1),t[3]=.5*i,i=.5/i,t[0]=(a[5]-a[7])*i,t[1]=(a[6]-a[2])*i,t[2]=(a[1]-a[3])*i;else{let r=0;a[4]>a[0]&&(r=1),a[8]>a[3*r+r]&&(r=2);let l=(r+1)%3,o=(r+2)%3;i=Math.sqrt(a[3*r+r]-a[3*l+l]-a[3*o+o]+1),t[r]=.5*i,i=.5/i,t[3]=(a[3*l+o]-a[3*o+l])*i,t[l]=(a[3*l+r]+a[3*r+l])*i,t[o]=(a[3*o+r]+a[3*r+o])*i}}(this,e),this.onChange(),this}fromEuler(e){return function(t,a,i="YXZ"){let n=Math.sin(.5*a[0]),r=Math.cos(.5*a[0]),l=Math.sin(.5*a[1]),o=Math.cos(.5*a[1]),u=Math.sin(.5*a[2]),c=Math.cos(.5*a[2]);i==="XYZ"?(t[0]=n*o*c+r*l*u,t[1]=r*l*c-n*o*u,t[2]=r*o*u+n*l*c,t[3]=r*o*c-n*l*u):i==="YXZ"?(t[0]=n*o*c+r*l*u,t[1]=r*l*c-n*o*u,t[2]=r*o*u-n*l*c,t[3]=r*o*c+n*l*u):i==="ZXY"?(t[0]=n*o*c-r*l*u,t[1]=r*l*c+n*o*u,t[2]=r*o*u+n*l*c,t[3]=r*o*c-n*l*u):i==="ZYX"?(t[0]=n*o*c-r*l*u,t[1]=r*l*c+n*o*u,t[2]=r*o*u-n*l*c,t[3]=r*o*c+n*l*u):i==="YZX"?(t[0]=n*o*c+r*l*u,t[1]=r*l*c+n*o*u,t[2]=r*o*u-n*l*c,t[3]=r*o*c-n*l*u):i==="XZY"&&(t[0]=n*o*c-r*l*u,t[1]=r*l*c-n*o*u,t[2]=r*o*u+n*l*c,t[3]=r*o*c+n*l*u)}(this,e,e.order),this}slerp(e,t,a){return function(i,n,r,l){let o,u,c,d,h,L=n[0],f=n[1],p=n[2],x=n[3],m=r[0],v=r[1],A=r[2],T=r[3];u=L*m+f*v+p*A+x*T,u<0&&(u=-u,m=-m,v=-v,A=-A,T=-T),1-u>1e-6?(o=Math.acos(u),c=Math.sin(o),d=Math.sin((1-l)*o)/c,h=Math.sin(l*o)/c):(d=1-l,h=l),i[0]=d*L+h*m,i[1]=d*f+h*v,i[2]=d*p+h*A,i[3]=d*x+h*T}(this,e,t,a),this}fromArray(e,t=0){return this[0]=e[t],this[1]=e[t+1],this[2]=e[t+2],this[3]=e[t+3],this}toArray(){return Array.from(this)}}function Be(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s}function We(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s}function ue(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s}function ze(s){var e=s[0],t=s[1];return Math.sqrt(e*e+t*t)}class $ extends Array{constructor(e=0,t=e){return super(e,t),this}get isVector2(){return!0}get x(){return this[0]}set x(e){this[0]=e}get y(){return this[1]}set y(e){this[1]=e}get width(){return this[0]}set width(e){this[0]=e}get height(){return this[1]}set height(e){this[1]=e}set(e,t=e){return e.length?this.copy(e):(function(a,i,n){a[0]=i,a[1]=n}(this,e,t),this)}copy(e){var t,a;return a=e,(t=this)[0]=a[0],t[1]=a[1],this}add(e,t){return t?Be(this,e,t):Be(this,this,e),this}sub(e,t){return t?We(this,e,t):We(this,this,e),this}multiply(e){var t,a,i;return e.length?(a=this,i=e,(t=this)[0]=a[0]*i[0],t[1]=a[1]*i[1]):ue(this,this,e),this}divide(e){var t,a,i;return e.length?(a=this,i=e,(t=this)[0]=a[0]/i[0],t[1]=a[1]/i[1]):ue(this,this,1/e),this}scale(e){return ue(this,this,e),this}distance(e){return e?(t=this,i=(a=e)[0]-t[0],n=a[1]-t[1],Math.sqrt(i*i+n*n)):ze(this);var t,a,i,n}squaredDistance(e){return e?(t=this,i=(a=e)[0]-t[0],n=a[1]-t[1],i*i+n*n):function(r){var l=r[0],o=r[1];return l*l+o*o}(this);var t,a,i,n}len(){return ze(this)}squaredLength(){return this.squaredDistance()}negate(e=this){var t,a;return a=e,(t=this)[0]=-a[0],t[1]=-a[1],this}inverse(e=this){var t,a;return a=e,(t=this)[0]=1/a[0],t[1]=1/a[1],this}normalize(){var e,t,a,i,n;e=this,a=(t=this)[0],i=t[1],(n=a*a+i*i)>0&&(n=1/Math.sqrt(n),e[0]=t[0]*n,e[1]=t[1]*n)}dot(e){return a=e,(t=this)[0]*a[0]+t[1]*a[1];var t,a}cross(e,t){return i=t,(a=e)[0]*i[1]-a[1]*i[0];var a,i}lerp(e,t,a){(function(i,n,r,l){var o=n[0],u=n[1];i[0]=o+l*(r[0]-o),i[1]=u+l*(r[1]-u)})(this,e,t,a)}applyMatrix3(e){var t,a,i,n,r;return t=this,i=e,n=(a=this)[0],r=a[1],t[0]=i[0]*n+i[3]*r+i[6],t[1]=i[1]*n+i[4]*r+i[7],this}applyMatrix4(e){return function(t,a,i){let n=a[0],r=a[1];t[0]=i[0]*n+i[4]*r+i[12],t[1]=i[1]*n+i[5]*r+i[13]}(this,this,e),this}equals(e){return a=e,(t=this)[0]===a[0]&&t[1]===a[1];var t,a}clone(){return new $(this[0],this[1])}fromArray(e,t=0){return this[0]=e[t],this[1]=e[t+1],this}toArray(){return Array.from(this)}}class y extends Array{constructor(e=0,t=e,a=e){return super(e,t,a),this.constant=1,this}get isVector3(){return!0}get x(){return this[0]}set x(e){this[0]=e}get y(){return this[1]}set y(e){this[1]=e}get z(){return this[2]}set z(e){this[2]=e}set(e,t=e,a=e){return e.length?this.copy(e):(function(i,n,r,l){i[0]=n,i[1]=r,i[2]=l}(this,e,t,a),this)}copy(e){var t,a;return a=e,(t=this)[0]=a[0],t[1]=a[1],t[2]=a[2],this}add(e,t){return t?Re(this,e,t):Re(this,this,e),this}sub(e,t){return t?Xe(this,e,t):Xe(this,this,e),this}multiply(e){var t,a,i;return e.length?(a=this,i=e,(t=this)[0]=a[0]*i[0],t[1]=a[1]*i[1],t[2]=a[2]*i[2]):le(this,this,e),this}divide(e){var t,a,i;return e.length?(a=this,i=e,(t=this)[0]=a[0]/i[0],t[1]=a[1]/i[1],t[2]=a[2]/i[2]):le(this,this,1/e),this}scale(e){return le(this,this,e),this}distance(e){return e?function(t,a){let i=a[0]-t[0],n=a[1]-t[1],r=a[2]-t[2];return Math.sqrt(i*i+n*n+r*r)}(this,e):function(t){let a=t[0],i=t[1],n=t[2];return Math.sqrt(a*a+i*i+n*n)}(this)}squaredDistance(e){return e?function(t,a){let i=a[0]-t[0],n=a[1]-t[1],r=a[2]-t[2];return i*i+n*n+r*r}(this,e):function(t){let a=t[0],i=t[1],n=t[2];return a*a+i*i+n*n}(this)}squaredLength(){return this.squaredDistance()}negate(e=this){var t,a;return a=e,(t=this)[0]=-a[0],t[1]=-a[1],t[2]=-a[2],this}reflect(e){let t=e.clone();return this.sub(t.multiply(2*this.dot(e)))}inverse(e=this){var t,a;return a=e,(t=this)[0]=1/a[0],t[1]=1/a[1],t[2]=1/a[2],this}normalize(){return ie(this,this),this}dot(e){return Ne(this,e)}cross(e,t){return function(a,i,n){let r=i[0],l=i[1],o=i[2],u=n[0],c=n[1],d=n[2];a[0]=l*d-o*c,a[1]=o*u-r*d,a[2]=r*c-l*u}(this,e,t),this}lerp(e,t,a){return function(i,n,r,l){let o=n[0],u=n[1],c=n[2];i[0]=o+l*(r[0]-o),i[1]=u+l*(r[1]-u),i[2]=c+l*(r[2]-c)}(this,e,t,a),this}hermite(e,t,a,i,n){return function(r,l,o,u,c,d){let h=d*d,L=h*(2*d-3)+1,f=h*(d-2)+d,p=h*(d-1),x=h*(3-2*d);r[0]=l[0]*L+o[0]*f+u[0]*p+c[0]*x,r[1]=l[1]*L+o[1]*f+u[1]*p+c[1]*x,r[2]=l[2]*L+o[2]*f+u[2]*p+c[2]*x}(this,e,t,a,i,n),this}bezier(e,t,a,i,n){return function(r,l,o,u,c,d){let h=1-d,L=h*h,f=d*d,p=L*h,x=3*d*L,m=3*f*h,v=f*d;r[0]=l[0]*p+o[0]*x+u[0]*m+c[0]*v,r[1]=l[1]*p+o[1]*x+u[1]*m+c[1]*v,r[2]=l[2]*p+o[2]*x+u[2]*m+c[2]*v}(this,e,t,a,i,n),this}applyMatrix4(e){return at(this,this,e),this}applyMatrix3(e){return it(this,this,e),this}applyQuaternion(e){return function(t,a,i){let n=a[0],r=a[1],l=a[2],o=i[0],u=i[1],c=i[2],d=i[3],h=d*n+u*l-c*r,L=d*r+c*n-o*l,f=d*l+o*r-u*n,p=-o*n-u*r-c*l;t[0]=h*d+p*-o+L*-c-f*-u,t[1]=L*d+p*-u+f*-o-h*-c,t[2]=f*d+p*-c+h*-u-L*-o}(this,this,e),this}setFromMatrixPosition(e){return this.x=e[12],this.y=e[13],this.z=e[14],this}angle(e){return function(t,a){let i=[...t],n=[...a];ie(i,i),ie(n,n);let r=Ne(i,n);return r>1?0:r<-1?Math.PI:Math.acos(r)}(this,e)}equals(e){return a=e,(t=this)[0]===a[0]&&t[1]===a[1]&&t[2]===a[2];var t,a}clone(){return new y(this[0],this[1],this[2])}fromArray(e,t=0){return this[0]=e[t],this[1]=e[t+1],this[2]=e[t+2],this}min(e){return this[0]=Math.min(this[0],e.x),this[1]=Math.min(this[1],e.y),this[2]=Math.min(this[2],e.z),this}max(e){return this[0]=Math.max(this[0],e.x),this[1]=Math.max(this[1],e.y),this[2]=Math.max(this[2],e.z),this}toArray(){return Array.from(this)}static copyTo(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2]}}const D=[new y,new y,new y,new y,new y,new y,new y,new y];class K{constructor(e=new y(1/0),t=new y(-1/0)){this.min=e,this.max=t}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.add(this.min,this.max).multiply(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.sub(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}setFromPoints(e){this.makeEmpty();for(let t=0,a=e.length;t<a;t++)this.expandByPoint(e[t]);return this}applyMatrix4(e){return this.isEmpty()||(D[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),D[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),D[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),D[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),D[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),D[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),D[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),D[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(D)),this}}class st{constructor(){this.name="",this.type="",this.isRayTracingMaterial=!0}setValues(e){if(e!==void 0)for(const t in e){const a=e[t];if(a===void 0){console.warn(`${this.name}: ${t} parameter is undefined.`);continue}const i=this[t];i!==void 0&&(i&&i.isColor?i.set(a):i&&i.isVector3&&a&&a.isVector3?i.copy(a):this[t]=a)}}copy(e){}}class ee extends st{constructor(e){super(),this.type="PrincipleBSDF",this.workflow="Metalness",this.color=new E(1,1,1),this.roughness=.5,this.metalness=0,this.transmission=0,this.ior=1.5,this.specularTint=0,this.clearcoat=0,this.clearcoatRoughness=0,this.sheen=0,this.sheenTint=.5,this.atDistance=1,this.extinction=new E(1,1,1),this.anisotropic=0,this.subsurface=0,this.subsurfaceColor=new E(1,1,1),this.subsurfaceMFP=.05,this.emissiveColor=new E(0,0,0),this.normalScale=new $(1,1),this.alpha=1,this.map=null,this.normalMap=null,this.roughnessMap=null,this.metalnessMap=null,this.emissiveMap=null,this.specularColor=new E(1,1,1),this.glossiness=1,this.specularMap=null,this.glossinessMap=null,this.setValues(e)}copy(e){return this.name=`copy_${e.name}`,this.type=e.type,this.workflow=e.workflow,this.color=new E().copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.transmission=e.transmission,this.ior=e.ior,this.specularTint=e.specularTint,this.clearcoat=e.clearcoat,this.clearcoatRoughness=e.clearcoatRoughness,this.sheen=e.sheen,this.sheenTint=e.sheenTint,this.atDistance=e.atDistance,this.anisotropic=e.anisotropic,this.extinction=new E().copy(e.extinction),this.subsurface=e.subsurface,this.subsurfaceColor=new E().copy(e.subsurfaceColor),this.subsurfaceMFP=e.subsurfaceMFP,this.emissiveColor=new E().copy(e.emissiveColor),this.normalScale=new $().copy(e.normalScale),this.alpha=e.alpha,this.map=e.map,this.normalMap=e.normalMap,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.emissiveMap=e.emissiveMap,this.specularColor=new E().copy(e.specularColor),this.glossiness=e.glossiness,this.specularMap=e.specularMap,this.glossinessMap=e.glossinessMap,this}clone(){return new ee().copy(this)}}class Se{constructor(){this.focus=10,this.aperture=0,this.zoom=1,this.tempVec3a=new y,this.tempVec3b=new y,this.type="PerspectiveCamera",this.viewToWorldMat=new V,this.worldToViewMat=new V,this.viewToClipMat=new V,this.clipToViewMat=new V,this.position=new y}copy(e){return this.type=e.type,this.focus=e.focus,this.aperture=e.aperture,this.zoom=e.zoom,this.viewToWorldMat.copy(e.viewToWorldMat),this.worldToViewMat.copy(e.worldToViewMat),this.viewToClipMat.copy(e.viewToClipMat),this.clipToViewMat.copy(e.clipToViewMat),this.position.copy(e.position),this}clone(){return new Se().copy(this)}updateFrustum(){this.frustum||(this.frustum=[new y,new y,new y,new y,new y,new y]);const e=new V().multiply(this.viewToClipMat,this.worldToViewMat);this.frustum[0].set(e[3]-e[0],e[7]-e[4],e[11]-e[8]).constant=e[15]-e[12],this.frustum[1].set(e[3]+e[0],e[7]+e[4],e[11]+e[8]).constant=e[15]+e[12],this.frustum[2].set(e[3]+e[1],e[7]+e[5],e[11]+e[9]).constant=e[15]+e[13],this.frustum[3].set(e[3]-e[1],e[7]-e[5],e[11]-e[9]).constant=e[15]-e[13],this.frustum[4].set(e[3]-e[2],e[7]-e[6],e[11]-e[10]).constant=e[15]-e[14],this.frustum[5].set(e[3]+e[2],e[7]+e[6],e[11]+e[10]).constant=e[15]+e[14];for(let t=0;t<6;t++){const a=1/this.frustum[t].distance();this.frustum[t].multiply(a),this.frustum[t].constant*=a}}frustumIntersectsMesh(e){if(!e.geometry.position||!e.geometry.aabb)return!0;const t=e.geometry.aabb;t.getCenter(this.tempVec3a);const a=this.tempVec3a,i=t.min.distance(t.max)/2;a.applyMatrix4(e.localToWorldMat);const n=i*e.localToWorldMat.getMaxScaleOnAxis();return this.frustumIntersectsSphere(a,n)}frustumIntersectsSphere(e,t){const a=this.tempVec3b;for(let i=0;i<6;i++){const n=this.frustum[i];if(a.copy(n).dot(e)+n.constant<-t)return!1}return!0}}class B{constructor(e,t){this.array=e,this.itemSize=t}getItem(e,t){const a=this.array,i=this.itemSize,n=t*i;for(let r=0;r<i;r++)e[r]=a[n+r]}get count(){return this.array.length/this.itemSize}}class re{constructor(e,t,a,i){this.position=e,this.normal=t,this.uv=a,this.indices=i}}class Xt extends re{constructor(){const e=new Float32Array([.5,.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5]),t=new Float32Array([1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1]),a=new Float32Array([0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0]),i=new Uint16Array([0,2,1,2,3,1,4,6,5,6,7,5,8,10,9,10,11,9,12,14,13,14,15,13,16,18,17,18,19,17,20,22,21,22,23,21]);super(new B(e,3),new B(t,3),new B(a,2),new B(i,1)),this.name="LGL_DefaultCubeGeometry",this.aabb=new K(new y(-.5,-.5,-.5),new y(.5,.5,.5))}}class se{constructor(e=new Xt,t=new ee){this.geometry=e,this.material=t,this.visible=!0,this.tlasMask=!1,this.localToWorldMat=new V}get worldToLocalMat(){return new V().inverse(this.localToWorldMat)}copy(e){return this.geometry=e.geometry,this.material.copy(e.material),this.localToWorldMat.copy(e.localToWorldMat),this}clone(e=!0){let t=this.material;e&&(t=this.material.clone());const a=new se(this.geometry,t);return a.localToWorldMat.copy(this.localToWorldMat),a}}class Nt{constructor(e){this.image=e,this.isTexture=!0,this.uvTransMat=new k,this.wrapS=0,this.wrapT=0}}class It{constructor(){this.resourcePool={},this.renderPipelines=new Map}getPipelineByCacheKey(e,t){const a=`${e}-${t}`;return this.renderPipelines.get(a)?this.renderPipelines.get(a):null}setPipelineByCacheKey(e,t,a){const i=`${e}-${t}`;this.renderPipelines.set(i,a)}clearPipelineCache(){Array.from(this.renderPipelines.values()).forEach(e=>e.dispose()),this.renderPipelines=new Map}getResourceByName(e){return this.resourcePool[e]}getRawResourceByName(e){var t;return(t=this.resourcePool[e])==null?void 0:t.raw}destoryResourceByName(e){this.resourcePool[e]&&(this.resourcePool[e].raw.dispose(),delete this.resourcePool[e])}setResource(e,t,a="Texture"){this.destoryResourceByName(e),this.resourcePool[e]={raw:t,type:a}}updateResource(e,t,a="Texture"){this.destoryResourceByName(e),this.resourcePool[e]={raw:t,type:a}}getPool(){return this.resourcePool}destroy(){for(const e in this.resourcePool)this.resourcePool[e].raw.dispose();this.resourcePool={}}}function Ee(s,e,t){return Object.assign({},t,{lightsNum:s.lightsNum,lightsData:s.lightsData,materialDefines:s.materialDefines,bvhDefines:s.bvhDefines,enableSSS:s.includeSSS,enableVolume:s.includeVolume,enableAtomsphere:s.includeAtomsphere})}const Bt=["color","roughness","metalness","transmission","ior","clearcoat","clearcoatRoughness","sheen","sheenTint","specularTint","atDistance","extinction","anisotropic","subsurface","subsurfaceColor","subsurfaceMFP","normalScale","alpha","specularColor","glossiness","glossiness","emissiveIntensity","emissive"],Wt=["map","normalMap","roughnessMap","metalnessMap","specularMap","glossinessMap","emissiveMap"],we={1e3:0,1001:1,1002:2};function Le(s){const e=new Map;for(const t of s){const a=t.material;let i=e.get(a);i===void 0&&(i=e.size,e.set(a,i))}return e.size==0&&e.set(new st,0),e}function Ce(s,e=!1){s.updateMatrixWorld(!0);const t=[],a=[];if(e){const u=new se;u.name="LGLDefaultMesh",u.material.name="LGLDefaultMaterial",u.visible=!1,t.push(u)}let i=!1;const n=new Map,r=new Map;s.traverse(u=>{if(u.isMesh){let c=u;if(c.geometry){let d=c.material;if(c.material||(d=new ee),c.userData.useLGLMaterial&&c.userData.LGLMaterial)d=c.userData.LGLMaterial;else{const f=n.get(d);f?d=f:(d=pe(c.material),n.set(c.material,d))}d.subsurface>0&&(i=!0);let h=r.get(c.geometry.id);h||(h=function(f){var p,x;const m=ce(f,"position"),v=ce(f,"normal"),A=ce(f,"uv"),T=f.getIndex(),_=new re(m&&new B(m.array,m.itemSize),v&&new B(v.array,v.itemSize),A&&new B(A.array,A.itemSize),T&&new B(T.array,T.itemSize));return _.id=`LGL_${f.id}`,_.name=`LGL_${f.name}`,f.boundingBox||f.computeBoundingBox(),_.aabb=new K,_.aabb.min.fromArray((p=f.boundingBox)==null?void 0:p.min.toArray()),_.aabb.max.fromArray((x=f.boundingBox)==null?void 0:x.max.toArray()),_}(c.geometry),r.set(c.geometry.id,h));const L=new se(h,d);ca.linkMeshWithTHREEMesh(L,c),t.push(L)}else console.warn(`${u.name} need geometry data`)}u.isLight&&a.push(u)});const l=Le(t),o=function(u){if(!u.length)return null;const c=new V,d=new Rt;return function(h){const L={};return L.position=h.map(f=>f.position),L.emission=h.map(f=>f.emission),L.p1=h.map(f=>f.p1),L.p2=h.map(f=>f.p2),L.radius=h.map(f=>f.radius),L.area=h.map(f=>f.area),L.type=h.map(f=>f.type),L.visible=h.map(f=>f.visible),L.position=[].concat(...L.position.map(f=>f.toArray())),L.emission=[].concat(...L.emission.map(f=>f.toArray())),L.p1=[].concat(...L.p1.map(f=>f.toArray())),L.p2=[].concat(...L.p2.map(f=>f.toArray())),L.params=function(...f){let p=0;for(let m=0;m<f.length;m++){const v=f[m],A=v.data?v.data.length/v.channels:0;p=Math.max(p,A)}const x=[];for(let m=0;m<p;m++)for(let v=0;v<f.length;v++){const{data:A=[],channels:T}=f[v];for(let _=0;_<T;_++)x.push(A[m*T+_])}return x}({data:L.radius,channels:1},{data:L.area,channels:1},{data:L.type,channels:1},{data:L.visible,channels:1}),L}(u.map(h=>{const L=h,f={},p=new y;switch(L.updateWorldMatrix(!0,!1),p.setFromMatrixPosition(L.matrixWorld.elements),f.position=p,f.emission=new y().fromArray(L.color.toArray()).multiply(L.intensity),f.radius=L.radius||0,f.area=0,f.visible=Number(L.visible),f.p1=new y,f.p2=new y,L.type){case"RectAreaLight":if(f.type=0,c.fromArray(L.matrixWorld.elements),c.getRotation(d),L.width&&L.height){const x=new y(L.width,0,0);x.applyQuaternion(d);const m=new y(0,L.height,0);m.applyQuaternion(d),f.p1.copy(m),f.p2.copy(x),f.area=new y().cross(f.p1,f.p2).distance()}break;case"PointLight":f.type=2,f.area=0;break;case"DirectionalLight":f.type=1,L.target&&f.p1.copy(L.target),f.area=0;break;default:console.warn(`Not support light type: ${L.type}`)}return f}))}(a);return{meshes:t,materialIndexMap:l,materials:Array.from(l.keys()),geometryConvertMap:r,lightsNum:a.length,lightsData:o,includeSSS:i,includeVolume:!1,includeAtomsphere:!1}}function Ue(s,e){s.updateMatrixWorld(!0);const t=e||new Se;return t.type=s.type,t.viewToWorldMat.fromArray(s.matrixWorld.elements),t.worldToViewMat.fromArray(s.matrixWorldInverse.elements),t.clipToViewMat.fromArray(s.projectionMatrixInverse.elements),t.viewToClipMat.fromArray(s.projectionMatrix.elements),t.position.fromArray(s.position.toArray()),s.aperture!=null&&(t.aperture=s.aperture||0),s.focus!=null&&(t.focus=s.focus||0),s.zoom!=null&&(t.zoom=s.zoom||1),t}function ce(s,e){const t=s.getAttribute(e);return t!=null&&t.isInterleavedBufferAttribute?t.clone():t}function Z(s){return s?new Nt(s.image):null}function pe(s,e){var t,a,i,n,r,l,o,u,c;Array.isArray(s)&&(s=s[0]);const d=e||new ee;return d.name=`LGL_${s.name}`,function(h,L){Bt.forEach(f=>{if(h[f]==null&&h.userData[f]==null)switch(f){case"emissive":h.userData[f]=L.emissiveColor.toArray();break;case"emissiveIntensity":h.userData[f]=1;break;default:h.userData[f]=L[f].toArray?L[f].toArray():L[f]}})}(s,d),s.color?d.color.fromArray(s.color.toArray()):d.color.fromArray(s.userData.color),d.roughness=(t=s.roughness)!=null?t:s.userData.roughness,d.metalness=(a=s.metalness)!=null?a:s.userData.metalness,d.transmission=(i=s.transmission)!=null?i:s.userData.transmission,d.ior=(n=s.ior)!=null?n:s.userData.ior,s.emissive?d.emissiveColor.fromArray(s.emissive.toArray()).scale(s.emissiveIntensity):d.emissiveColor.fromArray(s.userData.emissive).scale(s.userData.emissiveIntensity),s.normalScale?d.normalScale.fromArray(s.normalScale.toArray()):d.normalScale.fromArray(s.userData.normalScale),d.clearcoat=(r=s.clearcoat)!=null?r:s.userData.clearcoat,d.clearcoatRoughness=(l=s.clearcoatRoughness)!=null?l:s.userData.clearcoatRoughness,d.sheen=(o=s.sheen)!=null?o:s.userData.sheen,d.sheenTint=(u=s.sheenTint)!=null?u:s.userData.sheenTint,d.alpha=(c=s.opacity)!=null?c:s.userData.alpha,d.map=Z(s.map),d.normalMap=Z(s.normalMap),d.emissiveMap=Z(s.emissiveMap),d.roughnessMap=Z(s.roughnessMap),d.metalnessMap=Z(s.metalnessMap),s.isGLTFSpecularGlossinessMaterial&&(d.workflow="Specular",d.specularColor.fromArray(s.specular.toArray()),d.glossiness=s.glossiness,d.specularMap=Z(s.specularMap),d.glossinessMap=Z(s.glossinessMap)),d.subsurface=s.userData.subsurface,d.subsurfaceMFP=s.userData.subsurfaceMFP,d.subsurfaceColor.fromArray(s.userData.subsurfaceColor),d.specularTint=s.userData.specularTint,d.atDistance=s.userData.atDistance,d.extinction.fromArray(s.userData.extinction),d.anisotropic=s.userData.anisotropic,function(h,L){Wt.forEach(f=>{const p=h[f],x=L[f];p&&(p.updateMatrix(),x.uvTransMat.fromArray(p.matrix.toArray()),x.wrapS=we[p.wrapS],x.wrapT=we[p.wrapT])})}(s,d),d}class J{constructor(e,t){this.gl=e;const{color:a,depth:i}=t;this.color=a,this.depth=i,this.framebuffer=e.createFramebuffer(),this.init()}bind(){const{gl:e,framebuffer:t}=this;e.bindFramebuffer(e.FRAMEBUFFER,t)}unbind(){const{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null)}dispose(){const{gl:e,framebuffer:t}=this;e.deleteFramebuffer(t)}init(){const{gl:e,color:t,depth:a}=this;this.bind();const i=[];for(let n in t){const r=Number(n);r===void 0&&console.error("invalid location");const l=t[r];e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+r,l.target,l.texture,0),i.push(e.COLOR_ATTACHMENT0+r)}e.drawBuffers(i),a&&e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,a.target,a.texture),this.unbind()}}function Ve(s,e){const t={};for(const a of e)t[a]=s.getExtension(a);return t}function W(s,e){return{values:`uniform${s}${e}`,array:`uniform${s}${e}v`}}function de(s,e){return{matrix:s===e?`uniformMatrix${s}fv`:`uniformMatrix${s}x${e}fv`}}class zt{constructor(e,t){this.gl=e;const a=function(i,n){const r={},l=i.getProgramParameter(n,i.ACTIVE_UNIFORMS);for(let o=0;o<l;o++){const{name:u,type:c}=i.getActiveUniform(n,o),d=i.getUniformLocation(n,u);d&&(r[u]={type:c,location:d})}return r}(e,t);this.uniforms={};for(let i in a){const{type:n,location:r}=a[i],l={type:n,location:r,v0:0,v1:0,v2:0,v3:0};this.uniforms[i]=l}this.typeMap=function(i){return{[i.FLOAT]:W(1,"f"),[i.FLOAT_VEC2]:W(2,"f"),[i.FLOAT_VEC3]:W(3,"f"),[i.FLOAT_VEC4]:W(4,"f"),[i.INT]:W(1,"i"),[i.INT_VEC2]:W(2,"i"),[i.INT_VEC3]:W(3,"i"),[i.INT_VEC4]:W(4,"i"),[i.UNSIGNED_INT]:W(1,"ui"),[i.UNSIGNED_INT_VEC2]:W(2,"ui"),[i.UNSIGNED_INT_VEC3]:W(3,"ui"),[i.UNSIGNED_INT_VEC4]:W(4,"ui"),[i.SAMPLER_2D]:W(1,"i"),[i.SAMPLER_3D]:W(1,"i"),[i.SAMPLER_2D_ARRAY]:W(1,"i"),[i.FLOAT_MAT2]:de(2,2),[i.FLOAT_MAT3]:de(3,3),[i.FLOAT_MAT4]:de(4,4),[i.INT_SAMPLER_2D]:W(1,"i")}}(e),this.needsUpload=[],this.failedUnis=new Set}setUniform(e,t,a,i,n){const r=this.uniforms[e];r?(r.v0=t,r.v1=a,r.v2=i,r.v3=n,this.needsUpload.push(r)):this.failedUnis.has(e)||this.failedUnis.add(e)}setStructUniform(e,t){if(t.length)for(let a=0;a<t.length;a++){const i=t[a];Object.keys(i).map(n=>{let r=i[n];(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector3||r.isVector2||r.isVector4)&&(r=r.toArray()),this.setUniform(`${e}[${a}].${n}`,r)})}else Object.keys(t).map(a=>{const i=t[a];this.setUniform(`${e}.${a}[0]`,i)})}upload(){const{gl:e,needsUpload:t,typeMap:a}=this;for(;t.length>0;){const{type:i,location:n,v0:r,v1:l,v2:o,v3:u}=t.pop(),c=a[i];if(r&&r.length)if(c.matrix){const d=r,h=l||!1;e[c.matrix](n,h,d)}else e[c.array](n,r);else e[c.values](n,r,l,o,u)}}}function nt(s,e,t,a){let i=`#version 300 es
precision highp float;
precision highp int;
precision highp isampler2D;
precision highp usampler2D;
`;return a&&(i+=function(n){let r="";for(const l in n){const o=n[l];o&&(r+=`#define ${l} ${o}
`)}return r}(a)),i+=t.source?t.source:t,function(n,r,l){const o=n.createShader(r);if(n.shaderSource(o,l),n.compileShader(o),n.getShaderParameter(o,n.COMPILE_STATUS))return o;const u=l.split(`
`).map((c,d)=>`${d+1}: ${c}`).join(`
`);throw console.error(u),n.getShaderInfoLog(o)}(s,e,i)}function rt(s,{defines:e,vertex:t}){return nt(s,s.VERTEX_SHADER,t,e)}class O{constructor(e,t){this.gl=e,this.params=t;const{fragment:a,vertex:i}=t,n=i instanceof WebGLShader?i:rt(e,t),r=a instanceof WebGLShader?a:function(o,{defines:u,fragment:c}){return nt(o,o.FRAGMENT_SHADER,c,u)}(e,t),l=function(o,u,c,d,h){const L=o.createProgram();if(o.attachShader(L,u),o.attachShader(L,c),d&&o.transformFeedbackVaryings(L,d,h),o.linkProgram(L),o.detachShader(L,u),o.detachShader(L,c),o.getProgramParameter(L,o.LINK_STATUS))return L;throw o.getProgramInfoLog(L)}(e,n,r);this.program=l,this.uniformSetter=new zt(e,l),this.attribLocs=function(o,u){const c={},d=o.getProgramParameter(u,o.ACTIVE_ATTRIBUTES);for(let h=0;h<d;h++){const{name:L}=o.getActiveAttrib(u,h);L&&(c[L]=o.getAttribLocation(u,L))}return c}(e,l),this.textures={},this.nextTexUnit=1}setUniform(e,t,a,i,n){this.uniformSetter.setUniform(e,t,a,i,n)}setStructUniform(e,t){this.uniformSetter.setStructUniform(e,t)}setTexture(e,t){if(t)if(this.textures[e])this.textures[e].tex=t;else{const a=this.nextTexUnit++;this.uniformSetter.setUniform(e,a),this.textures[e]={unit:a,tex:t}}}bindTextures(){const{gl:e,textures:t}=this;for(let a in t){const{tex:i,unit:n}=t[a];e.activeTexture(e.TEXTURE0+n),e.bindTexture(i.target,i.texture)}}useProgram(e=!0){const{gl:t,uniformSetter:a,program:i}=this;t.useProgram(i),a.upload(),e&&this.bindTextures()}disposeProgram(){const{gl:e,program:t}=this;e.deleteProgram(t)}dispose(){const{gl:e,textures:t}=this;for(const a in t){const{tex:i}=t[a];e.deleteTexture(i.texture)}this.disposeProgram()}}class ot{constructor(e){this.gl=e;const t=e.createVertexArray();e.bindVertexArray(t),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,2,0,0,2]),e.STATIC_DRAW),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,0,0),e.bindVertexArray(null),this.vao=t,this.vertexShader=rt(e,{vertex:"layout(location=0)in vec2 aPosition;layout(location=1)in vec2 aUv;out vec2 vCoord;void main(){vCoord=aUv;gl_Position=vec4(aPosition,0.,1.);}",defines:null})}draw(){const{gl:e,vao:t}=this;e.bindVertexArray(t),e.drawArrays(e.TRIANGLES,0,3)}}function Et(s,e,t){return .2126*s+.7152*e+.0722*t}function lt(s,e,t){return Math.min(Math.max(s,e),t)}function He(s,e,t=1e-4){for(let a=0;a<s.length;a++)if(Math.abs(s[a]-e[a])>t)return!1;return!0}function me(s,e){return s.type!=e.type?(e=s.clone(),!1):s.type==="OrthographicCamera"?He(s.viewToWorldMat,e.viewToWorldMat)&&s.zoom==e.zoom:He(s.viewToWorldMat,e.viewToWorldMat)}function C(){console.error("Only webgpu version supports this feature")}function Ke(s,e){return{1:s.RED_INTEGER,2:s.RG_INTEGER,3:s.RGB_INTEGER,4:s.RGBA_INTEGER}[e]}class z{constructor(e,t){this.gl=e;let a,{width:i,height:n,data:r,length:l=1,channels:o,storage:u,flipY:c=!1,gammaCorrection:d=!1,wrapS:h=e.CLAMP_TO_EDGE,wrapT:L=e.CLAMP_TO_EDGE,minFilter:f=e.NEAREST,magFilter:p=e.NEAREST}=t;i=i||r.width||0,n=n||r.height||0,this.texture=e.createTexture(),Array.isArray(r)&&(a=r,r=a[0]);let x=this.target=a||l>1?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D;e.activeTexture(e.TEXTURE0),e.bindTexture(x,this.texture),e.texParameteri(x,e.TEXTURE_MIN_FILTER,f),e.texParameteri(x,e.TEXTURE_MAG_FILTER,p),e.texParameteri(x,e.TEXTURE_WRAP_S,h),e.texParameteri(x,e.TEXTURE_WRAP_T,L),o||(o=r&&r.length?r.length/(i*n):4),o=lt(o,1,4);const{type:m,format:v,internalFormat:A}=function(T,_,S,b,F){let G,M;const P=b instanceof Uint8Array||b instanceof HTMLImageElement||b instanceof HTMLCanvasElement||b instanceof ImageData||b instanceof ImageBitmap,R=b instanceof Float32Array,X=b instanceof Int32Array,N=b instanceof Uint32Array;let I=function(g,oe){return{1:g.RED,2:g.RG,3:g.RGB,4:g.RGBA}[oe]}(T,_);return S==="byte"||!S&&P?(M={1:T.R8,2:T.RG8,3:F?T.SRGB8:T.RGB8,4:F?T.SRGB8_ALPHA8:T.RGBA8}[_],G=T.UNSIGNED_BYTE):S==="float"||!S&&R?(M={1:T.R32F,2:T.RG32F,3:T.RGB32F,4:T.RGBA32F}[_],G=T.FLOAT):S==="halfFloat"?(M={1:T.R16F,2:T.RG16F,3:T.RGB16F,4:T.RGBA16F}[_],G=T.HALF_FLOAT):S==="snorm"?(M={1:T.R8_SNORM,2:T.RG8_SNORM,3:T.RGB8_SNORM,4:T.RGBA8_SNORM}[_],G=T.UNSIGNED_BYTE):S==="int"||!S&&X?(M={1:T.R32I,2:T.RG32I,3:T.RGB32I,4:T.RGBA32I}[_],G=T.INT,I=Ke(T,_)):(S==="uint"||!S&&N)&&(M={1:T.R32UI,2:T.RG32UI,3:T.RGB32UI,4:T.RGBA32UI}[_],G=T.UNSIGNED_INT,I=Ke(T,_)),{format:I,internalFormat:M,type:G}}(e,o,u,r,d);if(a){e.texStorage3D(x,1,A,i,n,a.length);for(let T=0;T<a.length;T++){const _=a[T].width||i,S=a[T].height||n;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,Array.isArray(c)?c[T]:c),e.texSubImage3D(x,0,0,0,T,_,S,1,v,m,a[T])}}else l>1?e.texStorage3D(x,1,A,i,n,l):(e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,c),e.texStorage2D(x,1,A,i,n),r&&e.texSubImage2D(x,0,0,0,i,n,v,m,r));e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1)}dispose(){const{gl:e,texture:t}=this;e.deleteTexture(t)}}class wt{constructor(e,t,a){this.gl=e;const i=e.createRenderbuffer(),n=e.RENDERBUFFER;e.bindRenderbuffer(n,i),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT24,t,a),e.bindRenderbuffer(n,null),this.gl=e,this.texture=i,this.target=n}dispose(){const{gl:e,texture:t}=this;e.deleteRenderbuffer(t)}}function Ct(s,e){const t=new s.constructor(e);return t.set(s),t}class U extends z{constructor(e,t,a=4){const i=function(l){const o=Math.round(Math.log2(Math.sqrt(l))),u=2**o,c=Math.ceil(l/u);return{columnsLog:o,columns:u,rows:c,size:c*u}}(t.length/a),n=i.columns,r=i.rows;super(e,{data:Ct(t,a*n*r),width:n,height:r}),this.textureDim=i}}function H(s,e,t,a,i,n,r){const l=Math.min(r.length/n,t);for(let o=0;o<l;o++)for(let u=0;u<n;u++)s[e](a+o*i+4*u,r[n*o+u],!0)}class Ut{constructor(e,t,a){this.gl=e;const i=e.getUniformBlockIndex(t,a),n=e.getActiveUniformBlockParameter(t,i,e.UNIFORM_BLOCK_DATA_SIZE),r=function(u,c,d){const h=u.getActiveUniformBlockParameter(c,d,u.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),L=u.getActiveUniforms(c,h,u.UNIFORM_OFFSET),f=u.getActiveUniforms(c,h,u.UNIFORM_ARRAY_STRIDE),p={};for(let x=0;x<h.length;x++){const{name:m,type:v,size:A}=u.getActiveUniform(c,h[x]);p[m]={type:v,size:A,offset:L[x],stride:f[x]}}return p}(e,t,i),l=e.createBuffer();e.bindBuffer(e.UNIFORM_BUFFER,l),e.bufferData(e.UNIFORM_BUFFER,n,e.STATIC_DRAW);const o=new DataView(new ArrayBuffer(n));this.uniforms=r,this.buffer=l,this.data=o}set(e,t){const{gl:a,uniforms:i,data:n}=this;if(!i[e])return void console.warn("No uniform property with name ",e);const{type:r,size:l,offset:o,stride:u}=i[e];switch(r){case a.FLOAT:H(n,"setFloat32",l,o,u,1,t);break;case a.FLOAT_VEC2:H(n,"setFloat32",l,o,u,2,t);break;case a.FLOAT_VEC3:H(n,"setFloat32",l,o,u,3,t);break;case a.FLOAT_VEC4:H(n,"setFloat32",l,o,u,4,t);break;case a.INT:H(n,"setInt32",l,o,u,1,t);break;case a.INT_VEC2:H(n,"setInt32",l,o,u,2,t);break;case a.INT_VEC3:H(n,"setInt32",l,o,u,3,t);break;case a.INT_VEC4:H(n,"setInt32",l,o,u,4,t);break;case a.BOOL:H(n,"setUint32",l,o,u,1,t);break;case a.FLOAT_MAT4:H(n,"setFloat32",l,o,u,16,t);break;default:console.warn("UniformBuffer: Unsupported type")}}bind(e){const{gl:t,buffer:a,data:i}=this;t.bindBuffer(t.UNIFORM_BUFFER,a),t.bufferSubData(t.UNIFORM_BUFFER,0,i),t.bindBufferBase(t.UNIFORM_BUFFER,e,a)}dispose(){const{gl:e,buffer:t}=this;e.deleteBuffer(t)}}const te=Vt();function Vt(){const s=new ArrayBuffer(4),e=new Float32Array(s),t=new Uint32Array(s),a=new Uint32Array(512),i=new Uint32Array(512);for(let o=0;o<256;++o){const u=o-127;u<-27?(a[o]=0,a[256|o]=32768,i[o]=24,i[256|o]=24):u<-14?(a[o]=1024>>-u-14,a[256|o]=1024>>-u-14|32768,i[o]=-u-1,i[256|o]=-u-1):u<=15?(a[o]=u+15<<10,a[256|o]=u+15<<10|32768,i[o]=13,i[256|o]=13):u<128?(a[o]=31744,a[256|o]=64512,i[o]=24,i[256|o]=24):(a[o]=31744,a[256|o]=64512,i[o]=13,i[256|o]=13)}const n=new Uint32Array(2048),r=new Uint32Array(64),l=new Uint32Array(64);for(let o=1;o<1024;++o){let u=o<<13,c=0;for(;!(8388608&u);)u<<=1,c-=8388608;u&=-8388609,c+=947912704,n[o]=u|c}for(let o=1024;o<2048;++o)n[o]=939524096+(o-1024<<13);for(let o=1;o<31;++o)r[o]=o<<23;r[31]=1199570944,r[32]=2147483648;for(let o=33;o<63;++o)r[o]=2147483648+(o-32<<23);r[63]=3347054592;for(let o=1;o<64;++o)o!==32&&(l[o]=1024);return{floatView:e,uint32View:t,baseTable:a,shiftTable:i,mantissaTable:n,exponentTable:r,offsetTable:l}}function Ht(s){if(s instanceof Uint16Array)return s;const e=new Uint16Array(s.length);return s.map((t,a)=>e[a]=function(i){Math.abs(i)>65504&&console.warn("toHalfFloat(): Value out of range."),i=Math.max(-65504,Math.min(65504,i)),te.floatView[0]=i;const n=te.uint32View[0],r=n>>23&511;return te.baseTable[r]+((8388607&n)>>te.shiftTable[r])}(t)),e}function De(s,e,t=0,a=s.length){let i=t,n=t+a-1;for(;i<n;){const r=i+n>>1;s[r]<e?i=r+1:n=r}return i-t}const Kt={width:1,height:1,data:new Float32Array(4)},q=class{constructor(s,e){this.gl=s,this.resourcePool=e,this.totalSumValue=1}destory(){const{resourcePool:s}=this;s.destoryResourceByName(q.ENVMAP_RES_NAME),s.destoryResourceByName(q.ENVMAP_MARGINAL_WEIGHTS_RES_NAME),s.destoryResourceByName(q.ENVMAP_CONDITIONAL_WEIGHTS_RES_NAME)}load(s){s||(s=Kt);const{gl:e,resourcePool:t}=this;this.destory();const a=s.width,i=s.height,n=Ht(s.data),r=new z(e,{data:n,storage:"halfFloat",minFilter:e.LINEAR,magFilter:e.LINEAR,width:a,height:i}),{marginalDataArray:l,conditionalDataArray:o,totalSumValue:u}=function(h){const{width:L,height:f,data:p}=h,x=new Float32Array(L*f),m=new Float32Array(L*f),v=new Float32Array(f),A=new Float32Array(f);let T=0,_=0;for(let F=0;F<f;F++){let G=0;for(let M=0;M<L;M++){const P=F*L+M,R=Et(p[4*P+0],p[4*P+1],p[4*P+2]);G+=R,T+=R,x[P]=R,m[P]=G}if(G!==0)for(let M=F*L,P=F*L+L;M<P;M++)x[M]/=G,m[M]/=G;_+=G,v[F]=G,A[F]=_}if(_!==0)for(let F=0,G=v.length;F<G;F++)v[F]/=_,A[F]/=_;const S=new Float32Array(f),b=new Float32Array(L*f);for(let F=0;F<f;F++){const G=De(A,(F+1)/f);S[F]=(G+.5)/f}for(let F=0;F<f;F++)for(let G=0;G<L;G++){const M=F*L+G,P=De(m,(G+1)/L,F*L,L);b[M]=(P+.5)/L}return{marginalDataArray:S,conditionalDataArray:b,totalSumValue:T}}(s);this.totalSumValue=u;const c=new z(e,{data:l,storage:"float",channels:1,width:i,height:1}),d=new z(e,{data:o,storage:"float",channels:1,width:a,height:i});t.setResource(q.ENVMAP_RES_NAME,r),t.setResource(q.ENVMAP_MARGINAL_WEIGHTS_RES_NAME,c),t.setResource(q.ENVMAP_CONDITIONAL_WEIGHTS_RES_NAME,d)}};let j=q;function ut(s,e=!1){const t=new Map;let a=0,i=0,n=0,r=0;const l=[];l.push({vertexSplitIndex:0,indicesSplitIndex:0});for(const o of s){let u=o.geometry;if(t.get(u)==null){u.indices||Yt(u),u.uv||kt(u),e&&(u=Dt(u,o.localToWorldMat)),u.normal?he(u.normal.array,3,0,void 0,ie,void 0):Ot(u),n+=u.position.count,r+=u.indices.count,l.push({vertexSplitIndex:3*n,indicesSplitIndex:r});const c=t.size;t.set(u,c),o.geometry=u}a+=u.position.count,i+=u.indices.count}return{vertexTotalCount:n,indicesTotalCount:r,geoInfoSplitIndex:l,renderVertexCount:a,renderIndicesCount:i,geometryIndexMap:t}}function Dt(s,e){const t=new re(new B(s.position.array.slice(),s.position.itemSize),s.normal&&new B(s.normal.array.slice(),s.normal.itemSize),s.uv&&new B(s.uv.array,s.uv.itemSize),s.indices&&new B(s.indices.array,s.indices.itemSize)),a=new k().getNormalMatrix(e);return he(t.position.array,3,0,null,at,e),t.normal&&he(t.normal.array,3,0,null,it,a),t}function Yt(s){const e=s.position;if(!e)return void console.warn("No position attribute");const t=new Uint32Array(e.count);for(let a=0;a<t.length;a++)t[a]=a;return s.indices=new B(t,1),s}function kt(s){const e=s.position,t=new Float32Array(2*e.count);for(let a=0;a<t.length;a++)t[a]=Math.random();return s.uv=new B(t,2),s}function Ot(s){const e=s.indices.array,t=s.position.array;s.normal=new B(new Float32Array(t.length),3);const a=s.normal.array,i=new y,n=new y,r=new y,l=new y,o=new y,u=new y,c=e.length;let d,h,L;for(let f=0;f<c;){e?(d=e[f++],h=e[f++],L=e[f++]):(d=f++,h=f++,L=f++),i.set(t[3*d],t[3*d+1],t[3*d+2]),n.set(t[3*h],t[3*h+1],t[3*h+2]),r.set(t[3*L],t[3*L+1],t[3*L+2]),l.sub(i,n),o.sub(n,r),u.cross(l,o);for(let p=0;p<3;p++)a[3*d+p]=a[3*d+p]+u[p],a[3*h+p]=a[3*h+p]+u[p],a[3*L+p]=a[3*L+p]+u[p]}for(let f=0;f<a.length;)u.set(a[f],a[f+1],a[f+2]),u.normalize(),a[f++]=u[0],a[f++]=u[1],a[f++]=u[2]}function Zt(s,e,t){const a=[],{renderVertexCount:i,renderIndicesCount:n}=t;for(const l of s){let o=l.geometry;const u=l.material;let c=e.get(u);a.push({geometry:o,materialID:c})}return{geometry:function(l,o,u){const c=new B(new Float32Array(3*o),3),d=new B(new Float32Array(3*o),3),h=new B(new Float32Array(2*o),2),L=new B(new Uint32Array(u),1),f=new B(new Int32Array(2*o),2),p=new re(c,d,h,L);p.materialMeshIndex=f;let x=0,m=0,v=0;for(const{geometry:A,materialID:T}of l){const _=A.position.count;["position","normal","uv"].forEach(b=>{A[b]&&p[b].array.set(A[b].array,x*A[b].itemSize)});const S=A.indices.array;for(let b=0;b<S.length;b++)L.array[m+b]=x+S[b];for(let b=0;b<2*_;)f.array[2*x+b++]=T,f.array[2*x+b++]=v;x+=_,m+=S.length,v++}return p}(a,i,n),vertexCount:i,IndicesCount:n,visible:!0}}j.ENVMAP_RES_NAME="EnvMapTexture",j.ENVMAP_MARGINAL_WEIGHTS_RES_NAME="EnvMapMarginalWeightsTexture",j.ENVMAP_CONDITIONAL_WEIGHTS_RES_NAME="EnvMapConditionalWeightsTexture";class Qt{constructor(e,t){this.gl=e,this.fullscreenTriangle=t}createPipeline(){const{gl:e,fullscreenTriangle:t}=this,a={gl:e,vertex:t.vertexShader,fragment:"layout(location=0)out vec4 out_color;in vec2 vCoord;uniform sampler2D inputTex;void main(){vec4 light=texture(inputTex,vCoord);out_color=light;}"};this.renderPass=new O(e,a),this.fullscreenTriangle=t}draw(e){let{inputTex:t}=e;this.renderPass.setTexture("inputTex",t),this.renderPass.useProgram(),this.fullscreenTriangle.draw()}dispose(){this.renderPass.dispose()}}async function ct(s,e){const t=new Map;let a=0;e.forEach(r=>{Object.keys(r).forEach(l=>{var o;if((o=r[l])!=null&&o.isTexture){const u=r[l].image;let c=t.get(u);c===void 0&&a<255&&(c=t.size,t.set(u,c),a++)}})});let i,n=Array.from(t.keys());return a==255&&console.warn("Material limit exceeded. Some material information will be lost"),n.length==0?i=function(r){return new z(r,{width:1,height:1,length:2,storage:"byte",minFilter:r.LINEAR,magFilter:r.LINEAR})}(s):(n.length==1&&(n=[n[0],n[0]]),i=await async function(r,l){const o=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,o);const u=new ot(r),c=new Qt(r,u);c.createPipeline();const d=new z(r,{width:2048,height:2048,length:l.length,storage:"byte",channels:4,minFilter:r.LINEAR,magFilter:r.LINEAR});for(let h=0;h<l.length;h++){r.framebufferTextureLayer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,d.texture,0,h),r.clear(r.COLOR_BUFFER_BIT),r.viewport(0,0,2048,2048);const L=l[h],f=new z(r,{width:L.width,height:L.height,data:L,storage:"byte",channels:4,minFilter:r.LINEAR,magFilter:r.LINEAR});c.draw({inputTex:f}),f.dispose()}return r.bindFramebuffer(r.FRAMEBUFFER,null),r.deleteFramebuffer(o),d}(s,n)),{textureImages:n,textureImageMap:t,textureArrayRes:i}}function Y(...s){let e=0;for(let a=0;a<s.length;a++){const i=s[a],n=i.data?i.data.length/i.channels:0;e=Math.max(e,n)}const t=[];for(let a=0;a<e;a++)for(let i=0;i<s.length;i++){const{data:n=[],channels:r}=s[i];for(let l=0;l<r;l++)t.push(n[a*r+l])}return t}function ge(s,e){s.color=e.map(t=>t.color),s.workflow=e.map(t=>t.workflow==="Metalness"?0:1),s.roughness=e.map(t=>t.roughness),s.metalness=e.map(t=>t.metalness),s.transmission=e.map(t=>t.transmission),s.ior=e.map(t=>t.ior),s.sheen=e.map(t=>t.sheen),s.sheenTint=e.map(t=>t.sheenTint),s.clearcoat=e.map(t=>t.clearcoat),s.clearcoatRoughness=e.map(t=>t.clearcoatRoughness),s.emissiveColor=e.map(t=>t.emissiveColor),s.alpha=e.map(t=>t.alpha),s.specularTint=e.map(t=>t.specularTint),s.atDistance=e.map(t=>t.atDistance),s.normalScale=e.map(t=>t.normalScale),s.subsurfaceColor=e.map(t=>t.subsurfaceColor),s.subsurface=e.map(t=>t.subsurface),s.extinction=e.map(t=>t.extinction),s.subsurfaceMFP=e.map(t=>t.subsurfaceMFP),s.specularColor=e.map(t=>t.specularColor),s.glossiness=e.map(t=>t.glossiness)}function dt(s,e){s.set("Materials.colorWorkflow[0]",Y({data:[].concat(...e.color),channels:3},{data:e.workflow,channels:1})),s.set("Materials.roughMetalTransIOR[0]",Y({data:e.roughness,channels:1},{data:e.metalness,channels:1},{data:e.transmission,channels:1},{data:e.ior,channels:1})),s.set("Materials.sheenTintClearcoatRoughness[0]",Y({data:e.sheen,channels:1},{data:e.sheenTint,channels:1},{data:e.clearcoat,channels:1},{data:e.clearcoatRoughness,channels:1})),s.set("Materials.emissiveAlpha[0]",Y({data:[].concat(...e.emissiveColor),channels:3},{data:e.alpha,channels:1})),s.set("Materials.specularTintAtDistanceNormalScale[0]",Y({data:e.specularTint,channels:1},{data:e.atDistance,channels:1},{data:[].concat(...e.normalScale),channels:2})),s.set("Materials.subsurfaceAndColor[0]",Y({data:e.subsurface,channels:1},{data:[].concat(...e.subsurfaceColor),channels:3})),s.set("Materials.extinctionSubsurfaceMFP[0]",Y({data:[].concat(...e.extinction),channels:3},{data:e.subsurfaceMFP,channels:1})),s.set("Materials.specularColorGlossiness[0]",Y({data:[].concat(...e.specularColor),channels:3},{data:e.glossiness,channels:1}))}function ft(s,e,t){const a=[],i=[];e.map((n,r)=>{const l=Q(t,n.map),o=Q(t,n.normalMap),u=Q(t,n.roughnessMap),c=Q(t,n.metalnessMap);a.push(l,o,u,c);const d=Q(t,n.emissiveMap),h=Q(t,n.specularMap),L=Q(t,n.glossinessMap);i.push(d,h,L,-1)}),s.diffuseNormalRoughnessMetalnessMapIndex=a,s.emissiveSpecularGlossinessMapIndex=i}function Q(s,e){return e!=null&&e.image?s.get(e.image):-1}function ht(s,e){return dt(s,e),function(t,a){t.set("Materials.diffuseNormalRoughnessMetalnessMapIndex[0]",a.diffuseNormalRoughnessMetalnessMapIndex),t.set("Materials.emissiveSpecularGlossinessMapIndex[0]",a.emissiveSpecularGlossinessMapIndex)}(s,e),s.bind(0),s}function Lt(s,e){const t={};ge(t,e),dt(s,t),s.bind(0)}async function pt(s,e,t){const a={};ge(a,t);const{textureImageMap:i,textureArrayRes:n}=await ct(s,t);return ft(a,t,i),ht(e,a),{textureArrayRes:n}}async function mt(s,e,t=!1){const a={};ge(a,e);const{textureImageMap:i,textureArrayRes:n}=await ct(s,e);ft(a,e,i);const{defines:r,materialBuffer:l}=function(o,u,c=!1){const d={BVH_DYNAMIC:c,NUM_MESHES:u.length,NUM_MATERIALS:u.length},h=new O(o,{vertex:{source:"void main() {}"},fragment:{source:`
#ifdef NUM_MATERIALS
uniform Materials{vec4 colorWorkflow[NUM_MATERIALS];vec4 roughMetalTransIOR[NUM_MATERIALS];vec4 sheenTintClearcoatRoughness[NUM_MATERIALS];vec4 emissiveAlpha[NUM_MATERIALS];vec4 specularTintAtDistanceNormalScale[NUM_MATERIALS];vec4 subsurfaceAndColor[NUM_MATERIALS];vec4 extinctionSubsurfaceMFP[NUM_MATERIALS];vec4 specularColorGlossiness[NUM_MATERIALS];ivec4 diffuseNormalRoughnessMetalnessMapIndex[NUM_MATERIALS];ivec4 emissiveSpecularGlossinessMapIndex[NUM_MATERIALS];}materials;
#endif

void main() {}`},defines:d}),L=new Ut(o,h.program,"Materials");return h.dispose(),{defines:d,materialBuffer:L}}(s,e,t);return ht(l,a),{materialDefines:r,bufferData:a,materialBuffer:l,textureArrayRes:n,textureImageMap:i}}const Ye=["map","normalMap","roughnessMap","metalnessMap","specularMap","glossinessMap","emissiveMap"];function xt(s,e){const{mapNum:t,perMatrixLength:a,perWrappingDataLength:i,uvTransDataLength:n,bufferSize:r}=function(h){const L=Ye.length,f=h.size*L*9,p=h.size*L*3;return{mapNum:L,perMatrixLength:9,perWrappingDataLength:3,uvTransDataLength:f,textureWrappingDataLength:p,bufferSize:f+p}}(e),l=new Float32Array(r),o=new k,u=t*a,c=t*i;e.forEach((h,L)=>{Ye.forEach((f,p)=>{const x=L[`${f}`];let m=o;x&&(m=x.uvTransMat);for(let _=0;_<a;_++)l[u*h+p*a+_]=m[_];let v=0,A=0;x&&(v=x.wrapS,A=x.wrapT);const T=n+h*c+p*i;l[T+0]=v,l[T+1]=A,l[T+2]=0})});const d=new U(s,l,3);return{uvTransDefines:{UV_TRANS_COLUMNS:d.textureDim.columnsLog,TEX_WRAP_DATA_INDEX:n/3},uvTransformBufferTex:d}}function ke(s,e,t=0,a=s.length,i=Math.floor((t+a)/2)){for(let n=t;n<=i;n++){let r=n,l=s[n];for(let o=n+1;o<a;o++)e(l,s[o])||(r=o,l=s[o],Tt(s,n,r))}}function Tt(s,e,t){const a=s[t];s[t]=s[e],s[e]=a}let At,xe=0,Te=0,Ae=0,be=!1;const w=new y;function Oe(s,e){return{primitives:s,bounds:e}}function Ze(s,e,t){let a=t[e]-s.min[e];return s.max[e]>s.min[e]&&(a/=s.max[e]-s.min[e]),a}function fe(s){return s.getSize(w),2*(w.x*w.z+w.x*w.y+w.z*w.y)}function ne(s,e,t,a=!1){const i=new K;for(let u=e;u<t;u++)i.union(s[u].bounds);be&&(Ae+=1,At((Ae+Te)/xe));const n=t-e;if(n===1)return Oe(s.slice(e,t),i);{const u=new K;for(let h=e;h<t;h++)u.expandByPoint(s[h].center);const c=(u.getSize(w),w.x>w.z?w.x>w.y?"x":"y":w.z>w.y?"z":"y");let d=Math.floor((e+t)/2);if(n<=4)ke(s,(h,L)=>h.center[c]<L.center[c],e,t,d);else if(u.max[c]===u.min[c]){if(!a)return Oe(s.slice(e,t),i);ke(s,(h,L)=>h.center[c]<L.center[c],e,t,d)}else{const L=[];for(let m=0;m<12;m++)L.push({bounds:new K,count:0});for(let m=e;m<t;m++){let v=Math.floor(12*Ze(u,c,s[m].center));v===L.length&&(v=L.length-1),L[v].count++,L[v].bounds.union(s[m].bounds)}const f=[];for(let m=0;m<L.length-1;m++){const v=new K,A=new K;let T=0,_=0;for(let S=0;S<=m;S++)v.union(L[S].bounds),T+=L[S].count;for(let S=m+1;S<L.length;S++)A.union(L[S].bounds),_+=L[S].count;f.push(.1+(T*fe(v)+_*fe(A))/fe(i))}let p=f[0],x=0;for(let m=1;m<f.length;m++)f[m]<p&&(p=f[m],x=m);d=function(m,v,A=0,T=m.length){for(;A!==T;){for(;v(m[A]);)if(++A===T)return A;do if(A===--T)return A;while(!v(m[T]));Tt(m,A,T),A++}return A}(s,m=>{let v=Math.floor(L.length*Ze(u,c,m.center));return v===L.length&&(v=L.length-1),v<=x},e,t)}return r=c,l=ne(s,e,d,a),o=ne(s,d,t,a),{child0:l,child1:o,bounds:new K().union(l.bounds).union(o.bounds),splitAxis:r}}var r,l,o}function Qe(s,e,t){const a=function(i,n,r){const l=[];for(let o=0;o<i.length;o++){const u=i[o],{material:c,geometry:d}=u,h=new K;h.copy(d.aabb).applyMatrix4(u.localToWorldMat);const L={bounds:h,center:h.getCenter(new y),meshID:o,geometryID:n.get(d),materialID:r.get(c),visible:u.visible};l.push(L)}return l}(s,e,t);return be=!1,ne(a,0,a.length,!0)}function qe(s,e){const{primitiveInfoArr:t}=function(i){let n=0;const r=[];for(let l=0;l<i.length;l++){const o=[],u=i[l],c=u.indices,d=u.position,h=u.materialMeshIndex,L=new y,f=new y,p=new y,x=new y,m=new y;for(let v=0;v<c.array.length;v+=3){const A=c.array[v],T=c.array[v+1],_=c.array[v+2],S=new K,b=3,F=A*b;L.x=d.array[F],L.y=d.array[F+1],L.z=d.array[F+2];const G=T*b;f.x=d.array[G],f.y=d.array[G+1],f.z=d.array[G+2];const M=_*b;p.x=d.array[M],p.y=d.array[M+1],p.z=d.array[M+2],S.expandByPoint(L),S.expandByPoint(f),S.expandByPoint(p),x.sub(p,L),m.sub(f,L);const P=new y().cross(m,x).normalize(),R={bounds:S,center:S.getCenter(new y),indices:[A+n,T+n,_+n],faceNormal:P,materialID:h&&h.array[A*h.itemSize]};o.push(R)}n+=u.position.array.length/3,r.push(o)}return{primitiveInfoArr:r}}(s),a=[];if(e){xe=0,Te=0,be=!0,At=e;for(let i=0;i<t.length;i++)xe+=2*t[i].length-1}for(let i=0;i<t.length;i++){const n=t[i];Ae=0;const r=ne(n,0,n.length);Te+=2*n.length-1,a.push(r)}return{blasBVHs:a}}function vt(s,e=0,t=[]){const a=[];let i=1;const n={x:0,y:1,z:2},r=(l,o=1)=>{if(i=Math.max(o,i),l.primitives){const u=l;for(let c=0;c<u.primitives.length;c++){const d=u.primitives[c];if(d.indices!==void 0){const h=d;a.push(h.indices[0],h.indices[1],h.indices[2],-1,h.faceNormal.x,h.faceNormal.y,h.faceNormal.z,h.materialID||0)}else{const h=d;a.push(t[h.geometryID],h.materialID,h.meshID,-1,Number(h.visible),0,0,0)}}}else{const u=l,c=u.bounds;a.push(c.min.x,c.min.y,c.min.z,n[u.splitAxis],c.max.x,c.max.y,c.max.z,-1);const d=a.length-1;r(u.child0,o+1),a[d]=a.length/4+e,r(u.child1,o+1)}};return r(s),{count:a.length/4,maxDepth:i,flatData:a}}function je(s,e){return vt(s,0,e)}function Je(s,e=0){const t=[];let a=[],i=1;for(let n=0;n<s.length;n++){const r=vt(s[n],e);i=Math.max(r.maxDepth,i),a.push(e),e+=r.count,t.push(r)}return{blasBufferSplitIndex:a,totalBLASDataLength:4*e,totalBLASDataCount:e,flatBVHInfos:t,maxDepth:i}}const _t="IWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NvbnN0IHQ9MWUtNjtmdW5jdGlvbiBuKHQpe3JldHVybiB0WzBdPTEsdFsxXT0wLHRbMl09MCx0WzNdPTAsdFs0XT0wLHRbNV09MSx0WzZdPTAsdFs3XT0wLHRbOF09MCx0WzldPTAsdFsxMF09MSx0WzExXT0wLHRbMTJdPTAsdFsxM109MCx0WzE0XT0wLHRbMTVdPTEsdH1mdW5jdGlvbiBpKHQsbixpKXtsZXQgcz1uWzBdLGU9blsxXSxyPW5bMl0saD1uWzNdLGE9bls0XSxvPW5bNV0sdT1uWzZdLGw9bls3XSxjPW5bOF0sbT1uWzldLGY9blsxMF0seD1uWzExXSx5PW5bMTJdLHA9blsxM10sZz1uWzE0XSxNPW5bMTVdLGQ9aVswXSx6PWlbMV0sdz1pWzJdLGI9aVszXTtyZXR1cm4gdFswXT1kKnMreiphK3cqYytiKnksdFsxXT1kKmUreipvK3cqbStiKnAsdFsyXT1kKnIreip1K3cqZitiKmcsdFszXT1kKmgreipsK3cqeCtiKk0sZD1pWzRdLHo9aVs1XSx3PWlbNl0sYj1pWzddLHRbNF09ZCpzK3oqYSt3KmMrYip5LHRbNV09ZCplK3oqbyt3Km0rYipwLHRbNl09ZCpyK3oqdSt3KmYrYipnLHRbN109ZCpoK3oqbCt3KngrYipNLGQ9aVs4XSx6PWlbOV0sdz1pWzEwXSxiPWlbMTFdLHRbOF09ZCpzK3oqYSt3KmMrYip5LHRbOV09ZCplK3oqbyt3Km0rYipwLHRbMTBdPWQqcit6KnUrdypmK2IqZyx0WzExXT1kKmgreipsK3cqeCtiKk0sZD1pWzEyXSx6PWlbMTNdLHc9aVsxNF0sYj1pWzE1XSx0WzEyXT1kKnMreiphK3cqYytiKnksdFsxM109ZCplK3oqbyt3Km0rYipwLHRbMTRdPWQqcit6KnUrdypmK2IqZyx0WzE1XT1kKmgreipsK3cqeCtiKk0sdH1mdW5jdGlvbiBzKHQsbil7bGV0IGk9blswXStuWzVdK25bMTBdLHM9MDtyZXR1cm4gaT4wPyhzPTIqTWF0aC5zcXJ0KGkrMSksdFszXT0uMjUqcyx0WzBdPShuWzZdLW5bOV0pL3MsdFsxXT0obls4XS1uWzJdKS9zLHRbMl09KG5bMV0tbls0XSkvcyk6blswXT5uWzVdJiZuWzBdPm5bMTBdPyhzPTIqTWF0aC5zcXJ0KDErblswXS1uWzVdLW5bMTBdKSx0WzNdPShuWzZdLW5bOV0pL3MsdFswXT0uMjUqcyx0WzFdPShuWzFdK25bNF0pL3MsdFsyXT0obls4XStuWzJdKS9zKTpuWzVdPm5bMTBdPyhzPTIqTWF0aC5zcXJ0KDErbls1XS1uWzBdLW5bMTBdKSx0WzNdPShuWzhdLW5bMl0pL3MsdFswXT0oblsxXStuWzRdKS9zLHRbMV09LjI1KnMsdFsyXT0obls2XStuWzldKS9zKToocz0yKk1hdGguc3FydCgxK25bMTBdLW5bMF0tbls1XSksdFszXT0oblsxXS1uWzRdKS9zLHRbMF09KG5bOF0rblsyXSkvcyx0WzFdPShuWzZdK25bOV0pL3MsdFsyXT0uMjUqcyksdH1mdW5jdGlvbiBlKHQsbil7bGV0IGk9blswXSxzPW5bMV0sZT1uWzJdLHI9blszXSxoPWkraSxhPXMrcyxvPWUrZSx1PWkqaCxsPXMqaCxjPXMqYSxtPWUqaCxmPWUqYSx4PWUqbyx5PXIqaCxwPXIqYSxnPXIqbztyZXR1cm4gdFswXT0xLWMteCx0WzFdPWwrZyx0WzJdPW0tcCx0WzNdPTAsdFs0XT1sLWcsdFs1XT0xLXUteCx0WzZdPWYreSx0WzddPTAsdFs4XT1tK3AsdFs5XT1mLXksdFsxMF09MS11LWMsdFsxMV09MCx0WzEyXT0wLHRbMTNdPTAsdFsxNF09MCx0WzE1XT0xLHR9ZnVuY3Rpb24gcih0LG4saSl7cmV0dXJuIHRbMF09blswXStpWzBdLHRbMV09blsxXStpWzFdLHRbMl09blsyXStpWzJdLHR9ZnVuY3Rpb24gaCh0LG4saSl7cmV0dXJuIHRbMF09blswXS1pWzBdLHRbMV09blsxXS1pWzFdLHRbMl09blsyXS1pWzJdLHR9ZnVuY3Rpb24gYSh0LG4saSl7cmV0dXJuIHRbMF09blswXSppLHRbMV09blsxXSppLHRbMl09blsyXSppLHR9ZnVuY3Rpb24gbyh0LG4pe2xldCBpPW5bMF0scz1uWzFdLGU9blsyXSxyPWkqaStzKnMrZSplO3JldHVybiByPjAmJihyPTEvTWF0aC5zcXJ0KHIpLHRbMF09blswXSpyLHRbMV09blsxXSpyLHRbMl09blsyXSpyKSx0fWZ1bmN0aW9uIHUodCxuKXtyZXR1cm4gdFswXSpuWzBdK3RbMV0qblsxXSt0WzJdKm5bMl19bmV3IGNsYXNzIGV4dGVuZHMgQXJyYXl7Y29uc3RydWN0b3IodD0xLG49MCxpPTAscz0wLGU9MCxyPTEsaD0wLGE9MCxvPTAsdT0wLGw9MSxjPTAsbT0wLGY9MCx4PTAseT0xKXtyZXR1cm4gc3VwZXIodCxuLGkscyxlLHIsaCxhLG8sdSxsLGMsbSxmLHgseSksdGhpc31nZXQgaXNNYXRyaXg0KCl7cmV0dXJuITB9c2V0IHgodCl7dGhpc1sxMl09dH1nZXQgeCgpe3JldHVybiB0aGlzWzEyXX1zZXQgeSh0KXt0aGlzWzEzXT10fWdldCB5KCl7cmV0dXJuIHRoaXNbMTNdfXNldCB6KHQpe3RoaXNbMTRdPXR9Z2V0IHooKXtyZXR1cm4gdGhpc1sxNF19c2V0IHcodCl7dGhpc1sxNV09dH1nZXQgdygpe3JldHVybiB0aGlzWzE1XX1zZXQodCxuLGkscyxlLHIsaCxhLG8sdSxsLGMsbSxmLHgseSl7cmV0dXJuIHQubGVuZ3RoP3RoaXMuY29weSh0KTooZnVuY3Rpb24odCxuLGkscyxlLHIsaCxhLG8sdSxsLGMsbSxmLHgseSxwKXt0WzBdPW4sdFsxXT1pLHRbMl09cyx0WzNdPWUsdFs0XT1yLHRbNV09aCx0WzZdPWEsdFs3XT1vLHRbOF09dSx0WzldPWwsdFsxMF09Yyx0WzExXT1tLHRbMTJdPWYsdFsxM109eCx0WzE0XT15LHRbMTVdPXB9KHRoaXMsdCxuLGkscyxlLHIsaCxhLG8sdSxsLGMsbSxmLHgseSksdGhpcyl9dHJhbnNsYXRlKHQsbj10aGlzKXtyZXR1cm4gZnVuY3Rpb24odCxuLGkpe2xldCBzLGUscixoLGEsbyx1LGwsYyxtLGYseCx5PWlbMF0scD1pWzFdLGc9aVsyXTtuPT09dD8odFsxMl09blswXSp5K25bNF0qcCtuWzhdKmcrblsxMl0sdFsxM109blsxXSp5K25bNV0qcCtuWzldKmcrblsxM10sdFsxNF09blsyXSp5K25bNl0qcCtuWzEwXSpnK25bMTRdLHRbMTVdPW5bM10qeStuWzddKnArblsxMV0qZytuWzE1XSk6KHM9blswXSxlPW5bMV0scj1uWzJdLGg9blszXSxhPW5bNF0sbz1uWzVdLHU9bls2XSxsPW5bN10sYz1uWzhdLG09bls5XSxmPW5bMTBdLHg9blsxMV0sdFswXT1zLHRbMV09ZSx0WzJdPXIsdFszXT1oLHRbNF09YSx0WzVdPW8sdFs2XT11LHRbN109bCx0WzhdPWMsdFs5XT1tLHRbMTBdPWYsdFsxMV09eCx0WzEyXT1zKnkrYSpwK2MqZytuWzEyXSx0WzEzXT1lKnkrbypwK20qZytuWzEzXSx0WzE0XT1yKnkrdSpwK2YqZytuWzE0XSx0WzE1XT1oKnkrbCpwK3gqZytuWzE1XSl9KHRoaXMsbix0KSx0aGlzfXJvdGF0ZVgodCxuPXRoaXMpe3JldHVybiBmdW5jdGlvbih0LG4saSl7bGV0IHM9TWF0aC5zaW4oaSksZT1NYXRoLmNvcyhpKSxyPW5bNF0saD1uWzVdLGE9bls2XSxvPW5bN10sdT1uWzhdLGw9bls5XSxjPW5bMTBdLG09blsxMV07biE9PXQmJih0WzBdPW5bMF0sdFsxXT1uWzFdLHRbMl09blsyXSx0WzNdPW5bM10sdFsxMl09blsxMl0sdFsxM109blsxM10sdFsxNF09blsxNF0sdFsxNV09blsxNV0pLHRbNF09ciplK3Uqcyx0WzVdPWgqZStsKnMsdFs2XT1hKmUrYypzLHRbN109byplK20qcyx0WzhdPXUqZS1yKnMsdFs5XT1sKmUtaCpzLHRbMTBdPWMqZS1hKnMsdFsxMV09bSplLW8qc30odGhpcyxuLHQpLHRoaXN9cm90YXRlWSh0LG49dGhpcyl7cmV0dXJuIGZ1bmN0aW9uKHQsbixpKXtsZXQgcz1NYXRoLnNpbihpKSxlPU1hdGguY29zKGkpLHI9blswXSxoPW5bMV0sYT1uWzJdLG89blszXSx1PW5bOF0sbD1uWzldLGM9blsxMF0sbT1uWzExXTtuIT09dCYmKHRbNF09bls0XSx0WzVdPW5bNV0sdFs2XT1uWzZdLHRbN109bls3XSx0WzEyXT1uWzEyXSx0WzEzXT1uWzEzXSx0WzE0XT1uWzE0XSx0WzE1XT1uWzE1XSksdFswXT1yKmUtdSpzLHRbMV09aCplLWwqcyx0WzJdPWEqZS1jKnMsdFszXT1vKmUtbSpzLHRbOF09cipzK3UqZSx0WzldPWgqcytsKmUsdFsxMF09YSpzK2MqZSx0WzExXT1vKnMrbSplfSh0aGlzLG4sdCksdGhpc31yb3RhdGVaKHQsbj10aGlzKXtyZXR1cm4gZnVuY3Rpb24odCxuLGkpe2xldCBzPU1hdGguc2luKGkpLGU9TWF0aC5jb3MoaSkscj1uWzBdLGg9blsxXSxhPW5bMl0sbz1uWzNdLHU9bls0XSxsPW5bNV0sYz1uWzZdLG09bls3XTtuIT09dCYmKHRbOF09bls4XSx0WzldPW5bOV0sdFsxMF09blsxMF0sdFsxMV09blsxMV0sdFsxMl09blsxMl0sdFsxM109blsxM10sdFsxNF09blsxNF0sdFsxNV09blsxNV0pLHRbMF09ciplK3Uqcyx0WzFdPWgqZStsKnMsdFsyXT1hKmUrYypzLHRbM109byplK20qcyx0WzRdPXUqZS1yKnMsdFs1XT1sKmUtaCpzLHRbNl09YyplLWEqcyx0WzddPW0qZS1vKnN9KHRoaXMsbix0KSx0aGlzfXNjYWxlKHQsbj10aGlzKXtyZXR1cm4gZnVuY3Rpb24odCxuLGkpe2xldCBzPWlbMF0sZT1pWzFdLHI9aVsyXTt0WzBdPW5bMF0qcyx0WzFdPW5bMV0qcyx0WzJdPW5bMl0qcyx0WzNdPW5bM10qcyx0WzRdPW5bNF0qZSx0WzVdPW5bNV0qZSx0WzZdPW5bNl0qZSx0WzddPW5bN10qZSx0WzhdPW5bOF0qcix0WzldPW5bOV0qcix0WzEwXT1uWzEwXSpyLHRbMTFdPW5bMTFdKnIsdFsxMl09blsxMl0sdFsxM109blsxM10sdFsxNF09blsxNF0sdFsxNV09blsxNV19KHRoaXMsbiwibnVtYmVyIj09dHlwZW9mIHQ/W3QsdCx0XTp0KSx0aGlzfW11bHRpcGx5KHQsbil7cmV0dXJuIG4/aSh0aGlzLHQsbik6aSh0aGlzLHRoaXMsdCksdGhpc31pZGVudGl0eSgpe3JldHVybiBuKHRoaXMpLHRoaXN9Y29weSh0KXt2YXIgbixpO3JldHVybiBpPXQsKG49dGhpcylbMF09aVswXSxuWzFdPWlbMV0sblsyXT1pWzJdLG5bM109aVszXSxuWzRdPWlbNF0sbls1XT1pWzVdLG5bNl09aVs2XSxuWzddPWlbN10sbls4XT1pWzhdLG5bOV09aVs5XSxuWzEwXT1pWzEwXSxuWzExXT1pWzExXSxuWzEyXT1pWzEyXSxuWzEzXT1pWzEzXSxuWzE0XT1pWzE0XSxuWzE1XT1pWzE1XSx0aGlzfWZyb21QZXJzcGVjdGl2ZSh7Zm92OnQsYXNwZWN0Om4sbmVhcjppLGZhcjpzfT17fSl7cmV0dXJuIGZ1bmN0aW9uKHQsbixpLHMsZSl7bGV0IHI9MS9NYXRoLnRhbihuLzIpLGg9MS8ocy1lKTt0WzBdPXIvaSx0WzFdPTAsdFsyXT0wLHRbM109MCx0WzRdPTAsdFs1XT1yLHRbNl09MCx0WzddPTAsdFs4XT0wLHRbOV09MCx0WzEwXT0oZStzKSpoLHRbMTFdPS0xLHRbMTJdPTAsdFsxM109MCx0WzE0XT0yKmUqcypoLHRbMTVdPTB9KHRoaXMsdCxuLGkscyksdGhpc31mcm9tT3J0aG9nb25hbCh7bGVmdDp0LHJpZ2h0Om4sYm90dG9tOmksdG9wOnMsbmVhcjplLGZhcjpyfSl7cmV0dXJuIGZ1bmN0aW9uKHQsbixpLHMsZSxyLGgpe2xldCBhPTEvKG4taSksbz0xLyhzLWUpLHU9MS8oci1oKTt0WzBdPS0yKmEsdFsxXT0wLHRbMl09MCx0WzNdPTAsdFs0XT0wLHRbNV09LTIqbyx0WzZdPTAsdFs3XT0wLHRbOF09MCx0WzldPTAsdFsxMF09Mip1LHRbMTFdPTAsdFsxMl09KG4raSkqYSx0WzEzXT0oZStzKSpvLHRbMTRdPShoK3IpKnUsdFsxNV09MX0odGhpcyx0LG4saSxzLGUsciksdGhpc31mcm9tUXVhdGVybmlvbih0KXtyZXR1cm4gZSh0aGlzLHQpLHRoaXN9c2V0UG9zaXRpb24odCl7cmV0dXJuIHRoaXMueD10WzBdLHRoaXMueT10WzFdLHRoaXMuej10WzJdLHRoaXN9dHJhbnNwb3NlKHQ9dGhpcyl7cmV0dXJuIGZ1bmN0aW9uKHQsbil7aWYodD09PW4pe2xldCBpPW5bMV0scz1uWzJdLGU9blszXSxyPW5bNl0saD1uWzddLGE9blsxMV07dFsxXT1uWzRdLHRbMl09bls4XSx0WzNdPW5bMTJdLHRbNF09aSx0WzZdPW5bOV0sdFs3XT1uWzEzXSx0WzhdPXMsdFs5XT1yLHRbMTFdPW5bMTRdLHRbMTJdPWUsdFsxM109aCx0WzE0XT1hfWVsc2UgdFswXT1uWzBdLHRbMV09bls0XSx0WzJdPW5bOF0sdFszXT1uWzEyXSx0WzRdPW5bMV0sdFs1XT1uWzVdLHRbNl09bls5XSx0WzddPW5bMTNdLHRbOF09blsyXSx0WzldPW5bNl0sdFsxMF09blsxMF0sdFsxMV09blsxNF0sdFsxMl09blszXSx0WzEzXT1uWzddLHRbMTRdPW5bMTFdLHRbMTVdPW5bMTVdfSh0aGlzLHQpLHRoaXN9aW52ZXJzZSh0PXRoaXMpe3JldHVybiBmdW5jdGlvbih0LG4pe2xldCBpPW5bMF0scz1uWzFdLGU9blsyXSxyPW5bM10saD1uWzRdLGE9bls1XSxvPW5bNl0sdT1uWzddLGw9bls4XSxjPW5bOV0sbT1uWzEwXSxmPW5bMTFdLHg9blsxMl0seT1uWzEzXSxwPW5bMTRdLGc9blsxNV0sTT1pKmEtcypoLGQ9aSpvLWUqaCx6PWkqdS1yKmgsdz1zKm8tZSphLGI9cyp1LXIqYSx2PWUqdS1yKm8scT1sKnktYyp4LEE9bCpwLW0qeCxCPWwqZy1mKngsST1jKnAtbSp5LEQ9YypnLWYqeSxQPW0qZy1mKnAsUz1NKlAtZCpEK3oqSSt3KkItYipBK3YqcTtTJiYoUz0xL1MsdFswXT0oYSpQLW8qRCt1KkkpKlMsdFsxXT0oZSpELXMqUC1yKkkpKlMsdFsyXT0oeSp2LXAqYitnKncpKlMsdFszXT0obSpiLWMqdi1mKncpKlMsdFs0XT0obypCLWgqUC11KkEpKlMsdFs1XT0oaSpQLWUqQityKkEpKlMsdFs2XT0ocCp6LXgqdi1nKmQpKlMsdFs3XT0obCp2LW0qeitmKmQpKlMsdFs4XT0oaCpELWEqQit1KnEpKlMsdFs5XT0ocypCLWkqRC1yKnEpKlMsdFsxMF09KHgqYi15KnorZypNKSpTLHRbMTFdPShjKnotbCpiLWYqTSkqUyx0WzEyXT0oYSpBLWgqSS1vKnEpKlMsdFsxM109KGkqSS1zKkErZSpxKSpTLHRbMTRdPSh5KmQteCp3LXAqTSkqUyx0WzE1XT0obCp3LWMqZCttKk0pKlMpfSh0aGlzLHQpLHRoaXN9Y29tcG9zZSh0LG4saSl7cmV0dXJuIGZ1bmN0aW9uKHQsbixpLHMpe2xldCBlPW5bMF0scj1uWzFdLGg9blsyXSxhPW5bM10sbz1lK2UsdT1yK3IsbD1oK2gsYz1lKm8sbT1lKnUsZj1lKmwseD1yKnUseT1yKmwscD1oKmwsZz1hKm8sTT1hKnUsZD1hKmwsej1zWzBdLHc9c1sxXSxiPXNbMl07dFswXT0oMS0oeCtwKSkqeix0WzFdPShtK2QpKnosdFsyXT0oZi1NKSp6LHRbM109MCx0WzRdPShtLWQpKncsdFs1XT0oMS0oYytwKSkqdyx0WzZdPSh5K2cpKncsdFs3XT0wLHRbOF09KGYrTSkqYix0WzldPSh5LWcpKmIsdFsxMF09KDEtKGMreCkpKmIsdFsxMV09MCx0WzEyXT1pWzBdLHRbMTNdPWlbMV0sdFsxNF09aVsyXSx0WzE1XT0xfSh0aGlzLHQsbixpKSx0aGlzfWdldFJvdGF0aW9uKHQpe3JldHVybiBzKHQsdGhpcyksdGhpc31leHRyYWN0Um90YXRpb24odCl7bGV0IG49W107cmV0dXJuIHMobix0KSxlKHRoaXMsbiksdGhpc31mcm9tUm90YXRpb24obixpKXtyZXR1cm4gZnVuY3Rpb24obixpLHMpe2xldCBlLHIsaCxhPXNbMF0sbz1zWzFdLHU9c1syXSxsPU1hdGguc3FydChhKmErbypvK3UqdSk7TWF0aC5hYnMobCk8dHx8KGw9MS9sLGEqPWwsbyo9bCx1Kj1sLGU9TWF0aC5zaW4oaSkscj1NYXRoLmNvcyhpKSxoPTEtcixuWzBdPWEqYSpoK3IsblsxXT1vKmEqaCt1KmUsblsyXT11KmEqaC1vKmUsblszXT0wLG5bNF09YSpvKmgtdSplLG5bNV09bypvKmgrcixuWzZdPXUqbypoK2EqZSxuWzddPTAsbls4XT1hKnUqaCtvKmUsbls5XT1vKnUqaC1hKmUsblsxMF09dSp1KmgrcixuWzExXT0wLG5bMTJdPTAsblsxM109MCxuWzE0XT0wLG5bMTVdPTEpfSh0aGlzLG4saSksdGhpc31nZXRUcmFuc2xhdGlvbih0KXt2YXIgbixpO3JldHVybiBpPXRoaXMsKG49dClbMF09aVsxMl0sblsxXT1pWzEzXSxuWzJdPWlbMTRdLHRoaXN9Z2V0U2NhbGluZyh0KXtyZXR1cm4gZnVuY3Rpb24odCxuKXtsZXQgaT1uWzBdLHM9blsxXSxlPW5bMl0scj1uWzRdLGg9bls1XSxhPW5bNl0sbz1uWzhdLHU9bls5XSxsPW5bMTBdO3RbMF09TWF0aC5zcXJ0KGkqaStzKnMrZSplKSx0WzFdPU1hdGguc3FydChyKnIraCpoK2EqYSksdFsyXT1NYXRoLnNxcnQobypvK3UqdStsKmwpfSh0LHRoaXMpLHRoaXN9Z2V0TWF4U2NhbGVPbkF4aXMoKXtyZXR1cm4gZnVuY3Rpb24odCl7bGV0IG49dFswXSxpPXRbMV0scz10WzJdLGU9dFs0XSxyPXRbNV0saD10WzZdLGE9dFs4XSxvPXRbOV0sdT10WzEwXTtjb25zdCBsPW4qbitpKmkrcypzLGM9ZSplK3IqcitoKmgsbT1hKmErbypvK3UqdTtyZXR1cm4gTWF0aC5zcXJ0KE1hdGgubWF4KGwsYyxtKSl9KHRoaXMpfWxvb2tBdCh0LG4saSl7cmV0dXJuIGZ1bmN0aW9uKHQsbixpLHMpe2xldCBlPW5bMF0scj1uWzFdLGg9blsyXSxhPXNbMF0sbz1zWzFdLHU9c1syXSxsPWUtaVswXSxjPXItaVsxXSxtPWgtaVsyXSxmPWwqbCtjKmMrbSptO2Y+MCYmKGY9MS9NYXRoLnNxcnQoZiksbCo9ZixjKj1mLG0qPWYpO2xldCB4PW8qbS11KmMseT11KmwtYSptLHA9YSpjLW8qbDtmPXgqeCt5KnkrcCpwLGY+MCYmKGY9MS9NYXRoLnNxcnQoZikseCo9Zix5Kj1mLHAqPWYpLHRbMF09eCx0WzFdPXksdFsyXT1wLHRbM109MCx0WzRdPWMqcC1tKnksdFs1XT1tKngtbCpwLHRbNl09bCp5LWMqeCx0WzddPTAsdFs4XT1sLHRbOV09Yyx0WzEwXT1tLHRbMTFdPTAsdFsxMl09ZSx0WzEzXT1yLHRbMTRdPWgsdFsxNV09MX0odGhpcyx0LG4saSksdGhpc31sb29rQXRUYXJnZXQoaSxzLGUpe3JldHVybiBmdW5jdGlvbihpLHMsZSxyKXtsZXQgaCxhLG8sdSxsLGMsbSxmLHgseSxwPXNbMF0sZz1zWzFdLE09c1syXSxkPXJbMF0sej1yWzFdLHc9clsyXSxiPWVbMF0sdj1lWzFdLHE9ZVsyXTtNYXRoLmFicyhwLWIpPHQmJk1hdGguYWJzKGctdik8dCYmTWF0aC5hYnMoTS1xKTx0P24oaSk6KG09cC1iLGY9Zy12LHg9TS1xLHk9MS9NYXRoLnNxcnQobSptK2YqZit4KngpLG0qPXksZio9eSx4Kj15LGg9eip4LXcqZixhPXcqbS1kKngsbz1kKmYteiptLHk9TWF0aC5zcXJ0KGgqaCthKmErbypvKSx5Pyh5PTEveSxoKj15LGEqPXksbyo9eSk6KGg9MCxhPTAsbz0wKSx1PWYqby14KmEsbD14KmgtbSpvLGM9bSphLWYqaCx5PU1hdGguc3FydCh1KnUrbCpsK2MqYykseT8oeT0xL3ksdSo9eSxsKj15LGMqPXkpOih1PTAsbD0wLGM9MCksaVswXT1oLGlbMV09dSxpWzJdPW0saVszXT0wLGlbNF09YSxpWzVdPWwsaVs2XT1mLGlbN109MCxpWzhdPW8saVs5XT1jLGlbMTBdPXgsaVsxMV09MCxpWzEyXT0tKGgqcCthKmcrbypNKSxpWzEzXT0tKHUqcCtsKmcrYypNKSxpWzE0XT0tKG0qcCtmKmcreCpNKSxpWzE1XT0xKX0odGhpcyxpLHMsZSksdGhpc31kZXRlcm1pbmFudCgpe3JldHVybiBmdW5jdGlvbih0KXtsZXQgbj10WzBdLGk9dFsxXSxzPXRbMl0sZT10WzNdLHI9dFs0XSxoPXRbNV0sYT10WzZdLG89dFs3XSx1PXRbOF0sbD10WzldLGM9dFsxMF0sbT10WzExXSxmPXRbMTJdLHg9dFsxM10seT10WzE0XSxwPXRbMTVdO3JldHVybihuKmgtaSpyKSooYypwLW0qeSktKG4qYS1zKnIpKihsKnAtbSp4KSsobipvLWUqcikqKGwqeS1jKngpKyhpKmEtcypoKSoodSpwLW0qZiktKGkqby1lKmgpKih1KnktYypmKSsocypvLWUqYSkqKHUqeC1sKmYpfSh0aGlzKX1mcm9tQXJyYXkodCxuPTApe2Zvcih2YXIgaT0wO2k8MTY7aSsrKXRoaXNbaV09dFtpK25dO3JldHVybiB0aGlzfXRvQXJyYXkodD1bXSxuPTApe2xldCBpPXRoaXM7cmV0dXJuIHRbbl09aVswXSx0W24rMV09aVsxXSx0W24rMl09aVsyXSx0W24rM109aVszXSx0W24rNF09aVs0XSx0W24rNV09aVs1XSx0W24rNl09aVs2XSx0W24rN109aVs3XSx0W24rOF09aVs4XSx0W24rOV09aVs5XSx0W24rMTBdPWlbMTBdLHRbbisxMV09aVsxMV0sdFtuKzEyXT1pWzEyXSx0W24rMTNdPWlbMTNdLHRbbisxNF09aVsxNF0sdFtuKzE1XT1pWzE1XSx0fXN0YXRpYyBjb3B5VG8odD1bXSxuPVtdKXt0WzBdPW5bMF0sdFsxXT1uWzFdLHRbMl09blsyXSx0WzNdPW5bM10sdFs0XT1uWzRdLHRbNV09bls1XSx0WzZdPW5bNl0sdFs3XT1uWzddLHRbOF09bls4XSx0WzldPW5bOV0sdFsxMF09blsxMF0sdFsxMV09blsxMV0sdFsxMl09blsxMl0sdFsxM109blsxM10sdFsxNF09blsxNF0sdFsxNV09blsxNV19fTtjbGFzcyBsIGV4dGVuZHMgQXJyYXl7Y29uc3RydWN0b3IodD0wLG49dCxpPXQpe3JldHVybiBzdXBlcih0LG4saSksdGhpcy5jb25zdGFudD0xLHRoaXN9Z2V0IGlzVmVjdG9yMygpe3JldHVybiEwfWdldCB4KCl7cmV0dXJuIHRoaXNbMF19c2V0IHgodCl7dGhpc1swXT10fWdldCB5KCl7cmV0dXJuIHRoaXNbMV19c2V0IHkodCl7dGhpc1sxXT10fWdldCB6KCl7cmV0dXJuIHRoaXNbMl19c2V0IHoodCl7dGhpc1syXT10fXNldCh0LG49dCxpPXQpe3JldHVybiB0Lmxlbmd0aD90aGlzLmNvcHkodCk6KGZ1bmN0aW9uKHQsbixpLHMpe3RbMF09bix0WzFdPWksdFsyXT1zfSh0aGlzLHQsbixpKSx0aGlzKX1jb3B5KHQpe3ZhciBuLGk7cmV0dXJuIGk9dCwobj10aGlzKVswXT1pWzBdLG5bMV09aVsxXSxuWzJdPWlbMl0sdGhpc31hZGQodCxuKXtyZXR1cm4gbj9yKHRoaXMsdCxuKTpyKHRoaXMsdGhpcyx0KSx0aGlzfXN1Yih0LG4pe3JldHVybiBuP2godGhpcyx0LG4pOmgodGhpcyx0aGlzLHQpLHRoaXN9bXVsdGlwbHkodCl7dmFyIG4saSxzO3JldHVybiB0Lmxlbmd0aD8oaT10aGlzLHM9dCwobj10aGlzKVswXT1pWzBdKnNbMF0sblsxXT1pWzFdKnNbMV0sblsyXT1pWzJdKnNbMl0pOmEodGhpcyx0aGlzLHQpLHRoaXN9ZGl2aWRlKHQpe3ZhciBuLGkscztyZXR1cm4gdC5sZW5ndGg/KGk9dGhpcyxzPXQsKG49dGhpcylbMF09aVswXS9zWzBdLG5bMV09aVsxXS9zWzFdLG5bMl09aVsyXS9zWzJdKTphKHRoaXMsdGhpcywxL3QpLHRoaXN9c2NhbGUodCl7cmV0dXJuIGEodGhpcyx0aGlzLHQpLHRoaXN9ZGlzdGFuY2UodCl7cmV0dXJuIHQ/ZnVuY3Rpb24odCxuKXtsZXQgaT1uWzBdLXRbMF0scz1uWzFdLXRbMV0sZT1uWzJdLXRbMl07cmV0dXJuIE1hdGguc3FydChpKmkrcypzK2UqZSl9KHRoaXMsdCk6ZnVuY3Rpb24odCl7bGV0IG49dFswXSxpPXRbMV0scz10WzJdO3JldHVybiBNYXRoLnNxcnQobipuK2kqaStzKnMpfSh0aGlzKX1zcXVhcmVkRGlzdGFuY2UodCl7cmV0dXJuIHQ/ZnVuY3Rpb24odCxuKXtsZXQgaT1uWzBdLXRbMF0scz1uWzFdLXRbMV0sZT1uWzJdLXRbMl07cmV0dXJuIGkqaStzKnMrZSplfSh0aGlzLHQpOmZ1bmN0aW9uKHQpe2xldCBuPXRbMF0saT10WzFdLHM9dFsyXTtyZXR1cm4gbipuK2kqaStzKnN9KHRoaXMpfXNxdWFyZWRMZW5ndGgoKXtyZXR1cm4gdGhpcy5zcXVhcmVkRGlzdGFuY2UoKX1uZWdhdGUodD10aGlzKXt2YXIgbixpO3JldHVybiBpPXQsKG49dGhpcylbMF09LWlbMF0sblsxXT0taVsxXSxuWzJdPS1pWzJdLHRoaXN9cmVmbGVjdCh0KXtsZXQgbj10LmNsb25lKCk7cmV0dXJuIHRoaXMuc3ViKG4ubXVsdGlwbHkoMip0aGlzLmRvdCh0KSkpfWludmVyc2UodD10aGlzKXt2YXIgbixpO3JldHVybiBpPXQsKG49dGhpcylbMF09MS9pWzBdLG5bMV09MS9pWzFdLG5bMl09MS9pWzJdLHRoaXN9bm9ybWFsaXplKCl7cmV0dXJuIG8odGhpcyx0aGlzKSx0aGlzfWRvdCh0KXtyZXR1cm4gdSh0aGlzLHQpfWNyb3NzKHQsbil7cmV0dXJuIGZ1bmN0aW9uKHQsbixpKXtsZXQgcz1uWzBdLGU9blsxXSxyPW5bMl0saD1pWzBdLGE9aVsxXSxvPWlbMl07dFswXT1lKm8tciphLHRbMV09cipoLXMqbyx0WzJdPXMqYS1lKmh9KHRoaXMsdCxuKSx0aGlzfWxlcnAodCxuLGkpe3JldHVybiBmdW5jdGlvbih0LG4saSxzKXtsZXQgZT1uWzBdLHI9blsxXSxoPW5bMl07dFswXT1lK3MqKGlbMF0tZSksdFsxXT1yK3MqKGlbMV0tciksdFsyXT1oK3MqKGlbMl0taCl9KHRoaXMsdCxuLGkpLHRoaXN9aGVybWl0ZSh0LG4saSxzLGUpe3JldHVybiBmdW5jdGlvbih0LG4saSxzLGUscil7bGV0IGg9cipyLGE9aCooMipyLTMpKzEsbz1oKihyLTIpK3IsdT1oKihyLTEpLGw9aCooMy0yKnIpO3RbMF09blswXSphK2lbMF0qbytzWzBdKnUrZVswXSpsLHRbMV09blsxXSphK2lbMV0qbytzWzFdKnUrZVsxXSpsLHRbMl09blsyXSphK2lbMl0qbytzWzJdKnUrZVsyXSpsfSh0aGlzLHQsbixpLHMsZSksdGhpc31iZXppZXIodCxuLGkscyxlKXtyZXR1cm4gZnVuY3Rpb24odCxuLGkscyxlLHIpe2xldCBoPTEtcixhPWgqaCxvPXIqcix1PWEqaCxsPTMqciphLGM9MypvKmgsbT1vKnI7dFswXT1uWzBdKnUraVswXSpsK3NbMF0qYytlWzBdKm0sdFsxXT1uWzFdKnUraVsxXSpsK3NbMV0qYytlWzFdKm0sdFsyXT1uWzJdKnUraVsyXSpsK3NbMl0qYytlWzJdKm19KHRoaXMsdCxuLGkscyxlKSx0aGlzfWFwcGx5TWF0cml4NCh0KXtyZXR1cm4gZnVuY3Rpb24odCxuLGkpe2xldCBzPW5bMF0sZT1uWzFdLHI9blsyXSxoPWlbM10qcytpWzddKmUraVsxMV0qcitpWzE1XTtoPWh8fDEsdFswXT0oaVswXSpzK2lbNF0qZStpWzhdKnIraVsxMl0pL2gsdFsxXT0oaVsxXSpzK2lbNV0qZStpWzldKnIraVsxM10pL2gsdFsyXT0oaVsyXSpzK2lbNl0qZStpWzEwXSpyK2lbMTRdKS9ofSh0aGlzLHRoaXMsdCksdGhpc31hcHBseU1hdHJpeDModCl7cmV0dXJuIGZ1bmN0aW9uKHQsbixpKXtsZXQgcz1uWzBdLGU9blsxXSxyPW5bMl07dFswXT1zKmlbMF0rZSppWzNdK3IqaVs2XSx0WzFdPXMqaVsxXStlKmlbNF0rcippWzddLHRbMl09cyppWzJdK2UqaVs1XStyKmlbOF19KHRoaXMsdGhpcyx0KSx0aGlzfWFwcGx5UXVhdGVybmlvbih0KXtyZXR1cm4gZnVuY3Rpb24odCxuLGkpe2xldCBzPW5bMF0sZT1uWzFdLHI9blsyXSxoPWlbMF0sYT1pWzFdLG89aVsyXSx1PWlbM10sbD11KnMrYSpyLW8qZSxjPXUqZStvKnMtaCpyLG09dSpyK2gqZS1hKnMsZj0taCpzLWEqZS1vKnI7dFswXT1sKnUrZiotaCtjKi1vLW0qLWEsdFsxXT1jKnUrZiotYSttKi1oLWwqLW8sdFsyXT1tKnUrZiotbytsKi1hLWMqLWh9KHRoaXMsdGhpcyx0KSx0aGlzfXNldEZyb21NYXRyaXhQb3NpdGlvbih0KXtyZXR1cm4gdGhpcy54PXRbMTJdLHRoaXMueT10WzEzXSx0aGlzLno9dFsxNF0sdGhpc31hbmdsZSh0KXtyZXR1cm4gZnVuY3Rpb24odCxuKXtsZXQgaT1bLi4udF0scz1bLi4ubl07byhpLGkpLG8ocyxzKTtsZXQgZT11KGkscyk7cmV0dXJuIGU+MT8wOmU8LTE/TWF0aC5QSTpNYXRoLmFjb3MoZSl9KHRoaXMsdCl9ZXF1YWxzKHQpe3JldHVybiBpPXQsKG49dGhpcylbMF09PT1pWzBdJiZuWzFdPT09aVsxXSYmblsyXT09PWlbMl07dmFyIG4saX1jbG9uZSgpe3JldHVybiBuZXcgbCh0aGlzWzBdLHRoaXNbMV0sdGhpc1syXSl9ZnJvbUFycmF5KHQsbj0wKXtyZXR1cm4gdGhpc1swXT10W25dLHRoaXNbMV09dFtuKzFdLHRoaXNbMl09dFtuKzJdLHRoaXN9bWluKHQpe3JldHVybiB0aGlzWzBdPU1hdGgubWluKHRoaXNbMF0sdC54KSx0aGlzWzFdPU1hdGgubWluKHRoaXNbMV0sdC55KSx0aGlzWzJdPU1hdGgubWluKHRoaXNbMl0sdC56KSx0aGlzfW1heCh0KXtyZXR1cm4gdGhpc1swXT1NYXRoLm1heCh0aGlzWzBdLHQueCksdGhpc1sxXT1NYXRoLm1heCh0aGlzWzFdLHQueSksdGhpc1syXT1NYXRoLm1heCh0aGlzWzJdLHQueiksdGhpc310b0FycmF5KCl7cmV0dXJuIEFycmF5LmZyb20odGhpcyl9c3RhdGljIGNvcHlUbyh0LG4pe3RbMF09blswXSx0WzFdPW5bMV0sdFsyXT1uWzJdfX1jb25zdCBjPVtuZXcgbCxuZXcgbCxuZXcgbCxuZXcgbCxuZXcgbCxuZXcgbCxuZXcgbCxuZXcgbF07Y2xhc3MgbXtjb25zdHJ1Y3Rvcih0PW5ldyBsKDEvMCksbj1uZXcgbCgtMS8wKSl7dGhpcy5taW49dCx0aGlzLm1heD1ufW1ha2VFbXB0eSgpe3JldHVybiB0aGlzLm1pbi54PXRoaXMubWluLnk9dGhpcy5taW4uej0xLzAsdGhpcy5tYXgueD10aGlzLm1heC55PXRoaXMubWF4Lno9LTEvMCx0aGlzfWlzRW1wdHkoKXtyZXR1cm4gdGhpcy5tYXgueDx0aGlzLm1pbi54fHx0aGlzLm1heC55PHRoaXMubWluLnl8fHRoaXMubWF4Lno8dGhpcy5taW4uen1nZXRDZW50ZXIodCl7cmV0dXJuIHRoaXMuaXNFbXB0eSgpP3Quc2V0KDAsMCwwKTp0LmFkZCh0aGlzLm1pbix0aGlzLm1heCkubXVsdGlwbHkoLjUpfWdldFNpemUodCl7cmV0dXJuIHRoaXMuaXNFbXB0eSgpP3Quc2V0KDAsMCwwKTp0LnN1Yih0aGlzLm1heCx0aGlzLm1pbil9ZXhwYW5kQnlQb2ludCh0KXtyZXR1cm4gdGhpcy5taW4ubWluKHQpLHRoaXMubWF4Lm1heCh0KSx0aGlzfXVuaW9uKHQpe3JldHVybiB0aGlzLm1pbi5taW4odC5taW4pLHRoaXMubWF4Lm1heCh0Lm1heCksdGhpc31jb3B5KHQpe3JldHVybiB0aGlzLm1pbi5jb3B5KHQubWluKSx0aGlzLm1heC5jb3B5KHQubWF4KSx0aGlzfWludGVyc2VjdHNCb3godCl7cmV0dXJuISh0Lm1heC54PHRoaXMubWluLnh8fHQubWluLng+dGhpcy5tYXgueHx8dC5tYXgueTx0aGlzLm1pbi55fHx0Lm1pbi55PnRoaXMubWF4Lnl8fHQubWF4Lno8dGhpcy5taW4uenx8dC5taW4uej50aGlzLm1heC56KX1zZXRGcm9tUG9pbnRzKHQpe3RoaXMubWFrZUVtcHR5KCk7Zm9yKGxldCBuPTAsaT10Lmxlbmd0aDtuPGk7bisrKXRoaXMuZXhwYW5kQnlQb2ludCh0W25dKTtyZXR1cm4gdGhpc31hcHBseU1hdHJpeDQodCl7cmV0dXJuIHRoaXMuaXNFbXB0eSgpfHwoY1swXS5zZXQodGhpcy5taW4ueCx0aGlzLm1pbi55LHRoaXMubWluLnopLmFwcGx5TWF0cml4NCh0KSxjWzFdLnNldCh0aGlzLm1pbi54LHRoaXMubWluLnksdGhpcy5tYXgueikuYXBwbHlNYXRyaXg0KHQpLGNbMl0uc2V0KHRoaXMubWluLngsdGhpcy5tYXgueSx0aGlzLm1pbi56KS5hcHBseU1hdHJpeDQodCksY1szXS5zZXQodGhpcy5taW4ueCx0aGlzLm1heC55LHRoaXMubWF4LnopLmFwcGx5TWF0cml4NCh0KSxjWzRdLnNldCh0aGlzLm1heC54LHRoaXMubWluLnksdGhpcy5taW4ueikuYXBwbHlNYXRyaXg0KHQpLGNbNV0uc2V0KHRoaXMubWF4LngsdGhpcy5taW4ueSx0aGlzLm1heC56KS5hcHBseU1hdHJpeDQodCksY1s2XS5zZXQodGhpcy5tYXgueCx0aGlzLm1heC55LHRoaXMubWluLnopLmFwcGx5TWF0cml4NCh0KSxjWzddLnNldCh0aGlzLm1heC54LHRoaXMubWF4LnksdGhpcy5tYXgueikuYXBwbHlNYXRyaXg0KHQpLHRoaXMuc2V0RnJvbVBvaW50cyhjKSksdGhpc319ZnVuY3Rpb24gZih0LG4saT0wLHM9dC5sZW5ndGgsZT1NYXRoLmZsb29yKChpK3MpLzIpKXtmb3IobGV0IHI9aTtyPD1lO3IrKyl7bGV0IGk9cixlPXRbcl07Zm9yKGxldCBoPXIrMTtoPHM7aCsrKW4oZSx0W2hdKXx8KGk9aCxlPXRbaF0seCh0LHIsaSkpfX1mdW5jdGlvbiB4KHQsbixpKXtjb25zdCBzPXRbaV07dFtpXT10W25dLHRbbl09c31sZXQgeSxwPTAsZz0wLE09MCxkPSExO2NvbnN0IHo9bmV3IGw7ZnVuY3Rpb24gdyh0LG4pe3JldHVybntwcmltaXRpdmVzOnQsYm91bmRzOm59fWZ1bmN0aW9uIGIodCxuLGkpe2xldCBzPWlbbl0tdC5taW5bbl07cmV0dXJuIHQubWF4W25dPnQubWluW25dJiYocy89dC5tYXhbbl0tdC5taW5bbl0pLHN9ZnVuY3Rpb24gdih0KXtyZXR1cm4gdC5nZXRTaXplKHopLDIqKHoueCp6Lnorei54KnoueSt6Lnoqei55KX1mdW5jdGlvbiBxKHQsbixpLHM9ITEpe2NvbnN0IGU9bmV3IG07Zm9yKGxldCB1PW47dTxpO3UrKyllLnVuaW9uKHRbdV0uYm91bmRzKTtpZihkKXtNKz0xLHkoKE0rZykvcCl9Y29uc3Qgcj1pLW47aWYoMT09PXIpcmV0dXJuIHcodC5zbGljZShuLGkpLGUpO3tjb25zdCB1PW5ldyBtO2ZvcihsZXQgcz1uO3M8aTtzKyspdS5leHBhbmRCeVBvaW50KHRbc10uY2VudGVyKTtjb25zdCBsPSh1LmdldFNpemUoeiksei54Pnouej96Lng+ei55PyJ4IjoieSI6ei56PnoueT8ieiI6InkiKTtsZXQgYz1NYXRoLmZsb29yKChuK2kpLzIpO2lmKHI8PTQpZih0LCgodCxuKT0+dC5jZW50ZXJbbF08bi5jZW50ZXJbbF0pLG4saSxjKTtlbHNlIGlmKHUubWF4W2xdPT09dS5taW5bbF0pe2lmKCFzKXJldHVybiB3KHQuc2xpY2UobixpKSxlKTtmKHQsKCh0LG4pPT50LmNlbnRlcltsXTxuLmNlbnRlcltsXSksbixpLGMpfWVsc2V7Y29uc3Qgcz0xMixyPVtdO2ZvcihsZXQgdD0wO3Q8czt0Kyspci5wdXNoKHtib3VuZHM6bmV3IG0sY291bnQ6MH0pO2ZvcihsZXQgZT1uO2U8aTtlKyspe2xldCBuPU1hdGguZmxvb3IocypiKHUsbCx0W2VdLmNlbnRlcikpO249PT1yLmxlbmd0aCYmKG49ci5sZW5ndGgtMSkscltuXS5jb3VudCsrLHJbbl0uYm91bmRzLnVuaW9uKHRbZV0uYm91bmRzKX1jb25zdCBoPVtdO2ZvcihsZXQgdD0wO3Q8ci5sZW5ndGgtMTt0Kyspe2NvbnN0IG49bmV3IG0saT1uZXcgbTtsZXQgcz0wLGE9MDtmb3IobGV0IGU9MDtlPD10O2UrKyluLnVuaW9uKHJbZV0uYm91bmRzKSxzKz1yW2VdLmNvdW50O2ZvcihsZXQgZT10KzE7ZTxyLmxlbmd0aDtlKyspaS51bmlvbihyW2VdLmJvdW5kcyksYSs9cltlXS5jb3VudDtoLnB1c2goLjErKHMqdihuKSthKnYoaSkpL3YoZSkpfWxldCBhPWhbMF0sbz0wO2ZvcihsZXQgdD0xO3Q8aC5sZW5ndGg7dCsrKWhbdF08YSYmKGE9aFt0XSxvPXQpO2M9ZnVuY3Rpb24odCxuLGk9MCxzPXQubGVuZ3RoKXtmb3IoO2khPT1zOyl7Zm9yKDtuKHRbaV0pOylpZigrK2k9PT1zKXJldHVybiBpO2Rve2lmKGk9PT0tLXMpcmV0dXJuIGl9d2hpbGUoIW4odFtzXSkpO3godCxpLHMpLGkrK31yZXR1cm4gaX0odCwodD0+e2xldCBuPU1hdGguZmxvb3Ioci5sZW5ndGgqYih1LGwsdC5jZW50ZXIpKTtyZXR1cm4gbj09PXIubGVuZ3RoJiYobj1yLmxlbmd0aC0xKSxuPD1vfSksbixpKX1yZXR1cm4gaD1sLGE9cSh0LG4sYyxzKSxvPXEodCxjLGkscykse2NoaWxkMDphLGNoaWxkMTpvLGJvdW5kczoobmV3IG0pLnVuaW9uKGEuYm91bmRzKS51bmlvbihvLmJvdW5kcyksc3BsaXRBeGlzOmh9fXZhciBoLGEsb31mdW5jdGlvbiBBKHQsbil7Y29uc3R7cHJpbWl0aXZlSW5mb0FycjppfT1mdW5jdGlvbih0KXtsZXQgbj0wO2NvbnN0IGk9W107Zm9yKGxldCBzPTA7czx0Lmxlbmd0aDtzKyspe2NvbnN0IGU9W10scj10W3NdLGg9ci5pbmRpY2VzLGE9ci5wb3NpdGlvbixvPXIubWF0ZXJpYWxNZXNoSW5kZXgsdT1uZXcgbCxjPW5ldyBsLGY9bmV3IGwseD1uZXcgbCx5PW5ldyBsO2ZvcihsZXQgdD0wO3Q8aC5hcnJheS5sZW5ndGg7dCs9Myl7Y29uc3QgaT1oLmFycmF5W3RdLHM9aC5hcnJheVt0KzFdLHI9aC5hcnJheVt0KzJdLHA9bmV3IG0sZz0zLE09aSpnO3UueD1hLmFycmF5W01dLHUueT1hLmFycmF5W00rMV0sdS56PWEuYXJyYXlbTSsyXTtjb25zdCBkPXMqZztjLng9YS5hcnJheVtkXSxjLnk9YS5hcnJheVtkKzFdLGMuej1hLmFycmF5W2QrMl07Y29uc3Qgej1yKmc7Zi54PWEuYXJyYXlbel0sZi55PWEuYXJyYXlbeisxXSxmLno9YS5hcnJheVt6KzJdLHAuZXhwYW5kQnlQb2ludCh1KSxwLmV4cGFuZEJ5UG9pbnQoYykscC5leHBhbmRCeVBvaW50KGYpLHguc3ViKGYsdSkseS5zdWIoYyx1KTtjb25zdCB3PShuZXcgbCkuY3Jvc3MoeSx4KS5ub3JtYWxpemUoKSxiPXtib3VuZHM6cCxjZW50ZXI6cC5nZXRDZW50ZXIobmV3IGwpLGluZGljZXM6W2krbixzK24scituXSxmYWNlTm9ybWFsOncsbWF0ZXJpYWxJRDpvJiZvLmFycmF5W2kqby5pdGVtU2l6ZV19O2UucHVzaChiKX1uKz1yLnBvc2l0aW9uLmFycmF5Lmxlbmd0aC8zLGkucHVzaChlKX1yZXR1cm57cHJpbWl0aXZlSW5mb0FycjppfX0odCkscz1bXTtpZihuKXtwPTAsZz0wLGQ9ITAseT1uO2ZvcihsZXQgdD0wO3Q8aS5sZW5ndGg7dCsrKXArPTIqaVt0XS5sZW5ndGgtMX1mb3IobGV0IGU9MDtlPGkubGVuZ3RoO2UrKyl7Y29uc3QgdD1pW2VdO009MDtjb25zdCBuPXEodCwwLHQubGVuZ3RoKTtnKz0yKnQubGVuZ3RoLTEscy5wdXNoKG4pfXJldHVybntibGFzQlZIczpzfX1mdW5jdGlvbiBCKHQsbj0wLGk9W10pe2NvbnN0IHM9W107bGV0IGU9MTtjb25zdCByPXt4OjAseToxLHo6Mn0saD0odCxhPTEpPT57aWYoZT1NYXRoLm1heChhLGUpLHQucHJpbWl0aXZlcyl7Y29uc3Qgbj10O2ZvcihsZXQgdD0wO3Q8bi5wcmltaXRpdmVzLmxlbmd0aDt0Kyspe2NvbnN0IGU9bi5wcmltaXRpdmVzW3RdO2lmKHZvaWQgMCE9PWUuaW5kaWNlcyl7Y29uc3QgdD1lO3MucHVzaCh0LmluZGljZXNbMF0sdC5pbmRpY2VzWzFdLHQuaW5kaWNlc1syXSwtMSx0LmZhY2VOb3JtYWwueCx0LmZhY2VOb3JtYWwueSx0LmZhY2VOb3JtYWwueix0Lm1hdGVyaWFsSUR8fDApfWVsc2V7Y29uc3QgdD1lO3MucHVzaChpW3QuZ2VvbWV0cnlJRF0sdC5tYXRlcmlhbElELHQubWVzaElELC0xLE51bWJlcih0LnZpc2libGUpLDAsMCwwKX19fWVsc2V7Y29uc3QgaT10LGU9aS5ib3VuZHM7cy5wdXNoKGUubWluLngsZS5taW4ueSxlLm1pbi56LHJbaS5zcGxpdEF4aXNdLGUubWF4LngsZS5tYXgueSxlLm1heC56LC0xKTtjb25zdCBvPXMubGVuZ3RoLTE7aChpLmNoaWxkMCxhKzEpLHNbb109cy5sZW5ndGgvNCtuLGgoaS5jaGlsZDEsYSsxKX19O3JldHVybiBoKHQpLHtjb3VudDpzLmxlbmd0aC80LG1heERlcHRoOmUsZmxhdERhdGE6c319c2VsZi5vbm1lc3NhZ2U9ZnVuY3Rpb24oe2RhdGE6dH0pe2NvbnN0e2dlb21ldHJpZXM6bn09dDtsZXQgaT1wZXJmb3JtYW5jZS5ub3coKTtjb25zdCBzPXQ9Pntjb25zdCBuPXBlcmZvcm1hbmNlLm5vdygpOyhuLWk+PTEwfHwxPT09dCkmJihpPW4sc2VsZi5wb3N0TWVzc2FnZSh7ZXJyb3I6bnVsbCxmbGF0QkxBU0JWSEluZm86bnVsbCxwcm9ncmVzczp0fSkpfTt0cnl7Y29uc3R7Ymxhc0JWSHM6dH09QShuLHMpLGk9ZnVuY3Rpb24odCxuPTApe2NvbnN0IGk9W107bGV0IHM9W10sZT0xO2ZvcihsZXQgcj0wO3I8dC5sZW5ndGg7cisrKXtjb25zdCBoPUIodFtyXSxuKTtlPU1hdGgubWF4KGgubWF4RGVwdGgsZSkscy5wdXNoKG4pLG4rPWguY291bnQsaS5wdXNoKGgpfXJldHVybntibGFzQnVmZmVyU3BsaXRJbmRleDpzLHRvdGFsQkxBU0RhdGFMZW5ndGg6NCpuLHRvdGFsQkxBU0RhdGFDb3VudDpuLGZsYXRCVkhJbmZvczppLG1heERlcHRoOmV9fSh0KTtzZWxmLnBvc3RNZXNzYWdlKHtlcnJvcjpudWxsLGZsYXRCTEFTQlZISW5mbzppLHByb2dyZXNzOm51bGx9KX1jYXRjaChlKXtzZWxmLnBvc3RNZXNzYWdlKHtlcnJvcjplLGZsYXRCTEFTQlZISW5mbzpudWxsLHByb2dyZXNzOm51bGx9KX19fSgpOwo=",$e=typeof window<"u"&&window.Blob&&new Blob([atob(_t)],{type:"text/javascript;charset=utf-8"});function qt(){const s=$e&&(window.URL||window.webkitURL).createObjectURL($e);try{return s?new Worker(s,{}):new Worker("data:application/javascript;base64,"+_t,{type:"module"})}finally{s&&(window.URL||window.webkitURL).revokeObjectURL(s)}}class jt{constructor(){this.worker=new qt,this.building=!1}build(e,t){if(this.building)throw new Error("BVHWorker is building");this.building=!0;const{worker:a}=this;return new Promise((i,n)=>{a.onmessage=r=>{this.building=!1;const{flatBLASBVHInfo:l,error:o,progress:u}=r.data;o?n(new Error(o)):l?(a.onmessage=null,i(l)):u!=null&&t(u)},Array.isArray(e)||(e=[e]),a.postMessage({geometries:e})})}}function et(s){const e=new Float32Array(16*s.length);for(let t=0;t<s.length;t++){const a=s[t].localToWorldMat;for(let i=0;i<16;i++)e[16*t+i]=a[i]}return e}class St{constructor(e,t){this.gl=e,this.useWebWorker=t,this.workerBuilder=new jt}rebuildTLAS(e,t=!1){const{gl:a,geometryIndexMap:i}=this;let{meshes:n,materialIndexMap:r}=e;n=n.filter(h=>!h.tlasMask);const l=je(Qe(n,i,r),this.lastFlatBLASBVHInfo.blasBufferSplitIndex),o=l.flatData.length,u=new Float32Array(o);u.set(l.flatData,0);const c=new U(a,u,4),d=et(n);return{tlasBuffer:c,transformBuffer:new U(a,d,4)}}async buildDynamic(e,t,a,i,n){const{gl:r,useWebWorker:l}=this;this.geometryIndexMap=t;let{meshes:o,materialIndexMap:u}=e;const c=Array.from(t.keys()),d=[];if(c.forEach((P,R)=>{d[R]={};const X=d[R];X.position=P.position,X.indices=P.indices}),l)this.lastFlatBLASBVHInfo=await this.workerBuilder.build(d,n);else{const{blasBVHs:P}=qe(d);this.lastFlatBLASBVHInfo=Je(P)}o=o.filter(P=>!P.tlasMask);const h=je(Qe(o,t,u),this.lastFlatBLASBVHInfo.blasBufferSplitIndex),L=this.lastFlatBLASBVHInfo.totalBLASDataLength,f=new Float32Array(L),p=this.lastFlatBLASBVHInfo.flatBVHInfos;let x=0;for(let P=0;P<p.length;P++){const R=p[P].flatData;f.set(R,x),x+=R.length}const m=new U(r,f,4),v=h.flatData.length,A=new Float32Array(v);A.set(h.flatData,0);const T=new U(r,A,4),_=new Float32Array(4*a),S=new Float32Array(4*a);let b=0;c.forEach(P=>{const R=P.position.array,X=P.normal.array,N=P.uv.array,I=P.position.count;for(let g=0;g<I;g++)_[b+4*g+0]=R[3*g+0],_[b+4*g+1]=R[3*g+1],_[b+4*g+2]=R[3*g+2],_[b+4*g+3]=N?N[2*g+0]:0,S[b+4*g+0]=X[3*g+0],S[b+4*g+1]=X[3*g+1],S[b+4*g+2]=X[3*g+2],S[b+4*g+3]=N?N[2*g+1]:0;b+=4*I});const F=new U(r,_,4),G=new U(r,S,4),M=et(o);return{positionBuffer:F,normalBuffer:G,blasBuffer:m,tlasBuffer:T,transformBuffer:new U(r,M,4),maxDepth:this.lastFlatBLASBVHInfo.maxDepth+h.maxDepth}}async buildStatic(e,t){const{gl:a,useWebWorker:i}=this,{geometry:n}=e;if(i)this.lastFlatBLASBVHInfo=await this.workerBuilder.build([n],t);else{const{blasBVHs:p}=qe([n]);this.lastFlatBLASBVHInfo=Je(p)}const r=this.lastFlatBLASBVHInfo.flatBVHInfos[0],l=new Float32Array(r.flatData),o=new U(a,l,4),u=n.position.count,c=new Float32Array(4*u),d=new Float32Array(4*u),h=n.position.array,L=n.normal.array,f=n.uv.array;for(let p=0;p<u;p++)c[4*p+0]=h[3*p+0],c[4*p+1]=h[3*p+1],c[4*p+2]=h[3*p+2],c[4*p+3]=f?f[2*p+0]:0,d[4*p+0]=L[3*p+0],d[4*p+1]=L[3*p+1],d[4*p+2]=L[3*p+2],d[4*p+3]=f?f[2*p+1]:0;return{positionBuffer:new U(a,c,4),normalBuffer:new U(a,d,4),bvhBuffer:o,maxDepth:r.maxDepth}}}class Jt{constructor(e,t,a=!0){this.gl=e,this.resourcePool=t,this.useWebWorker=a,this.bvhBuilder=new St(e,a)}destroy(){const{resourcePool:e}=this;e.destoryResourceByName("MaterialBuffer"),e.destoryResourceByName("PositionBuffer"),e.destoryResourceByName("NormalBuffer"),e.destoryResourceByName("BVHBuffer"),e.destoryResourceByName("MaterialTextureArray")}async buildBVH(e,t,a){const{resourcePool:i}=this,{maxDepth:n,positionBuffer:r,normalBuffer:l,bvhBuffer:o}=await this.bvhBuilder.buildStatic(t,a);i.setResource("PositionBuffer",r),i.setResource("NormalBuffer",l),i.setResource("BVHBuffer",o),e.bvhDefines={STACK_SIZE:n,BVH_COLUMNS:o.textureDim.columnsLog,VERTEX_COLUMNS:r.textureDim.columnsLog}}async build(e,t){let{meshes:a,materialIndexMap:i,materials:n}=e;this.destroy(),a=a.filter(L=>L.visible==1);const r=ut(a,!0);e.geometryInfo=r;const l=Zt(a,i,r),{materialDefines:o,textureArrayRes:u,materialBuffer:c}=await mt(this.gl,n,!1);e.mergedMesh=l,this.resourcePool.setResource("MaterialBuffer",c,"Buffer"),this.resourcePool.setResource("MaterialTextureArray",u);const{uvTransDefines:d,uvTransformBufferTex:h}=xt(this.gl,i);this.resourcePool.setResource("TextureUVTransformBuffer",h),this.lastMaterialBuffer=c,e.materialDefines=o,await this.buildBVH(e,l,t),Object.assign(e.bvhDefines,d)}updateMaterialParams(e){const{lastMaterialBuffer:t}=this,{materials:a}=e;Lt(t,a)}async rebuildMaterialBuffer(e){const{materials:t}=e,{textureArrayRes:a}=await pt(this.gl,this.lastMaterialBuffer,t);this.resourcePool.setResource("MaterialTextureArray",a)}}class $t{constructor(e,t,a=!0){this.gl=e,this.resourcePool=t,this.useWebWorker=a,this.bvhBuilder=new St(e,a)}destroy(){const{resourcePool:e}=this;e.destoryResourceByName("MaterialBuffer"),e.destoryResourceByName("MaterialTextureArray"),e.destoryResourceByName("PositionBuffer"),e.destoryResourceByName("NormalBuffer"),e.destoryResourceByName("TLASBuffer"),e.destoryResourceByName("BLASBuffer"),e.destoryResourceByName("TLASTransformBuffer")}async buildBVH(e,t){const{resourcePool:a}=this,{geometryIndexMap:i,vertexTotalCount:n,indicesTotalCount:r}=e.geometryInfo,{positionBuffer:l,normalBuffer:o,blasBuffer:u,tlasBuffer:c,transformBuffer:d,maxDepth:h}=await this.bvhBuilder.buildDynamic(e,i,n,r,t);a.setResource("PositionBuffer",l),a.setResource("NormalBuffer",o),a.setResource("TLASBuffer",c),a.setResource("TLASTransformBuffer",d),a.setResource("BLASBuffer",u),e.bvhDefines={BVH_DYNAMIC:1,STACK_SIZE:32,BLAS_COLUMNS:u.textureDim.columnsLog,TLAS_COLUMNS:c.textureDim.columnsLog,TLAS_TRANSFORM_COLUMNS:d.textureDim.columnsLog,VERTEX_COLUMNS:l.textureDim.columnsLog}}async build(e,t){let{meshes:a,materials:i,materialIndexMap:n}=e;const r=ut(a,!1);e.geometryInfo=r;const{materialDefines:l,textureImageMap:o,textureArrayRes:u,materialBuffer:c}=await mt(this.gl,i,!0);this.resourcePool.setResource("MaterialBuffer",c,"Buffer"),this.resourcePool.setResource("MaterialTextureArray",u),e.materialDefines=l;const{uvTransDefines:d,uvTransformBufferTex:h}=xt(this.gl,n);this.resourcePool.setResource("TextureUVTransformBuffer",h),this.lastMaterialBuffer=c,await this.buildBVH(e,t),Object.assign(e.bvhDefines,d)}updateMaterialParams(e){const{materials:t}=e;Lt(this.lastMaterialBuffer,t)}rebuildTLAS(e,t=!1){const{tlasBuffer:a,transformBuffer:i}=this.bvhBuilder.rebuildTLAS(e,t);this.resourcePool.updateResource("TLASBuffer",a,"Buffer"),this.resourcePool.updateResource("TLASTransformBuffer",i,"Buffer")}async rebuildMaterialBuffer(e){const{materials:t}=e,{textureArrayRes:a}=await pt(this.gl,this.lastMaterialBuffer,t);this.resourcePool.setResource("MaterialTextureArray",a)}}class ea{constructor(e){this.gl=e,this.curTileNum=-1,this.totalTileNum=-1,this.columns=0,this.rows=0,this.tileWidth=0,this.tileHeight=0,this.viewWidth=0,this.viewHeight=0}reset(){this.curTileNum=-1}setSize(e,t){this.viewWidth=e,this.viewHeight=t,this.computeTileDimensions()}setTileCount(e){this.totalTileNum=e,this.computeTileDimensions(),this.reset()}computeTileDimensions(){const{viewWidth:e,viewHeight:t}=this,a=Math.sqrt(this.totalTileNum);this.tileWidth=Math.ceil(e/a),this.tileHeight=Math.ceil(t/a),this.columns=Math.ceil(e/this.tileWidth),this.rows=Math.ceil(t/this.tileHeight),this.columns&&this.rows&&(this.totalTileNum=this.columns*this.rows)}nextTile(){const{totalTileNum:e,tileWidth:t,tileHeight:a,viewHeight:i,columns:n,rows:r}=this;this.curTileNum++,this.curTileNum%e==0&&(this.curTileNum=0);const l=this.curTileNum===e-1,o=this.curTileNum%n,u=Math.floor(this.curTileNum/n)%r;return{x:o*t,y:Math.min(i,u*a),tileWidth:t,tileHeight:a,isFirstTile:this.curTileNum===0,isLastTile:l}}}class ta{constructor(e,t){this.gl=e,this.fullscreenTriangle=t}createPipeline(e){const{gl:t,fullscreenTriangle:a}=this,i={gl:t,vertex:a.vertexShader,fragment:`layout(location=0)out vec4 out_color;uniform sampler2D inputBuffer;uniform vec2 resolution;in vec2 vCoord;
#define FXAA_PC 1
#define FXAA_GLSL_100 1
#define FXAA_QUALITY_PRESET 12
#define FXAA_GREEN_AS_LUMA 1
#ifndef FXAA_PC_CONSOLE
#define FXAA_PC_CONSOLE 0
#endif
#ifndef FXAA_GLSL_120
#define FXAA_GLSL_120 0
#endif
#ifndef FXAA_GLSL_130
#define FXAA_GLSL_130 0
#endif
#ifndef FXAA_HLSL_3
#define FXAA_HLSL_3 0
#endif
#ifndef FXAA_HLSL_4
#define FXAA_HLSL_4 0
#endif
#ifndef FXAA_HLSL_5
#define FXAA_HLSL_5 0
#endif
#ifndef FXAA_GREEN_AS_LUMA
#define FXAA_GREEN_AS_LUMA 0
#endif
#ifndef FXAA_EARLY_EXIT
#define FXAA_EARLY_EXIT 1
#endif
#ifndef FXAA_DISCARD
#define FXAA_DISCARD 0
#endif
#ifndef FXAA_FAST_PIXEL_OFFSET
#ifdef GL_EXT_gpu_shader4
#define FXAA_FAST_PIXEL_OFFSET 1
#endif
#ifdef GL_NV_gpu_shader5
#define FXAA_FAST_PIXEL_OFFSET 1
#endif
#ifdef GL_ARB_gpu_shader5
#define FXAA_FAST_PIXEL_OFFSET 1
#endif
#ifndef FXAA_FAST_PIXEL_OFFSET
#define FXAA_FAST_PIXEL_OFFSET 0
#endif
#endif
#ifndef FXAA_GATHER4_ALPHA
#if (FXAA_HLSL_5 == 1)
#define FXAA_GATHER4_ALPHA 1
#endif
#ifdef GL_ARB_gpu_shader5
#define FXAA_GATHER4_ALPHA 1
#endif
#ifdef GL_NV_gpu_shader5
#define FXAA_GATHER4_ALPHA 1
#endif
#ifndef FXAA_GATHER4_ALPHA
#define FXAA_GATHER4_ALPHA 0
#endif
#endif
/*============================================================================FXAA QUALITY-TUNING KNOBS------------------------------------------------------------------------------NOTE the other tuning knobs are now in the shader function inputs!============================================================================*/
#ifndef FXAA_QUALITY_PRESET
#define FXAA_QUALITY_PRESET 12
#endif
/*============================================================================FXAA QUALITY-PRESETS============================================================================*//*============================================================================FXAA QUALITY-MEDIUM DITHER PRESETS============================================================================*/
#if (FXAA_QUALITY_PRESET == 10)
#define FXAA_QUALITY_PS 3
#define FXAA_QUALITY_P0 1.5
#define FXAA_QUALITY_P1 3.0
#define FXAA_QUALITY_P2 12.0
#endif
#if (FXAA_QUALITY_PRESET == 11)
#define FXAA_QUALITY_PS 4
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 3.0
#define FXAA_QUALITY_P3 12.0
#endif
#if (FXAA_QUALITY_PRESET == 12)
#define FXAA_QUALITY_PS 5
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 4.0
#define FXAA_QUALITY_P4 12.0
#endif
#if (FXAA_QUALITY_PRESET == 13)
#define FXAA_QUALITY_PS 6
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 4.0
#define FXAA_QUALITY_P5 12.0
#endif
#if (FXAA_QUALITY_PRESET == 14)
#define FXAA_QUALITY_PS 7
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 4.0
#define FXAA_QUALITY_P6 12.0
#endif
#if (FXAA_QUALITY_PRESET == 15)
#define FXAA_QUALITY_PS 8
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 4.0
#define FXAA_QUALITY_P7 12.0
#endif
/*============================================================================FXAA QUALITY-LOW DITHER PRESETS============================================================================*/
#if (FXAA_QUALITY_PRESET == 20)
#define FXAA_QUALITY_PS 3
#define FXAA_QUALITY_P0 1.5
#define FXAA_QUALITY_P1 2.0
#define FXAA_QUALITY_P2 8.0
#endif
#if (FXAA_QUALITY_PRESET == 21)
#define FXAA_QUALITY_PS 4
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 8.0
#endif
#if (FXAA_QUALITY_PRESET == 22)
#define FXAA_QUALITY_PS 5
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 8.0
#endif
#if (FXAA_QUALITY_PRESET == 23)
#define FXAA_QUALITY_PS 6
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 8.0
#endif
#if (FXAA_QUALITY_PRESET == 24)
#define FXAA_QUALITY_PS 7
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 3.0
#define FXAA_QUALITY_P6 8.0
#endif
#if (FXAA_QUALITY_PRESET == 25)
#define FXAA_QUALITY_PS 8
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 4.0
#define FXAA_QUALITY_P7 8.0
#endif
#if (FXAA_QUALITY_PRESET == 26)
#define FXAA_QUALITY_PS 9
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 2.0
#define FXAA_QUALITY_P7 4.0
#define FXAA_QUALITY_P8 8.0
#endif
#if (FXAA_QUALITY_PRESET == 27)
#define FXAA_QUALITY_PS 10
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 2.0
#define FXAA_QUALITY_P7 2.0
#define FXAA_QUALITY_P8 4.0
#define FXAA_QUALITY_P9 8.0
#endif
#if (FXAA_QUALITY_PRESET == 28)
#define FXAA_QUALITY_PS 11
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 2.0
#define FXAA_QUALITY_P7 2.0
#define FXAA_QUALITY_P8 2.0
#define FXAA_QUALITY_P9 4.0
#define FXAA_QUALITY_P10 8.0
#endif
#if (FXAA_QUALITY_PRESET == 29)
#define FXAA_QUALITY_PS 12
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 2.0
#define FXAA_QUALITY_P7 2.0
#define FXAA_QUALITY_P8 2.0
#define FXAA_QUALITY_P9 2.0
#define FXAA_QUALITY_P10 4.0
#define FXAA_QUALITY_P11 8.0
#endif
/*============================================================================FXAA QUALITY-EXTREME QUALITY============================================================================*/
#if (FXAA_QUALITY_PRESET == 39)
#define FXAA_QUALITY_PS 12
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.0
#define FXAA_QUALITY_P2 1.0
#define FXAA_QUALITY_P3 1.0
#define FXAA_QUALITY_P4 1.0
#define FXAA_QUALITY_P5 1.5
#define FXAA_QUALITY_P6 2.0
#define FXAA_QUALITY_P7 2.0
#define FXAA_QUALITY_P8 2.0
#define FXAA_QUALITY_P9 2.0
#define FXAA_QUALITY_P10 4.0
#define FXAA_QUALITY_P11 8.0
#endif
/*============================================================================API PORTING============================================================================*/
#if (FXAA_GLSL_100 == 1) || (FXAA_GLSL_120 == 1) || (FXAA_GLSL_130 == 1)
#define FxaaBool bool
#define FxaaDiscard discard
#define FxaaFloat float
#define FxaaFloat2 vec2
#define FxaaFloat3 vec3
#define FxaaFloat4 vec4
#define FxaaHalf float
#define FxaaHalf2 vec2
#define FxaaHalf3 vec3
#define FxaaHalf4 vec4
#define FxaaInt2 ivec2
#define FxaaSat(x) clamp(x, 0.0, 1.0)
#define FxaaTex sampler2D
#else
#define FxaaBool bool
#define FxaaDiscard clip(-1)
#define FxaaFloat float
#define FxaaFloat2 float2
#define FxaaFloat3 float3
#define FxaaFloat4 float4
#define FxaaHalf half
#define FxaaHalf2 half2
#define FxaaHalf3 half3
#define FxaaHalf4 half4
#define FxaaSat(x) saturate(x)
#endif
#if (FXAA_GLSL_100 == 1)
#define FxaaTexTop(t, p) texture(t, p, 0.0)
#define FxaaTexOff(t, p, o, r) texture(t, p + (o * r), 0.0)
#endif
#if (FXAA_GLSL_120 == 1)
#define FxaaTexTop(t, p) textureLod(t, p, 0.0)
#if (FXAA_FAST_PIXEL_OFFSET == 1)
#define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)
#else
#define FxaaTexOff(t, p, o, r) textureLod(t, p + (o * r), 0.0)
#endif
#if (FXAA_GATHER4_ALPHA == 1)
#define FxaaTexAlpha4(t, p) textureGather(t, p, 3)
#define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)
#define FxaaTexGreen4(t, p) textureGather(t, p, 1)
#define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)
#endif
#endif
#if (FXAA_GLSL_130 == 1)
#define FxaaTexTop(t, p) textureLod(t, p, 0.0)
#define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)
#if (FXAA_GATHER4_ALPHA == 1)
#define FxaaTexAlpha4(t, p) textureGather(t, p, 3)
#define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)
#define FxaaTexGreen4(t, p) textureGather(t, p, 1)
#define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)
#endif
#endif
#if (FXAA_HLSL_3 == 1)
#define FxaaInt2 float2
#define FxaaTex sampler2D
#define FxaaTexTop(t, p) tex2Dlod(t, float4(p, 0.0, 0.0))
#define FxaaTexOff(t, p, o, r) tex2Dlod(t, float4(p + (o * r), 0, 0))
#endif
#if (FXAA_HLSL_4 == 1)
#define FxaaInt2 int2
struct FxaaTex{SamplerState smpl;texture tex;};
#define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)
#define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)
#endif
#if (FXAA_HLSL_5 == 1)
#define FxaaInt2 int2
struct FxaaTex{SamplerState smpl;texture tex;};
#define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)
#define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)
#define FxaaTexAlpha4(t, p) t.tex.GatherAlpha(t.smpl, p)
#define FxaaTexOffAlpha4(t, p, o) t.tex.GatherAlpha(t.smpl, p, o)
#define FxaaTexGreen4(t, p) t.tex.GatherGreen(t.smpl, p)
#define FxaaTexOffGreen4(t, p, o) t.tex.GatherGreen(t.smpl, p, o)
#endif
/*============================================================================GREEN AS LUMA OPTION SUPPORT FUNCTION============================================================================*/
#if (FXAA_GREEN_AS_LUMA == 0)
FxaaFloat FxaaLuma(FxaaFloat4 rgba){return rgba.w;}
#else
FxaaFloat FxaaLuma(FxaaFloat4 rgba){return rgba.y;}
#endif
/*============================================================================FXAA3 QUALITY-PC============================================================================*/
#if (FXAA_PC == 1)
FxaaFloat4 FxaaPixelShader(FxaaFloat2 pos,FxaaFloat4 fxaaConsolePosPos,FxaaTex tex,FxaaTex fxaaConsole360TexExpBiasNegOne,FxaaTex fxaaConsole360TexExpBiasNegTwo,FxaaFloat2 fxaaQualityRcpFrame,FxaaFloat4 fxaaConsoleRcpFrameOpt,FxaaFloat4 fxaaConsoleRcpFrameOpt2,FxaaFloat4 fxaaConsole360RcpFrameOpt2,FxaaFloat fxaaQualitySubpix,FxaaFloat fxaaQualityEdgeThreshold,FxaaFloat fxaaQualityEdgeThresholdMin,FxaaFloat fxaaConsoleEdgeSharpness,FxaaFloat fxaaConsoleEdgeThreshold,FxaaFloat fxaaConsoleEdgeThresholdMin,FxaaFloat4 fxaaConsole360ConstDir){FxaaFloat2 posM;posM.x=pos.x;posM.y=pos.y;
#if (FXAA_GATHER4_ALPHA == 1)
#if (FXAA_DISCARD == 0)
FxaaFloat4 rgbyM=FxaaTexTop(tex,posM);
#if (FXAA_GREEN_AS_LUMA == 0)
#define lumaM rgbyM.w
#else
#define lumaM rgbyM.y
#endif
#endif
#if (FXAA_GREEN_AS_LUMA == 0)
FxaaFloat4 luma4A=FxaaTexAlpha4(tex,posM);FxaaFloat4 luma4B=FxaaTexOffAlpha4(tex,posM,FxaaInt2(-1,-1));
#else
FxaaFloat4 luma4A=FxaaTexGreen4(tex,posM);FxaaFloat4 luma4B=FxaaTexOffGreen4(tex,posM,FxaaInt2(-1,-1));
#endif
#if (FXAA_DISCARD == 1)
#define lumaM luma4A.w
#endif
#define lumaE luma4A.z
#define lumaS luma4A.x
#define lumaSE luma4A.y
#define lumaNW luma4B.w
#define lumaN luma4B.z
#define lumaW luma4B.x
#else
FxaaFloat4 rgbyM=FxaaTexTop(tex,posM);
#if (FXAA_GREEN_AS_LUMA == 0)
#define lumaM rgbyM.w
#else
#define lumaM rgbyM.y
#endif
#if (FXAA_GLSL_100 == 1)
FxaaFloat lumaS=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(0.0,1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaE=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(1.0,0.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaN=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(0.0,-1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaW=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(-1.0,0.0),fxaaQualityRcpFrame.xy));
#else
FxaaFloat lumaS=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(0,1),fxaaQualityRcpFrame.xy));FxaaFloat lumaE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,0),fxaaQualityRcpFrame.xy));FxaaFloat lumaN=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(0,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,0),fxaaQualityRcpFrame.xy));
#endif
#endif
FxaaFloat maxSM=max(lumaS,lumaM);FxaaFloat minSM=min(lumaS,lumaM);FxaaFloat maxESM=max(lumaE,maxSM);FxaaFloat minESM=min(lumaE,minSM);FxaaFloat maxWN=max(lumaN,lumaW);FxaaFloat minWN=min(lumaN,lumaW);FxaaFloat rangeMax=max(maxWN,maxESM);FxaaFloat rangeMin=min(minWN,minESM);FxaaFloat rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;FxaaFloat range=rangeMax-rangeMin;FxaaFloat rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);FxaaBool earlyExit=range<rangeMaxClamped;if(earlyExit)
#if (FXAA_DISCARD == 1)
FxaaDiscard;
#else
return rgbyM;
#endif
#if (FXAA_GATHER4_ALPHA == 0)
#if (FXAA_GLSL_100 == 1)
FxaaFloat lumaNW=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(-1.0,-1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaSE=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(1.0,1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaNE=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(1.0,-1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaSW=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(-1.0,1.0),fxaaQualityRcpFrame.xy));
#else
FxaaFloat lumaNW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaSE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,1),fxaaQualityRcpFrame.xy));FxaaFloat lumaNE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaSW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,1),fxaaQualityRcpFrame.xy));
#endif
#else
FxaaFloat lumaNE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaSW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,1),fxaaQualityRcpFrame.xy));
#endif
FxaaFloat lumaNS=lumaN+lumaS;FxaaFloat lumaWE=lumaW+lumaE;FxaaFloat subpixRcpRange=1.0/range;FxaaFloat subpixNSWE=lumaNS+lumaWE;FxaaFloat edgeHorz1=(-2.0*lumaM)+lumaNS;FxaaFloat edgeVert1=(-2.0*lumaM)+lumaWE;FxaaFloat lumaNESE=lumaNE+lumaSE;FxaaFloat lumaNWNE=lumaNW+lumaNE;FxaaFloat edgeHorz2=(-2.0*lumaE)+lumaNESE;FxaaFloat edgeVert2=(-2.0*lumaN)+lumaNWNE;FxaaFloat lumaNWSW=lumaNW+lumaSW;FxaaFloat lumaSWSE=lumaSW+lumaSE;FxaaFloat edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);FxaaFloat edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);FxaaFloat edgeHorz3=(-2.0*lumaW)+lumaNWSW;FxaaFloat edgeVert3=(-2.0*lumaS)+lumaSWSE;FxaaFloat edgeHorz=abs(edgeHorz3)+edgeHorz4;FxaaFloat edgeVert=abs(edgeVert3)+edgeVert4;FxaaFloat subpixNWSWNESE=lumaNWSW+lumaNESE;FxaaFloat lengthSign=fxaaQualityRcpFrame.x;FxaaBool horzSpan=edgeHorz>=edgeVert;FxaaFloat subpixA=subpixNSWE*2.0+subpixNWSWNESE;if(!horzSpan)lumaN=lumaW;if(!horzSpan)lumaS=lumaE;if(horzSpan)lengthSign=fxaaQualityRcpFrame.y;FxaaFloat subpixB=(subpixA*(1.0/12.0))-lumaM;FxaaFloat gradientN=lumaN-lumaM;FxaaFloat gradientS=lumaS-lumaM;FxaaFloat lumaNN=lumaN+lumaM;FxaaFloat lumaSS=lumaS+lumaM;FxaaBool pairN=abs(gradientN)>=abs(gradientS);FxaaFloat gradient=max(abs(gradientN),abs(gradientS));if(pairN)lengthSign=-lengthSign;FxaaFloat subpixC=FxaaSat(abs(subpixB)*subpixRcpRange);FxaaFloat2 posB;posB.x=posM.x;posB.y=posM.y;FxaaFloat2 offNP;offNP.x=(!horzSpan)? 0.0 : fxaaQualityRcpFrame.x;offNP.y=(horzSpan)? 0.0 : fxaaQualityRcpFrame.y;if(!horzSpan)posB.x+=lengthSign*0.5;if(horzSpan)posB.y+=lengthSign*0.5;FxaaFloat2 posN;posN.x=posB.x-offNP.x*FXAA_QUALITY_P0;posN.y=posB.y-offNP.y*FXAA_QUALITY_P0;FxaaFloat2 posP;posP.x=posB.x+offNP.x*FXAA_QUALITY_P0;posP.y=posB.y+offNP.y*FXAA_QUALITY_P0;FxaaFloat subpixD=((-2.0)*subpixC)+3.0;FxaaFloat lumaEndN=FxaaLuma(FxaaTexTop(tex,posN));FxaaFloat subpixE=subpixC*subpixC;FxaaFloat lumaEndP=FxaaLuma(FxaaTexTop(tex,posP));if(!pairN)lumaNN=lumaSS;FxaaFloat gradientScaled=gradient*1.0/4.0;FxaaFloat lumaMM=lumaM-lumaNN*0.5;FxaaFloat subpixF=subpixD*subpixE;FxaaBool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;FxaaBool doneN=abs(lumaEndN)>=gradientScaled;FxaaBool doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P1;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P1;FxaaBool doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P1;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P1;if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P2;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P2;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P2;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P2;
#if (FXAA_QUALITY_PS > 3)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P3;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P3;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P3;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P3;
#if (FXAA_QUALITY_PS > 4)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P4;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P4;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P4;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P4;
#if (FXAA_QUALITY_PS > 5)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P5;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P5;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P5;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P5;
#if (FXAA_QUALITY_PS > 6)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P6;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P6;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P6;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P6;
#if (FXAA_QUALITY_PS > 7)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P7;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P7;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P7;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P7;
#if (FXAA_QUALITY_PS > 8)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P8;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P8;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P8;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P8;
#if (FXAA_QUALITY_PS > 9)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P9;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P9;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P9;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P9;
#if (FXAA_QUALITY_PS > 10)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P10;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P10;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P10;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P10;
#if (FXAA_QUALITY_PS > 11)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P11;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P11;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P11;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P11;
#if (FXAA_QUALITY_PS > 12)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P12;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P12;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P12;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P12;}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}FxaaFloat dstN=posM.x-posN.x;FxaaFloat dstP=posP.x-posM.x;if(!horzSpan)dstN=posM.y-posN.y;if(!horzSpan)dstP=posP.y-posM.y;FxaaBool goodSpanN=(lumaEndN<0.0)!=lumaMLTZero;FxaaFloat spanLength=(dstP+dstN);FxaaBool goodSpanP=(lumaEndP<0.0)!=lumaMLTZero;FxaaFloat spanLengthRcp=1.0/spanLength;FxaaBool directionN=dstN<dstP;FxaaFloat dst=min(dstN,dstP);FxaaBool goodSpan=directionN ? goodSpanN : goodSpanP;FxaaFloat subpixG=subpixF*subpixF;FxaaFloat pixelOffset=(dst*(-spanLengthRcp))+0.5;FxaaFloat subpixH=subpixG*fxaaQualitySubpix;FxaaFloat pixelOffsetGood=goodSpan ? pixelOffset : 0.0;FxaaFloat pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if(!horzSpan)posM.x+=pixelOffsetSubpix*lengthSign;if(horzSpan)posM.y+=pixelOffsetSubpix*lengthSign;
#if (FXAA_DISCARD == 1)
return FxaaTexTop(tex,posM);
#else
return FxaaFloat4(FxaaTexTop(tex,posM).xyz,lumaM);
#endif
}
#endif
void main(){out_color=FxaaPixelShader(vCoord,vec4(0.0),inputBuffer,inputBuffer,inputBuffer,resolution,vec4(0.0),vec4(0.0),vec4(0.0),0.75,0.166,0.0833,0.0,0.0,0.0,vec4(0.0));out_color.a=texture(inputBuffer,vCoord).a;}`};this.renderPass=new O(t,i),this.fullscreenTriangle=a}setSize(e,t){this.renderPass.setUniform("resolution",1/e,1/t)}draw(e){let{light:t}=e;this.renderPass.setTexture("inputBuffer",t),this.renderPass.useProgram(),this.fullscreenTriangle.draw()}dispose(){this.renderPass.dispose()}}function ae(s,e,t){if(e===void 0)return;const{itemSize:a,array:i}=t;if(s.enableVertexAttribArray(e),s.bindBuffer(s.ARRAY_BUFFER,s.createBuffer()),s.bufferData(s.ARRAY_BUFFER,i,s.STATIC_DRAW),i instanceof Float32Array)s.vertexAttribPointer(e,a,s.FLOAT,!1,0,0);else{if(!(i instanceof Int32Array))throw"Unsupported buffer type";s.vertexAttribIPointer(e,a,s.INT,0,0)}}function aa(s,e,t,a){ae(s,e.attribLocs.aPosition,t.position),ae(s,e.attribLocs.aNormal,t.normal),ae(s,e.attribLocs.aUv,t.uv),a=="Static"&&t.materialMeshIndex&&ae(s,e.attribLocs.aMaterialMeshIndex,t.materialMeshIndex),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,s.createBuffer()),s.bufferData(s.ELEMENT_ARRAY_BUFFER,t.indices.array,s.STATIC_DRAW)}class ia{constructor(e,t,a){this.gl=e,this.resourcePool=a,this.vaos=[],this.fullscreenTriangle=t,this.meshNormalMat=new k}createPipeline(e,t){this.renderSetting=e,this.sceneInfo=t;const{materialDefines:a,sceneMode:i,bvhDefines:n}=e,{gl:r,resourcePool:l}=this,o=new O(r,{defines:{SUPPORT_UV_TRANS:e.supportUVTrans,...n,...a},vertex:`in vec3 aPosition;in vec3 aNormal;in vec2 aUv;
#ifndef BVH_DYNAMIC
in ivec2 aMaterialMeshIndex;flat out ivec2 vMaterialMeshIndex;
#endif
uniform mat4 projView;
#ifdef BVH_DYNAMIC
uniform mat4 modelMat;uniform mat3 normalMat;
#endif
out vec3 vPosition;out vec3 vNormal;out vec2 vUv;void main(){
#ifdef BVH_DYNAMIC
vec4 mPosition=modelMat*vec4(aPosition,1.);vPosition=mPosition.xyz;vNormal=normalize(normalMat*aNormal);vUv=aUv;gl_Position=projView*mPosition;
#else
vPosition=aPosition;vNormal=aNormal;vUv=aUv;vMaterialMeshIndex=aMaterialMeshIndex;gl_Position=projView*vec4(aPosition,1);
#endif
}`,fragment:`
#define PI 3.14159265359
#define TWOPI 6.28318530718
#define INVPI 0.31830988618
#define INVPI2 0.10132118364
#define EPS 0.0001
#define ONE_MINUS_EPS 0.999999
#define INF 1000000.0
#define INTERSECT_EPS 1.0e-2
#define ROUGHNESS_MIN 0.001
#define DISNEY 0
const vec3 LGL_Ag=vec3(0.2126,0.7152,0.0722);float LGL_Af(vec3 color){return dot(color,LGL_Ag);}
#define RAY_MAX_DISTANCE 9999.0
struct Ray{vec3 o;vec3 d;};struct Path{Ray ray;vec3 li;float alpha;vec3 beta;bool LGL_BR;float LGL_BS;vec3 LGL_BT;};struct Camera{mat4 viewToWorldMat;mat4 clipToViewMat;float aperture;float focus;};
#if defined(NUM_LIGHTS)
struct Lights{vec3 position[NUM_LIGHTS];vec3 emission[NUM_LIGHTS];vec3 p1[NUM_LIGHTS];vec3 p2[NUM_LIGHTS];vec4 params[NUM_LIGHTS];};struct Light{vec3 position;float radius;vec3 emission;float area;vec3 p1;float type;vec3 p2;float LGL_s;};
#endif
struct SurfaceInteraction{bool LGL_BL;bool isEmitter;float t;vec3 position;vec3 normal;vec3 LGL_BM;float eta;vec3 color;float workflow;float roughness;float metalness;float transmission;float ior;float sheen;float sheenTint;float clearcoat;float clearcoatRoughness;vec3 emissive;float alpha;float specularTint;float atDistance;vec3 specularColor;float subsurface;vec3 extinction;};struct BsdfSampleRec{vec3 L;vec3 f;float pdf;};struct LightSampleRec{vec3 normal;vec3 emission;vec3 direction;float dist;float pdf;};ivec2 LGL_Ai(int i,int LGL_BU){ivec2 u;u.y=i>>LGL_BU;u.x=i-(u.y<<LGL_BU);return u;}vec4 LGL_Aj(sampler2D s,int i,int LGL_BU){return texelFetch(s,LGL_Ai(i,LGL_BU),0);}ivec4 LGL_Aj(isampler2D s,int i,int LGL_BU){return texelFetch(s,LGL_Ai(i,LGL_BU),0);}uniform Camera camera;uniform vec2 pixelSize;uniform vec2 jitter;uniform float frameCount;uniform sampler2D accumulateTex;in vec2 vCoord;
#if defined(NUM_LIGHTS)
uniform Lights lights;
#endif
uniform int bounces;uniform vec3 backgroundColor;uniform float envMapIntensity;uniform float backgroundAlpha;uniform float enviromentVisible;uniform int useBackgroundColor;uniform mat3 envRotMatrix;uniform mat3 invEnvRotMatrix;vec3 ndcToWorld(vec2 coord){vec4 worldPos=camera.viewToWorldMat*camera.clipToViewMat*vec4(coord,-1.0,1.0);return worldPos.xyz/worldPos.w;}vec3 localToWorld(vec3 X,vec3 Y,vec3 Z,vec3 V){return vec3(X.x*V.x+Y.x*V.y+Z.x*V.z,X.y*V.x+Y.y*V.y+Z.y*V.z,X.z*V.x+Y.z*V.y+Z.z*V.z);}vec3 worldToLocal(vec3 X,vec3 Y,vec3 Z,vec3 V){return vec3(dot(V,X),dot(V,Y),dot(V,Z));}
#ifdef NUM_MATERIALS
uniform Materials{vec4 colorWorkflow[NUM_MATERIALS];vec4 roughMetalTransIOR[NUM_MATERIALS];vec4 sheenTintClearcoatRoughness[NUM_MATERIALS];vec4 emissiveAlpha[NUM_MATERIALS];vec4 specularTintAtDistanceNormalScale[NUM_MATERIALS];vec4 subsurfaceAndColor[NUM_MATERIALS];vec4 extinctionSubsurfaceMFP[NUM_MATERIALS];vec4 specularColorGlossiness[NUM_MATERIALS];ivec4 diffuseNormalRoughnessMetalnessMapIndex[NUM_MATERIALS];ivec4 emissiveSpecularGlossinessMapIndex[NUM_MATERIALS];}materials;
#endif
uniform mediump sampler2DArray materialTexArray;vec3 srgbToLinear(vec3 srgb){return pow(srgb,vec3(2.2));}
#if defined(SUPPORT_UV_TRANS) || defined(SUPPORT_TEX_WRAP)
uniform sampler2D uvTransBuffer;
#define UV_TRANS_MAPS_LEN 7
#endif
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Be(int materialID,int mapKey){int offset=materialID*UV_TRANS_MAPS_LEN*3;int mapOffset=mapKey*3;vec3 LGL_BZ=LGL_Aj(uvTransBuffer,offset+mapOffset+0,UV_TRANS_COLUMNS).xyz;vec3 LGL_Ba=LGL_Aj(uvTransBuffer,offset+mapOffset+1,UV_TRANS_COLUMNS).xyz;vec3 LGL_Bb=LGL_Aj(uvTransBuffer,offset+mapOffset+2,UV_TRANS_COLUMNS).xyz;mat3 LGL_Bk=mat3(LGL_BZ,LGL_Ba,LGL_Bb);return LGL_Bk;}
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bf(int materialID,int mapKey){int offset=TEX_WRAP_DATA_INDEX+materialID*UV_TRANS_MAPS_LEN;int mapOffset=mapKey;vec3 wrappingData=LGL_Aj(uvTransBuffer,offset+mapOffset,UV_TRANS_COLUMNS).xyz;return wrappingData;}vec2 applyTextureWrapping(vec2 uv,vec3 LGL_Bh){if(uv.x<=0.||uv.x>=1.){int LGL_Bi=int(LGL_Bh.x);if(LGL_Bi==1){uv.x=uv.x<=0. ? 0. : 1.;}else if(LGL_Bi==2){uv.x=1.0-abs(fract(uv.x*0.5)*2.0-1.0);}else{uv.x=fract(uv.x);}}if(uv.y<=0.||uv.y>=1.){int LGL_Bj=int(LGL_Bh.y);if(LGL_Bj==1){uv.y=uv.y<=0. ? 0. : 1.;}else if(LGL_Bj==2){uv.y=1.0-abs(fract(uv.y*0.5)*2.0-1.0);}else{uv.y=fract(uv.y);}}return uv;}
#endif
#ifdef SUPPORT_SG_WORKFLOW
float LGL_AC(const vec3 v){return max(v.x,max(v.y,v.z));}float LGL_AD(const vec3 specularColor){return LGL_AC(specularColor);}vec3 LGL_AE(const vec3 baseColor,float metallic){return baseColor*(1.0-metallic);}vec3 LGL_z(int materialID,vec2 uv){vec3 specularColor=materials.specularColorGlossiness[materialID].rgb;int specularMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialID].y;if(specularMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,4);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,4);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
vec3 LGL_AV=srgbToLinear(texture(materialTexArray,vec3(uv,specularMapIndex)).rgb);specularColor*=LGL_AV;}return specularColor;}float LGL_AA(int materialID,vec2 uv){float glossiness=materials.specularColorGlossiness[materialID].a;int glossinessMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialID].z;if(glossinessMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,5);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,5);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
float LGL_AW=texture(materialTexArray,vec3(uv,glossinessMapIndex)).a;glossiness*=LGL_AW;}return glossiness;}
#endif
vec4 LGL_AGAlpha(int materialID,vec2 uv){vec3 color=materials.colorWorkflow[materialID].rgb;float alpha=materials.emissiveAlpha[materialID].a;int diffuseMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialID].x;if(diffuseMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,0);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,0);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
vec4 texData=texture(materialTexArray,vec3(uv,diffuseMapIndex));color*=srgbToLinear(texData.rgb);alpha*=texData.a;}
#ifdef SUPPORT_SG_WORKFLOW
float workflow=materials.colorWorkflow[materialID].w;if(workflow>0.1){vec3 specularFactor=LGL_z(materialID,uv);color=LGL_AE(color,LGL_AD(specularFactor));}
#endif
return vec4(color,alpha);}float LGL_AB(int materialID,vec2 uv){float workflow=materials.colorWorkflow[materialID].w;float roughness=0.0;
#ifdef SUPPORT_SG_WORKFLOW
if(workflow>0.1){roughness=1.0-LGL_AA(materialID,uv);}else
#endif
{roughness=materials.roughMetalTransIOR[materialID].x;int roughnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialID].z;if(roughnessMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,2);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,2);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
roughness*=texture(materialTexArray,vec3(uv,roughnessMapIndex)).g;}}return roughness*roughness;}float LGL_AF(int materialID,vec2 uv){float workflow=materials.colorWorkflow[materialID].w;float metalness=0.0;
#ifdef SUPPORT_SG_WORKFLOW
if(workflow>0.1){vec3 specularFactor=LGL_z(materialID,uv);metalness=LGL_AD(specularFactor);}else
#endif
{metalness=materials.roughMetalTransIOR[materialID].y;int metalnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialID].w;if(metalnessMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,3);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,3);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
metalness*=texture(materialTexArray,vec3(uv,metalnessMapIndex)).b;}}return metalness;}vec3 LGL_y(int materialID,vec2 uv){vec3 emissive=materials.emissiveAlpha[materialID].xyz;int emissiveMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialID].x;if(emissiveMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,6);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,6);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
emissive*=srgbToLinear(texture(materialTexArray,vec3(uv,emissiveMapIndex)).rgb);}return emissive;}vec3 LGL_AI(int materialID,vec2 uv,vec3 normal,vec3 dp1,vec3 dp2,vec2 duv1,vec2 duv2){vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 dpdu=dp2perp*duv1.x+dp1perp*duv2.x;vec3 dpdv=dp2perp*duv1.y+dp1perp*duv2.y;float invmax=inversesqrt(max(dot(dpdu,dpdu),dot(dpdv,dpdv)));dpdu*=invmax;dpdv*=invmax;int normalMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialID].y;if(normalMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,1);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,1);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
vec3 n=2.0*texture(materialTexArray,vec3(uv,normalMapIndex)).rgb-1.0;n.xy*=materials.specularTintAtDistanceNormalScale[materialID].zw;mat3 tbn=mat3(dpdu,dpdv,normal);return normalize(tbn*n);}else{return normal;}return normal;}float LGL_AJ(int materialID){return materials.specularTintAtDistanceNormalScale[materialID].x;}float LGL_AS(int materialID){return materials.specularTintAtDistanceNormalScale[materialID].y;}float LGL_AP(int materialID){return materials.subsurfaceAndColor[materialID].x;}vec3 LGL_APColor(int materialID){return materials.subsurfaceAndColor[materialID].yzw;}vec3 LGL_AU(int materialID){return materials.extinctionSubsurfaceMFP[materialID].rgb;}float getMatSubsurfaceMFP(int materialID){return materials.extinctionSubsurfaceMFP[materialID].a;}layout(location=0)out vec4 out_position;layout(location=1)out vec4 out_normal;layout(location=2)out vec4 out_color;in vec3 vPosition;in vec3 vNormal;in vec2 vUv;
#ifdef BVH_DYNAMIC
uniform int meshIndex;uniform int materialID;
#else
flat in ivec2 vMaterialMeshIndex;
#endif
vec3 LGL_BNs(vec3 pos){vec3 fdx=dFdx(pos);vec3 fdy=dFdy(pos);return cross(fdx,fdy);}void main(){
#ifndef BVH_DYNAMIC
int materialID=vMaterialMeshIndex.x;int meshIndex=vMaterialMeshIndex.y;
#endif
vec2 uv=vUv;vec3 color=LGL_AGAlpha(materialID,uv).rgb;vec3 normal=normalize(vNormal);vec3 LGL_BN=normalize(LGL_BNs(vPosition));normal*=sign(dot(normal,LGL_BN));int normalMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialID].y;if(normalMapIndex>=0){vec3 dp1=dFdx(vPosition);vec3 dp2=dFdy(vPosition);vec2 duv1=dFdx(vUv);vec2 duv2=dFdy(vUv);normal=LGL_AI(materialID,uv,normal,dp1,dp2,duv1,duv2);}out_position=vec4(vPosition,float(meshIndex)+EPS);out_normal=vec4(normal,0);out_color=vec4(color,0.);}`}),u=this.renderSetting.sceneMode=="Static"?[t.mergedMesh]:t.meshes;this.meshes=u,this.renderPass=o,o.setTexture("materialTexArr",l.getRawResourceByName("MaterialTextureArray")),(e.supportUVTrans||e.supportTexWrap)&&o.setTexture("uvTransBuffer",l.getRawResourceByName("TextureUVTransformBuffer")),this.vaos=[];for(let c=0;c<u.length;c++){const d=u[c].geometry,h=r.createVertexArray();r.bindVertexArray(h),aa(r,o,d,i),r.bindVertexArray(null),this.vaos.push(h)}this.projView=new V}setCamera(e){this.currentCamera=e}calcCamera(){const{projView:e,currentCamera:t,renderPass:a}=this;e.copy(t.viewToClipMat),e.multiply(t.worldToViewMat),a.setUniform("projView",e)}draw(){const{gl:e,renderSetting:t,renderPass:a,vaos:i,meshes:n}=this,{materialIndexMap:r}=this.sceneInfo;this.calcCamera(),e.enable(e.DEPTH_TEST),e.disable(e.CULL_FACE);for(let l=0;l<n.length;l++){const o=n[l];if(o.visible==0)continue;const u=o.geometry,c=u.indices.array,d=u.indices.count;if(t.sceneMode=="Dynamic"){const L=o;a.setUniform("modelMat",L.localToWorldMat),this.meshNormalMat.getNormalMatrix(L.localToWorldMat),a.setUniform("normalMat",this.meshNormalMat),a.setUniform("meshIndex",l);const f=r.get(L.material);a.setUniform("materialID",f)}const h=i[l];e.bindVertexArray(h),a.useProgram(),c instanceof Uint16Array?e.drawElements(e.TRIANGLES,d,e.UNSIGNED_SHORT,0):c instanceof Uint32Array&&e.drawElements(e.TRIANGLES,d,e.UNSIGNED_INT,0)}e.enable(e.CULL_FACE),e.disable(e.DEPTH_TEST)}dispose(){this.renderPass.dispose()}}class sa{constructor(e,t){this.gl=e,this.level=3,this.colorFactor=.05,this.normalFactor=.02,this.positionFactor=.35,this.fullscreenTriangle=t}createPipeline(e){const{gl:t,fullscreenTriangle:a}=this,i={gl:t,vertex:a.vertexShader,fragment:`vec4 LGL_Az(sampler2D map,vec2 uv){
#ifdef EXT_FLOAT_LINEAR
return texture(map,uv);
#else
vec2 size=vec2(textureSize(map,0));vec2 texelSize=1.0/size;uv=uv*size-0.5;vec2 f=fract(uv);uv=floor(uv)+0.5;vec4 s1=texture(map,(uv+vec2(0,0))*texelSize);vec4 s2=texture(map,(uv+vec2(1,0))*texelSize);vec4 s3=texture(map,(uv+vec2(0,1))*texelSize);vec4 s4=texture(map,(uv+vec2(1,1))*texelSize);return mix(mix(s1,s2,f.x),mix(s3,s4,f.x),f.y);
#endif
}layout(location=0)out vec4 out_color;in vec2 vCoord;uniform sampler2D lightTex;uniform sampler2D gPosition;uniform sampler2D gNormal;uniform sampler2D gColor;uniform float colorFactor;uniform float normalFactor;uniform float positionFactor;uniform float stepwidth;uniform int level;float LGL_BB(float v){return acos(min(max(v,0.0),1.0));}vec4 LGL_BD(){vec4 upscaledLight=texture(lightTex,vCoord);float sampleFrame=upscaledLight.a;float sf2=sampleFrame*sampleFrame;vec3 color=upscaledLight.rgb/upscaledLight.a;vec3 normal=texture(gNormal,vCoord).rgb;vec4 positionAndMeshIndex=LGL_Az(gPosition,vCoord);vec3 position=positionAndMeshIndex.rgb;float meshIndex=positionAndMeshIndex.w;bool isBG=meshIndex>0.0 ? false : true;if(isBG){return upscaledLight;}vec2 size=vec2(textureSize(lightTex,0));int kernelRadius=9;float dx=1./size.x;float dy=1./size.y;float kernel[9]=float[9](1.0/16.0,1.0/8.0,1.0/16.0,1.0/8.0,1.0/4.0,1.0/8.0,1.0/16.0,1.0/8.0,1.0/16.0);vec2 offset[9]=vec2[9](vec2(-dx,-dy),vec2(0,-dy),vec2(dx,-dy),vec2(-dx,0),vec2(0,0),vec2(dx,0),vec2(-dx,dy),vec2(0,dy),vec2(dx,dy));vec3 colorSum=vec3(0.);float weightSum=0.;float var;float varSum;float varSumWeight;for(int i=0;i<kernelRadius;i++){vec2 uv=vCoord+offset[i]*float(stepwidth);if(uv.x<0.0||uv.x>1.0||uv.y<0.0||uv.y>1.0){continue;}vec4 positionAndMeshIndex=texture(gPosition,uv);float meshIndex=positionAndMeshIndex.w;bool isBG=meshIndex>0.0 ? false : true;if(isBG){continue;}vec4 upscaledLight=texture(lightTex,uv);vec3 kernelColor=upscaledLight.rgb/upscaledLight.a;float Dc=distance(color,kernelColor);float Wc;Wc=min(exp(-Dc/(colorFactor+1e-6)),1.0);vec3 kernelNormal=texture(gNormal,uv).rgb;float Dn=distance(normal,kernelNormal);float dist2=max(Dn/(stepwidth*stepwidth+1e-6),0.0);float Wn=min(exp(-(dist2)/normalFactor+1e-6),1.0);vec3 kernelPosition=positionAndMeshIndex.rgb;float Dp=distance(position,kernelPosition);float Wp=min(exp(-Dp/(positionFactor+1e-6)),1.0);float weight=Wc*Wn*Wp*kernel[i];weightSum+=weight;colorSum+=kernelColor*weight;}colorSum=colorSum/weightSum;return vec4(colorSum*sampleFrame,sampleFrame);}void main(){vec4 light=LGL_BD();out_color=light;}`},n=new O(t,i);this.renderPass=n,this.fullscreenTriangle=a}initFrameBuffers(e,t){const{gl:a}=this;this.readBuffer=new J(a,{color:{0:new z(a,{width:e,height:t,storage:"float",magFilter:a.NEAREST,minFilter:a.NEAREST})}}),this.writeBuffer=new J(a,{color:{0:new z(a,{width:e,height:t,storage:"float",magFilter:a.NEAREST,minFilter:a.NEAREST})}})}swapBuffers(){let e=this.writeBuffer;this.writeBuffer=this.readBuffer,this.readBuffer=e}setSize(e,t){this.initFrameBuffers(e,t)}setGBuffers({position:e,normal:t,color:a}){this.renderPass.setTexture("gPosition",e),this.renderPass.setTexture("gNormal",t),this.renderPass.setTexture("gColor",a)}setColorFactor(e){this.colorFactor=e}setNormalFactor(e){this.normalFactor=e}setPositionFactor(e){this.positionFactor=e}draw(e){let{light:t}=e;const{gl:a,renderPass:i,fullscreenTriangle:n,level:r,colorFactor:l,normalFactor:o,positionFactor:u}=this;for(let c=0;c<r;c++)i.setUniform("level",c),i.setUniform("colorFactor",1/(1<<c)*l),i.setUniform("normalFactor",1/(1<<c)*o),i.setUniform("positionFactor",1/(1<<c)*u),i.setUniform("stepwidth",(1<<c+1)-1),c===0?i.setTexture("lightTex",t):i.setTexture("lightTex",this.readBuffer.color[0]),this.writeBuffer.bind(),a.clear(a.COLOR_BUFFER_BIT),a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),i.useProgram(),n.draw(),this.writeBuffer.unbind(),this.swapBuffers();return this.readBuffer}dispose(){this.renderPass.dispose()}}class na{constructor(e,t,a){this.gl=e,this.resourcePool=a,this.defaultLightScale=[1,1],this.fullscreenTriangle=t}createPipeline(e){const{gl:t,fullscreenTriangle:a}=this;this.renderSetting=e;const{toneMapping:i}=e,n={gl:t,vertex:a.vertexShader,fragment:"layout(location=0)out vec4 out_color;in vec2 vCoord;uniform sampler2D lightTex;uniform vec2 lightScale;uniform int toneMappingFun;vec3 linear(vec3 color){return color;}vec3 LGL_BH(vec3 color){return clamp(color/(vec3(1.0)+color),vec3(0.0),vec3(1.0));}vec3 LGL_BI(vec3 color){color=max(vec3(0.0),color-0.004);return pow((color*(6.2*color+0.5))/(color*(6.2*color+1.7)+0.06),vec3(2.2));}vec3 LGL_BJ(vec3 color){return clamp((color*(2.51*color+0.03))/(color*(2.43*color+0.59)+0.14),vec3(0.0),vec3(1.0));}void main(){vec4 upscaledLight=texture(lightTex,lightScale*vCoord);vec3 light=upscaledLight.rgb;if(toneMappingFun==0){light=linear(light);}if(toneMappingFun==1){light=LGL_BJ(light);}if(toneMappingFun==2){light=LGL_BH(light);}if(toneMappingFun==3){light=LGL_BI(light);}light=pow(light,vec3(1.0/2.2));out_color=vec4(light*upscaledLight.a,upscaledLight.a);}"},r=new O(t,n);r.setUniform("toneMappingFun",i),this.renderPass=r}initFrameBuffers(e,t){const{gl:a,resourcePool:i}=this,n=new z(a,{width:e,height:t,storage:"byte",magFilter:a.LINEAR,minFilter:a.LINEAR});this.passBuffer=new J(a,{color:{0:n}}),i.updateResource("ScreenPassOutputTexture",n)}draw(e,t=!1){let{light:a,lightScale:i}=e;i||(i=this.defaultLightScale);const{gl:n,renderPass:r,passBuffer:l,fullscreenTriangle:o}=this;if(r.setTexture("lightTex",a),r.setUniform("lightScale",i),t&&l)return l.bind(),n.clear(n.COLOR_BUFFER_BIT),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),r.useProgram(),o.draw(),l.unbind(),l;r.useProgram(),o.draw()}setSize(e,t){this.initFrameBuffers(e,t)}setToneMapping(e){this.renderPass.setUniform("toneMappingFun",e)}dispose(){this.renderPass.dispose()}}class ra{constructor(e,t){this.gl=e,this.fullscreenTriangle=t}createPipeline(){const{gl:e,fullscreenTriangle:t}=this,a={vertex:t.vertexShader,fragment:"layout(location=0)out vec4 out_color;in vec2 vCoord;uniform sampler2D inputTex;void main(){vec2 size=vec2(textureSize(inputTex,0));vec4 accumulatedLight=texelFetch(inputTex,ivec2(vCoord*size),0);out_color=accumulatedLight;}"},i=new O(e,a);this.renderPass=i}draw(e){const{gl:t,renderPass:a,fullscreenTriangle:i}=this;let{inputTex:n,outputTex:r,width:l=t.drawingBufferWidth,height:o=t.drawingBufferHeight}=e;return a.setTexture("inputTex",n),r.bind(),t.viewport(0,0,l,o),a.useProgram(),i.draw(),r.unbind(),r}dispose(){this.renderPass.dispose()}}class oa{constructor(e,t){this.strata=[];const a=e**t;for(let i=0;i<a;i++)this.strata[i]=i;this.index=this.strata.length,this.sample=[],this.strataCount=e,this.dimensions=t}restart(){this.index=0}next(){const{strata:e,strataCount:t,dimensions:a}=this;this.index>=e.length&&(function(n){for(let r=n.length-1;r>0;r--){const l=Math.floor(Math.random()*(r+1)),o=n[r];n[r]=n[l],n[l]=o}}(this.strata),this.restart());let i=e[this.index++];for(let n=0;n<a;n++)this.sample[n]=i%t+Math.random(),i=Math.floor(i/t);return this.sample}}class tt{constructor(e,t){this.strataObjs=[];for(const a of t)this.strataObjs.push(new oa(e,a));this.combined=[],this.strataCount=e}next(){const{strataObjs:e,combined:t}=this;let a=0;for(const i of e){const n=i.next();for(const r of n)t[a++]=r}return t}restart(){for(const e of this.strataObjs)e.restart()}}const ve=class{constructor(s,e,t){this.gl=s,this.fullscreenTriangle=e,this.resourcePool=t,this.samplingDimensions=[],this.samples=new tt(1,this.samplingDimensions)}createPipeline(s,e=!1){const{gl:t,fullscreenTriangle:a,resourcePool:i}=this;let n;this.renderSetting=s;const r={SUPPORT_SG_WORKFLOW:s.supportSGWorkflow,SUPPORT_UV_TRANS:s.supportUVTrans,SUPPORT_TEX_WRAP:s.supportTexWrap,SUPPORT_ALPHA:s.supportAlpha,EXT_FLOAT_LINEAR:s.isFloatLinearSupport,NUM_LIGHTS:s.lightsNum,...s.bvhDefines,...s.materialDefines},l=JSON.stringify(r),o=i.getPipelineByCacheKey(ve.ID,l);if(o){if(n=o,e)return}else n=new O(t,{defines:r,fragment:`
#define PI 3.14159265359
#define TWOPI 6.28318530718
#define INVPI 0.31830988618
#define INVPI2 0.10132118364
#define EPS 0.0001
#define ONE_MINUS_EPS 0.999999
#define INF 1000000.0
#define INTERSECT_EPS 1.0e-2
#define ROUGHNESS_MIN 0.001
#define DISNEY 0
const vec3 LGL_Ag=vec3(0.2126,0.7152,0.0722);float LGL_Af(vec3 color){return dot(color,LGL_Ag);}
#define RAY_MAX_DISTANCE 9999.0
struct Ray{vec3 o;vec3 d;};struct Path{Ray ray;vec3 li;float alpha;vec3 beta;bool LGL_BR;float LGL_BS;vec3 LGL_BT;};struct Camera{mat4 viewToWorldMat;mat4 clipToViewMat;float aperture;float focus;};
#if defined(NUM_LIGHTS)
struct Lights{vec3 position[NUM_LIGHTS];vec3 emission[NUM_LIGHTS];vec3 p1[NUM_LIGHTS];vec3 p2[NUM_LIGHTS];vec4 params[NUM_LIGHTS];};struct Light{vec3 position;float radius;vec3 emission;float area;vec3 p1;float type;vec3 p2;float LGL_s;};
#endif
struct SurfaceInteraction{bool LGL_BL;bool isEmitter;float t;vec3 position;vec3 normal;vec3 LGL_BM;float eta;vec3 color;float workflow;float roughness;float metalness;float transmission;float ior;float sheen;float sheenTint;float clearcoat;float clearcoatRoughness;vec3 emissive;float alpha;float specularTint;float atDistance;vec3 specularColor;float subsurface;vec3 extinction;};struct BsdfSampleRec{vec3 L;vec3 f;float pdf;};struct LightSampleRec{vec3 normal;vec3 emission;vec3 direction;float dist;float pdf;};ivec2 LGL_Ai(int i,int LGL_BU){ivec2 u;u.y=i>>LGL_BU;u.x=i-(u.y<<LGL_BU);return u;}vec4 LGL_Aj(sampler2D s,int i,int LGL_BU){return texelFetch(s,LGL_Ai(i,LGL_BU),0);}ivec4 LGL_Aj(isampler2D s,int i,int LGL_BU){return texelFetch(s,LGL_Ai(i,LGL_BU),0);}uniform Camera camera;uniform vec2 pixelSize;uniform vec2 jitter;uniform float frameCount;uniform sampler2D accumulateTex;in vec2 vCoord;
#if defined(NUM_LIGHTS)
uniform Lights lights;
#endif
uniform int bounces;uniform vec3 backgroundColor;uniform float envMapIntensity;uniform float backgroundAlpha;uniform float enviromentVisible;uniform int useBackgroundColor;uniform mat3 envRotMatrix;uniform mat3 invEnvRotMatrix;vec3 ndcToWorld(vec2 coord){vec4 worldPos=camera.viewToWorldMat*camera.clipToViewMat*vec4(coord,-1.0,1.0);return worldPos.xyz/worldPos.w;}vec3 localToWorld(vec3 X,vec3 Y,vec3 Z,vec3 V){return vec3(X.x*V.x+Y.x*V.y+Z.x*V.z,X.y*V.x+Y.y*V.y+Z.y*V.z,X.z*V.x+Y.z*V.y+Z.z*V.z);}vec3 worldToLocal(vec3 X,vec3 Y,vec3 Z,vec3 V){return vec3(dot(V,X),dot(V,Y),dot(V,Z));}uniform sampler2D noiseTex;uniform float stratifiedSamples[71];uniform float strataSize;float pixelSeed;float LGL_AX(vec2 p){return fract(sin(dot(p,vec2(12.9898,78.233)))*43758.5453);}uvec4 seed;ivec2 pixel;void LGL_AY(float frame){pixel=ivec2(vCoord/pixelSize);seed=uvec4(pixel,int(frame),pixel.x+pixel.y);}void LGL_AZ(inout uvec4 v){v=v*1664525u+1013904223u;v.x+=v.y*v.w;v.y+=v.z*v.x;v.z+=v.x*v.y;v.w+=v.y*v.z;v=v ^(v>>16u);v.x+=v.y*v.w;v.y+=v.z*v.x;v.z+=v.x*v.y;v.w+=v.y*v.z;}float LGL_Aa(){LGL_AZ(seed);return float(seed.x)/float(0xffffffffu);}vec2 LGL_Aa2(){LGL_AZ(seed);return vec2(seed.xy)/float(0xffffffffu);}void LGL_Ac(float frame){vec2 noiseSize=vec2(textureSize(noiseTex,0));pixelSeed=texture(noiseTex,vCoord/(pixelSize*noiseSize)).r;LGL_AY(frame);}int sampleIndex=0;float LGL_AaomSample(){float stratifiedSample=stratifiedSamples[sampleIndex++];float LGL_Aaom=fract((stratifiedSample+pixelSeed)*strataSize);return EPS+(1.0-2.0*EPS)*LGL_Aaom;}vec2 LGL_AaomSampleVec2(){return vec2(LGL_AaomSample(),LGL_AaomSample());}struct MaterialSamples{vec2 s1;vec2 s2;vec2 s3;vec2 s4;};MaterialSamples getRandomMaterialSamples(){MaterialSamples samples;samples.s1=LGL_AaomSampleVec2();samples.s2=LGL_AaomSampleVec2();samples.s3=LGL_AaomSampleVec2();samples.s4=LGL_AaomSampleVec2();return samples;}vec4 LGL_Az(sampler2D map,vec2 uv){
#ifdef EXT_FLOAT_LINEAR
return texture(map,uv);
#else
vec2 size=vec2(textureSize(map,0));vec2 texelSize=1.0/size;uv=uv*size-0.5;vec2 f=fract(uv);uv=floor(uv)+0.5;vec4 s1=texture(map,(uv+vec2(0,0))*texelSize);vec4 s2=texture(map,(uv+vec2(1,0))*texelSize);vec4 s3=texture(map,(uv+vec2(0,1))*texelSize);vec4 s4=texture(map,(uv+vec2(1,1))*texelSize);return mix(mix(s1,s2,f.x),mix(s3,s4,f.x),f.y);
#endif
}uniform sampler2D envMap;uniform float totalSumValue;uniform sampler2D envMarginalWeights;uniform sampler2D envConditionalWeights;vec2 equirectDirToUV(vec3 pointOnSphere){float phi=atan(pointOnSphere.z,pointOnSphere.x)/TWOPI;float theta=acos(pointOnSphere.y);return vec2(phi+0.5,theta*INVPI);}vec3 equirectUVToDir(vec2 uv){uv.x-=0.5;float theta=uv.x*2.0*PI;float phi=uv.y*PI;float sinPhi=sin(phi);return vec3(sinPhi*cos(theta),cos(phi),sinPhi*sin(theta));}vec3 LGL_Z(vec3 d){vec2 uv=equirectDirToUV(d);return LGL_Az(envMap,uv).rgb;}float equirectDirectionPdf(vec3 dir){vec2 uv=equirectDirToUV(dir);float sinTheta=sin(uv.y*PI);if(sinTheta==0.0){return 0.0;}return INVPI2/(2.0*sinTheta);}float LGL_c(vec3 dir){vec2 uv=equirectDirToUV(dir);vec3 color=LGL_Az(envMap,uv).rgb;float lum=LGL_Af(color);vec2 size=vec2(textureSize(envMap,0));return(size.x*size.y)*(lum/totalSumValue)*equirectDirectionPdf(dir);}vec3 LGL_d(vec2 LGL_Aaom,out vec2 uv,out float pdf){vec2 size=vec2(textureSize(envMap,0));float sizeMarginalWeights=size.y;float v=texelFetch(envMarginalWeights,ivec2(LGL_Aaom.x*sizeMarginalWeights,0),0).x;float u=texelFetch(envConditionalWeights,ivec2(LGL_Aaom.y*size.x,v*size.y),0).x;uv=vec2(u,v);vec3 dir=equirectUVToDir(uv);vec3 color=LGL_Az(envMap,uv).rgb;float lum=LGL_Af(color);pdf=(size.x*size.y)*(lum/totalSumValue)*equirectDirectionPdf(dir);return dir;}void LGL_Al(in vec3 N,inout vec3 T,inout vec3 B){if(N.z<-0.999999){T=vec3(0.,-1.,0.);B=vec3(-1.,0.,0.);}else{float a=1.0/(1.+N.z);float b=-N.x*N.y*a;T=vec3(1.0-N.x*N.x*a,b,-N.x);B=vec3(b,1.-N.y*N.y*a,-N.y);}}vec3 LGL_Ay(vec3 V,float rgh,float r1,float r2){vec3 Vh=normalize(vec3(rgh*V.x,rgh*V.y,V.z));float lensq=Vh.x*Vh.x+Vh.y*Vh.y;vec3 T1=lensq>0. ? vec3(-Vh.y,Vh.x,0)*inversesqrt(lensq): vec3(1.,0.,0.);vec3 T2=cross(Vh,T1);float r=sqrt(r1);float phi=2.0*PI*r2;float t1=r*cos(phi);float t2=r*sin(phi);float s=0.5*(1.0+Vh.z);t2=(1.0-s)*sqrt(1.0-t1*t1)+s*t2;vec3 Nh=t1*T1+t2*T2+sqrt(max(0.0,1.0-t1*t1-t2*t2))*Vh;return normalize(vec3(rgh*Nh.x,rgh*Nh.y,max(0.0,Nh.z)));}vec2 LGL_Am(vec2 p){p=2.0*p-1.0;bool greater=abs(p.x)>abs(p.y);float r=greater ? p.x : p.y;float theta=greater ? 0.25*PI*p.y/p.x : PI*(0.5-0.25*p.x/p.y);return r*vec2(cos(theta),sin(theta));}vec3 LGL_An(vec2 p){vec2 h=LGL_Am(p);float z=sqrt(max(0.0,1.0-h.x*h.x-h.y*h.y));return vec3(h,z);}vec3 LGL_A(float r1,float r2){vec3 dir;float r=sqrt(r1);float phi=TWOPI*r2;dir.x=r*cos(phi);dir.y=r*sin(phi);dir.z=sqrt(max(0.0,1.0-dir.x*dir.x-dir.y*dir.y));return dir;}vec3 LGL_Ao(float r1,float r2){float z=1.0-2.0*r1;float r=sqrt(max(0.0,1.0-z*z));float phi=TWOPI*r2;return vec3(r*cos(phi),r*sin(phi),z);}float LGL_Ar(float f,float g){return(f*f)/(f*f+g*g);}vec3 LGL_As(in Ray r,int depth,in LightSampleRec lightSampleRec,in BsdfSampleRec bsdfSampleRec){vec3 Le;if(depth==0){Le=lightSampleRec.emission;}else{Le=LGL_Ar(bsdfSampleRec.pdf,lightSampleRec.pdf)*lightSampleRec.emission;}return Le;}
#if defined(NUM_LIGHTS)
void sampleAreaLight(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec,vec2 LGL_Aaom){float r1=LGL_Aaom.x-0.5;float r2=LGL_Aaom.y-0.5;vec3 lightSurfacePos=light.position+light.p1*r1+light.p2*r2;lightSampleRec.direction=lightSurfacePos-surfacePos;lightSampleRec.dist=length(lightSampleRec.direction);float distSq=lightSampleRec.dist*lightSampleRec.dist;lightSampleRec.direction/=lightSampleRec.dist;lightSampleRec.normal=normalize(cross(light.p1,light.p2));lightSampleRec.emission=light.emission*float(NUM_LIGHTS);lightSampleRec.pdf=distSq/(light.area*abs(dot(lightSampleRec.normal,lightSampleRec.direction)));}void LGL_Aw(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec){lightSampleRec.direction=normalize(light.position-light.p1);lightSampleRec.normal=normalize(surfacePos-light.position);if(dot(lightSampleRec.direction,lightSampleRec.normal)>0.0){lightSampleRec.normal=-lightSampleRec.normal;}lightSampleRec.emission=light.emission*float(NUM_LIGHTS);lightSampleRec.dist=INF;lightSampleRec.pdf=1.0;}void samplePointLight(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec){lightSampleRec.direction=light.position-surfacePos;lightSampleRec.dist=length(lightSampleRec.direction);float distSq=lightSampleRec.dist*lightSampleRec.dist;lightSampleRec.direction=normalize(lightSampleRec.direction);lightSampleRec.normal=normalize(surfacePos-light.position);lightSampleRec.emission=light.emission*float(NUM_LIGHTS)/distSq;lightSampleRec.pdf=1.0;}void LGL_Ax(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec,vec2 LGL_Aaom){int type=int(light.type);if(type==0){sampleAreaLight(light,surfacePos,lightSampleRec,LGL_Aaom);}else if(type==1){LGL_Aw(light,surfacePos,lightSampleRec);}else if(type==2){samplePointLight(light,surfacePos,lightSampleRec);}}
#endif
#ifdef NUM_MATERIALS
uniform Materials{vec4 colorWorkflow[NUM_MATERIALS];vec4 roughMetalTransIOR[NUM_MATERIALS];vec4 sheenTintClearcoatRoughness[NUM_MATERIALS];vec4 emissiveAlpha[NUM_MATERIALS];vec4 specularTintAtDistanceNormalScale[NUM_MATERIALS];vec4 subsurfaceAndColor[NUM_MATERIALS];vec4 extinctionSubsurfaceMFP[NUM_MATERIALS];vec4 specularColorGlossiness[NUM_MATERIALS];ivec4 diffuseNormalRoughnessMetalnessMapIndex[NUM_MATERIALS];ivec4 emissiveSpecularGlossinessMapIndex[NUM_MATERIALS];}materials;
#endif
uniform mediump sampler2DArray materialTexArray;vec3 srgbToLinear(vec3 srgb){return pow(srgb,vec3(2.2));}
#if defined(SUPPORT_UV_TRANS) || defined(SUPPORT_TEX_WRAP)
uniform sampler2D uvTransBuffer;
#define UV_TRANS_MAPS_LEN 7
#endif
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Be(int materialID,int mapKey){int offset=materialID*UV_TRANS_MAPS_LEN*3;int mapOffset=mapKey*3;vec3 LGL_BZ=LGL_Aj(uvTransBuffer,offset+mapOffset+0,UV_TRANS_COLUMNS).xyz;vec3 LGL_Ba=LGL_Aj(uvTransBuffer,offset+mapOffset+1,UV_TRANS_COLUMNS).xyz;vec3 LGL_Bb=LGL_Aj(uvTransBuffer,offset+mapOffset+2,UV_TRANS_COLUMNS).xyz;mat3 LGL_Bk=mat3(LGL_BZ,LGL_Ba,LGL_Bb);return LGL_Bk;}
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bf(int materialID,int mapKey){int offset=TEX_WRAP_DATA_INDEX+materialID*UV_TRANS_MAPS_LEN;int mapOffset=mapKey;vec3 wrappingData=LGL_Aj(uvTransBuffer,offset+mapOffset,UV_TRANS_COLUMNS).xyz;return wrappingData;}vec2 applyTextureWrapping(vec2 uv,vec3 LGL_Bh){if(uv.x<=0.||uv.x>=1.){int LGL_Bi=int(LGL_Bh.x);if(LGL_Bi==1){uv.x=uv.x<=0. ? 0. : 1.;}else if(LGL_Bi==2){uv.x=1.0-abs(fract(uv.x*0.5)*2.0-1.0);}else{uv.x=fract(uv.x);}}if(uv.y<=0.||uv.y>=1.){int LGL_Bj=int(LGL_Bh.y);if(LGL_Bj==1){uv.y=uv.y<=0. ? 0. : 1.;}else if(LGL_Bj==2){uv.y=1.0-abs(fract(uv.y*0.5)*2.0-1.0);}else{uv.y=fract(uv.y);}}return uv;}
#endif
#ifdef SUPPORT_SG_WORKFLOW
float LGL_AC(const vec3 v){return max(v.x,max(v.y,v.z));}float LGL_AD(const vec3 specularColor){return LGL_AC(specularColor);}vec3 LGL_AE(const vec3 baseColor,float metallic){return baseColor*(1.0-metallic);}vec3 LGL_z(int materialID,vec2 uv){vec3 specularColor=materials.specularColorGlossiness[materialID].rgb;int specularMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialID].y;if(specularMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,4);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,4);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
vec3 LGL_AV=srgbToLinear(texture(materialTexArray,vec3(uv,specularMapIndex)).rgb);specularColor*=LGL_AV;}return specularColor;}float LGL_AA(int materialID,vec2 uv){float glossiness=materials.specularColorGlossiness[materialID].a;int glossinessMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialID].z;if(glossinessMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,5);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,5);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
float LGL_AW=texture(materialTexArray,vec3(uv,glossinessMapIndex)).a;glossiness*=LGL_AW;}return glossiness;}
#endif
vec4 LGL_AGAlpha(int materialID,vec2 uv){vec3 color=materials.colorWorkflow[materialID].rgb;float alpha=materials.emissiveAlpha[materialID].a;int diffuseMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialID].x;if(diffuseMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,0);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,0);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
vec4 texData=texture(materialTexArray,vec3(uv,diffuseMapIndex));color*=srgbToLinear(texData.rgb);alpha*=texData.a;}
#ifdef SUPPORT_SG_WORKFLOW
float workflow=materials.colorWorkflow[materialID].w;if(workflow>0.1){vec3 specularFactor=LGL_z(materialID,uv);color=LGL_AE(color,LGL_AD(specularFactor));}
#endif
return vec4(color,alpha);}float LGL_AB(int materialID,vec2 uv){float workflow=materials.colorWorkflow[materialID].w;float roughness=0.0;
#ifdef SUPPORT_SG_WORKFLOW
if(workflow>0.1){roughness=1.0-LGL_AA(materialID,uv);}else
#endif
{roughness=materials.roughMetalTransIOR[materialID].x;int roughnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialID].z;if(roughnessMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,2);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,2);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
roughness*=texture(materialTexArray,vec3(uv,roughnessMapIndex)).g;}}return roughness*roughness;}float LGL_AF(int materialID,vec2 uv){float workflow=materials.colorWorkflow[materialID].w;float metalness=0.0;
#ifdef SUPPORT_SG_WORKFLOW
if(workflow>0.1){vec3 specularFactor=LGL_z(materialID,uv);metalness=LGL_AD(specularFactor);}else
#endif
{metalness=materials.roughMetalTransIOR[materialID].y;int metalnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialID].w;if(metalnessMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,3);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,3);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
metalness*=texture(materialTexArray,vec3(uv,metalnessMapIndex)).b;}}return metalness;}vec3 LGL_y(int materialID,vec2 uv){vec3 emissive=materials.emissiveAlpha[materialID].xyz;int emissiveMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialID].x;if(emissiveMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,6);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,6);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
emissive*=srgbToLinear(texture(materialTexArray,vec3(uv,emissiveMapIndex)).rgb);}return emissive;}vec3 LGL_AI(int materialID,vec2 uv,vec3 normal,vec3 dp1,vec3 dp2,vec2 duv1,vec2 duv2){vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 dpdu=dp2perp*duv1.x+dp1perp*duv2.x;vec3 dpdv=dp2perp*duv1.y+dp1perp*duv2.y;float invmax=inversesqrt(max(dot(dpdu,dpdu),dot(dpdv,dpdv)));dpdu*=invmax;dpdv*=invmax;int normalMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialID].y;if(normalMapIndex>-1){
#ifdef SUPPORT_UV_TRANS
mat3 LGL_Bk=LGL_Be(materialID,1);uv=(LGL_Bk*vec3(uv,1)).xy;
#endif
#ifdef SUPPORT_TEX_WRAP
vec3 LGL_Bh=LGL_Bf(materialID,1);uv=applyTextureWrapping(uv,LGL_Bh);
#endif
vec3 n=2.0*texture(materialTexArray,vec3(uv,normalMapIndex)).rgb-1.0;n.xy*=materials.specularTintAtDistanceNormalScale[materialID].zw;mat3 tbn=mat3(dpdu,dpdv,normal);return normalize(tbn*n);}else{return normal;}return normal;}float LGL_AJ(int materialID){return materials.specularTintAtDistanceNormalScale[materialID].x;}float LGL_AS(int materialID){return materials.specularTintAtDistanceNormalScale[materialID].y;}float LGL_AP(int materialID){return materials.subsurfaceAndColor[materialID].x;}vec3 LGL_APColor(int materialID){return materials.subsurfaceAndColor[materialID].yzw;}vec3 LGL_AU(int materialID){return materials.extinctionSubsurfaceMFP[materialID].rgb;}float getMatSubsurfaceMFP(int materialID){return materials.extinctionSubsurfaceMFP[materialID].a;}uniform sampler2D positionBuffer;uniform sampler2D normalBuffer;
#if defined(BVH_DYNAMIC)
uniform sampler2D blasBuffer;uniform sampler2D tlasBuffer;uniform sampler2D tlasTransformBuffer;
#else
uniform sampler2D bvhBuffer;
#endif
struct Triangle{vec3 p0;vec3 p1;vec3 p2;};struct TriangleIntersect{float t;vec3 barycentric;};float rectIntersect(in vec3 pos,in vec3 u,in vec3 v,in vec4 plane,in Ray r){vec3 n=vec3(plane);float dt=dot(r.d,n);float t=(plane.w-dot(n,r.o))/dt;if(t>EPS){vec3 p=r.o+r.d*t;vec3 vi=p-pos;float a1=dot(u,vi);if(abs(a1)<=0.5){float a2=dot(v,vi);if(abs(a2)<=0.5)return t;}}return INF;}TriangleIntersect LGL_k(Ray r,Triangle tri,float LGL_BP){vec3 v0=tri.p0;vec3 v1=tri.p1;vec3 v2=tri.p2;TriangleIntersect ti;vec3 e0=v1-v0;vec3 e1=v2-v0;vec3 pv=cross(r.d,e1);float det=dot(e0,pv);vec3 tv=r.o-v0;vec3 qv=cross(tv,e0);vec4 uvt;uvt.x=dot(tv,pv);uvt.y=dot(r.d,qv);uvt.z=dot(e1,qv);uvt.xyz=uvt.xyz/det;uvt.w=1.0-uvt.x-uvt.y;if(uvt.z>=LGL_BP){return ti;}if(all(greaterThanEqual(uvt,vec4(0.0)))&&uvt.z<INF){ti.t=uvt.z;ti.barycentric=uvt.wxy;}return ti;}float LGL_l(Ray r,vec3 aabbMin,vec3 aabbMax,vec3 LGL_BOir,float LGL_BP){vec3 tBot=(aabbMin-r.o)*LGL_BOir;vec3 tTop=(aabbMax-r.o)*LGL_BOir;vec3 tNear=min(tBot,tTop);vec3 tFar=max(tBot,tTop);float t0=max(tNear.x,max(tNear.y,tNear.z));float t1=min(tFar.x,min(tFar.y,tFar.z));return(t0>t1||t0>LGL_BP)?-1.0 :(t0>0.0 ? t0 : t1);}void LGL_j(inout SurfaceInteraction si,Triangle tri,vec3 barycentric,ivec3 index,vec3 u,int materialID){si.LGL_BL=true;si.position=barycentric.x*tri.p0+barycentric.y*tri.p1+barycentric.z*tri.p2;ivec2 i0=LGL_Ai(index.x,VERTEX_COLUMNS);ivec2 i1=LGL_Ai(index.y,VERTEX_COLUMNS);ivec2 i2=LGL_Ai(index.z,VERTEX_COLUMNS);vec4 nv0=texelFetch(normalBuffer,i0,0);vec4 nv1=texelFetch(normalBuffer,i1,0);vec4 nv2=texelFetch(normalBuffer,i2,0);vec3 n0=nv0.xyz;vec3 n1=nv1.xyz;vec3 n2=nv2.xyz;vec3 normal=normalize(barycentric.x*n0+barycentric.y*n1+barycentric.z*n2);vec2 uv0=vec2(u.x,nv0.w);vec2 uv1=vec2(u.y,nv1.w);vec2 uv2=vec2(u.z,nv2.w);vec2 uv=barycentric.x*uv0+barycentric.y*uv1+barycentric.z*uv2;vec3 dp1=tri.p0-tri.p2;vec3 dp2=tri.p1-tri.p2;vec2 duv1=uv0-uv2;vec2 duv2=uv1-uv2;si.normal=LGL_AI(materialID,uv,normal,dp1,dp2,duv1,duv2);si.workflow=materials.colorWorkflow[materialID].w;vec4 colorAlpha=LGL_AGAlpha(materialID,uv);si.color=colorAlpha.rgb;si.alpha=colorAlpha.a;si.emissive=LGL_y(materialID,uv);si.roughness=clamp(LGL_AB(materialID,uv),ROUGHNESS_MIN,1.0);si.metalness=LGL_AF(materialID,uv);si.transmission=materials.roughMetalTransIOR[materialID].z;si.ior=materials.roughMetalTransIOR[materialID].w;si.sheen=materials.sheenTintClearcoatRoughness[materialID].x;si.sheenTint=materials.sheenTintClearcoatRoughness[materialID].y;si.clearcoat=materials.sheenTintClearcoatRoughness[materialID].z;si.clearcoatRoughness=materials.sheenTintClearcoatRoughness[materialID].w;si.specularTint=materials.specularTintAtDistanceNormalScale[materialID].x;si.atDistance=materials.specularTintAtDistanceNormalScale[materialID].y;si.subsurface=materials.subsurfaceAndColor[materialID].x;si.extinction=materials.extinctionSubsurfaceMFP[materialID].rgb;
#ifdef SUPPORT_SG_WORKFLOW
si.specularColor=LGL_z(materialID,uv);
#endif
}
#ifndef BVH_DYNAMIC
bool LGL_m(inout Ray ray,float maxDist){vec3 LGL_BOir=1./ray.d;float LGL_BP=maxDist;int LGL_p[STACK_SIZE];LGL_p[0]=0;int LGL_t=0;while(LGL_t>=0&&LGL_t<STACK_SIZE){int i=LGL_p[LGL_t--];vec4 r1=LGL_Aj(bvhBuffer,i,BVH_COLUMNS);vec4 r2=LGL_Aj(bvhBuffer,i+1,BVH_COLUMNS);int LGL_q=int(r1.w);if(LGL_q>=0){int LGL_r=LGL_q;if(LGL_l(ray,r1.xyz,r2.xyz,LGL_BOir,LGL_BP)>0.0){if(ray.d[LGL_r]>0.0){LGL_p[++LGL_t]=int(r2.w);LGL_p[++LGL_t]=i+2;}else{LGL_p[++LGL_t]=i+2;LGL_p[++LGL_t]=int(r2.w);}}}else{ivec3 index=ivec3(r1.xyz);Triangle tri=Triangle(LGL_Aj(positionBuffer,index.x,VERTEX_COLUMNS).xyz,LGL_Aj(positionBuffer,index.y,VERTEX_COLUMNS).xyz,LGL_Aj(positionBuffer,index.z,VERTEX_COLUMNS).xyz);TriangleIntersect LGL_BL=LGL_k(ray,tri,LGL_BP);if(LGL_BL.t>0.0){return true;}}}return false;}void LGL_n(Ray ray,inout SurfaceInteraction si,inout LightSampleRec lightSampleRec,int depth,float maxDist){si.LGL_BL=false;float LGL_BP=maxDist;vec3 LGL_BOir=1./ray.d;float curDist;
#if defined(NUM_LIGHTS)
for(int i=0;i<NUM_LIGHTS;i++){vec4 params=lights.params[i];float radius=params.x;float area=params.y;float type=params.z;float LGL_s=params.w;if(depth==0&&LGL_s<0.1)continue;vec3 position=lights.position[i];vec3 emission=lights.emission[i];vec3 p1=lights.p1[i];vec3 p2=lights.p2[i];if(type==0.){vec3 normal=normalize(cross(p1,p2));if(dot(normal,ray.d)>0.)continue;vec4 plane=vec4(normal,dot(normal,position));p1*=1.0/dot(p1,p1);p2*=1.0/dot(p2,p2);curDist=rectIntersect(position,p1,p2,plane,ray);if(curDist<0.)curDist=INF;if(curDist<LGL_BP){LGL_BP=curDist;float cosTheta=dot(-ray.d,normal);float pdf=(curDist*curDist)/(area*cosTheta);lightSampleRec.emission=emission;lightSampleRec.pdf=pdf;si.LGL_BL=true;si.isEmitter=true;}}}
#endif
int LGL_p[STACK_SIZE];LGL_p[0]=0;int LGL_t=0;while(LGL_t>=0&&LGL_t<STACK_SIZE){int i=LGL_p[LGL_t--];vec4 r1=LGL_Aj(bvhBuffer,i,BVH_COLUMNS);vec4 r2=LGL_Aj(bvhBuffer,i+1,BVH_COLUMNS);int LGL_q=int(r1.w);if(LGL_q>=0){int LGL_r=LGL_q;if(LGL_l(ray,r1.xyz,r2.xyz,LGL_BOir,LGL_BP)>0.0){if(ray.d[LGL_r]>0.0){LGL_p[++LGL_t]=int(r2.w);LGL_p[++LGL_t]=i+2;}else{LGL_p[++LGL_t]=i+2;LGL_p[++LGL_t]=int(r2.w);}}}else{ivec3 index=ivec3(r1.xyz);vec4 pu0=LGL_Aj(positionBuffer,index.x,VERTEX_COLUMNS);vec4 pu1=LGL_Aj(positionBuffer,index.y,VERTEX_COLUMNS);vec4 pu2=LGL_Aj(positionBuffer,index.z,VERTEX_COLUMNS);Triangle tri=Triangle(pu0.xyz,pu1.xyz,pu2.xyz);TriangleIntersect LGL_BL=LGL_k(ray,tri,LGL_BP);if(LGL_BL.t>0.0){int materialID=int(r2.w);vec3 LGL_BN=r2.xyz;si.t=LGL_BL.t;si.isEmitter=false;LGL_BP=LGL_BL.t;vec3 u=vec3(pu0.w,pu1.w,pu2.w);LGL_j(si,tri,LGL_BL.barycentric,index,u,materialID);si.LGL_BM=dot(LGL_BN,ray.d)<=0.0 ? si.normal :-si.normal;si.eta=dot(si.normal,si.LGL_BM)>0.0 ?(1.0/si.ior): si.ior;}}}}
#endif
#ifdef BVH_DYNAMIC
bool LGL_m(Ray ray,float maxDist){float LGL_BP=maxDist;const int SHADOW_STACK_SIZE=20;int LGL_p[SHADOW_STACK_SIZE];int nodesLevel[SHADOW_STACK_SIZE];LGL_p[0]=0;nodesLevel[0]=0;vec3 LGL_BOirWorld=1./ray.d;vec3 LGL_BOirLocal=vec3(1.);int LGL_BV=0;int tlasMeshID=0;mat4 LGL_BX;mat4 LGL_BXInverse;Ray LGL_BY=Ray(ray.o,ray.d);bool throughBLASMark=false;int LGL_t=0;while(LGL_t>=0&&LGL_t<SHADOW_STACK_SIZE){int i=LGL_p[LGL_t];int level=nodesLevel[LGL_t];LGL_t--;if(throughBLASMark&&i==-1){throughBLASMark=false;LGL_BY.o=ray.o;LGL_BY.d=ray.d;continue;}if(level==0){vec4 r1=LGL_Aj(tlasBuffer,i,TLAS_COLUMNS);vec4 r2=LGL_Aj(tlasBuffer,i+1,TLAS_COLUMNS);int typeFlag=int(r1.w);if(typeFlag>=0){if(LGL_l(LGL_BY,r1.xyz,r2.xyz,LGL_BOirWorld,LGL_BP)>0.0){if(LGL_BY.d[typeFlag]>0.0){LGL_t++;LGL_p[LGL_t]=int(r2.w);nodesLevel[LGL_t]=0;LGL_t++;LGL_p[LGL_t]=i+2;nodesLevel[LGL_t]=0;}else{LGL_t++;LGL_p[LGL_t]=i+2;nodesLevel[LGL_t]=0;LGL_t++;LGL_p[LGL_t]=int(r2.w);nodesLevel[LGL_t]=0;}}}else{int LGL_s=int(r2.x);if(LGL_s==0){continue;}int LGL_u=int(r1.z);vec4 LGL_BZ=LGL_Aj(tlasTransformBuffer,LGL_u*4+0,TLAS_TRANSFORM_COLUMNS).xyzw;vec4 LGL_Ba=LGL_Aj(tlasTransformBuffer,LGL_u*4+1,TLAS_TRANSFORM_COLUMNS).xyzw;vec4 LGL_Bb=LGL_Aj(tlasTransformBuffer,LGL_u*4+2,TLAS_TRANSFORM_COLUMNS).xyzw;vec4 LGL_Bc=LGL_Aj(tlasTransformBuffer,LGL_u*4+3,TLAS_TRANSFORM_COLUMNS).xyzw;LGL_BX=mat4(LGL_BZ,LGL_Ba,LGL_Bb,LGL_Bc);LGL_BXInverse=inverse(LGL_BX);LGL_BY.o=vec3(LGL_BXInverse*vec4(ray.o,1.0));LGL_BY.d=vec3(LGL_BXInverse*vec4(ray.d,0.0));LGL_BOirLocal=1./LGL_BY.d;LGL_t++;throughBLASMark=true;LGL_p[LGL_t]=-1;nodesLevel[LGL_t]=-1;LGL_t++;LGL_p[LGL_t]=int(r1.x);nodesLevel[LGL_t]=1;LGL_BV=int(r1.y);tlasMeshID=int(r1.z);}}else{vec4 r1=LGL_Aj(blasBuffer,i,BLAS_COLUMNS);vec4 r2=LGL_Aj(blasBuffer,i+1,BLAS_COLUMNS);int typeFlag=int(r1.w);if(typeFlag>=0){if(LGL_l(LGL_BY,r1.xyz,r2.xyz,LGL_BOirLocal,LGL_BP)>0.0){if(LGL_BY.d[typeFlag]>0.0){LGL_t++;LGL_p[LGL_t]=int(r2.w);nodesLevel[LGL_t]=1;LGL_t++;LGL_p[LGL_t]=i+2;nodesLevel[LGL_t]=1;}else{LGL_t++;LGL_p[LGL_t]=i+2;nodesLevel[LGL_t]=1;LGL_t++;LGL_p[LGL_t]=int(r2.w);nodesLevel[LGL_t]=1;}}}else{ivec3 index=ivec3(r1.xyz);vec4 pu0=LGL_Aj(positionBuffer,index.x,VERTEX_COLUMNS);vec4 pu1=LGL_Aj(positionBuffer,index.y,VERTEX_COLUMNS);vec4 pu2=LGL_Aj(positionBuffer,index.z,VERTEX_COLUMNS);Triangle tri=Triangle(pu0.xyz,pu1.xyz,pu2.xyz);TriangleIntersect LGL_BL=LGL_k(LGL_BY,tri,LGL_BP);if(LGL_BL.t>0.0){return true;}}}}return false;}void LGL_n(Ray ray,inout SurfaceInteraction si,inout LightSampleRec lightSampleRec,int depth,float maxDist){si.LGL_BL=false;float LGL_BP=maxDist;float curDist;
#if defined(NUM_LIGHTS)
for(int i=0;i<NUM_LIGHTS;i++){vec4 params=lights.params[i];float radius=params.x;float area=params.y;float type=params.z;float LGL_s=params.w;if(depth==0&&LGL_s<0.1)continue;vec3 position=lights.position[i];vec3 emission=lights.emission[i];vec3 p1=lights.p1[i];vec3 p2=lights.p2[i];if(type==0.){vec3 normal=normalize(cross(p1,p2));if(dot(normal,ray.d)>0.)continue;vec4 plane=vec4(normal,dot(normal,position));p1*=1.0/dot(p1,p1);p2*=1.0/dot(p2,p2);curDist=rectIntersect(position,p1,p2,plane,ray);if(curDist<0.)curDist=INF;if(curDist<LGL_BP){LGL_BP=curDist;float cosTheta=dot(-ray.d,normal);float pdf=(curDist*curDist)/(area*cosTheta);lightSampleRec.emission=emission;lightSampleRec.pdf=pdf;si.LGL_BL=true;si.isEmitter=true;}}}
#endif
int LGL_p[STACK_SIZE];int nodesLevel[STACK_SIZE];LGL_p[0]=0;nodesLevel[0]=0;vec3 LGL_BOirWorld=1./ray.d;vec3 LGL_BOirLocal=vec3(1.);int LGL_BV=0;int tlasMeshID=0;mat4 LGL_BX;mat4 LGL_BXInverse;Ray LGL_BY=Ray(ray.o,ray.d);bool throughBLASMark=false;int LGL_t=0;while(LGL_t>=0&&LGL_t<STACK_SIZE){int i=LGL_p[LGL_t];int level=nodesLevel[LGL_t];LGL_t--;if(throughBLASMark&&i==-1){throughBLASMark=false;LGL_BY.o=ray.o;LGL_BY.d=ray.d;continue;}if(level==0){vec4 r1=LGL_Aj(tlasBuffer,i,TLAS_COLUMNS);vec4 r2=LGL_Aj(tlasBuffer,i+1,TLAS_COLUMNS);int typeFlag=int(r1.w);if(typeFlag>=0){if(LGL_l(LGL_BY,r1.xyz,r2.xyz,LGL_BOirWorld,LGL_BP)>0.0){if(LGL_BY.d[typeFlag]>0.0){LGL_t++;LGL_p[LGL_t]=int(r2.w);nodesLevel[LGL_t]=0;LGL_t++;LGL_p[LGL_t]=i+2;nodesLevel[LGL_t]=0;}else{LGL_t++;LGL_p[LGL_t]=i+2;nodesLevel[LGL_t]=0;LGL_t++;LGL_p[LGL_t]=int(r2.w);nodesLevel[LGL_t]=0;}}}else{int LGL_s=int(r2.x);if(LGL_s==0){continue;}int LGL_u=int(r1.z);vec4 LGL_BZ=LGL_Aj(tlasTransformBuffer,LGL_u*4+0,TLAS_TRANSFORM_COLUMNS).xyzw;vec4 LGL_Ba=LGL_Aj(tlasTransformBuffer,LGL_u*4+1,TLAS_TRANSFORM_COLUMNS).xyzw;vec4 LGL_Bb=LGL_Aj(tlasTransformBuffer,LGL_u*4+2,TLAS_TRANSFORM_COLUMNS).xyzw;vec4 LGL_Bc=LGL_Aj(tlasTransformBuffer,LGL_u*4+3,TLAS_TRANSFORM_COLUMNS).xyzw;LGL_BX=mat4(LGL_BZ,LGL_Ba,LGL_Bb,LGL_Bc);LGL_BXInverse=inverse(LGL_BX);LGL_BY.o=vec3(LGL_BXInverse*vec4(ray.o,1.0));LGL_BY.d=vec3(LGL_BXInverse*vec4(ray.d,0.0));LGL_BOirLocal=1./LGL_BY.d;LGL_t++;throughBLASMark=true;LGL_p[LGL_t]=-1;nodesLevel[LGL_t]=-1;LGL_t++;LGL_p[LGL_t]=int(r1.x);nodesLevel[LGL_t]=1;LGL_BV=int(r1.y);tlasMeshID=int(r1.z);}}else{vec4 r1=LGL_Aj(blasBuffer,i,BLAS_COLUMNS);vec4 r2=LGL_Aj(blasBuffer,i+1,BLAS_COLUMNS);int typeFlag=int(r1.w);if(typeFlag>=0){if(LGL_l(LGL_BY,r1.xyz,r2.xyz,LGL_BOirLocal,LGL_BP)>0.0){if(LGL_BY.d[typeFlag]>0.0){LGL_t++;LGL_p[LGL_t]=int(r2.w);nodesLevel[LGL_t]=1;LGL_t++;LGL_p[LGL_t]=i+2;nodesLevel[LGL_t]=1;}else{LGL_t++;LGL_p[LGL_t]=i+2;nodesLevel[LGL_t]=1;LGL_t++;LGL_p[LGL_t]=int(r2.w);nodesLevel[LGL_t]=1;}}}else{ivec3 index=ivec3(r1.xyz);vec4 pu0=LGL_Aj(positionBuffer,index.x,VERTEX_COLUMNS);vec4 pu1=LGL_Aj(positionBuffer,index.y,VERTEX_COLUMNS);vec4 pu2=LGL_Aj(positionBuffer,index.z,VERTEX_COLUMNS);Triangle tri=Triangle(pu0.xyz,pu1.xyz,pu2.xyz);TriangleIntersect LGL_BL=LGL_k(LGL_BY,tri,LGL_BP);if(LGL_BL.t>0.0){vec3 LGL_BN=r2.xyz;si.t=LGL_BL.t;si.isEmitter=false;LGL_BP=LGL_BL.t;vec3 u=vec3(pu0.w,pu1.w,pu2.w);LGL_j(si,tri,LGL_BL.barycentric,index,u,LGL_BV);si.position=vec3(LGL_BX*vec4(si.position,1.0));mat3 inverseNormalMat=transpose(mat3(LGL_BXInverse));si.normal=normalize(inverseNormalMat*si.normal);si.LGL_BM=dot(normalize(inverseNormalMat*LGL_BN),ray.d)<=0.0 ? si.normal :-si.normal;si.eta=dot(si.normal,si.LGL_BM)>0.0 ?(1.0/si.ior): si.ior;}}}}}
#endif
float LGL_B(float eta){float sqrtR0=(eta-1.)/(eta+1.);return sqrtR0*sqrtR0;}float LGL_E(float u){float m=clamp(1.0-u,0.0,1.0);float m2=m*m;return m2*m2*m;}float LGL_F(float F0,float cosTheta){return mix(F0,1.0,LGL_E(cosTheta));}vec3 LGL_F(vec3 F0,float cosTheta){return mix(F0,vec3(1.),LGL_E(cosTheta));}float LGL_G(float cosThetaI,float eta){float sinThetaTSq=eta*eta*(1.0f-cosThetaI*cosThetaI);if(sinThetaTSq>1.0)return 1.0;float cosThetaT=sqrt(max(1.0-sinThetaTSq,0.0));float rs=(eta*cosThetaT-cosThetaI)/(eta*cosThetaT+cosThetaI);float rp=(eta*cosThetaI-cosThetaT)/(eta*cosThetaI+cosThetaT);return 0.5*(rs*rs+rp*rp);}vec3 LGL_H(vec3 F0,float metalness,float eta,float cosThetaI){vec3 FrSchlick=LGL_F(F0,cosThetaI);float FrDielectric=LGL_G(cosThetaI,eta);return mix(vec3(FrDielectric),FrSchlick,metalness);}float LGL_H(float metalness,float eta,float cosThetaI){float FrSchlick=LGL_E(cosThetaI);float FrDielectric=LGL_G(cosThetaI,eta);return mix(FrDielectric,FrSchlick,metalness);}float LGL_I(float NDotV,float alphaG){float a=alphaG*alphaG;float b=NDotV*NDotV;return 1.0/(NDotV+sqrt(a+b-a*b));}float LGL_J(float NDotH,float alpha){float alpha2=alpha*alpha;float t=1.0+(alpha2-1.0)*NDotH*NDotH;return(alpha2-1.0)/(PI*log(alpha2)*t);}float LGL_K(float NDotH,float a){float a2=a*a;float t=1.0+(a2-1.0)*NDotH*NDotH;return a2/(PI*t*t);}vec3 ISLGL_J(float rgh,float r1,float r2){float a=max(0.001,rgh);float a2=a*a;float phi=r1*TWOPI;float cosTheta=sqrt((1.0-pow(a2,1.0-r1))/(1.0-a2));float sinTheta=clamp(sqrt(1.0-(cosTheta*cosTheta)),0.0,1.0);float sinPhi=sin(phi);float cosPhi=cos(phi);return vec3(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}vec3 ISLGL_K(float rgh,float r1,float r2){float a=max(0.001,rgh);float phi=r1*TWOPI;float cosTheta=sqrt((1.0-r2)/(1.0+(a*a-1.0)*r2));float sinTheta=clamp(sqrt(1.0-(cosTheta*cosTheta)),0.0,1.0);float sinPhi=sin(phi);float cosPhi=cos(phi);return vec3(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}vec3 LGL_N(SurfaceInteraction si,vec3 Csheen,vec3 V,vec3 L,vec3 H,out float pdf){pdf=0.0;if(L.z<=0.0)return vec3(0.0);pdf=L.z*INVPI;float LDotH=dot(L,H);float FL=LGL_E(L.z);float FV=LGL_E(V.z);float Fh=LGL_E(LDotH);float Fd90=0.5+2.0*LDotH*LDotH*si.roughness;float Fd=mix(1.0,Fd90,FL)*mix(1.0,Fd90,FV);float Fss90=LDotH*LDotH*si.roughness;float Fss=mix(1.0,Fss90,FL)*mix(1.0,Fss90,FV);float DisneyFakeSS=1.25*(Fss*(1.0/(L.z+V.z)-0.5)+0.5);vec3 Fsheen=Fh*si.sheen*Csheen;return(INVPI*mix(Fd,DisneyFakeSS,si.subsurface)*si.color+Fsheen)*(1.0-si.metalness)*(1.0-si.transmission);}vec3 LGL_O(SurfaceInteraction si,vec3 Cspec0,vec3 V,vec3 L,vec3 H,out float pdf){pdf=0.0;if(L.z<=0.0)return vec3(0.0);float LDotH=dot(L,H);float D=LGL_K(H.z,si.roughness);pdf=D*H.z/(4.0*LDotH);vec3 F=LGL_H(Cspec0,si.metalness,si.eta,LDotH);float G=LGL_I(abs(L.z),si.roughness)*LGL_I(abs(V.z),si.roughness);return F*D*G;}vec3 DisneyTransmission(SurfaceInteraction si,vec3 Cspec0,vec3 V,vec3 L,vec3 H,out float pdf){pdf=0.0;if(L.z>=0.0)return vec3(0.0);float F=LGL_G(abs(dot(V,H)),si.eta);float D=LGL_K(H.z,si.roughness);float denomSqrt=dot(L,H)+dot(V,H)*si.eta;pdf=D*H.z*abs(dot(L,H))/(denomSqrt*denomSqrt);float G=LGL_I(abs(L.z),si.roughness)*LGL_I(abs(V.z),si.roughness);vec3 specColor=pow(si.color,vec3(0.5));return specColor*(1.0-si.metalness)*si.transmission*(1.0-F)*D*G*abs(dot(V,H))*abs(dot(L,H))*4.0*si.eta*si.eta/(denomSqrt*denomSqrt);}vec3 LGL_Q(SurfaceInteraction si,vec3 V,vec3 L,vec3 H,out float pdf){pdf=0.0;if(L.z<=0.0)return vec3(0.0);float LDotH=dot(L,H);float F=LGL_F(.04,LDotH);float D=LGL_J(H.z,mix(0.1,0.001,1.-si.clearcoatRoughness));pdf=D*H.z/(4.0*LDotH);float G=LGL_I(L.z,0.25)*LGL_I(V.z,0.25);return vec3(0.25*si.clearcoat*F*D*G);}vec3 LGL_C(vec3 baseColor){float LGL_Ag=LGL_Af(baseColor);return(LGL_Ag>0.0)? baseColor/LGL_Ag : vec3(1.);}void LGL_D(SurfaceInteraction si,out vec3 Cspec0,out vec3 Csheen){vec3 tint=LGL_C(si.color);
#ifdef SUPPORT_SG_WORKFLOW
if(si.workflow>0.1){Cspec0=si.specularColor;}else
#endif
{Cspec0=mix(LGL_B(si.ior)*mix(vec3(1.0),tint,min(si.specularTint,0.99)),si.color,si.metalness);}Csheen=mix(vec3(1.0),tint,si.sheenTint);}void ComputeLobe(SurfaceInteraction si,vec3 Cspec0,float fresnelWeight,out float LGL_S,out float LGL_T,out float LGL_U,out float LGL_V){LGL_S=max(LGL_Af(si.color),si.sheen)*(1.0-si.metalness)*(1.0-si.transmission);LGL_T=LGL_Af(Cspec0);LGL_U=(1.0-fresnelWeight)*(1.0-si.metalness)*si.transmission*LGL_Af(si.color);LGL_V=si.clearcoat*(1.0-si.metalness);float weightSum=LGL_S+LGL_T+LGL_U+LGL_V;LGL_S/=weightSum;LGL_T/=weightSum;LGL_U/=weightSum;LGL_V/=weightSum;}vec3 PrincipledBSDFSample(SurfaceInteraction si,vec3 V,vec3 N,out vec3 L,out float pdf,MaterialSamples LGL_AaomSamples){pdf=0.0;vec3 f=vec3(0.0);vec2 bounceDirSample=LGL_AaomSamples.s3;vec2 diffuseOrSpecular=LGL_AaomSamples.s4;float r1=bounceDirSample.x;float r2=bounceDirSample.y;vec3 Cspec0,Csheen;LGL_D(si,Cspec0,Csheen);vec3 T,B;LGL_Al(N,T,B);V=worldToLocal(T,B,N,V);float LGL_S,LGL_T,LGL_U,LGL_V;float fresnelWeight=LGL_H(si.metalness,si.eta,V.z);ComputeLobe(si,Cspec0,fresnelWeight,LGL_S,LGL_T,LGL_U,LGL_V);float cdf[4];cdf[0]=LGL_S;cdf[1]=cdf[0]+LGL_T;cdf[2]=cdf[1]+LGL_U;cdf[3]=cdf[2]+LGL_V;if(r1<cdf[0]){r1/=cdf[0];L=LGL_A(r1,r2);vec3 H=normalize(L+V);f=LGL_N(si,Csheen,V,L,H,pdf);pdf*=LGL_S;}else if(r1<cdf[1]){r1=(r1-cdf[0])/(cdf[1]-cdf[0]);vec3 H=ISLGL_K(si.roughness,r1,r2);if(dot(V,H)<0.0)H=-H;L=normalize(reflect(-V,H));f=LGL_O(si,Cspec0,V,L,H,pdf);pdf*=LGL_T;}else if(r1<cdf[2]){r1=(r1-cdf[1])/(cdf[2]-cdf[1]);vec3 H=ISLGL_K(si.roughness,r1,r2);if(dot(V,H)<0.0)H=-H;vec3 R=reflect(-V,H);L=normalize(refract(-V,H,si.eta));f=DisneyTransmission(si,Cspec0,V,L,H,pdf);pdf*=LGL_U;}else{r1=(r1-cdf[2])/(1.0-cdf[2]);vec3 H=ISLGL_J(mix(0.1,0.001,1.-si.clearcoatRoughness),r1,r2);if(dot(V,H)<0.0)H=-H;L=normalize(reflect(-V,H));f=LGL_Q(si,V,L,H,pdf);pdf*=LGL_V;}L=localToWorld(T,B,N,L);return f*abs(dot(N,L));}vec3 PrincipledBSDFMaterial(inout SurfaceInteraction si,vec3 V,vec3 L,out float bsdfPdf){bsdfPdf=0.0;vec3 f=vec3(0.0);vec3 N=si.LGL_BM;vec3 T,B;LGL_Al(N,T,B);V=worldToLocal(T,B,N,V);L=worldToLocal(T,B,N,L);vec3 H;if(L.z>0.0){H=normalize(L+V);}else{H=normalize(L+V*si.eta);}if(dot(V,H)<0.0){H=-H;}vec3 Cspec0,Csheen;LGL_D(si,Cspec0,Csheen);float LGL_S,LGL_T,LGL_U,LGL_V;float fresnelWeight=LGL_H(si.metalness,si.eta,abs(dot(L,H)));ComputeLobe(si,Cspec0,fresnelWeight,LGL_S,LGL_T,LGL_U,LGL_V);float pdf;if(LGL_S>0.0&&L.z>0.0){f+=LGL_N(si,Csheen,V,L,H,pdf);bsdfPdf+=pdf*LGL_S;}if(LGL_T>0.0&&L.z>0.0&&V.z>0.0){f+=LGL_O(si,Cspec0,V,L,H,pdf);bsdfPdf+=pdf*LGL_T;}if(LGL_U>0.0&&L.z<0.0){f+=DisneyTransmission(si,Cspec0,V,L,H,pdf);bsdfPdf+=pdf*LGL_U;}if(LGL_V>0.0&&L.z>0.0&&V.z>0.0){f+=LGL_Q(si,V,L,H,pdf);bsdfPdf+=pdf*LGL_V;}return f*abs(L.z);}vec3 computeDirectLight(inout SurfaceInteraction si,in Path path,in vec2 s1,in vec2 s2){vec3 viewDir=-path.ray.d;vec3 surfacePos=si.position+INTERSECT_EPS*si.LGL_BM;vec3 Li=vec3(0.0);BsdfSampleRec bsdfSampleRec;vec2 lightDirSample=s1;vec2 envDirSample=s2;vec3 lightDir;vec2 uv;float lightPdf;bool brdfSample=false;lightDir=invEnvRotMatrix*LGL_d(envDirSample,uv,lightPdf);path.ray=Ray(surfacePos,lightDir);if(!LGL_m(path.ray,INF-EPS)){vec3 irr=LGL_Az(envMap,uv).rgb*envMapIntensity;bsdfSampleRec.f=PrincipledBSDFMaterial(si,viewDir,lightDir,bsdfSampleRec.pdf);if(bsdfSampleRec.pdf>0.0){float LGL_BS=LGL_Ar(lightPdf,bsdfSampleRec.pdf);if(LGL_BS>0.0){Li+=LGL_BS*bsdfSampleRec.f*irr/lightPdf;}}}
#if defined(NUM_LIGHTS)
LightSampleRec lightSampleRec;Light light;int i=int(lightDirSample.x*float(NUM_LIGHTS));vec3 position=lights.position[i];vec3 emission=lights.emission[i];vec3 p1=lights.p1[i];vec3 p2=lights.p2[i];vec4 params=lights.params[i];float radius=params.x;float area=params.y;float type=params.z;float LGL_s=params.w;light=Light(position,radius,emission,area,p1,type,p2,LGL_s);LGL_Ax(light,surfacePos,lightSampleRec,lightDirSample);if(dot(lightSampleRec.direction,lightSampleRec.normal)<0.0){path.ray=Ray(surfacePos,lightSampleRec.direction);if(!LGL_m(path.ray,lightSampleRec.dist-EPS)){bsdfSampleRec.f=PrincipledBSDFMaterial(si,viewDir,lightSampleRec.direction,bsdfSampleRec.pdf);float LGL_BS=1.0;if(light.area>0.0&&bsdfSampleRec.pdf>0.0){LGL_BS=LGL_Ar(lightSampleRec.pdf,bsdfSampleRec.pdf);}if(LGL_BS>0.0){Li+=LGL_BS*bsdfSampleRec.f*lightSampleRec.emission/lightSampleRec.pdf;}}}
#endif
return Li;}layout(location=0)out vec4 out_light;void computeBounce(inout Path path,int depth,inout SurfaceInteraction si,inout BsdfSampleRec bsdfSampleRec,in LightSampleRec lightSampleRec){if(!si.LGL_BL){vec3 envSampleDir=envRotMatrix*path.ray.d;if(depth==0){path.li+=useBackgroundColor==1 ? backgroundColor : LGL_Z(envSampleDir)*envMapIntensity;path.alpha=backgroundAlpha;path.LGL_BR=true;return;}vec3 irr=LGL_Z(envSampleDir)*envMapIntensity;float LGL_BS=1.0;float lightPdf=LGL_c(envSampleDir);LGL_BS=LGL_Ar(bsdfSampleRec.pdf,lightPdf);path.li+=LGL_BS*path.beta*irr;path.LGL_BR=true;return;}if(si.isEmitter){path.li+=LGL_As(path.ray,depth,lightSampleRec,bsdfSampleRec)*path.beta;path.LGL_BR=true;return;}if(dot(si.normal,si.LGL_BM)>0.0){path.LGL_BT=vec3(0.0);}path.li+=path.beta*si.emissive;path.beta*=exp(-path.LGL_BT*si.t);MaterialSamples LGL_AaomSamples=getRandomMaterialSamples();path.li+=computeDirectLight(si,path,LGL_AaomSamples.s1,LGL_AaomSamples.s2)*path.beta;bsdfSampleRec.f=PrincipledBSDFSample(si,-path.ray.d,si.LGL_BM,bsdfSampleRec.L,bsdfSampleRec.pdf,LGL_AaomSamples);if(dot(si.LGL_BM,bsdfSampleRec.L)<0.0){path.LGL_BT=-log(si.extinction)/si.atDistance;}if(bsdfSampleRec.pdf>0.0){path.beta*=bsdfSampleRec.f/bsdfSampleRec.pdf;}else{path.LGL_BR=true;return;}if(depth>=2){float q=1.0-LGL_Af(path.beta);if(LGL_AaomSample()<q){path.LGL_BR=true;return;}path.beta/=1.0-q;}path.ray=Ray(si.position+INTERSECT_EPS*bsdfSampleRec.L,bsdfSampleRec.L);}vec4 LGL_BA(inout Ray ray){SurfaceInteraction si;Path path;BsdfSampleRec bsdfSampleRec;LightSampleRec lightSampleRec;path.ray=ray;path.li=vec3(0);path.alpha=1.0;path.LGL_BR=false;path.LGL_BS=1.0;path.LGL_BT=vec3(0.0);path.beta=vec3(1.0);int curAlphaDepth=0;int maxAlphaDepth=3;for(int i=0;i<bounces;i++){if(path.LGL_BR){return vec4(path.li,path.alpha);}LGL_n(path.ray,si,lightSampleRec,i,INF);
#ifdef SUPPORT_ALPHA
if(si.LGL_BL&&!si.isEmitter&&si.alpha<1.0&&curAlphaDepth<maxAlphaDepth){if(LGL_Aa()>si.alpha){path.ray.o=si.position+INTERSECT_EPS*path.ray.d;curAlphaDepth++;i--;continue;}}
#endif
computeBounce(path,i,si,bsdfSampleRec,lightSampleRec);}return vec4(path.li,path.alpha);}void main(){LGL_Ac(frameCount);vec2 vCoordAntiAlias=vCoord+jitter;vCoordAntiAlias=(vCoordAntiAlias-0.5)*2.0;vec3 origin=ndcToWorld(vCoordAntiAlias);vec3 direction;if(camera.clipToViewMat[2].w==0.){direction=-camera.viewToWorldMat[2].xyz;}else{direction=normalize(mat3(camera.viewToWorldMat)*(camera.clipToViewMat*vec4(vCoordAntiAlias,0.0,1.0)).xyz);}if(camera.aperture>0.0){vec3 focusPoint=origin+camera.focus*normalize(direction);vec2 lensPoint=camera.aperture*LGL_Am(vec2(LGL_AX(vCoordAntiAlias)));origin=vec3(camera.viewToWorldMat*vec4(lensPoint,0.0,1.0));direction=normalize(focusPoint-origin);}Ray cam=Ray(origin,direction);vec4 Li=LGL_BA(cam);if(!(Li.x<INF&&Li.x>-EPS)){Li=vec4(0.,0.,0.,1.);}if(frameCount>1.){vec2 size=vec2(textureSize(accumulateTex,0));vec4 accColor=texelFetch(accumulateTex,ivec2(vCoord*size),0);Li=(Li+accColor*frameCount)/(frameCount+1.);}out_light=Li;}`,vertex:a.vertexShader}),i.setPipelineByCacheKey(ve.ID,l,n);this.renderPass=n,n.setTexture("materialTexArr",i.getRawResourceByName("MaterialTextureArray")),(s.supportUVTrans||s.supportTexWrap)&&n.setTexture("uvTransBuffer",i.getRawResourceByName("TextureUVTransformBuffer")),n.setTexture("positionBuffer",i.getRawResourceByName("PositionBuffer")),n.setTexture("normalBuffer",i.getRawResourceByName("NormalBuffer")),s.sceneMode=="Static"?n.setTexture("bvhBuffer",i.getRawResourceByName("BVHBuffer")):(n.setTexture("blasBuffer",i.getRawResourceByName("BLASBuffer")),n.setTexture("tlasBuffer",i.getRawResourceByName("TLASBuffer")),n.setTexture("tlasTransformBuffer",i.getRawResourceByName("TLASTransformBuffer"))),this.initBySettingParams()}initBySettingParams(){const{renderSetting:s}=this,{bounces:e,backgroundColor:t,enableBackgroundColor:a,envMapIntensity:i,backgroundAlpha:n,enviromentVisible:r,envRotMatrix:l,invEnvRotMatrix:o}=s;this.updateBounces(e),this.setEnvMapIntensity(i),this.setBackgroundAlpha(n),this.setEnviromentVisible(r),this.enableBackgroundColor(a),this.setBackgroundColor(t),this.setEnvRotMatrix(l,o),this.updateEnvLight(),this.updateMeshLight()}setAccumulateTex(s){this.renderPass&&this.renderPass.setTexture("accumulateTex",s)}updateBounces(s){const{renderPass:e,samples:t,samplingDimensions:a}=this;a.length=0;for(let i=1;i<=s;i++)a.push(2,2,2,2),i>=2&&a.push(1);e.setUniform("bounces",s),t&&(t.strataCount=-1)}updateEnvLight(){const{renderPass:s,resourcePool:e,renderSetting:t}=this,{totalSumValue:a}=t;s.setTexture("envMap",e.getRawResourceByName(j.ENVMAP_RES_NAME)),s.setUniform("totalSumValue",a),s.setTexture("envMarginalWeights",e.getRawResourceByName(j.ENVMAP_MARGINAL_WEIGHTS_RES_NAME)),s.setTexture("envConditionalWeights",e.getRawResourceByName(j.ENVMAP_CONDITIONAL_WEIGHTS_RES_NAME))}updateMeshLight(){const{renderPass:s,renderSetting:e}=this,{lightsData:t}=e;t&&(s.setUniform("lights.position[0]",t.position),s.setUniform("lights.emission[0]",t.emission),s.setUniform("lights.p1[0]",t.p1),s.setUniform("lights.p2[0]",t.p2),s.setUniform("lights.params[0]",t.params))}setEnvRotMatrix(s,e){const{renderPass:t}=this;t.setUniform("envRotMatrix",s),t.setUniform("invEnvRotMatrix",e)}rebindTLASBuffer(){const{renderPass:s,resourcePool:e}=this;s.setTexture("tlasBuffer",e.getRawResourceByName("TLASBuffer")),s.setTexture("tlasTransformBuffer",e.getRawResourceByName("TLASTransformBuffer"))}rebindTextureArr(){const{renderPass:s,resourcePool:e}=this;s.setTexture("materialTexArr",e.getRawResourceByName("MaterialTextureArray"))}updateMeshMaterial(s){}enableBackgroundColor(s){this.renderPass.setUniform("useBackgroundColor",Number(s))}setBackgroundColor(s){this.renderPass.setUniform("backgroundColor",s)}setEnvMapIntensity(s){this.renderPass.setUniform("envMapIntensity",s)}setBackgroundAlpha(s){this.renderPass.setUniform("backgroundAlpha",s)}setEnviromentVisible(s){this.renderPass.setUniform("enviromentVisible",Number(s))}setNoise(s){this.renderPass.setTexture("noiseTex",s)}setFrameCount(s){this.renderPass.setUniform("frameCount",s)}setJitter(s,e){this.renderPass.setUniform("jitter",s,e)}nextSeed(){this.renderPass.setUniform("stratifiedSamples[0]",this.samples.next())}setStrataCount(s){s>1&&s!==this.samples.strataCount?this.samples=new tt(s,this.samplingDimensions):this.samples.restart(),this.renderPass.setUniform("strataSize",1/s),this.nextSeed()}setSize(s,e){this.renderPass.setUniform("pixelSize",1/s,1/e)}setCamera(s){const{renderPass:e}=this;e.setUniform("camera.viewToWorldMat",s.viewToWorldMat),e.setUniform("camera.clipToViewMat",s.clipToViewMat),e.setUniform("camera.aperture",s.aperture),e.setUniform("camera.focus",s.focus)}bindTextures(){this.renderPass.bindTextures()}draw(){this.renderPass.useProgram(),this.fullscreenTriangle.draw()}dispose(){}};let gt=ve;gt.ID="PTPass";class la{constructor(){this.scale=new $(1,1)}get width(){return this.renderWidth}get height(){return this.renderHeight}calcDimensions(e){const{fullWidth:t,fullHeight:a}=this;this.renderWidth=Math.round(t/e),this.renderHeight=Math.round(a/e),this.scale.set(this.renderWidth/t,this.renderHeight/a)}setSize(e,t,a){this.fullWidth=e,this.fullHeight=t,this.calcDimensions(a)}}class ua{constructor(e,t){this.gl=e,this.resourcePool=t,this.sampleCount=0,this.numUniformSamples=4,this.strataCount=6,this.forceUpdate=!1,this.firstFrame=!0,this.needsUpdateBG=!1,this.enableTileRender=!0,this.enableDenoise=!1,this.movingDownsampling=!0,this.downsamplingFactor=4;const a=new ot(e);this.integratorPass=new gt(e,a,t),this.toneMapPass=new na(e,a,t),this.accumulatePass=new ra(e,a),this.gBufferPass=new ia(e,a,t),this.svgfAtrousPass=new sa(e,a),this.fxaaPass=new ta(e,a),this.tileCalculator=new ea(e),this.previewSize=new la}async buildPipeline(e,t,a){this.camera=t,this.lastCamera=t.clone(),this.renderSetting=Ee(e,0,a);const i=await this.initNoise();this.integratorPass.createPipeline(this.renderSetting),this.integratorPass.setNoise(i),this.gBufferPass.createPipeline(this.renderSetting,e),this.svgfAtrousPass.createPipeline(this.renderSetting),this.fxaaPass.createPipeline(this.renderSetting),this.toneMapPass.createPipeline(this.renderSetting),this.accumulatePass.createPipeline(),this.updateTileNumber(this.renderSetting.tileNumber)}updateScene(e,t){const{camera:a,resourcePool:i}=this;this.renderSetting=Ee(e,0,t),this.integratorPass.createPipeline(this.renderSetting),this.gBufferPass.createPipeline(this.renderSetting,e),this.svgfAtrousPass.createPipeline(this.renderSetting);const n=i.getRawResourceByName("NoiseTexture");this.integratorPass.setNoise(n),this.integratorPass.setAccumulateTex(this.accumulateBuffer.color[0])}async initNoise(){const{gl:e,resourcePool:t}=this,a=t.getRawResourceByName("NoiseTexture");if(a)return a;const i=new Image;return i.src="data:image/png;base64,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",new Promise(n=>{i.onload=()=>{const r=new z(e,{data:i,wrapS:e.REPEAT,wrapT:e.REPEAT,storage:"halfFloat"});t.setResource("NoiseTexture",r),n(r)}})}initFrameBuffers(e,t){const{gl:a,renderSetting:i}=this,n="float";this.lightBuffer=new J(a,{color:{0:new z(a,{width:e,height:t,storage:n})}}),this.accumulateBuffer=new J(a,{color:{0:new z(a,{width:e,height:t,storage:n})}}),this.integratorPass.setAccumulateTex(this.accumulateBuffer.color[0]);const r=new z(a,{width:e,height:t,storage:"float"}),l=new z(a,{width:e,height:t,storage:"halfFloat"}),o=new z(a,{width:e,height:t,storage:"byte"}),u=new wt(a,e,t);this.gBuffer=new J(a,{color:{0:r,1:l,2:o},depth:u})}syncTracerSetting(e){Object.assign(this.renderSetting,e)}updateMaterialParams(e){}rebindTLASBuffer(){this.integratorPass.rebindTLASBuffer()}rebindTextureArr(){this.integratorPass.rebindTextureArr()}updateEnvLight(){this.integratorPass.updateEnvLight()}updateMeshLight(){this.integratorPass.updateMeshLight()}setEnvRotMatrix(e,t){this.integratorPass.setEnvRotMatrix(e,t)}enableBackgroundColor(e){this.integratorPass.enableBackgroundColor(e)}setBackgroundColor(e){this.integratorPass.setBackgroundColor(e)}updateTileNumber(e){this.tileCalculator.setTileCount(e),this.reset()}setTileCountSyncRender(e){this.tileCalculator.setTileCount(e),this.tileCalculator.reset()}updateBounces(e){this.integratorPass.updateBounces(e)}setEnvMapIntensity(e){this.integratorPass.setEnvMapIntensity(e)}setBackgroundAlpha(e){this.integratorPass.setBackgroundAlpha(e)}setEnviromentVisible(e){this.integratorPass.setEnviromentVisible(e)}setToneMapping(e){this.toneMapPass.setToneMapping(e)}setDenoiseColorFactor(e){this.svgfAtrousPass.setColorFactor(e)}setDenoiseNormalFactor(e){this.svgfAtrousPass.setNormalFactor(e)}setDenoisePositionFactor(e){this.svgfAtrousPass.setPositionFactor(e)}setCameras(e){this.integratorPass.setCamera(e),this.gBufferPass.setCamera(e),this.lastCamera.copy(e)}updateSeed(e,t,a=!0){const{enableDenoise:i,integratorPass:n,sampleCount:r,numUniformSamples:l,strataCount:o}=this;n.setSize(e,t),n.setFrameCount(r);const u=a?(Math.random()-.5)/e:0,c=a?(Math.random()-.5)/t:0;i||n.setJitter(u,c),r===0?n.setStrataCount(1):r===l?n.setStrataCount(o):n.nextSeed()}clearBuffer(e){const{gl:t}=this;e&&(e.bind(),t.clear(t.COLOR_BUFFER_BIT),e.unbind())}renderGBuffer(){const{gBuffer:e,gBufferPass:t,svgfAtrousPass:a,gl:i,screenWidth:n,screenHeight:r}=this;e.bind(),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.viewport(0,0,n,r),t.draw(),e.unbind(),a.setGBuffers({position:e.color[0],normal:e.color[1],color:e.color[2]})}svgfDraw(){const{svgfAtrousPass:e,lightBuffer:t}=this,a=e.draw({light:t.color[0]});this.toneMapWithAAToScreen(a.color[0])}addSampleToBuffer(e,t,a){const{gl:i,integratorPass:n,accumulatePass:r,lightBuffer:l,accumulateBuffer:o}=this;e.bind(),i.viewport(0,0,t,a),n.draw(),e.unbind(),r.draw({inputTex:l.color[0],outputTex:o})}newSampleToBuffer(e,t,a){const{gl:i,integratorPass:n}=this;e.bind(),i.viewport(0,0,t,a),n.draw(),e.unbind()}toneMapToScreen(e,t=[1,1]){const{gl:a,toneMapPass:i}=this,{renderToScreen:n}=this.renderSetting;a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),i.draw({light:e,lightScale:t},!n)}toneMapWithAAToScreen(e){const{renderToScreen:t}=this.renderSetting;let a=this.toneMapPass.draw({light:e},!0);t&&this.fxaaPass.draw({light:a.color[0]})}reset(){this.forceUpdate=!0,this.sampleCount=0,this.tileCalculator.reset(),this.clearBuffer(this.lightBuffer)}setSize(e,t){this.sampleCount=0,this.screenWidth=e,this.screenHeight=t,this.reset(),this.tileCalculator.setSize(e,t),this.previewSize.setSize(e,t,this.downsamplingFactor),this.initFrameBuffers(e,t),this.svgfAtrousPass.setSize(e,t),this.fxaaPass.setSize(e,t),this.toneMapPass.setSize(e,t)}drawPreview(){const{previewSize:e,lightBuffer:t}=this;this.updateSeed(e.width,e.height,!1),this.newSampleToBuffer(t,e.width,e.height),this.toneMapToScreen(t.color[0],e.scale)}renderPerTile(e,t,a,i,n){const{gl:r,screenWidth:l,screenHeight:o}=this;r.scissor(t,a,i,n),r.enable(r.SCISSOR_TEST),this.addSampleToBuffer(e,l,o),r.disable(r.SCISSOR_TEST)}drawTile(e=!1){const{enableDenoise:t,integratorPass:a,lightBuffer:i,screenWidth:n,screenHeight:r}=this,{x:l,y:o,tileWidth:u,tileHeight:c,isFirstTile:d,isLastTile:h}=this.tileCalculator.nextTile();d&&(this.sampleCount===0&&this.clearBuffer(i),this.updateSeed(n,r,!0),t&&this.renderGBuffer()),this.renderPerTile(i,l,o,u,c),e&&!h&&this.toneMapToScreen(i.color[0]),h&&(t?this.svgfDraw():this.toneMapToScreen(i.color[0]),this.sampleCount++)}renderTile(e){const{lastCamera:t}=this;!me(e,t)||this.forceUpdate?(this.forceUpdate=!1,this.setCameras(e),this.firstFrame?this.firstFrame=!1:this.drawPreview(),this.sampleCount=0,this.tileCalculator.reset()):this.drawTile()}renderFull(e){const{enableDenoise:t,integratorPass:a,lightBuffer:i,screenWidth:n,screenHeight:r,lastCamera:l,movingDownsampling:o}=this;if(!me(e,l)||this.forceUpdate){if(this.forceUpdate=!1,o)return this.setCameras(e),this.sampleCount=0,void this.drawPreview();this.sampleCount=0,this.clearBuffer(i)}else this.sampleCount++;this.setCameras(e),this.updateSeed(n,r,!0),t&&this.renderGBuffer(),this.addSampleToBuffer(i,n,r),t?this.svgfDraw():this.toneMapToScreen(i.color[0])}render(e){this.enableTileRender?this.renderTile(e):this.renderFull(e)}dispose(){}}var _e=(s=>(s[s.Linear=0]="Linear",s[s.ACES=1]="ACES",s))(_e||{});class ca{constructor(e={}){this.pixelRatio=1,this.geoType="Mesh",this.targetSampleCount=0,this._viewportSize=[],this.inited=!1,this.isBuilding=!1,this.needsUpdate=!1,this._bounces=2,this._backgroundColor=new E,this._enableBackgroundColor=!1,this._backgroundAlpha=1,this._envMapIntensity=1,this._envRotation=0,this._envRotMatrix=new k,this._invEnvRotMatrix=new k,this._totalSumValue=0,this._toneMapping="Linear",this._downsamplingFactor=4,this._enviromentVisible=!0,this._tileNumber=4,this._denoiseColorFactor=.05,this._denoiseNormalFactor=.02,this._denoisePositionFactor=.35,this.isFloatLinearSupport=!0,this.forceUpdateOneFullSample=!1,this.onBuildingProgressCallback=()=>{},this.canvas=e.canvas||document.createElement("canvas"),this.gl=this.canvas.getContext("webgl2",{alpha:e.canvasAlpha||!0,depth:!1,stencil:!1,antialias:!1,powerPreference:"high-performance",premultipliedAlpha:!0,failIfMajorPerformanceCaveat:!0}),this.checkSupported(this.gl),this.sceneMode=e.sceneMode||"Static",this.useWebWorker=e.useWebWorker==null||e.useWebWorker,this.renderToScreen=e.renderToScreen==null||e.renderToScreen,this.resourcePool=new It,this.environmentLoader=new j(this.gl,this.resourcePool),this.sceneMode=="Static"?this.sceneBuilder=new Jt(this.gl,this.resourcePool):this.sceneBuilder=new $t(this.gl,this.resourcePool),this.renderer=new ua(this.gl,this.resourcePool),this.featureOption={supportSGWorkflow:!0,supportUVTrans:!0,supportTexWrap:!0,supportAlpha:!0},e.featureOption&&Object.assign(this.featureOption,e.featureOption)}checkSupported(e){if(!e)throw new Error("webgl2 no supported!");const t=Ve(e,bt);for(let i in t)if(!t[i])throw new Error(`require extension ${i} no supported!`);const a=Ve(e,Ft);for(let i in a)a[i]||(i==="OES_texture_float_linear"&&(this.isFloatLinearSupport=!1),console.error(`extension ${i} no supported!`))}set bounces(e){this._bounces=lt(e,2,8),this.inited&&this.renderer.updateBounces(e),this._syncTracerSetting()}get bounces(){return this._bounces}set envMapIntensity(e){this._envMapIntensity=e,this.inited&&this.renderer.setEnvMapIntensity(e),this._syncTracerSetting()}get envMapIntensity(){return this._envMapIntensity}set enableBackgroundColor(e){this._enableBackgroundColor=e,this.inited&&this.renderer.enableBackgroundColor(e),this._syncTracerSetting()}get enableBackgroundColor(){return this._enableBackgroundColor}set backgroundColor(e){typeof e=="string"?this._backgroundColor.fromHex(e):Array.isArray(e)&&this._backgroundColor.fromArray(e),this.inited&&this.renderer.setBackgroundColor(this._backgroundColor),this._syncTracerSetting()}get backgroundColor(){return this._backgroundColor}set backgroundAlpha(e){this._backgroundAlpha=e,this.inited&&this.renderer.setBackgroundAlpha(e),this._syncTracerSetting()}get backgroundAlpha(){return this._backgroundAlpha}set envRotation(e){this._envRotation=e;let t=function(a){return a*Math.PI/180}(e);this._envRotMatrix.fromMatrix4(new V().rotateY(t)),this._invEnvRotMatrix.inverse(this._envRotMatrix),this.inited&&this.renderer.setEnvRotMatrix(this._envRotMatrix,this._invEnvRotMatrix),this._syncTracerSetting()}get envRotation(){return this._envRotation}set toneMapping(e){this._toneMapping=e,this.inited&&this.renderer.setToneMapping(_e[e]),this.forceUpdateOneFullSample=!0,this._syncTracerSetting()}get toneMapping(){return this._toneMapping}set enableTileRender(e){this.renderer.enableTileRender=e,this.renderer.reset(),this._syncTracerSetting()}get enableTileRender(){return this.renderer.enableTileRender}set tileNumber(e){this._tileNumber=e,this.inited&&this.renderer.updateTileNumber(e)}get tileNumber(){return this._tileNumber}set movingDownsampling(e){this.inited&&(this.renderer.movingDownsampling=e),this._syncTracerSetting()}get movingDownsampling(){return this.renderer.movingDownsampling}set enableDenoise(e){this.renderer.enableDenoise=e,this.forceUpdateOneFullSample=!0,this._syncTracerSetting()}get enableDenoise(){return this.renderer.enableDenoise}set denoiseColorFactor(e){e=Math.max(e,.1),this._denoiseColorFactor=e,this.inited&&this.renderer.setDenoiseColorFactor(e),this._syncTracerSetting(),this.forceUpdateOneFullSample=!0}get denoiseColorFactor(){return this._denoiseColorFactor}set denoiseNormalFactor(e){e=Math.max(e,.1),this._denoiseNormalFactor=e,this.inited&&this.renderer.setDenoiseNormalFactor(e),this._syncTracerSetting(),this.forceUpdateOneFullSample=!0}get denoiseNormalFactor(){return this._denoiseNormalFactor}set denoisePositionFactor(e){e=Math.max(e,.1),this._denoisePositionFactor=e,this.inited&&this.renderer.setDenoisePositionFactor(e),this._syncTracerSetting(),this.forceUpdateOneFullSample=!0}get denoisePositionFactor(){return this._denoisePositionFactor}set downsamplingFactor(e){this._downsamplingFactor=Math.floor(Math.max(e,1)),this.renderer.downsamplingFactor=this._downsamplingFactor,this.renderer.previewSize.calcDimensions(this._downsamplingFactor)}get downsamplingFactor(){return this._downsamplingFactor}get sampleCount(){return this.renderer.sampleCount}get size(){return this._viewportSize}set enviromentVisible(e){this._enviromentVisible=e,this.inited&&this.renderer.setEnviromentVisible(e)}get enviromentVisible(){return this._enviromentVisible}_syncTracerSetting(){const{geoType:e,integrator:t,sceneMode:a,bounces:i,backgroundColor:n,enableBackgroundColor:r,backgroundAlpha:l,envMapIntensity:o,enviromentVisible:u,featureOption:c,renderToScreen:d,_envRotMatrix:h,_invEnvRotMatrix:L,_toneMapping:f,_totalSumValue:p,isFloatLinearSupport:x,enableTileRender:m,tileNumber:v,enableDenoise:A,denoiseColorFactor:T,denoiseNormalFactor:_,denoisePositionFactor:S}=this;this.tracerSetting={geoType:e,integrator:t,sceneMode:a,bounces:i,backgroundColor:n,enableBackgroundColor:r,backgroundAlpha:l,envMapIntensity:o,enviromentVisible:u,envRotMatrix:h,invEnvRotMatrix:L,totalSumValue:p,toneMapping:_e[f],supportSGWorkflow:c.supportSGWorkflow,supportUVTrans:c.supportUVTrans,supportTexWrap:c.supportTexWrap,supportAlpha:c.supportAlpha,renderToScreen:d,isFloatLinearSupport:x,enableTileRender:m,tileNumber:v,enableDenoise:A,denoiseColorFactor:T,denoiseNormalFactor:_,denoisePositionFactor:S},this.inited&&this.renderer.syncTracerSetting(this.tracerSetting)}async buildPipeline(e,t){this.isBuilding=!0;const{sceneInfo:a,camera:i}=function(n,r){return{sceneInfo:Ce(n,!0),camera:Ue(r)}}(e,t);this.sceneInfo=a,this.camera=i,this.onBuildingBeginCallback&&this.onBuildingBeginCallback(),this.environmentLoader.load(this.environment),this._totalSumValue=this.environmentLoader.totalSumValue,this._syncTracerSetting(),await this.sceneBuilder.build(a,this.onBuildingProgressCallback),await this.renderer.buildPipeline(a,i,this.tracerSetting),this.setSize(this.canvas.width,this.canvas.height),this.inited=!0,this.isBuilding=!1,this.onBuildingEndCallback&&this.onBuildingEndCallback()}getRenderResGPUTexture(){if(!this.renderToScreen)return this.resourcePool.getRawResourceByName("ScreenPassOutputTexture").texture;console.error("Need to set init tracer renderToScreen to false first")}getMeshByTHREEID(e){const{meshes:t}=this.sceneInfo,a=`LGL_${e}`;return t.find(i=>a==i.id)}static linkMeshWithTHREEMesh(e,t){var a;e.id=`LGL_${t.id}`,e.name=`LGL_${t.name}`,e.tlasMask=!!((a=t.userData)!=null&&a.lgl_tlasMask),e.visible=t.visible,e.localToWorldMat.fromArray(t.matrixWorld.elements)}updateMeshTransformFromTHREE(e){e.updateMatrixWorld(!0),this.getMeshByTHREEID(e.id).localToWorldMat.fromArray(e.matrixWorld.toArray())}async updateMeshMaterialParamsFromTHREE(e){pe(e.material,this.getMeshByTHREEID(e.id).material),await this.updateMaterialParams()}async rebuildMeshMaterialFromTHREE(e){if(C(),this.isBuilding)return;this.isBuilding=!0;const t=pe(e.material);this.getMeshByTHREEID(e.id).material=t,this.updateSceneStructure(),this.needsUpdate=!0,this.isBuilding=!1}updateSceneStructure(e=!1){if(this.sceneMode=="Static")return;const t=Le(this.sceneInfo.meshes);this.sceneInfo.materialIndexMap=t,this.sceneInfo.materials=Array.from(t.keys()),this.sceneBuilder.rebuildMaterialBuffer(this.sceneInfo),this.sceneBuilder.rebuildTLAS(this.sceneInfo,!0),this.renderer.rebindTextureArr(),this.renderer.rebindTLASBuffer()}rebuildMaterial(){const{meshes:e}=this.sceneInfo,t=Le(e);this.sceneInfo.materialIndexMap=t,this.sceneInfo.materials=Array.from(t.keys()),this.sceneBuilder.rebuildMaterialBuffer(this.sceneInfo),this.renderer.rebindTextureArr()}async addSceneFromTHREE(e){C(),await this.updateScene(e)}async replaceMainSceneFromTHREE(e){await this.updateScene(e)}setMeshTLASMaskStatusFromTHREE(e,t){const a=this.getMeshByTHREEID(e.id);return a.visible=!t,a}setMeshVisibleFromTHREE(e,t){const a=this.getMeshByTHREEID(e.id);return a.visible=t,a}updateTLAS(){this.sceneMode=="Static"||this.isBuilding||(this.sceneBuilder.rebuildTLAS(this.sceneInfo),this.renderer.rebindTLASBuffer(),this.needsUpdate=!0,this.renderer.forceUpdate=!0)}rebuildTLAS(){this.updateTLAS()}updateMaterialParams(){this.isBuilding||(this.isBuilding=!0,function(e){const{materials:t}=e;let a=!1;t.forEach(i=>{i.subsurface>0&&(a=!0)}),e.includeSSS=a}(this.sceneInfo),this.renderer.updateMaterialParams(this.sceneInfo),this.sceneBuilder.updateMaterialParams(this.sceneInfo),this.renderer.reset(),this.isBuilding=!1)}async updateScene(e){if(this.isBuilding)return;this.isBuilding=!0,this.onBuildingBeginCallback&&this.onBuildingBeginCallback();const t=Ce(e);await this.sceneBuilder.build(t,this.onBuildingProgressCallback),this.sceneInfo=t,this.renderer.updateScene(t,this.tracerSetting),this.isBuilding=!1,this.onBuildingEndCallback&&this.onBuildingEndCallback()}updateEnvLight(e){this.environment=e,this.environmentLoader.load(this.environment),this._totalSumValue=this.environmentLoader.totalSumValue,this._syncTracerSetting(),this.renderer.updateEnvLight(),this.needsUpdate=!0}updateMeshLight(){this.renderer.updateMeshLight(),this.needsUpdate=!0}getLightByTHREEID(e){C()}static linkLightWithTHREELight(e,t){C()}async addMeshFromTHREE(e){C()}async removeMeshFromTHREE(e){C()}cloneMeshFromTHREE(e,t,a=!0){C()}updateTextureParamsFromTHREE(e){C()}addLightFromTHREE(e){C()}removeLightFromTHREE(e){C()}updateLightFromTHREE(e){C()}addTracerInstanceMeshes(e){C()}syncCamera(e){if(!e)throw new Error("Need to pass camera into render(camera) method!");e.updateMatrixWorld(),Ue(e,this.renderer.camera)}setTileCountSyncRender(e){this._tileNumber=e,this.renderer.setTileCountSyncRender(e)}setSize(e,t,a=!0){const{canvas:i,pixelRatio:n}=this,r=Math.floor(e*n),l=Math.floor(t*n);i.width=r,i.height=l,this._viewportSize=[r,l],a&&(i.style.width=`${e}px`,i.style.height=`${t}px`),this.inited&&this.renderer.setSize(r,l)}setPixelRatio(e,t=!1){const{_viewportSize:a}=this;this.pixelRatio=e,this.setSize(a[0]/e,a[1]/e,t)}render(e){if(this.isBuilding||!this.inited)return;this.syncCamera(e);const{camera:t,lastCamera:a}=this.renderer;if(this.needsUpdate&&(this.needsUpdate=!1,this.renderer.reset()),this.targetSampleCount!=0&&this.renderer.sampleCount>=this.targetSampleCount&&!this.forceUpdateOneFullSample&&me(t,a))return;let i=this.renderer.sampleCount;this.renderer.render(t);let n=this.renderer.sampleCount;this.onSampleFinCallback&&i!=n&&typeof this.onSampleFinCallback=="function"&&this.onSampleFinCallback(),i!=n&&this.forceUpdateOneFullSample&&(this.forceUpdateOneFullSample=!1)}dispose(){this.renderer.dispose()}}export{ca as LGLTracer,se as Mesh,ee as PrincipledBSDFMaterial};
