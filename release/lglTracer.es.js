/**
 * @license
 * MIT license statement included in lglTracer:
 * GLSL-PathTracer:
 * Copyright 2019-2021 Asif Ali. MIT License
 * ray-tracing-renderer:
 * Copyright 2019 HOVER. MIT License
 * 
 * lglTracer is not open source. you are free to use this library except for projects for commercial purposes.
 * Copyright lgltracer.com
 */
var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,r=(t,a,n)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[a]=n,s=(e,t)=>{for(var a in t||(t={}))i.call(t,a)&&r(e,a,t[a]);if(n)for(var a of n(t))o.call(t,a)&&r(e,a,t[a]);return e};import{ClampToEdgeWrapping as l,RepeatWrapping as f,MirroredRepeatWrapping as u,Material as c,Color as d,Vector2 as p,Vector3 as m,PlaneGeometry as L,Matrix3 as x,UnsignedByteType as v,HalfFloatType as _,FloatType as h,RGBAFormat as A,Box3 as g,BufferGeometry as S,BufferAttribute as M,Matrix4 as F,LinearToneMapping as T,ACESFilmicToneMapping as G,ReinhardToneMapping as I,CineonToneMapping as N,PerspectiveCamera as P,Light as y}from"three";function B(e,t){const a={};for(const n of t)a[n]=e.getExtension(n);return a}function R(e,t){const a={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let i=0;i<n;i++){const{name:n}=e.getActiveAttrib(t,i);n&&(a[n]=e.getAttribLocation(t,n))}return a}const b=["EXT_color_buffer_float","EXT_float_blend"],U=["OES_texture_float_linear"];function E(e,{color:t,depth:a}){const n=e.createFramebuffer();function i(){e.bindFramebuffer(e.FRAMEBUFFER,n)}function o(){e.bindFramebuffer(e.FRAMEBUFFER,null)}return function(){i();const n=[];for(let a in t){a=Number(a),void 0===a&&console.error("invalid location");const i=t[a];e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+a,i.target,i.texture,0),n.push(e.COLOR_ATTACHMENT0+a)}e.drawBuffers(n),a&&e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,a.target,a.texture),o()}(),{color:t,bind:i,unbind:o,dispose:function(){e.deleteFramebuffer(n)}}}var w={source:"layout(location=0)in vec2 a_position;out vec2 vCoord;void main(){vCoord=a_position;gl_Position=vec4(2.*a_position-1.,0,1);}"};let D;function z(e,t){return{values:`uniform${e}${t}`,array:`uniform${e}${t}v`}}function X(e,t){return{matrix:e===t?`uniformMatrix${e}fv`:`uniformMatrix${e}x${t}fv`}}function C(e,t){const a=function(e,t){const a={},n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let i=0;i<n;i++){const{name:n,type:o}=e.getActiveUniform(t,i),r=e.getUniformLocation(t,n);r&&(a[n]={type:o,location:r})}return a}(e,t),n={},i=[];for(let r in a){const{type:e,location:t}=a[r],i={type:e,location:t,v0:0,v1:0,v2:0,v3:0};n[r]=i}const o=new Set;return D=D||function(e){return{[e.FLOAT]:z(1,"f"),[e.FLOAT_VEC2]:z(2,"f"),[e.FLOAT_VEC3]:z(3,"f"),[e.FLOAT_VEC4]:z(4,"f"),[e.INT]:z(1,"i"),[e.INT_VEC2]:z(2,"i"),[e.INT_VEC3]:z(3,"i"),[e.INT_VEC4]:z(4,"i"),[e.SAMPLER_2D]:z(1,"i"),[e.SAMPLER_2D_ARRAY]:z(1,"i"),[e.FLOAT_MAT2]:X(2,2),[e.FLOAT_MAT3]:X(3,3),[e.FLOAT_MAT4]:X(4,4)}}(e),{setUniform:function(e,t,a,r,s){const l=n[e];l?(l.v0=t,l.v1=a,l.v2=r,l.v3=s,i.push(l)):o.has(e)||o.add(e)},upload:function(){for(;i.length>0;){const{type:t,location:a,v0:n,v1:o,v2:r,v3:s}=i.pop(),l=D[t];if(n&&n.length)if(l.matrix){const t=n,i=o||!1;e[l.matrix](a,i,t)}else e[l.array](a,n);else e[l.values](a,n,o,r,s)}}}}function O(e){let t={};for(let a=0;a<e.length;a++)t[e[a]]=a;return t}function V(e,t,a,n){let i="#version 300 es\nprecision mediump float;\nprecision mediump int;\nprecision lowp isampler2D;\n";return n&&(i+=function(e){let t="";for(const a in e){const n=e[a];n&&(t+=`#define ${a} ${n}\n`)}return t}(n)),t===e.FRAGMENT_SHADER&&a.outputs&&(i+=function(e){let t="";const a=O(e);for(let n in a)t+=`layout(location = ${a[n]}) out vec4 out_${n};\n`;return t}(a.outputs)),a.includes&&(i+=function(e,t){let a="";for(let n of e)a+="function"==typeof n?n(t):n;return a}(a.includes,n)),"function"==typeof a.source?i+=a.source(n):i+=a.source,function(e,t,a){const n=e.createShader(t);if(e.shaderSource(n,a),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS))return n;const i=a.split("\n").map(((e,t)=>`${t+1}: ${e}`)).join("\n");throw console.log(i),e.getShaderInfoLog(n)}(e,t,i)}function Q(e,{defines:t,vertex:a}){return V(e,e.VERTEX_SHADER,a,t)}function Y(e,n){const{fragment:i,vertex:o}=n,r=o instanceof WebGLShader?o:Q(e,n),l=i instanceof WebGLShader?i:function(e,{defines:t,fragment:a}){return V(e,e.FRAGMENT_SHADER,a,t)}(e,n),f=function(e,t,a,n,i){const o=e.createProgram();if(e.attachShader(o,t),e.attachShader(o,a),n&&e.transformFeedbackVaryings(o,n,i),e.linkProgram(o),e.detachShader(o,t),e.detachShader(o,a),e.getProgramParameter(o,e.LINK_STATUS))return o;throw e.getProgramInfoLog(o)}(e,r,l);return u=s({},function(e,t){const a=C(e,t),n={};let i=1;function o(){for(let t in n){const{tex:a,unit:i}=n[t];e.activeTexture(e.TEXTURE0+i),e.bindTexture(a.target,a.texture)}}return{attribLocs:R(e,t),bindTextures:o,updateTexture:function(t,a,i,o){const{tex:r,unit:s}=n[t];e.activeTexture(e.TEXTURE0+s),e.bindTexture(r.target,r.texture)},program:t,setTexture:function(e,t){if(t)if(n[e])n[e].tex=t;else{const o=i++;a.setUniform(e,o),n[e]={unit:o,tex:t}}},setUniform:a.setUniform,textures:n,useProgram:function(n=!0){e.useProgram(t),a.upload(),n&&o()},dispose:function(){for(const t in n){const{tex:a}=n[t];e.deleteTexture(a.texture)}e.deleteProgram(t)}}}(e,f)),c={outputLocs:i.outputs?O(i.outputs):{}},t(u,a(c));var u,c}function H(e,t,a){return Math.min(Math.max(e,t),a)}function W(e){const t=Math.round(Math.log2(Math.sqrt(e))),a=2**t,n=Math.ceil(e/a);return{columnsLog:t,columns:a,rows:n,size:n*a}}function k(e,t){const a=new e.constructor(t);return a.set(e),a}function q(e,t,a){const n=W(t.length/a);return Z(e,{data:k(t,a*n.size),width:n.columns,height:n.rows})}function Z(e,t){let{width:a=null,height:n=null,data:i=null,length:o=1,channels:r=null,storage:s=null,flipY:l=!1,gammaCorrection:f=!1,wrapS:u=e.CLAMP_TO_EDGE,wrapT:c=e.CLAMP_TO_EDGE,minFilter:d=e.NEAREST,magFilter:p=e.NEAREST}=t;a=a||i.width||0,n=n||i.height||0;const m=e.createTexture();let L,x;Array.isArray(i)&&(x=i,i=x[0]),L=x||o>1?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D,e.activeTexture(e.TEXTURE0),e.bindTexture(L,m),!Array.isArray(u)&&e.texParameteri(L,e.TEXTURE_WRAP_S,u),!Array.isArray(c)&&e.texParameteri(L,e.TEXTURE_WRAP_T,c),e.texParameteri(L,e.TEXTURE_MIN_FILTER,d),e.texParameteri(L,e.TEXTURE_MAG_FILTER,p),r||(r=i&&i.length?i.length/(a*n):4),r=H(r,1,4);const{type:v,format:_,internalFormat:h}=function(e,t,a,n,i){let o,r;const s=n instanceof Uint8Array||n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof ImageData||n instanceof ImageBitmap,l=n instanceof Float32Array;"byte"===a||!a&&s?(r={1:e.R8,2:e.RG8,3:i?e.SRGB8:e.RGB8,4:i?e.SRGB8_ALPHA8:e.RGBA8}[t],o=e.UNSIGNED_BYTE):"float"===a||!a&&l?(r={1:e.R32F,2:e.RG32F,3:e.RGB32F,4:e.RGBA32F}[t],o=e.FLOAT):"halfFloat"===a?(r={1:e.R16F,2:e.RG16F,3:e.RGB16F,4:e.RGBA16F}[t],o=e.HALF_FLOAT):"snorm"===a&&(r={1:e.R8_SNORM,2:e.RG8_SNORM,3:e.RGB8_SNORM,4:e.RGBA8_SNORM}[t],o=e.UNSIGNED_BYTE);return{format:K(e,t),internalFormat:r,type:o}}(e,r,s,i,f);if(x){e.texStorage3D(L,1,h,a,n,x.length);for(let t=0;t<x.length;t++){const i=x[t].width||a,o=x[t].height||n;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,Array.isArray(l)?l[t]:l),e.texParameteri(L,e.TEXTURE_WRAP_S,Array.isArray(u)?u[t]:u),e.texParameteri(L,e.TEXTURE_WRAP_T,Array.isArray(c)?c[t]:c),e.texSubImage3D(L,0,0,0,t,i,o,1,_,v,x[t])}}else o>1?e.texStorage3D(L,1,h,a,n,o):(e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,l),e.texStorage2D(L,1,h,a,n),i&&e.texSubImage2D(L,0,0,0,a,n,_,v,i));return e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),{target:L,texture:m,dispose:function(){e.deleteTexture(m)}}}function K(e,t){return{1:e.RED,2:e.RG,3:e.RGB,4:e.RGBA}[t]}const j=["map","normalMap","roughnessMap","metalnessMap","specularMap","glossinessMap","emissiveMap"],J=new Map;J.set(l,0),J.set(f,1),J.set(u,2);const $=e=>{const t=j.length,a=e.size*t*9,n=e.size*t*3;return{mapNum:t,perMatrixLength:9,perWrappingDataLength:3,uvTransDataLength:a,textureWrappingDataLength:n,bufferSize:a+n}};class ee extends c{constructor(){super(),this.materialType=null,this.isRayTracingMaterial=!0}copy(e){super.copy(e),this.materialType=e.materialType,this.isRayTracingMaterial=e.isRayTracingMaterial}}class te extends ee{constructor(e){super(),this.materialType="Disney",this.workflow="Metalness",this.color=new d(16777215),this.roughness=.5,this.metalness=0,this.map=null,this.emissive=new d(0),this.emissiveMap=null,this.normalMap=null,this.normalScale=new p(1,1),this.roughnessMap=null,this.metalnessMap=null,this.specularTint=0,this.sheen=0,this.sheenTint=.5,this.clearcoat=0,this.clearcoatRoughness=0,this.subsurface=0,this.alpha=1,this.ior=1.5,this.transmission=0,this.atDistance=1,this.extinction=new d(16777215),this.anisotropic=0,this.specularColor=new d(16777215),this.glossiness=1,this.specularMap=null,this.glossinessMap=null,this.setValues(e)}copy(e){return this.color=(new d).copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.emissive=(new d).copy(e.emissive),this.emissiveMap=e.emissiveMap,this.normalMap=e.normalMap,this.normalScale=(new p).copy(e.normalScale),this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.specularTint=e.specularTint,this.sheen=e.sheen,this.sheenTint=e.sheenTint,this.clearcoat=e.clearcoat,this.clearcoatRoughness=e.clearcoatRoughness,this.subsurface=e.subsurface,this.transmission=e.transmission,this.ior=e.ior,this.atDistance=e.atDistance,this.anisotropic=e.anisotropic,this.extinction=(new d).copy(e.extinction),this.alpha=e.alpha,this}clone(){return(new this.constructor).copy(this)}fromBasicMaterial(e){return this.name=e.name,e.color&&this.color.copy(e.color),e.map&&(this.map=e.map),this}fromStandardMaterial(e){return this.name=e.name,this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.transmission=e.transmission||0,this.ior=e.ior||1.5,this.clearcoat=e.clearcoat||0,this.clearcoatRoughness=e.clearcoatRoughness||0,this.sheen=e.sheen||0,this.sheenTint=e.sheenTint||.5,this.alpha=e.opacity,this.map=e.map,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,e.isGLTFSpecularGlossinessMaterial&&(this.workflow="Specular",this.specularColor.copy(e.specular),this.glossiness=e.glossiness,this.specularMap=e.specularMap,this.glossinessMap=e.glossinessMap),this}}function ae(e){const t={};return t.position=e.map((e=>e.position)),t.emission=e.map((e=>e.emission)),t.p1=e.map((e=>e.p1)),t.p2=e.map((e=>e.p2)),t.radius=e.map((e=>e.radius)),t.area=e.map((e=>e.area)),t.type=e.map((e=>e.type)),t.visible=e.map((e=>e.visible)),t.position=[].concat(...t.position.map((e=>e.toArray()))),t.emission=[].concat(...t.emission.map((e=>e.toArray()))),t.p1=[].concat(...t.p1.map((e=>e.toArray()))),t.p2=[].concat(...t.p2.map((e=>e.toArray()))),t.params=function(...e){let t=0;for(let n=0;n<e.length;n++){const a=e[n],i=a.data?a.data.length/a.channels:0;t=Math.max(t,i)}const a=[];for(let n=0;n<t;n++)for(let t=0;t<e.length;t++){const{data:i=[],channels:o}=e[t];for(let e=0;e<o;e++)a.push(i[n*o+e])}return a}({data:t.radius,channels:1},{data:t.area,channels:1},{data:t.type,channels:1},{data:t.visible,channels:1}),t}function ne(e,t){const a=[],n=[];e.traverse((e=>{e.isMesh&&(e.geometry?e.material?(e.material.isMeshStandardMaterial?e.material=(new te).fromStandardMaterial(e.material):e.material.isRayTracingMaterial||(e.material=(new te).fromBasicMaterial(e.material)),a.push(e)):console.warn(e,"must have a material property."):console.warn(e,"must have a geometry property")),e.isLight&&n.push(e)}));const i={data:e.environment,intensity:e.envMapIntensity||1},o=i.data&&i.data.isTexture,r=n.length||0;let s=null;r&&(s=function(e){return ae(e.map((e=>{const t={};switch(t.position=e.position,t.emission=e.color.multiplyScalar(e.intensity),t.radius=e.radius||0,t.area=0,t.visible=Number(e.visible),t.p1=new m,t.p2=new m,e.type){case"RectAreaLight":if(t.type=0,e.width&&e.height){const a=new L(e.width,e.height),n=new m;e.target&&n.copy(e.target);const i=(new m).subVectors(e.position,n),o=(new m).copy(i).negate();a.lookAt(o);const r=a.attributes.position.array,s=new m(r[0],r[1],r[2]).add(e.position);new m(r[3],r[4],r[5]).add(e.position);const l=new m(r[6],r[7],r[8]).add(e.position),f=new m(r[9],r[10],r[11]).add(e.position);t.position.copy(l),t.p1=f.sub(l),t.p2=s.sub(l),t.area=(new m).crossVectors(t.p1,t.p2).length()}break;case"QuadLight":t.type=1,t.p1=e.v1.sub(e.position),t.p2=e.v2.sub(e.position),t.area=(new m).crossVectors(t.p1,t.p2).length();break;case"SphereAreaLight":t.type=2,t.area=4*Math.PI*e.radius*e.radius;break;case"PointLight":t.type=4,t.area=0;break;case"DirectionalLight":t.type=3,e.target&&t.p1.copy(e.target),t.area=0;break;default:console.warn(`Not support light type: ${e.type}`)}return t})))}(n));const l=new Map;for(const u of a){const e=u.material;let t=l.get(e);void 0===t&&(t=l.size,l.set(e,t))}const f=$(l).bufferSize;return{environment:i,isTextureEnv:o,camera:t,meshes:a,meshLights:s,meshLightsNum:r,materialIndexMap:l,materials:Array.from(l.keys()),uvTransformBufferDataLength:f}}function ie(e,t){const a=t.materialIndexMap,{mapNum:n,perMatrixLength:i,perWrappingDataLength:o,uvTransDataLength:r,bufferSize:s}=$(a);let l=new Float32Array(s);const f=new x,u=n*i,c=n*o;a.forEach(((e,t)=>{j.forEach(((a,n)=>{const s=t[`${a}`];let d=f.elements;s&&(s.updateMatrix(),d=s.matrix.elements);for(let t=0;t<i;t++)l[u*e+n*i+t]=d[t];let p=0,m=0;s&&(p=J.get(s.wrapS),m=J.get(s.wrapT)),l[r+e*c+n*o+0]=p,l[r+e*c+n*o+1]=m,l[r+e*c+n*o+2]=0}))}));const d=q(e,l,3);return{uvTransformBufferTex:d,uvTransformBufferDataCount:l.length/3,wrappingRootIndex:r/3,dispose:function(){l=null,d.dispose()}}}function oe(e,t,a,n,i,o,r){const s=Math.min(r.length/o,a);for(let l=0;l<s;l++)for(let a=0;a<o;a++)e[t](n+l*i+4*a,r[o*l+a],!0)}function re(e,t){const a={textures:[],indices:{}};for(const n of t)a.indices[n]=se(e,n,a.textures);return a}function se(e,t,a){const n=[];for(const i of e){if(i[t]&&i[t].image){let e=a.length;for(let n=0;n<a.length;n++)if(a[n]===i[t]){e=n;break}e===a.length&&a.push(i[t]),n.push(e)}else n.push(-1)}return n}function le(...e){let t=0;for(let n=0;n<e.length;n++){const a=e[n],i=a.data?a.data.length/a.channels:0;t=Math.max(t,i)}const a=[];for(let n=0;n<t;n++)for(let t=0;t<e.length;t++){const{data:i=[],channels:o}=e[t];for(let e=0;e<o;e++)a.push(i[n*o+e])}return a}function fe(e,t,a){const n=function(e,t,a){const n=e.getUniformBlockIndex(t,a),i=e.getActiveUniformBlockParameter(t,n,e.UNIFORM_BLOCK_DATA_SIZE),o=function(e,t,a){const n=e.getActiveUniformBlockParameter(t,a,e.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),i=e.getActiveUniforms(t,n,e.UNIFORM_OFFSET),o=e.getActiveUniforms(t,n,e.UNIFORM_ARRAY_STRIDE),r={};for(let s=0;s<n.length;s++){const{name:a,type:l,size:f}=e.getActiveUniform(t,n[s]);r[a]={type:l,size:f,offset:i[s],stride:o[s]}}return r}(e,t,n),r=e.createBuffer();e.bindBuffer(e.UNIFORM_BUFFER,r),e.bufferData(e.UNIFORM_BUFFER,i,e.STATIC_DRAW);const s=new DataView(new ArrayBuffer(i));return{set:function(t,a){if(!o[t])return;const{type:n,size:i,offset:r,stride:l}=o[t];switch(n){case e.FLOAT:oe(s,"setFloat32",i,r,l,1,a);break;case e.FLOAT_VEC2:oe(s,"setFloat32",i,r,l,2,a);break;case e.FLOAT_VEC3:oe(s,"setFloat32",i,r,l,3,a);break;case e.FLOAT_VEC4:oe(s,"setFloat32",i,r,l,4,a);break;case e.INT:oe(s,"setInt32",i,r,l,1,a);break;case e.INT_VEC2:oe(s,"setInt32",i,r,l,2,a);break;case e.INT_VEC3:oe(s,"setInt32",i,r,l,3,a);break;case e.INT_VEC4:oe(s,"setInt32",i,r,l,4,a);break;case e.BOOL:oe(s,"setUint32",i,r,l,1,a);break;default:console.warn("UniformBuffer: Unsupported type")}},bind:function(t){e.bindBuffer(e.UNIFORM_BUFFER,r),e.bufferSubData(e.UNIFORM_BUFFER,0,s),e.bindBufferBase(e.UNIFORM_BUFFER,t,r)},dispose:function(){e.deleteBuffer(r)}}}(e,t,"Materials");return n.set("Materials.colorAndMaterialType[0]",le({data:[].concat(...a.color.map((e=>e.toArray()))),channels:3},{data:a.type,channels:1})),n.set("Materials.roughnessMetalnessNormalScale[0]",le({data:a.roughness,channels:1},{data:a.metalness,channels:1},{data:[].concat(...a.normalScale.map((e=>e.toArray()))),channels:2})),n.set("Materials.alphaSpecularTintSheenSheenTint[0]",le({data:a.alpha,channels:1},{data:a.specularTint,channels:1},{data:a.sheen,channels:1},{data:a.sheenTint,channels:1})),n.set("Materials.clearcoaRoughnessSubfaceTransmission[0]",le({data:a.clearcoat,channels:1},{data:a.clearcoatRoughness,channels:1},{data:a.subsurface,channels:1},{data:a.transmission,channels:1})),n.set("Materials.iorAtDistanceAnisotropicWorkflow[0]",le({data:a.ior,channels:1},{data:a.atDistance,channels:1},{data:a.anisotropic,channels:1},{data:a.workflow,channels:1})),n.set("Materials.specularColorGlossiness[0]",le({data:[].concat(...a.specularColor.map((e=>e.toArray()))),channels:3},{data:a.glossiness,channels:1})),n.set("Materials.extinction[0]",le({data:[].concat(...a.extinction.map((e=>e.toArray()))),channels:3},{data:a.anisotropic,channels:1})),n.set("Materials.diffuseNormalRoughnessMetalnessMapIndex[0]",le({data:a.diffuseMapIndex,channels:1},{data:a.normalMapIndex,channels:1},{data:a.roughnessMapIndex,channels:1},{data:a.metalnessMapIndex,channels:1})),n.set("Materials.emissiveSpecularGlossinessMapIndex[0]",le({data:a.emissiveMapIndex,channels:1},{data:a.specularMapIndex,channels:1},{data:a.glossinessMapIndex,channels:1},{data:a.emissiveMapIndex,channels:1})),n.set("Materials.diffuseNormalMapSize[0]",le({data:a.diffuseMapSize,channels:2},{data:a.normalMapSize,channels:2})),n.set("Materials.pbrMapSize[0]",a.pbrMapSize),n.bind(0),n}function ue(e,t){let a;switch(t){case l:a=e.CLAMP_TO_EDGE;break;case f:a=e.REPEAT;break;case u:a=e.GL_MIRRORED_REPEAT}return a}function ce(e,t,a=!1,n=3){const i=t.map((e=>e.image)),o=t.map((e=>e.flipY)),r=t.map((t=>ue(e,t.wrapS))),s=t.map((t=>ue(e,t.wrapT))),{maxSize:l,relativeSizes:f}=function(e){const t={width:0,height:0};for(const n of e)t.width=Math.max(t.width,n.width),t.height=Math.max(t.height,n.height);const a=[];for(const n of e)a.push(n.width/t.width),a.push(n.height/t.height);return{maxSize:t,relativeSizes:a}}(i);return{texture:Z(e,{width:l.width,height:l.height,gammaCorrection:a,data:i,flipY:o,channels:n,minFilter:e.LINEAR,magFilter:e.LINEAR,wrapS:r,wrapT:s}),relativeSizes:f}}function de(e,t){const{materials:a,uvTransformBufferDataLength:n}=t,i=function(e,t){const a={};for(const n of t){const t=[];a[n]={indices:se(e,n,t),textures:t}}return a}(a,["map","normalMap","emissiveMap"]),o=re(a,["roughnessMap","metalnessMap"]),r=re(a,["specularMap","glossinessMap"]),s={},l={};if(l.color=a.map((e=>e.color)),l.roughness=a.map((e=>e.roughness)),l.metalness=a.map((e=>e.metalness)),l.normalScale=a.map((e=>e.normalScale)),l.specularTint=a.map((e=>e.specularTint)),l.sheen=a.map((e=>e.sheen)),l.sheenTint=a.map((e=>e.sheenTint)),l.clearcoat=a.map((e=>e.clearcoat)),l.clearcoatRoughness=a.map((e=>e.clearcoatRoughness)),l.transmission=a.map((e=>e.transmission)),l.subsurface=a.map((e=>e.subsurface)),l.ior=a.map((e=>e.ior)),l.atDistance=a.map((e=>e.atDistance)),l.extinction=a.map((e=>e.extinction)),l.alpha=a.map((e=>e.alpha)),l.workflow=a.map((e=>"Metalness"===e.workflow?0:1)),l.specularColor=a.map((e=>e.specularColor)),l.glossiness=a.map((e=>e.glossiness)),l.type=a.map((e=>0)),i.map.textures.length>0){const{relativeSizes:t,texture:a}=ce(e,i.map.textures,!0,4);s.diffuseMap=a,l.diffuseMapSize=t,l.diffuseMapIndex=i.map.indices}if(i.normalMap.textures.length>0){const{relativeSizes:t,texture:a}=ce(e,i.normalMap.textures,!1);s.normalMap=a,l.normalMapSize=t,l.normalMapIndex=i.normalMap.indices}if(o.textures.length>0){const{relativeSizes:t,texture:a}=ce(e,o.textures,!1);s.pbrMap=a,l.pbrMapSize=t,l.roughnessMapIndex=o.indices.roughnessMap,l.metalnessMapIndex=o.indices.metalnessMap}if(r.textures.length>0){const{relativeSizes:t,texture:a}=ce(e,r.textures,!1,4);s.pbrSGMap=a,l.pbrMapSize=t,l.specularMapIndex=r.indices.specularMap,l.glossinessMapIndex=r.indices.glossinessMap}if(i.emissiveMap.textures.length>0){const{relativeSizes:t,texture:a}=ce(e,i.emissiveMap.textures,!0);s.emissiveMap=a,l.pbrMapSize||(l.pbrMapSize=t),l.emissiveMapIndex=i.emissiveMap.indices}const f={NUM_MATERIALS:a.length,NUM_DIFFUSE_MAPS:i.map.textures.length,NUM_NORMAL_MAPS:i.normalMap.textures.length,NUM_DIFFUSE_NORMAL_MAPS:Math.max(i.map.textures.length,i.normalMap.textures.length),NUM_PBR_MAPS:o.textures.length,NUM_PBR_SG_MAPS:r.textures.length,NUM_EMISSIVE_MAPS:i.emissiveMap.textures.length,UVTRANSFORM_COLUMNS:W(n/3).columnsLog,SUPPORTED_MAPS:j.length},u=Y(e,{vertex:{source:"void main() {}"},fragment:{includes:["uniform sampler2D uvTransformBuffer;\nuniform int wrappingIndex;\n\n// given the index from a 1D array, retrieve corresponding position from packed 2D texture\nivec2 unpackTexel(int i, int columnsLog2) {\n\tivec2 u;\n\tu.y = i >> columnsLog2; // equivalent to (i / 2^columnsLog2) 除以行数得当前所在行\n\tu.x = i - (u.y << columnsLog2); // equivalent to (i % 2^columnsLog2) 区域得到当前所在列\n\treturn u;\n}\n\nvec4 fetchData(sampler2D s, int i, int columnsLog2) {\n\treturn texelFetch(s, unpackTexel(i, columnsLog2), 0);\n}\n\nivec4 fetchData(isampler2D s, int i, int columnsLog2) {\n\treturn texelFetch(s, unpackTexel(i, columnsLog2), 0);\n}\n\nuniform Materials {\n\tvec4 colorAndMaterialType[NUM_MATERIALS];\n\tvec4 roughnessMetalnessNormalScale[NUM_MATERIALS];\n\tvec4 alphaSpecularTintSheenSheenTint[NUM_MATERIALS];\n\tvec4 clearcoaRoughnessSubfaceTransmission[NUM_MATERIALS];\n\tvec4 iorAtDistanceAnisotropicWorkflow[NUM_MATERIALS];\n\tvec4 extinction[NUM_MATERIALS];\n\tvec4 specularColorGlossiness[NUM_MATERIALS];\n\n\t#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS) || defined(NUM_PBR_MAPS)\n\t\tivec4 diffuseNormalRoughnessMetalnessMapIndex[NUM_MATERIALS];\n\t#endif\n\n\t#if defined(NUM_EMISSIVE_MAPS) || defined(NUM_PBR_SG_MAPS)\n\t\tivec4 emissiveSpecularGlossinessMapIndex[NUM_MATERIALS];\n\t#endif\n\n\t#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS)\n\t\tvec4 diffuseNormalMapSize[NUM_DIFFUSE_NORMAL_MAPS];\n\t#endif\n\n\t#if defined(NUM_PBR_MAPS)\n\t\tvec2 pbrMapSize[NUM_PBR_MAPS];\n\t#else\n\t\t#if defined(NUM_PBR_SG_MAPS)\n\t\t\tvec2 pbrMapSize[NUM_PBR_SG_MAPS];\n\t\t#else\n\t\t\t#if defined(NUM_EMISSIVE_MAPS)\n\t\t\t\tvec2 pbrMapSize[NUM_EMISSIVE_MAPS];\n\t\t\t#endif\n\t\t#endif\n\t#endif\n} materials;\n\n#ifdef NUM_DIFFUSE_MAPS\n\tuniform mediump sampler2DArray diffuseMap;\n#endif\n\n#ifdef NUM_NORMAL_MAPS\n\tuniform mediump sampler2DArray normalMap;\n#endif\n\n#ifdef NUM_PBR_MAPS\n\tuniform mediump sampler2DArray pbrMap;\n#endif\n\n#ifdef NUM_PBR_SG_MAPS\n\tuniform mediump sampler2DArray pbrSGMap;\n#endif\n\n#ifdef NUM_EMISSIVE_MAPS\n\tuniform mediump sampler2DArray emissiveMap;\n#endif\n\nmat3 getMatUVTransform(int materialIndex, int mapKey) {\n\tint offset = materialIndex * SUPPORTED_MAPS * 3;\n\tint mapOffset = mapKey * 3;\n\tvec3 matRow1 = fetchData(uvTransformBuffer, offset + mapOffset + 0, UVTRANSFORM_COLUMNS).xyz;\n\tvec3 matRow2 = fetchData(uvTransformBuffer, offset + mapOffset + 1, UVTRANSFORM_COLUMNS).xyz;\n\tvec3 matRow3 = fetchData(uvTransformBuffer, offset + mapOffset + 2, UVTRANSFORM_COLUMNS).xyz;\n\tmat3 uvTransMat = mat3(matRow1, matRow2, matRow3);\n\treturn uvTransMat;\n}\n\nvec3 getMatWrapping(int materialIndex, int mapKey) {\n\tint offset = wrappingIndex + materialIndex * SUPPORTED_MAPS;\n\tint mapOffset = mapKey;\n\tvec3 wrappingData = fetchData(uvTransformBuffer, offset + mapOffset, UVTRANSFORM_COLUMNS).xyz;\n\treturn wrappingData;\n}\n\nvec2 applayTextureWrapping(vec2 uv, vec3 warpping) {\n\tif (uv.x <= 0. || uv.x >= 1.) {\n\t\tfloat warpS = warpping.x;\n\t\tif (warpS == 0.) {\n\t\t\t// ClampToEdgeWrapping\n\t\t\tuv.x = uv.x <= 0. ? 0. : 1.;\n\t\t} else if (warpS == 1.) {\n\t\t\t// RepeatWrapping\n\t\t\tuv.x = uv.x - floor(uv.x);\n\t\t}\n\t\t// MirroredRepeatWrapping\n\t}\n\tif (uv.y <= 0. || uv.y >= 1.) {\n\t\tfloat warpT = warpping.y;\n\t\tif (warpT == 0.) {\n\t\t\tuv.y = uv.y <= 0. ? 0. : 1.;\n\t\t} else if (warpT == 1.) {\n\t\t\tuv.y = uv.y - floor(uv.y);\n\t\t}\n\t}\n\n\treturn uv;\n}\n\nfloat getMatType(int materialIndex) {\n\treturn materials.colorAndMaterialType[materialIndex].w;\n}\n\nfloat getMatWorkflow(int materialIndex) {\n\treturn materials.iorAtDistanceAnisotropicWorkflow[materialIndex].w;\n}\n\nvec3 getMatEmissive(int materialIndex, vec2 uv) {\n\t// Todo: emissive Intensity\n\tvec3 emissive = vec3(0.0);\n\n\t#ifdef NUM_EMISSIVE_MAPS\n\t\tint emissiveMapIndex = materials.emissiveSpecularGlossinessMapIndex[materialIndex].x;\n\t\tif (emissiveMapIndex >= 0) {\n\t\t\tmat3 uvTransMat = getMatUVTransform(materialIndex, 6);\n\t\t\tuv = (uvTransMat * vec3(uv, 1)).xy;\n\t\t\tvec3 warpping = getMatWrapping(materialIndex, 6);\n\t\t\tuv = applayTextureWrapping(uv, warpping);\n\t\t\tuv = uv * materials.pbrMapSize[emissiveMapIndex].xy;\n\t\t\temissive = texture(emissiveMap, vec3(uv, emissiveMapIndex)).rgb;\n\t\t}\n\t#endif\n\t\n\treturn emissive;\n}\n\nvec3 getMatSpecularColor(int materialIndex, vec2 uv) {\n\tvec3 specularColor = materials.specularColorGlossiness[materialIndex].rgb;\n\n\t#ifdef NUM_PBR_SG_MAPS\n\t\tint specularMapIndex = materials.emissiveSpecularGlossinessMapIndex[materialIndex].y;\n\t\tif (specularMapIndex >= 0) {\n\t\t\tmat3 uvTransMat = getMatUVTransform(materialIndex, 4);\n\t\t\tuv = (uvTransMat * vec3(uv, 1)).xy;\n\t\t\tvec3 warpping = getMatWrapping(materialIndex, 4);\n\t\t\tuv = applayTextureWrapping(uv, warpping);\n\t\t\tuv = uv * materials.pbrMapSize[specularMapIndex].xy;\n\n\t\t\tvec3 texelSpecular = texture(pbrSGMap, vec3(uv, specularMapIndex)).rgb;\n\t\t\ttexelSpecular = pow(texelSpecular, vec3(2.2));\n\t\t\tspecularColor *= texelSpecular;\n\t\t}\n\t#endif\n\n\treturn specularColor;\n}\n\nfloat getMatGlossiness(int materialIndex, vec2 uv) {\n\tfloat glossiness = materials.specularColorGlossiness[materialIndex].a;\n\t#ifdef NUM_PBR_SG_MAPS\n\t\tint glossinessMapIndex = materials.emissiveSpecularGlossinessMapIndex[materialIndex].z;\n\t\tif (glossinessMapIndex >= 0) {\n\t\t\tmat3 uvTransMat = getMatUVTransform(materialIndex, 5);\n\t\t\tuv = (uvTransMat * vec3(uv, 1)).xy;\n\t\t\tvec3 warpping = getMatWrapping(materialIndex, 5);\n\t\t\tuv = applayTextureWrapping(uv, warpping);\n\t\t\tuv = uv * materials.pbrMapSize[glossinessMapIndex].xy;\n\t\t\tfloat texelGlossiness = texture(pbrSGMap, vec3(uv, glossinessMapIndex)).a;\n\t\t\t// 4D\n\t\t\t// float texelGlossiness = texture(pbrSGMap, vec3(uv, glossinessMapIndex)).x;\n\t\t\tglossiness *= texelGlossiness;\n\t\t}\n\t#endif\n\treturn glossiness;\n}\n\nfloat getMatRoughness(int materialIndex, vec2 uv) {\n\tfloat workflow = getMatWorkflow(materialIndex);\n\tfloat roughness = 0.0;\n\tif (workflow > 0.1) {\n\t\troughness = 1.0 - getMatGlossiness(materialIndex, uv);\n\t} else {\n\t\troughness = materials.roughnessMetalnessNormalScale[materialIndex].x;\n\n\t\t#ifdef NUM_PBR_MAPS\n\t\t\tint roughnessMapIndex = materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].z;\n\t\t\tif (roughnessMapIndex >= 0) {\n\t\t\t\tuv = uv * materials.pbrMapSize[roughnessMapIndex].xy;\n\t\t\t\tmat3 uvTransMat = getMatUVTransform(materialIndex, 2);\n\t\t\t\tuv = (uvTransMat * vec3(uv, 1)).xy;\n\t\t\t\tvec3 warpping = getMatWrapping(materialIndex, 2);\n\t\t\t\tuv = applayTextureWrapping(uv, warpping);\n\t\t\t\troughness *= texture(pbrMap, vec3(uv, roughnessMapIndex)).g;\n\t\t\t}\n\t\t#endif\n\t}\n\t// Remap\n\treturn roughness * roughness;\n}\n\nfloat max3(const vec3 v) {\n\treturn max(v.x, max(v.y, v.z));\n}\n\nfloat computeMetallicFromSpecularColor(const vec3 specularColor) {\n\treturn max3(specularColor);\n}\n\nvec3 computeDiffuseColor(const vec3 baseColor, float metallic) {\n\treturn baseColor * (1.0 - metallic);\n}\n\nfloat getMatMetalness(int materialIndex, vec2 uv) {\n\tfloat workflow = getMatWorkflow(materialIndex);\n\tfloat metalness = 0.0;\n\tif (workflow > 0.1) {\n\t\tvec3 specularFactor = getMatSpecularColor(materialIndex, uv);\n\t\tmetalness = computeMetallicFromSpecularColor(specularFactor);\n\t} else {\n\t\tmetalness = materials.roughnessMetalnessNormalScale[materialIndex].y;\n\n\t\t#ifdef NUM_PBR_MAPS\n\t\t\tint metalnessMapIndex = materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].w;\n\t\t\tif (metalnessMapIndex >= 0) {\n\t\t\t\tmat3 uvTransMat = getMatUVTransform(materialIndex, 3);\n\t\t\t\tuv = (uvTransMat * vec3(uv, 1)).xy;\n\t\t\t\tvec3 warpping = getMatWrapping(materialIndex, 3);\n\t\t\t\tuv = applayTextureWrapping(uv, warpping);\n\t\t\t\tuv = uv * materials.pbrMapSize[metalnessMapIndex].xy;\n\t\t\t\tmetalness *= texture(pbrMap, vec3(uv, metalnessMapIndex)).b;\n\t\t\t}\n\t\t#endif\n\t}\n\n\treturn metalness;\n}\n\nvec4 getMatColorAlpha(int materialIndex, vec2 uv) {\n\t// if (enableAlbedo && bounce == 0) return vec3(1.);\n\tvec3 color = materials.colorAndMaterialType[materialIndex].rgb;\n\tfloat alphaCutoff = 1.0;\n\t#ifdef NUM_DIFFUSE_MAPS\n\t\tint diffuseMapIndex = materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].x;\n\t\tif (diffuseMapIndex >= 0) {\n\t\t\tmat3 uvTransMat = getMatUVTransform(materialIndex, 0);\n\t\t\tuv = (uvTransMat * vec3(uv, 1)).xy;\n\t\t\tvec3 warpping = getMatWrapping(materialIndex, 0);\n\t\t\tuv = applayTextureWrapping(uv, warpping);\n\t\t\t\n\t\t\tuv = uv * materials.diffuseNormalMapSize[diffuseMapIndex].xy;\n\t\t\tvec4 diffuse = texture(diffuseMap, vec3(uv, diffuseMapIndex));\n\t\t\tcolor *= diffuse.rgb;\n\t\t\talphaCutoff = diffuse.a;\n\t\t}\n\t#endif\n\n\tfloat workflow = getMatWorkflow(materialIndex);\n\tif (workflow > 0.1) {\n\t\tvec3 specularFactor = getMatSpecularColor(materialIndex, uv);\n\t\tcolor = computeDiffuseColor(color, computeMetallicFromSpecularColor(specularFactor));\n\t}\n\n\treturn vec4(color, alphaCutoff);\n}\n\nvec3 getMatNormal(int materialIndex, vec2 uv, vec3 normal, vec3 dp1, vec3 dp2, vec2 duv1, vec2 duv2, inout vec3 tangent, inout vec3 bitangent) {\n\t// http://www.thetenthplanet.de/archives/1180\n\t// Compute co-tangent and co-bitangent vectors\n\tvec3 dp2perp = cross(dp2, normal);\n\tvec3 dp1perp = cross(normal, dp1);\n\tvec3 dpdu = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 dpdv = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat invmax = inversesqrt(max(dot(dpdu, dpdu), dot(dpdv, dpdv)));\n\tdpdu *= invmax;\n\tdpdv *= invmax;\n\n\t// All world space\n\t// Todo: /3ed-2018/Materials/BSDFs => WorldToLocal/LocalToWorld\n\ttangent = normalize(dpdu);\n\tbitangent = normalize(dpdv);\n\n#ifdef NUM_NORMAL_MAPS\n\tint normalMapIndex = materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].y;\n\tif (normalMapIndex >= 0) {\n\t\tmat3 uvTransMat = getMatUVTransform(materialIndex, 1);\n\t\tuv = (uvTransMat * vec3(uv, 1)).xy;\n\t\tvec3 warpping = getMatWrapping(materialIndex, 1);\n\t\tuv = applayTextureWrapping(uv, warpping);\n\n\t\tvec3 n = 2.0 * texture(normalMap, vec3(uv * materials.diffuseNormalMapSize[normalMapIndex].zw, normalMapIndex)).rgb - 1.0;\n\t\tn.xy *= materials.roughnessMetalnessNormalScale[materialIndex].zw;\n\n\t\tmat3 tbn = mat3(dpdu, dpdv, normal);\n\n\t\treturn normalize(tbn * n);\n\t} else {\n\t\treturn normal;\n\t}\n#endif\n\n\treturn normal;\n}\n\n// alphaSpecularTintSheenSheenTint\nfloat getMatAlpha(int materialIndex, vec2 uv) {\n\tfloat alpha =  materials.alphaSpecularTintSheenSheenTint[materialIndex].x;\n\t#ifdef NUM_DIFFUSE_MAPS\n\t\tint diffuseMapIndex = materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].x;\n\t\tif (diffuseMapIndex >= 0) {\n\t\t\talpha *= texture(diffuseMap, vec3(uv * materials.diffuseNormalMapSize[diffuseMapIndex].xy, diffuseMapIndex)).a;\n\t\t}\n\t#endif\n\treturn alpha;\n}\n\nfloat getMatSpecularTint(int materialIndex) {\n\treturn materials.alphaSpecularTintSheenSheenTint[materialIndex].y;\n}\n\nfloat getMatSheen(int materialIndex) {\n\treturn materials.alphaSpecularTintSheenSheenTint[materialIndex].z;\n}\n\nfloat getMatSheenTint(int materialIndex) {\n\treturn materials.alphaSpecularTintSheenSheenTint[materialIndex].w;\n}\n\n// clearcoaRoughnessSubfaceTransmission\nfloat getMatClearcoat(int materialIndex) {\n\treturn materials.clearcoaRoughnessSubfaceTransmission[materialIndex].x;\n}\n\nfloat getMatClearcoatRoughness(int materialIndex) {\n\treturn materials.clearcoaRoughnessSubfaceTransmission[materialIndex].y;\n}\n\nfloat getMatSubface(int materialIndex) {\n\treturn materials.clearcoaRoughnessSubfaceTransmission[materialIndex].z;\n}\n\nfloat getMatTransmission(int materialIndex) {\n\treturn materials.clearcoaRoughnessSubfaceTransmission[materialIndex].w;\n}\n\n// iorAtDistanceAnisotropicWorkflow\nfloat getMatIOR(int materialIndex) {\n\treturn materials.iorAtDistanceAnisotropicWorkflow[materialIndex].x;\n}\n\nfloat getMatAtDistance(int materialIndex) {\n\treturn materials.iorAtDistanceAnisotropicWorkflow[materialIndex].y;\n}\n\nfloat getMatAnisotropic(int materialIndex) {\n\treturn materials.iorAtDistanceAnisotropicWorkflow[materialIndex].z;\n}\n\nvec3 getMatExtinction(int materialIndex) {\n\treturn materials.extinction[materialIndex].rgb;\n}"],source:"void main() {}"},defines:f}),c=fe(e,u.program,l);return{defines:f,textures:s,dispose:function(){u.dispose(),c.dispose()}}}function pe(e){let t;if(t={width:e.data.image.width,height:e.data.image.height,data:e.data.image.data,dataFormat:"float"},e.data.type===v?t.data?t.data=function(e,t=1){const a=e.length/4,n=new Float32Array(3*a),i=[];for(let o=0;o<255;o++)i[o]=t*Math.pow(2,o-128)/255;for(let o=0;o<a;o++){const t=e[4*o],a=e[4*o+1],r=e[4*o+2],s=i[e[4*o+3]];n[3*o]=t*s,n[3*o+1]=a*s,n[3*o+2]=r*s}return n}(t.data,e.intensity):(t.data=function(e){const t=document.createElement("canvas"),a=t.getContext("2d");return t.width=e.width,t.height=e.height,a.drawImage(e,0,0),a.getImageData(0,0,t.width,t.height).data}(e.data.image),t.dataFormat="byte"):e.data.type==_?console.error("Please use 'new RGBELoader().setDataType(THREE.FloatType)' to load hdr env map. Half-Float type will loss of precision and have an impression of the effect."):e.data.type!==h&&console.error(`No support environmentLight's data type: ${e.data.type.toString()}`),e.data.type===h&&e.data.format===A){const a=e.data.image.data,n=a.length/4,i=new Float32Array(3*n);for(let e=0;e<n;e++)i[3*e+0]=a[4*e+0],i[3*e+1]=a[4*e+1],i[3*e+2]=a[4*e+2];t.data=i}return t}function me(e){const t=e.data,a={width:e.width+2,height:e.height+1},n=function(e,t,a){const n=new Float32Array(a*e*t);return{set(t,i,o,r){n[a*(i*e+t)+o]=r},get:(t,i,o)=>n[a*(i*e+t)+o],width:e,height:t,channels:a,array:n}}(a.width,a.height,2);for(let o=0;o<e.height;o++){const i=Math.sin(Math.PI*(o+.5)/e.height);for(let a=0;a<e.width;a++){const r=3*(o*e.width+a);let s=.2126*t[r]+.7152*t[r+1]+.0722*t[r+2];s*=i,n.set(a+2,o,0,n.get(a+1,o,0)+s/e.width),n.set(a+1,o,1,s)}const r=n.get(a.width-1,o,0);for(let e=1;e<n.width;e++)n.set(e,o,0,n.get(e,o,0)/r),n.set(e,o,1,n.get(e,o,1)/r);n.set(0,o+1,0,n.get(0,o,0)+r/e.height),n.set(0,o,1,r)}const i=n.get(0,n.height-1,0);for(let o=0;o<n.height;o++)n.set(0,o,0,n.get(0,o,0)/i),n.set(0,o,1,n.get(0,o,1)/i);return a.data=n.array,a}var Le={source:e=>"\n#define PI 3.14159265359\n#define TWOPI 6.28318530718\n#define INVPI 0.31830988618\n#define INVPI2 0.10132118364\n#define EPS 0.0001\n#define ONE_MINUS_EPS 0.999999\n#define INF 1000000.0\n#define ROUGHNESS_MIN 0.001\n#define DISNEY 0\nconst vec3 LGL_Af=vec3(0.2126,0.7152,0.0722);float LGL_Ae(vec3 color){return dot(color,LGL_Af);}\n#define RAY_MAX_DISTANCE 9999.0\nstruct Ray{vec3 o;vec3 d;float LGL_BZ;};struct Path{Ray ray;vec3 li;float alpha;vec3 beta;bool LGL_Bb;float LGL_Bc;vec3 LGL_Bd;};struct Camera{mat4 transform;float aspect;float fov;float focus;float aperture;};\n#if defined(NUM_LIGHTS)\nstruct Lights{vec3 position[NUM_LIGHTS];vec3 emission[NUM_LIGHTS];vec3 p1[NUM_LIGHTS];vec3 p2[NUM_LIGHTS];vec4 params[NUM_LIGHTS];};struct Light{vec3 position;vec3 emission;vec3 p1;vec3 p2;float radius;float area;float type;float LGL_s;};\n#endif\nstruct SurfaceInteraction{bool LGL_BV;bool LGL_BT;float t;vec3 position;vec3 normal;vec3 LGL_BX;vec3 LGL_BW;vec3 tangent;vec3 bitangent;vec3 color;vec3 extinction;vec3 emissive;int LGL_BS;float roughness;float metalness;float LGL_BQ;float LGL_BM;float LGL_BJ;float sheen;float LGL_BK;float clearcoat;float LGL_BL;float LGL_BN;float ior;float LGL_BP;float eta;float LGL_BO;vec3 specularColor;float LGL_BR;};struct BsdfSampleRec{vec3 L;vec3 f;float pdf;};struct LightSampleRec{vec3 normal;vec3 emission;vec3 direction;float dist;float pdf;};void LGL_Ag(inout Ray ray,vec3 origin,vec3 direction){ray.o=origin;ray.d=direction;ray.LGL_BZ=RAY_MAX_DISTANCE;}void LGL_Ag(inout Ray ray,vec3 origin,vec3 direction,float rMax){ray.o=origin;ray.d=direction;ray.LGL_BZ=rMax;}void LGL_Bn(inout Ray ray,in Ray targetRay){ray.o=targetRay.o;ray.d=targetRay.d;ray.LGL_BZ=targetRay.LGL_BZ;}uniform Camera camera;uniform vec2 pixelSize;uniform vec2 jitter;uniform float frameCount;in vec2 vCoord;\n#if defined(NUM_LIGHTS)\nuniform Lights lights;\n#endif\nuniform int bounces;uniform vec3 backgroundColor;uniform float envMapIntensity;uniform int enviromentVisible;uniform int tlasIndex;uniform sampler2D noiseTex;uniform float stratifiedSamples[71];uniform float strataSize;float pixelSeed;float LGL_AW(vec2 p){return fract(sin(dot(p,vec2(12.9898,78.233)))*43758.5453);}uvec4 seed;ivec2 pixel;void LGL_AX(float frame){pixel=ivec2(vCoord/pixelSize);seed=uvec4(pixel,int(frame),pixel.x+pixel.y);}void LGL_AY(inout uvec4 v){v=v*1664525u+1013904223u;v.x+=v.y*v.w;v.y+=v.z*v.x;v.z+=v.x*v.y;v.w+=v.y*v.z;v=v ^(v>>16u);v.x+=v.y*v.w;v.y+=v.z*v.x;v.z+=v.x*v.y;v.w+=v.y*v.z;}float LGL_AZ(){LGL_AY(seed);return float(seed.x)/float(0xffffffffu);}vec2 LGL_AZ2(){LGL_AY(seed);return vec2(seed.xy)/float(0xffffffffu);}void LGL_Ab(float frame){vec2 noiseSize=vec2(textureSize(noiseTex,0));pixelSeed=texture(noiseTex,vCoord/(pixelSize*noiseSize)).r;LGL_AX(frame);}int sampleIndex=0;float LGL_AZomSample(){float stratifiedSample=stratifiedSamples[sampleIndex++];float LGL_AZom=fract((stratifiedSample+pixelSeed)*strataSize);return EPS+(1.0-2.0*EPS)*LGL_AZom;}vec2 LGL_AZomSampleVec2(){return vec2(LGL_AZomSample(),LGL_AZomSample());}struct MaterialSamples{vec2 s1;vec2 s2;vec2 s3;vec2 s4;};MaterialSamples getRandomMaterialSamples(){MaterialSamples samples;samples.s1=LGL_AZomSampleVec2();samples.s2=LGL_AZomSampleVec2();samples.s3=LGL_AZomSampleVec2();samples.s4=LGL_AZomSampleVec2();return samples;}vec4 LGL_Ay(sampler2D map,vec2 uv){\n#ifdef OES_texture_float_linear\nreturn texture(map,uv);\n#else\nvec2 size=vec2(textureSize(map,0));vec2 texelSize=1.0/size;uv=uv*size-0.5;vec2 f=fract(uv);uv=floor(uv)+0.5;vec4 s1=texture(map,(uv+vec2(0,0))*texelSize);vec4 s2=texture(map,(uv+vec2(1,0))*texelSize);vec4 s3=texture(map,(uv+vec2(0,1))*texelSize);vec4 s4=texture(map,(uv+vec2(1,1))*texelSize);return mix(mix(s1,s2,f.x),mix(s3,s4,f.x),f.y);\n#endif\n}uniform sampler2D uvTransformBuffer;uniform int wrappingIndex;ivec2 LGL_Ah(int i,int LGL_Be){ivec2 u;u.y=i>>LGL_Be;u.x=i-(u.y<<LGL_Be);return u;}vec4 LGL_Ai(sampler2D s,int i,int LGL_Be){return texelFetch(s,LGL_Ah(i,LGL_Be),0);}ivec4 LGL_Ai(isampler2D s,int i,int LGL_Be){return texelFetch(s,LGL_Ah(i,LGL_Be),0);}uniform Materials{vec4 colorAndMaterialType[NUM_MATERIALS];vec4 roughnessMetalnessNormalScale[NUM_MATERIALS];vec4 alphaSpecularTintSheenSheenTint[NUM_MATERIALS];vec4 clearcoaRoughnessSubfaceTransmission[NUM_MATERIALS];vec4 iorAtDistanceAnisotropicWorkflow[NUM_MATERIALS];vec4 extinction[NUM_MATERIALS];vec4 specularColorGlossiness[NUM_MATERIALS];\n#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS) || defined(NUM_PBR_MAPS)\nivec4 diffuseNormalRoughnessMetalnessMapIndex[NUM_MATERIALS];\n#endif\n#if defined(NUM_EMISSIVE_MAPS) || defined(NUM_PBR_SG_MAPS)\nivec4 emissiveSpecularGlossinessMapIndex[NUM_MATERIALS];\n#endif\n#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS)\nvec4 diffuseNormalMapSize[NUM_DIFFUSE_NORMAL_MAPS];\n#endif\n#if defined(NUM_PBR_MAPS)\nvec2 pbrMapSize[NUM_PBR_MAPS];\n#else\n#if defined(NUM_PBR_SG_MAPS)\nvec2 pbrMapSize[NUM_PBR_SG_MAPS];\n#else\n#if defined(NUM_EMISSIVE_MAPS)\nvec2 pbrMapSize[NUM_EMISSIVE_MAPS];\n#endif\n#endif\n#endif\n}materials;\n#ifdef NUM_DIFFUSE_MAPS\nuniform mediump sampler2DArray diffuseMap;\n#endif\n#ifdef NUM_NORMAL_MAPS\nuniform mediump sampler2DArray normalMap;\n#endif\n#ifdef NUM_PBR_MAPS\nuniform mediump sampler2DArray pbrMap;\n#endif\n#ifdef NUM_PBR_SG_MAPS\nuniform mediump sampler2DArray pbrSGMap;\n#endif\n#ifdef NUM_EMISSIVE_MAPS\nuniform mediump sampler2DArray emissiveMap;\n#endif\nmat3 LGL_Bo(int materialIndex,int mapKey){int offset=materialIndex*SUPPORTED_MAPS*3;int mapOffset=mapKey*3;vec3 LGL_Bj=LGL_Ai(uvTransformBuffer,offset+mapOffset+0,UVTRANSFORM_COLUMNS).xyz;vec3 LGL_Bk=LGL_Ai(uvTransformBuffer,offset+mapOffset+1,UVTRANSFORM_COLUMNS).xyz;vec3 LGL_Bl=LGL_Ai(uvTransformBuffer,offset+mapOffset+2,UVTRANSFORM_COLUMNS).xyz;mat3 LGL_Bu=mat3(LGL_Bj,LGL_Bk,LGL_Bl);return LGL_Bu;}vec3 LGL_Bp(int materialIndex,int mapKey){int offset=wrappingIndex+materialIndex*SUPPORTED_MAPS;int mapOffset=mapKey;vec3 wrappingData=LGL_Ai(uvTransformBuffer,offset+mapOffset,UVTRANSFORM_COLUMNS).xyz;return wrappingData;}vec2 LGL_Bq(vec2 uv,vec3 LGL_Br){if(uv.x<=0.||uv.x>=1.){float LGL_Bs=LGL_Br.x;if(LGL_Bs==0.){uv.x=uv.x<=0. ? 0. : 1.;}else if(LGL_Bs==1.){uv.x=uv.x-floor(uv.x);}}if(uv.y<=0.||uv.y>=1.){float LGL_Bt=LGL_Br.y;if(LGL_Bt==0.){uv.y=uv.y<=0. ? 0. : 1.;}else if(LGL_Bt==1.){uv.y=uv.y-floor(uv.y);}}return uv;}float LGL_w(int materialIndex){return materials.colorAndMaterialType[materialIndex].w;}float LGL_x(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].w;}vec3 LGL_y(int materialIndex,vec2 uv){vec3 emissive=vec3(0.0);\n#ifdef NUM_EMISSIVE_MAPS\nint emissiveMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].x;if(emissiveMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,6);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,6);uv=LGL_Bq(uv,LGL_Br);uv=uv*materials.pbrMapSize[emissiveMapIndex].xy;emissive=texture(emissiveMap,vec3(uv,emissiveMapIndex)).rgb;}\n#endif\nreturn emissive;}vec3 LGL_z(int materialIndex,vec2 uv){vec3 specularColor=materials.specularColorGlossiness[materialIndex].rgb;\n#ifdef NUM_PBR_SG_MAPS\nint specularMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].y;if(specularMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,4);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,4);uv=LGL_Bq(uv,LGL_Br);uv=uv*materials.pbrMapSize[specularMapIndex].xy;vec3 LGL_AU=texture(pbrSGMap,vec3(uv,specularMapIndex)).rgb;LGL_AU=pow(LGL_AU,vec3(2.2));specularColor*=LGL_AU;}\n#endif\nreturn specularColor;}float LGL_AA(int materialIndex,vec2 uv){float glossiness=materials.specularColorGlossiness[materialIndex].a;\n#ifdef NUM_PBR_SG_MAPS\nint glossinessMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].z;if(glossinessMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,5);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,5);uv=LGL_Bq(uv,LGL_Br);uv=uv*materials.pbrMapSize[glossinessMapIndex].xy;float LGL_AV=texture(pbrSGMap,vec3(uv,glossinessMapIndex)).a;glossiness*=LGL_AV;}\n#endif\nreturn glossiness;}float LGL_AB(int materialIndex,vec2 uv){float LGL_BR=LGL_x(materialIndex);float roughness=0.0;if(LGL_BR>0.1){roughness=1.0-LGL_AA(materialIndex,uv);}else{roughness=materials.roughnessMetalnessNormalScale[materialIndex].x;\n#ifdef NUM_PBR_MAPS\nint roughnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].z;if(roughnessMapIndex>=0){uv=uv*materials.pbrMapSize[roughnessMapIndex].xy;mat3 LGL_Bu=LGL_Bo(materialIndex,2);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,2);uv=LGL_Bq(uv,LGL_Br);roughness*=texture(pbrMap,vec3(uv,roughnessMapIndex)).g;}\n#endif\n}return roughness*roughness;}float LGL_AC(const vec3 v){return max(v.x,max(v.y,v.z));}float LGL_AD(const vec3 specularColor){return LGL_AC(specularColor);}vec3 LGL_AE(const vec3 baseColor,float metallic){return baseColor*(1.0-metallic);}float LGL_AF(int materialIndex,vec2 uv){float LGL_BR=LGL_x(materialIndex);float metalness=0.0;if(LGL_BR>0.1){vec3 specularFactor=LGL_z(materialIndex,uv);metalness=LGL_AD(specularFactor);}else{metalness=materials.roughnessMetalnessNormalScale[materialIndex].y;\n#ifdef NUM_PBR_MAPS\nint metalnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].w;if(metalnessMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,3);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,3);uv=LGL_Bq(uv,LGL_Br);uv=uv*materials.pbrMapSize[metalnessMapIndex].xy;metalness*=texture(pbrMap,vec3(uv,metalnessMapIndex)).b;}\n#endif\n}return metalness;}vec4 LGL_AG(int materialIndex,vec2 uv){vec3 color=materials.colorAndMaterialType[materialIndex].rgb;float LGL_BO=1.0;\n#ifdef NUM_DIFFUSE_MAPS\nint diffuseMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].x;if(diffuseMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,0);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,0);uv=LGL_Bq(uv,LGL_Br);uv=uv*materials.diffuseNormalMapSize[diffuseMapIndex].xy;vec4 diffuse=texture(diffuseMap,vec3(uv,diffuseMapIndex));color*=diffuse.rgb;LGL_BO=diffuse.a;}\n#endif\nfloat LGL_BR=LGL_x(materialIndex);if(LGL_BR>0.1){vec3 specularFactor=LGL_z(materialIndex,uv);color=LGL_AE(color,LGL_AD(specularFactor));}return vec4(color,LGL_BO);}vec3 LGL_AH(int materialIndex,vec2 uv,vec3 normal,vec3 dp1,vec3 dp2,vec2 duv1,vec2 duv2,inout vec3 tangent,inout vec3 bitangent){vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 dpdu=dp2perp*duv1.x+dp1perp*duv2.x;vec3 dpdv=dp2perp*duv1.y+dp1perp*duv2.y;float invmax=inversesqrt(max(dot(dpdu,dpdu),dot(dpdv,dpdv)));dpdu*=invmax;dpdv*=invmax;tangent=normalize(dpdu);bitangent=normalize(dpdv);\n#ifdef NUM_NORMAL_MAPS\nint normalMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].y;if(normalMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,1);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,1);uv=LGL_Bq(uv,LGL_Br);vec3 n=2.0*texture(normalMap,vec3(uv*materials.diffuseNormalMapSize[normalMapIndex].zw,normalMapIndex)).rgb-1.0;n.xy*=materials.roughnessMetalnessNormalScale[materialIndex].zw;mat3 tbn=mat3(dpdu,dpdv,normal);return normalize(tbn*n);}else{return normal;}\n#endif\nreturn normal;}float LGL_AK(int materialIndex,vec2 uv){float alpha=materials.alphaSpecularTintSheenSheenTint[materialIndex].x;\n#ifdef NUM_DIFFUSE_MAPS\nint diffuseMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].x;if(diffuseMapIndex>=0){alpha*=texture(diffuseMap,vec3(uv*materials.diffuseNormalMapSize[diffuseMapIndex].xy,diffuseMapIndex)).a;}\n#endif\nreturn alpha;}float LGL_AI(int materialIndex){return materials.alphaSpecularTintSheenSheenTint[materialIndex].y;}float LGL_AJ(int materialIndex){return materials.alphaSpecularTintSheenSheenTint[materialIndex].z;}float LGL_AJTint(int materialIndex){return materials.alphaSpecularTintSheenSheenTint[materialIndex].w;}float LGL_AM(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].x;}float LGL_AMRoughness(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].y;}float LGL_AO(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].z;}float LGL_AP(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].w;}float LGL_AQ(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].x;}float LGL_AR(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].y;}float LGL_AS(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].z;}vec3 LGL_AT(int materialIndex){return materials.extinction[materialIndex].rgb;}uniform sampler2D positionBuffer;uniform sampler2D normalBuffer;uniform sampler2D transformBuffer;uniform sampler2D bvhBuffer;struct Triangle{vec3 p0;vec3 p1;vec3 p2;};struct Box{vec3 min;vec3 max;};struct TriangleIntersect{float t;vec3 barycentric;};float LGL_f(float rad,vec3 pos,Ray r){vec3 op=pos-r.o;float eps=0.001;float b=dot(op,r.d);float det=b*b-dot(op,op)+rad*rad;if(det<0.0)return INF;det=sqrt(det);float t1=b-det;if(t1>eps)return t1;float t2=b+det;if(t2>eps)return t2;return INF;}float LGL_g(in vec3 pos,in vec3 u,in vec3 v,in vec4 plane,in Ray r){vec3 n=vec3(plane);float dt=dot(r.d,n);float t=(plane.w-dot(n,r.o))/dt;if(t>EPS){vec3 p=r.o+r.d*t;vec3 vi=p-pos;float a1=dot(u,vi);if(a1>=0.&&a1<=1.){float a2=dot(v,vi);if(a2>=0.&&a2<=1.)return t;}}return INF;}float LGL_h(vec3 v0,vec3 v1,vec3 v2,Ray r,bool isDoubleSided){vec3 edge1=v1-v0;vec3 edge2=v2-v0;vec3 pvec=cross(r.d,edge2);float det=1.0/dot(edge1,pvec);if(!isDoubleSided&&det<0.0)return INF;vec3 tvec=r.o-v0;float u=dot(tvec,pvec)*det;vec3 qvec=cross(tvec,edge1);float v=dot(r.d,qvec)*det;float t=dot(edge2,qvec)*det;return(u<0.0||u>1.0||v<0.0||u+v>1.0||t<=0.0)? INF : t;}float LGL_gClassic(vec3 v1,vec3 v2,vec3 v3,vec3 v4,Ray r,bool isDoubleSided){return min(LGL_h(v1,v3,v2,r,isDoubleSided),LGL_h(v2,v3,v4,r,isDoubleSided));}void LGL_j(inout SurfaceInteraction si,Triangle tri,vec3 barycentric,ivec3 index,vec3 u,vec3 LGL_BX,int materialIndex){si.LGL_BV=true;si.LGL_BX=LGL_BX;si.position=barycentric.x*tri.p0+barycentric.y*tri.p1+barycentric.z*tri.p2;ivec2 i0=LGL_Ah(index.x,VERTEX_COLUMNS);ivec2 i1=LGL_Ah(index.y,VERTEX_COLUMNS);ivec2 i2=LGL_Ah(index.z,VERTEX_COLUMNS);vec4 nu0=texelFetch(normalBuffer,i0,0).xyzw;vec4 nu1=texelFetch(normalBuffer,i1,0).xyzw;vec4 nu2=texelFetch(normalBuffer,i2,0).xyzw;vec3 n0=nu0.xyz;vec3 n1=nu1.xyz;vec3 n2=nu2.xyz;vec3 normal=normalize(barycentric.x*n0+barycentric.y*n1+barycentric.z*n2);vec2 uv0=vec2(u.x,nu0.w);vec2 uv1=vec2(u.y,nu1.w);vec2 uv2=vec2(u.z,nu2.w);\n#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS) || defined(NUM_PBR_MAPS)\nvec2 uv=barycentric.x*uv0+barycentric.y*uv1+barycentric.z*uv2;\n#else\nvec2 uv=vec2(0.0);\n#endif\nsi.LGL_BS=int(LGL_w(materialIndex));vec4 colorAlpha=LGL_AG(materialIndex,uv);si.color=colorAlpha.rgb;si.LGL_BO=colorAlpha.a;si.roughness=LGL_AB(materialIndex,uv);si.metalness=LGL_AF(materialIndex,uv);si.specularColor=LGL_z(materialIndex,uv);si.LGL_BR=LGL_x(materialIndex);si.emissive=LGL_y(materialIndex,uv);vec3 dp1=tri.p0-tri.p2;vec3 dp2=tri.p1-tri.p2;vec2 duv1=uv0-uv2;vec2 duv2=uv1-uv2;si.normal=LGL_AH(materialIndex,uv,normal,dp1,dp2,duv1,duv2,si.tangent,si.bitangent);si.LGL_BJ=LGL_AI(materialIndex);si.sheen=LGL_AJ(materialIndex);si.LGL_BK=LGL_AJTint(materialIndex);si.clearcoat=LGL_AM(materialIndex);si.LGL_BL=LGL_AMRoughness(materialIndex);si.LGL_BM=LGL_AO(materialIndex);si.LGL_BN=LGL_AP(materialIndex);si.ior=LGL_AQ(materialIndex);si.LGL_BP=LGL_AR(materialIndex);si.LGL_BQ=LGL_AS(materialIndex);si.extinction=LGL_AT(materialIndex);}TriangleIntersect LGL_k(Ray r,Triangle tri){vec3 v0=tri.p0;vec3 v1=tri.p1;vec3 v2=tri.p2;TriangleIntersect ti;vec3 e0=v1-v0;vec3 e1=v2-v0;vec3 pv=cross(r.d,e1);float det=dot(e0,pv);vec3 tv=r.o-v0;vec3 qv=cross(tv,e0);vec4 uvt;uvt.x=dot(tv,pv);uvt.y=dot(r.d,qv);uvt.z=dot(e1,qv);uvt.xyz=uvt.xyz/det;uvt.w=1.0-uvt.x-uvt.y;if(uvt.z>=r.LGL_BZ){return ti;}if(all(greaterThanEqual(uvt,vec4(0.0)))&&uvt.z<INF){ti.t=uvt.z;ti.barycentric=uvt.wxy;}return ti;}float LGL_l(Ray r,Box b){vec3 LGL_BY=1.0/r.d;vec3 tBot=(b.min-r.o)*LGL_BY;vec3 tTop=(b.max-r.o)*LGL_BY;vec3 tNear=min(tBot,tTop);vec3 tFar=max(tBot,tTop);float t0=max(tNear.x,max(tNear.y,tNear.z));float t1=min(tFar.x,min(tFar.y,tFar.z));return(t0>t1||t0>r.LGL_BZ)?-1.0 :(t0>0.0 ? t0 : t1);}bool LGL_m(inout Ray ray,float maxDist){\n#if defined(NUM_LIGHTS)\nfor(int i=0;i<NUM_LIGHTS;i++){vec3 position=lights.position[i];vec3 emission=lights.emission[i];vec3 p1=lights.p1[i];vec3 p2=lights.p2[i];vec4 params=lights.params[i];float radius=params.x;float area=params.y;float type=params.z;float LGL_s=params.w;if(type==0.||type==1.){vec3 normal=normalize(cross(p1,p2));if(dot(normal,ray.d)>0.)continue;vec4 plane=vec4(normal,dot(normal,position));p1*=1.0/dot(p1,p1);p2*=1.0/dot(p2,p2);float d=LGL_g(position,p1,p2,plane,ray);if(d>0.&&d<maxDist)return true;}if(type==1.){float d=LGL_f(radius,position,ray);if(d>0.&&d<maxDist)return true;}}\n#endif\nint LGL_p[MAX_DEPTH];LGL_p[0]=tlasIndex;int LGL_Bf=0;bool LGL_Bg=false;mat4 LGL_Bh;mat4 LGL_BhInverse;Ray LGL_Bi;LGL_Bn(LGL_Bi,ray);int LGL_t=0;while(LGL_t>=0){int i=LGL_p[LGL_t--];if(LGL_Bg&&i==-1){LGL_Bg=false;LGL_Bn(LGL_Bi,ray);continue;}vec4 r1=LGL_Ai(bvhBuffer,i,BVH_COLUMNS);vec4 r2=LGL_Ai(bvhBuffer,i+1,BVH_COLUMNS);int LGL_q=int(r1.w);if(LGL_q>0){int LGL_r=LGL_q-1;Box bbox=Box(r1.xyz,r2.xyz);if(LGL_l(LGL_Bi,bbox)>0.0){if(LGL_Bi.d[LGL_r]>0.0){LGL_p[++LGL_t]=int(r2.w);LGL_p[++LGL_t]=i+2;}else{LGL_p[++LGL_t]=i+2;LGL_p[++LGL_t]=int(r2.w);}}}else if(LGL_q<0){ivec3 index=ivec3(r1.xyz);Triangle tri=Triangle(LGL_Ai(positionBuffer,index.x,VERTEX_COLUMNS).xyz,LGL_Ai(positionBuffer,index.y,VERTEX_COLUMNS).xyz,LGL_Ai(positionBuffer,index.z,VERTEX_COLUMNS).xyz);TriangleIntersect LGL_BV=LGL_k(LGL_Bi,tri);if(LGL_BV.t>0.0&&LGL_BV.t<maxDist){return true;}}else{int LGL_s=int(r2.x);if(LGL_s==0){continue;}int LGL_u=int(r1.z);vec4 LGL_Bj=LGL_Ai(transformBuffer,LGL_u*4+0,TRANSFORM_COLUMNS).xyzw;vec4 LGL_Bk=LGL_Ai(transformBuffer,LGL_u*4+1,TRANSFORM_COLUMNS).xyzw;vec4 LGL_Bl=LGL_Ai(transformBuffer,LGL_u*4+2,TRANSFORM_COLUMNS).xyzw;vec4 LGL_Bm=LGL_Ai(transformBuffer,LGL_u*4+3,TRANSFORM_COLUMNS).xyzw;LGL_Bh=mat4(LGL_Bj,LGL_Bk,LGL_Bl,LGL_Bm);LGL_BhInverse=inverse(LGL_Bh);LGL_Bi.o=vec3(LGL_BhInverse*vec4(ray.o,1.0));LGL_Bi.d=vec3(LGL_BhInverse*vec4(ray.d,0.0));LGL_p[++LGL_t]=-1;LGL_p[++LGL_t]=int(r1.x);LGL_Bg=true;LGL_Bf=int(r1.y);continue;}}return false;}void LGL_n(inout Ray ray,inout SurfaceInteraction si,inout LightSampleRec lightSampleRec,int bounce){si.LGL_BV=false;float t=INF;float d;\n#if defined(NUM_LIGHTS)\nfor(int i=0;i<NUM_LIGHTS;i++){vec4 params=lights.params[i];float radius=params.x;float area=params.y;float type=params.z;float LGL_s=params.w;if(bounce==0&&LGL_s<0.1)continue;vec3 position=lights.position[i];vec3 emission=lights.emission[i];vec3 p1=lights.p1[i];vec3 p2=lights.p2[i];if(type==0.||type==1.){vec3 normal=normalize(cross(p1,p2));if(dot(normal,ray.d)>0.)continue;vec4 plane=vec4(normal,dot(normal,position));p1*=1.0/dot(p1,p1);p2*=1.0/dot(p2,p2);d=LGL_g(position,p1,p2,plane,ray);if(d<0.)d=INF;if(d<t){t=d;float cosTheta=dot(-ray.d,normal);float pdf=(t*t)/(area*cosTheta);lightSampleRec.emission=emission;lightSampleRec.pdf=pdf;si.LGL_BV=true;si.LGL_BT=true;ray.LGL_BZ=t;}}if(type==2.){d=LGL_f(radius,position,ray);if(d<0.)d=INF;if(d<t){t=d;float pdf=(t*t)/area;lightSampleRec.emission=emission;lightSampleRec.pdf=pdf;si.LGL_BV=true;si.LGL_BT=true;ray.LGL_BZ=t;}}}\n#endif\nint LGL_p[MAX_DEPTH];LGL_p[0]=tlasIndex;int LGL_Bf=0;bool LGL_Bg=false;mat4 LGL_Bh;mat4 LGL_BhInverse;Ray LGL_Bi;LGL_Bn(LGL_Bi,ray);int LGL_t=0;while(LGL_t>=0){int i=LGL_p[LGL_t--];if(LGL_Bg&&i==-1){LGL_Bg=false;LGL_Bn(LGL_Bi,ray);continue;}vec4 r1=LGL_Ai(bvhBuffer,i,BVH_COLUMNS);vec4 r2=LGL_Ai(bvhBuffer,i+1,BVH_COLUMNS);int LGL_q=int(r1.w);if(LGL_q>0){int LGL_r=LGL_q-1;Box bbox=Box(r1.xyz,r2.xyz);if(LGL_l(LGL_Bi,bbox)>0.0){if(LGL_Bi.d[LGL_r]>0.0){LGL_p[++LGL_t]=int(r2.w);LGL_p[++LGL_t]=i+2;}else{LGL_p[++LGL_t]=i+2;LGL_p[++LGL_t]=int(r2.w);}}}else if(LGL_q<0){ivec3 index=ivec3(r1.xyz);vec4 pu0=LGL_Ai(positionBuffer,index.x,VERTEX_COLUMNS).xyzw;vec4 pu1=LGL_Ai(positionBuffer,index.y,VERTEX_COLUMNS).xyzw;vec4 pu2=LGL_Ai(positionBuffer,index.z,VERTEX_COLUMNS).xyzw;Triangle tri=Triangle(pu0.xyz,pu1.xyz,pu2.xyz);TriangleIntersect LGL_BV=LGL_k(LGL_Bi,tri);if(LGL_BV.t>0.0){vec3 LGL_BX=r2.xyz;si.t=LGL_BV.t;si.LGL_BT=false;LGL_Bi.LGL_BZ=LGL_BV.t;ray.LGL_BZ=LGL_BV.t;vec3 u=vec3(pu0.w,pu1.w,pu2.w);LGL_j(si,tri,LGL_BV.barycentric,index,u,LGL_BX,LGL_Bf);si.position=vec3(LGL_Bh*vec4(si.position,1.0));mat3 inverseNormalMat=transpose(mat3(LGL_BhInverse));si.normal=normalize(inverseNormalMat*si.normal);si.LGL_BW=dot(normalize(inverseNormalMat*si.LGL_BX),ray.d)<=0.0 ? si.normal :-si.normal;}}else{int LGL_s=int(r2.x);if(LGL_s==0){continue;}int LGL_u=int(r1.z);vec4 LGL_Bj=LGL_Ai(transformBuffer,LGL_u*4+0,TRANSFORM_COLUMNS).xyzw;vec4 LGL_Bk=LGL_Ai(transformBuffer,LGL_u*4+1,TRANSFORM_COLUMNS).xyzw;vec4 LGL_Bl=LGL_Ai(transformBuffer,LGL_u*4+2,TRANSFORM_COLUMNS).xyzw;vec4 LGL_Bm=LGL_Ai(transformBuffer,LGL_u*4+3,TRANSFORM_COLUMNS).xyzw;LGL_Bh=mat4(LGL_Bj,LGL_Bk,LGL_Bl,LGL_Bm);LGL_BhInverse=inverse(LGL_Bh);LGL_Bi.o=vec3(LGL_BhInverse*vec4(ray.o,1.0));LGL_Bi.d=vec3(LGL_BhInverse*vec4(ray.d,0.0));LGL_p[++LGL_t]=-1;LGL_p[++LGL_t]=int(r1.x);LGL_Bg=true;LGL_Bf=int(r1.y);continue;}}si.roughness=clamp(si.roughness,ROUGHNESS_MIN,1.0);si.metalness=clamp(si.metalness,0.0,1.0);}void LGL_o(inout Ray ray,inout SurfaceInteraction si,inout LightSampleRec lightSampleRec,int depth){if(si.LGL_BV&&!si.LGL_BT&&si.LGL_BO<1.0){float LGL_v=0.;float LGL_BU=LGL_AZ();while(si.LGL_BV&&!si.LGL_BT&&LGL_BU>si.LGL_BO&&LGL_v<2.){LGL_Ag(ray,si.position+EPS*ray.d,ray.d);LGL_n(ray,si,lightSampleRec,depth);LGL_v++;}}}\n#ifndef CONST_COLOR_ENV\nuniform sampler2D envMap;uniform sampler2D envMapDistribution;vec2 LGL_Y(vec3 pointOnSphere){float phi=mod(atan(-pointOnSphere.z,-pointOnSphere.x),TWOPI);float theta=acos(pointOnSphere.y);return vec2(phi*0.5*INVPI,theta*INVPI);}vec3 LGL_Z(vec3 d){vec2 uv=LGL_Y(d);return LGL_Ay(envMap,uv).rgb;}float LGL_a(float u,out int vOffset,out float pdf){ivec2 size=textureSize(envMap,0);int left=0;int right=size.y+1;while(left<right){int mid=(left+right)>>1;float s=texelFetch(envMapDistribution,ivec2(0,mid),0).x;if(s<=u){left=mid+1;}else{right=mid;}}vOffset=left-1;vec2 s0=texelFetch(envMapDistribution,ivec2(0,vOffset),0).xy;vec2 s1=texelFetch(envMapDistribution,ivec2(0,vOffset+1),0).xy;pdf=s0.y;return(float(vOffset)+(u-s0.x)/(s1.x-s0.x))/float(size.y);}float LGL_b(float u,int vOffset,out float pdf){ivec2 size=textureSize(envMap,0);int left=0;int right=size.x+1;while(left<right){int mid=(left+right)>>1;float s=texelFetch(envMapDistribution,ivec2(1+mid,vOffset),0).x;if(s<=u){left=mid+1;}else{right=mid;}}int uOffset=left-1;vec2 s0=texelFetch(envMapDistribution,ivec2(1+uOffset,vOffset),0).xy;vec2 s1=texelFetch(envMapDistribution,ivec2(1+uOffset+1,vOffset),0).xy;pdf=s0.y;return(float(uOffset)+(u-s0.x)/(s1.x-s0.x))/float(size.x);}float LGL_c(vec2 uv){vec2 size=vec2(textureSize(envMap,0));float sinTheta=sin(uv.y*PI);uv*=size;float partialX=texelFetch(envMapDistribution,ivec2(1.0+uv.x,uv.y),0).y;float partialY=texelFetch(envMapDistribution,ivec2(0,uv.y),0).y;return partialX*partialY*INVPI2/(2.0*sinTheta);}vec3 LGL_d(vec2 LGL_AZom,out vec2 uv,out float pdf){vec2 partialPdf;int vOffset;uv.y=LGL_a(LGL_AZom.x,vOffset,partialPdf.y);uv.x=LGL_b(LGL_AZom.y,vOffset,partialPdf.x);float phi=uv.x*TWOPI;float theta=uv.y*PI;float cosTheta=cos(theta);float sinTheta=sin(theta);float cosPhi=cos(phi);float sinPhi=sin(phi);vec3 dir=vec3(-sinTheta*cosPhi,cosTheta,-sinTheta*sinPhi);pdf=partialPdf.x*partialPdf.y*INVPI2/(2.0*sinTheta);return dir;}\n#endif\nvoid LGL_Ak(in vec3 N,inout vec3 T,inout vec3 B){if(N.z<-0.999999){T=vec3(0.,-1.,0.);B=vec3(-1.,0.,0.);}else{float a=1.0/(1.+N.z);float b=-N.x*N.y*a;T=vec3(1.0-N.x*N.x*a,b,-N.x);B=vec3(b,1.-N.y*N.y*a,-N.y);}}vec3 LGL_Ax(vec3 V,float rgh,float r1,float r2){vec3 Vh=normalize(vec3(rgh*V.x,rgh*V.y,V.z));float lensq=Vh.x*Vh.x+Vh.y*Vh.y;vec3 T1=lensq>0. ? vec3(-Vh.y,Vh.x,0)*inversesqrt(lensq): vec3(1.,0.,0.);vec3 T2=cross(Vh,T1);float r=sqrt(r1);float phi=2.0*PI*r2;float t1=r*cos(phi);float t2=r*sin(phi);float s=0.5*(1.0+Vh.z);t2=(1.0-s)*sqrt(1.0-t1*t1)+s*t2;vec3 Nh=t1*T1+t2*T2+sqrt(max(0.0,1.0-t1*t1-t2*t2))*Vh;return normalize(vec3(rgh*Nh.x,rgh*Nh.y,max(0.0,Nh.z)));}vec2 LGL_Al(vec2 p){p=2.0*p-1.0;bool greater=abs(p.x)>abs(p.y);float r=greater ? p.x : p.y;float theta=greater ? 0.25*PI*p.y/p.x : PI*(0.5-0.25*p.x/p.y);return r*vec2(cos(theta),sin(theta));}vec3 LGL_Am(vec2 p){vec2 h=LGL_Al(p);float z=sqrt(max(0.0,1.0-h.x*h.x-h.y*h.y));return vec3(h,z);}vec3 LGL_An(float r1,float r2){float z=1.0-2.0*r1;float r=sqrt(max(0.0,1.0-z*z));float phi=TWOPI*r2;return vec3(r*cos(phi),r*sin(phi),z);}vec3 LGL_Ao(vec3 LGL_BX,vec3 viewDir,mat3 basis,float roughness,vec2 LGL_AZom){float phi=TWOPI*LGL_AZom.y;float alpha=roughness*roughness;float cosTheta=sqrt((1.0-LGL_AZom.x)/(1.0+(alpha*alpha-1.0)*LGL_AZom.x));float sinTheta=sqrt(1.0-cosTheta*cosTheta);vec3 halfVector=basis*sign(dot(LGL_BX,viewDir))*vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);vec3 lightDir=reflect(-viewDir,halfVector);return lightDir;}vec3 LGL_Ap(vec3 LGL_BX,vec3 viewDir,mat3 basis,vec2 LGL_AZom){return basis*sign(dot(LGL_BX,viewDir))*LGL_Am(LGL_AZom);}float LGL_Aq(float f,float g){return(f*f)/(f*f+g*g);}vec3 LGL_Ar(in Ray r,int depth,in LightSampleRec lightSampleRec,in BsdfSampleRec bsdfSampleRec){vec3 Le;if(depth==0){Le=lightSampleRec.emission;}else{Le=LGL_Aq(bsdfSampleRec.pdf,lightSampleRec.pdf)*lightSampleRec.emission;}return Le;}\n#if defined(NUM_LIGHTS)\nvoid LGL_As(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec,vec2 LGL_AZom){float r1=LGL_AZom.x;float r2=LGL_AZom.y;vec3 lightSurfacePos=light.position+LGL_An(r1,r2)*light.radius;lightSampleRec.direction=lightSurfacePos-surfacePos;lightSampleRec.dist=length(lightSampleRec.direction);float distSq=lightSampleRec.dist*lightSampleRec.dist;lightSampleRec.direction/=lightSampleRec.dist;lightSampleRec.normal=normalize(lightSurfacePos-light.position);lightSampleRec.emission=light.emission*float(NUM_LIGHTS);lightSampleRec.pdf=distSq/(light.area*abs(dot(lightSampleRec.normal,lightSampleRec.direction)));}void LGL_Au(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec,vec2 LGL_AZom){float r1=LGL_AZom.x;float r2=LGL_AZom.y;vec3 lightSurfacePos=light.position+light.p1*r1+light.p2*r2;lightSampleRec.direction=lightSurfacePos-surfacePos;lightSampleRec.dist=length(lightSampleRec.direction);float distSq=lightSampleRec.dist*lightSampleRec.dist;lightSampleRec.direction/=lightSampleRec.dist;lightSampleRec.normal=normalize(cross(light.p1,light.p2));lightSampleRec.emission=light.emission*float(NUM_LIGHTS);lightSampleRec.pdf=distSq/(light.area*abs(dot(lightSampleRec.normal,lightSampleRec.direction)));}void LGL_Av(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec){lightSampleRec.direction=normalize(light.position-light.p1);lightSampleRec.normal=normalize(surfacePos-light.position);if(dot(lightSampleRec.direction,lightSampleRec.normal)>0.0){lightSampleRec.normal=-lightSampleRec.normal;}lightSampleRec.emission=light.emission*float(NUM_LIGHTS);lightSampleRec.dist=INF;lightSampleRec.pdf=1.0;}void samplePointLight(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec){lightSampleRec.direction=light.position-surfacePos;lightSampleRec.dist=length(lightSampleRec.direction);float distSq=lightSampleRec.dist*lightSampleRec.dist;lightSampleRec.direction=normalize(lightSampleRec.direction);lightSampleRec.normal=normalize(surfacePos-light.position);lightSampleRec.emission=light.emission*float(NUM_LIGHTS)/distSq;lightSampleRec.pdf=1.0;}void LGL_Aw(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec,vec2 LGL_AZom){int type=int(light.type);if(type==0||type==1){LGL_Au(light,surfacePos,lightSampleRec,LGL_AZom);}else if(type==2){LGL_As(light,surfacePos,lightSampleRec,LGL_AZom);}else if(type==3){LGL_Av(light,surfacePos,lightSampleRec);}else if(type==4){samplePointLight(light,surfacePos,lightSampleRec);}}\n#endif\nvec3 LocalToWorld(vec3 X,vec3 Y,vec3 Z,vec3 V){return vec3(X.x*V.x+Y.x*V.y+Z.x*V.z,X.y*V.x+Y.y*V.y+Z.y*V.z,X.z*V.x+Y.z*V.y+Z.z*V.z);}vec3 WorldToLocal(vec3 X,vec3 Y,vec3 Z,vec3 V){return vec3(dot(V,X),dot(V,Y),dot(V,Z));}vec3 LGL_A(float r1,float r2){vec3 dir;float r=sqrt(r1);float phi=TWOPI*r2;dir.x=r*cos(phi);dir.y=r*sin(phi);dir.z=sqrt(max(0.0,1.0-dir.x*dir.x-dir.y*dir.y));return dir;}float LGL_B(float eta){float sqrtR0=(eta-1.)/(eta+1.);return sqrtR0*sqrtR0;}vec3 LGL_C(vec3 baseColor){float LGL_Af=LGL_Ae(baseColor);return(LGL_Af>0.0)? baseColor/LGL_Af : vec3(1.);}void LGL_D(SurfaceInteraction si,out vec3 Cspec0,out vec3 Csheen){vec3 tint=LGL_C(si.color);if(si.LGL_BR>0.1){Cspec0=si.specularColor;}else{Cspec0=mix(LGL_B(si.ior)*mix(vec3(1.0),tint,min(si.LGL_BJ,0.99)),si.color,si.metalness);}Csheen=mix(vec3(1.0),tint,si.LGL_BK);}float LGL_E(float u){float m=clamp(1.0-u,0.0,1.0);float m2=m*m;return m2*m2*m;}float LGL_F(float F0,float cosTheta){return mix(F0,1.0,LGL_E(cosTheta));}vec3 LGL_F(vec3 F0,float cosTheta){return mix(F0,vec3(1.),LGL_E(cosTheta));}float LGL_G(float cosThetaI,float eta){float sinThetaTSq=eta*eta*(1.0f-cosThetaI*cosThetaI);if(sinThetaTSq>1.0)return 1.0;float cosThetaT=sqrt(max(1.0-sinThetaTSq,0.0));float rs=(eta*cosThetaT-cosThetaI)/(eta*cosThetaT+cosThetaI);float rp=(eta*cosThetaI-cosThetaT)/(eta*cosThetaI+cosThetaT);return 0.5*(rs*rs+rp*rp);}vec3 LGL_H(vec3 F0,float metalness,float eta,float cosThetaI){vec3 FrSchlick=LGL_F(F0,cosThetaI);float FrDielectric=LGL_G(cosThetaI,eta);return mix(vec3(FrDielectric),FrSchlick,metalness);}float LGL_H(float metalness,float eta,float cosThetaI){float FrSchlick=LGL_E(cosThetaI);float FrDielectric=LGL_G(cosThetaI,eta);return mix(FrDielectric,FrSchlick,metalness);}float LGL_I(float NDotV,float alphaG){float a=alphaG*alphaG;float b=NDotV*NDotV;return 1.0/(NDotV+sqrt(a+b-a*b));}float LGL_J(float NDotH,float alpha){float alpha2=alpha*alpha;float t=1.0+(alpha2-1.0)*NDotH*NDotH;return(alpha2-1.0)/(PI*log(alpha2)*t);}float LGL_K(float NDotH,float a){float a2=a*a;float t=1.0+(a2-1.0)*NDotH*NDotH;return a2/(PI*t*t);}vec3 ImportanceSampleLGL_J(float rgh,float r1,float r2){float a=max(0.001,rgh);float a2=a*a;float phi=r1*TWOPI;float cosTheta=sqrt((1.0-pow(a2,1.0-r1))/(1.0-a2));float sinTheta=clamp(sqrt(1.0-(cosTheta*cosTheta)),0.0,1.0);float sinPhi=sin(phi);float cosPhi=cos(phi);return vec3(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}vec3 ImportanceSampleLGL_K(float rgh,float r1,float r2){float a=max(0.001,rgh);float phi=r1*TWOPI;float cosTheta=sqrt((1.0-r2)/(1.0+(a*a-1.0)*r2));float sinTheta=clamp(sqrt(1.0-(cosTheta*cosTheta)),0.0,1.0);float sinPhi=sin(phi);float cosPhi=cos(phi);return vec3(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}vec3 LGL_N(SurfaceInteraction si,vec3 Csheen,vec3 V,vec3 L,vec3 H,out float pdf){pdf=0.0;if(L.z<=0.0)return vec3(0.0);pdf=L.z*INVPI;float LDotH=dot(L,H);float FL=LGL_E(L.z);float FV=LGL_E(V.z);float Fh=LGL_E(LDotH);float Fd90=0.5+2.0*LDotH*LDotH*si.roughness;float Fd=mix(1.0,Fd90,FL)*mix(1.0,Fd90,FV);float Fss90=LDotH*LDotH*si.roughness;float Fss=mix(1.0,Fss90,FL)*mix(1.0,Fss90,FV);float DisneyFakeSS=1.25*(Fss*(1.0/(L.z+V.z)-0.5)+0.5);vec3 Fsheen=Fh*si.sheen*Csheen;return(INVPI*mix(Fd,DisneyFakeSS,si.LGL_BM)*si.color+Fsheen)*(1.0-si.metalness)*(1.0-si.LGL_BN);}vec3 LGL_O(SurfaceInteraction si,vec3 Cspec0,vec3 V,vec3 L,vec3 H,out float pdf){pdf=0.0;if(L.z<=0.0)return vec3(0.0);float LDotH=dot(L,H);float D=LGL_K(H.z,si.roughness);pdf=D*H.z/(4.0*LDotH);vec3 F=LGL_H(Cspec0,si.metalness,si.eta,LDotH);float G=LGL_I(abs(L.z),si.roughness)*LGL_I(abs(V.z),si.roughness);return F*D*G;}vec3 LGL_P(SurfaceInteraction si,vec3 Cspec0,vec3 V,vec3 L,vec3 H,out float pdf){pdf=0.0;if(L.z>=0.0)return vec3(0.0);float F=LGL_G(abs(dot(V,H)),si.eta);float D=LGL_K(H.z,si.roughness);float denomSqrt=dot(L,H)+dot(V,H)*si.eta;pdf=D*H.z*abs(dot(L,H))/(denomSqrt*denomSqrt);float G=LGL_I(abs(L.z),si.roughness)*LGL_I(abs(V.z),si.roughness);vec3 specColor=pow(si.color,vec3(0.5));return specColor*(1.0-si.metalness)*si.LGL_BN*(1.0-F)*D*G*abs(dot(V,H))*abs(dot(L,H))*4.0*si.eta*si.eta/(denomSqrt*denomSqrt);}vec3 LGL_Q(SurfaceInteraction si,vec3 V,vec3 L,vec3 H,out float pdf){pdf=0.0;if(L.z<=0.0)return vec3(0.0);float LDotH=dot(L,H);float F=LGL_F(.04,LDotH);float D=LGL_J(H.z,mix(0.1,0.001,1.-si.LGL_BL));pdf=D*H.z/(4.0*LDotH);float G=LGL_I(L.z,0.25)*LGL_I(V.z,0.25);return vec3(0.25*si.clearcoat*F*D*G);}void LGL_R(SurfaceInteraction si,vec3 Cspec0,float fresnelWeight,out float LGL_S,out float LGL_T,out float LGL_U,out float LGL_V){LGL_S=max(LGL_Ae(si.color),si.sheen)*(1.0-si.metalness)*(1.0-si.LGL_BN);LGL_T=LGL_Ae(mix(Cspec0,vec3(1.0),fresnelWeight));LGL_U=(1.0-fresnelWeight)*(1.0-si.metalness)*si.LGL_BN*LGL_Ae(si.color);LGL_V=si.clearcoat*(1.0-si.metalness);float weightSum=LGL_S+LGL_T+LGL_U+LGL_V;LGL_S/=weightSum;LGL_T/=weightSum;LGL_U/=weightSum;LGL_V/=weightSum;}vec3 LGL_W(SurfaceInteraction si,vec3 V,vec3 N,out vec3 L,out float pdf,MaterialSamples LGL_AZomSamples){pdf=0.0;vec3 f=vec3(0.0);vec2 bounceDirSample=LGL_AZomSamples.s3;vec2 diffuseOrSpecular=LGL_AZomSamples.s4;float r1=bounceDirSample.x;float r2=bounceDirSample.y;vec3 Cspec0,Csheen;LGL_D(si,Cspec0,Csheen);vec3 T,B;LGL_Ak(N,T,B);V=WorldToLocal(T,B,N,V);float LGL_S,LGL_T,LGL_U,LGL_V;float fresnelWeight=LGL_H(si.metalness,si.eta,V.z);LGL_R(si,Cspec0,fresnelWeight,LGL_S,LGL_T,LGL_U,LGL_V);float cdf[4];cdf[0]=LGL_S;cdf[1]=cdf[0]+LGL_T;cdf[2]=cdf[1]+LGL_U;cdf[3]=cdf[2]+LGL_V;if(r1<cdf[0]){r1/=cdf[0];L=LGL_A(r1,r2);vec3 H=normalize(L+V);f=LGL_N(si,Csheen,V,L,H,pdf);pdf*=LGL_S;}else if(r1<cdf[1]){r1=(r1-cdf[0])/(cdf[1]-cdf[0]);vec3 H=ImportanceSampleLGL_K(si.roughness,r1,r2);if(dot(V,H)<0.0)H=-H;L=normalize(reflect(-V,H));f=LGL_O(si,Cspec0,V,L,H,pdf);pdf*=LGL_T;}else if(r1<cdf[2]){r1=(r1-cdf[1])/(cdf[2]-cdf[1]);vec3 H=ImportanceSampleLGL_K(si.roughness,r1,r2);if(dot(V,H)<0.0)H=-H;vec3 R=reflect(-V,H);L=normalize(refract(-V,H,si.eta));f=LGL_P(si,Cspec0,V,L,H,pdf);pdf*=LGL_U;}else{r1=(r1-cdf[2])/(1.0-cdf[2]);vec3 H=ImportanceSampleLGL_J(mix(0.1,0.001,1.-si.LGL_BL),r1,r2);if(dot(V,H)<0.0)H=-H;L=normalize(reflect(-V,H));f=LGL_Q(si,V,L,H,pdf);pdf*=LGL_V;}L=LocalToWorld(T,B,N,L);return f*abs(dot(N,L));}vec3 LGL_X(inout SurfaceInteraction si,vec3 V,vec3 L,out float bsdfPdf){bsdfPdf=0.0;vec3 f=vec3(0.0);vec3 N=si.LGL_BW;vec3 T,B;LGL_Ak(N,T,B);V=WorldToLocal(T,B,N,V);L=WorldToLocal(T,B,N,L);vec3 H;if(L.z>0.0){H=normalize(L+V);}else{H=normalize(L+V*si.eta);}if(dot(V,H)<0.0){H=-H;}vec3 Cspec0,Csheen;LGL_D(si,Cspec0,Csheen);float LGL_S,LGL_T,LGL_U,LGL_V;float fresnelWeight=LGL_H(si.metalness,si.eta,abs(dot(L,H)));LGL_R(si,Cspec0,fresnelWeight,LGL_S,LGL_T,LGL_U,LGL_V);float pdf;if(LGL_S>0.0&&L.z>0.0){f+=LGL_N(si,Csheen,V,L,H,pdf);bsdfPdf+=pdf*LGL_S;}if(LGL_T>0.0&&L.z>0.0&&V.z>0.0){f+=LGL_O(si,Cspec0,V,L,H,pdf);bsdfPdf+=pdf*LGL_T;}if(LGL_U>0.0&&L.z<0.0){f+=LGL_P(si,Cspec0,V,L,H,pdf);bsdfPdf+=pdf*LGL_U;}if(LGL_V>0.0&&L.z>0.0&&V.z>0.0){f+=LGL_Q(si,V,L,H,pdf);bsdfPdf+=pdf*LGL_V;}return f*abs(L.z);}vec3 LGL_e(inout SurfaceInteraction si,in Path path,in vec2 s1,in vec2 s2){si.eta=dot(si.normal,si.LGL_BW)>0.0 ?(1.0/si.ior): si.ior;vec3 viewDir=-path.ray.d;vec3 surfacePos=si.position+EPS*si.normal;vec3 Li=vec3(0.0);BsdfSampleRec bsdfSampleRec;vec2 lightDirSample=s1;vec2 envDirSample=s2;vec3 lightDir;vec2 uv;float lightPdf;bool brdfSample=false;\n#ifndef CONST_COLOR_ENV\nlightDir=LGL_d(envDirSample,uv,lightPdf);LGL_Ag(path.ray,surfacePos,lightDir);if(!LGL_m(path.ray,INF-EPS)){vec3 irr=LGL_Ay(envMap,uv).rgb*envMapIntensity;bsdfSampleRec.f=LGL_X(si,viewDir,lightDir,bsdfSampleRec.pdf);if(bsdfSampleRec.pdf>0.0){float LGL_Bc=LGL_Aq(lightPdf,bsdfSampleRec.pdf);if(LGL_Bc>0.0){Li+=LGL_Bc*bsdfSampleRec.f*irr/lightPdf;}}}\n#endif\n#if defined(NUM_LIGHTS)\nLightSampleRec lightSampleRec;Light light;int i=int(lightDirSample.x*float(NUM_LIGHTS));vec3 position=lights.position[i];vec3 emission=lights.emission[i];vec3 p1=lights.p1[i];vec3 p2=lights.p2[i];vec4 params=lights.params[i];float radius=params.x;float area=params.y;float type=params.z;float LGL_s=params.w;light=Light(position,emission,p1,p2,radius,area,type,LGL_s);LGL_Aw(light,surfacePos,lightSampleRec,lightDirSample);if(dot(lightSampleRec.direction,lightSampleRec.normal)<0.0){LGL_Ag(path.ray,surfacePos,lightSampleRec.direction);if(!LGL_m(path.ray,lightSampleRec.dist-EPS)){bsdfSampleRec.f=LGL_X(si,viewDir,lightSampleRec.direction,bsdfSampleRec.pdf);float LGL_Bc=1.0;if(light.area>0.0&&bsdfSampleRec.pdf>0.0){LGL_Bc=LGL_Aq(lightSampleRec.pdf,bsdfSampleRec.pdf);}if(LGL_Bc>0.0){Li+=LGL_Bc*bsdfSampleRec.f*lightSampleRec.emission/lightSampleRec.pdf;}}}\n#endif\nreturn Li;}layout(location=0)out vec4 out_light;void bounce(inout Path path,int depth,inout SurfaceInteraction si,inout BsdfSampleRec bsdfSampleRec,in LightSampleRec lightSampleRec){if(!si.LGL_BV){if(depth==0&&enviromentVisible==0){path.alpha=0.0;path.LGL_Bb=true;return;}\n#ifdef CONST_COLOR_ENV\npath.li+=backgroundColor*path.beta;path.LGL_Bb=true;return;\n#else\nfloat LGL_Bc=1.0;if(depth>0){float lightPdf=LGL_c(LGL_Y(path.ray.d));LGL_Bc=LGL_Aq(bsdfSampleRec.pdf,lightPdf);}vec3 irr=LGL_Z(path.ray.d)*envMapIntensity;path.li+=LGL_Bc*path.beta*irr;path.LGL_Bb=true;return;\n#endif\n}if(si.LGL_BT){path.li+=LGL_Ar(path.ray,depth,lightSampleRec,bsdfSampleRec)*path.beta;path.LGL_Bb=true;return;}if(dot(si.normal,si.LGL_BW)>0.0){path.LGL_Bd=vec3(0.0);}path.li+=path.beta*si.emissive;path.beta*=exp(-path.LGL_Bd*si.t);MaterialSamples LGL_AZomSamples=getRandomMaterialSamples();if(si.LGL_BS==DISNEY){path.li+=LGL_e(si,path,LGL_AZomSamples.s1,LGL_AZomSamples.s2)*path.beta;}bsdfSampleRec.f=LGL_W(si,-path.ray.d,si.LGL_BW,bsdfSampleRec.L,bsdfSampleRec.pdf,LGL_AZomSamples);if(dot(si.LGL_BW,bsdfSampleRec.L)<0.0){path.LGL_Bd=-log(si.extinction)/si.LGL_BP;}if(bsdfSampleRec.pdf>0.0){path.beta*=bsdfSampleRec.f/bsdfSampleRec.pdf;}else{path.LGL_Bb=true;return;}if(depth>=2){float q=1.0-LGL_Ae(path.beta);if(LGL_AZomSample()<q){path.LGL_Bb=true;return;}path.beta/=1.0-q;}LGL_Ag(path.ray,si.position+EPS*bsdfSampleRec.L,bsdfSampleRec.L);}vec4 LGL_Az(inout Ray ray){SurfaceInteraction si;Path path;BsdfSampleRec bsdfSampleRec;LightSampleRec lightSampleRec;path.ray=ray;path.li=vec3(0);path.alpha=1.0;path.LGL_Bb=false;path.LGL_Bc=1.0;path.LGL_Bd=vec3(0.0);path.beta=vec3(1.0);for(int i=0;i<bounces;i++){if(path.LGL_Bb){return vec4(path.li,path.alpha);}LGL_n(path.ray,si,lightSampleRec,i);LGL_o(path.ray,si,lightSampleRec,i);bounce(path,i,si,bsdfSampleRec,lightSampleRec);}return vec4(path.li,path.alpha);}void main(){LGL_Ab(frameCount);vec2 vCoordAntiAlias=vCoord+jitter;vec3 direction=normalize(vec3(vCoordAntiAlias-0.5,-1.0)*vec3(camera.aspect,1.0,camera.fov));vec3 origin=camera.transform[3].xyz;direction=mat3(camera.transform)*direction;Ray cam;LGL_Ag(cam,origin,direction);vec4 LGL_Aj=LGL_Az(cam);if(!(LGL_Aj.x<INF&&LGL_Aj.x>-EPS)){LGL_Aj=vec4(0,0,0,1);}out_light=LGL_Aj;}"};function xe(e,t){const a=[],n=e**t;for(let s=0;s<n;s++)a[s]=s;let i=a.length;const o=[];function r(){i=0}return{next:function(){i>=a.length&&(!function(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1)),n=e[t];e[t]=e[a],e[a]=n}}(a),r());let n=a[i++];for(let a=0;a<t;a++)o[a]=n%e+Math.random(),n=Math.floor(n/e);return o},restart:r,strataCount:e}}function ve(e,t){const a=[];for(const i of t)a.push(xe(e,i));const n=[];return{next:function(){let e=0;for(const t of a){const a=t.next();for(const t of a)n[e++]=t}return n},restart:function(){for(const e of a)e.restart()},strataCount:e}}function _e(e,t,a){const n=e[a];e[a]=e[t],e[t]=n}const he=new m;function Ae(e,t){return{primitives:e,bounds:t}}function ge(e,t,a){let n=a[t]-e.min[t];return e.max[t]>e.min[t]&&(n/=e.max[t]-e.min[t]),n}function Se(e){return e.getSize(he),2*(he.x*he.z+he.x*he.y+he.z*he.y)}function Me(e,t,a){const n=new g;for(let l=t;l<a;l++)n.union(e[l].bounds);const i=a-t;if(1===i)return Ae(e.slice(t,a),n);{const l=new g;for(let n=t;n<a;n++)l.expandByPoint(e[n].center);const f=(l.getSize(he),he.x>he.z?he.x>he.y?"x":"y":he.z>he.y?"z":"y");let u=Math.floor((t+a)/2);if(i<=4)!function(e,t,a=0,n=e.length,i=Math.floor((a+n)/2)){for(let o=a;o<=i;o++){let a=o,i=e[o];for(let r=o+1;r<n;r++)t(i,e[r])||(a=r,i=e[r],_e(e,o,a))}}(e,((e,t)=>e.center[f]<t.center[f]),t,a,u);else{if(l.max[f]===l.min[f])return Ae(e.slice(t,a),n);{const i=12,o=[];for(let e=0;e<i;e++)o.push({bounds:new g,count:0});for(let n=t;n<a;n++){let t=Math.floor(i*ge(l,f,e[n].center));t===o.length&&(t=o.length-1),o[t].count++,o[t].bounds.union(e[n].bounds)}const r=[];for(let e=0;e<o.length-1;e++){const t=new g,a=new g;let i=0,s=0;for(let n=0;n<=e;n++)t.union(o[n].bounds),i+=o[n].count;for(let n=e+1;n<o.length;n++)a.union(o[n].bounds),s+=o[n].count;r.push(.1+(i*Se(t)+s*Se(a))/Se(n))}let s=r[0],c=0;for(let e=1;e<r.length;e++)r[e]<s&&(s=r[e],c=e);u=function(e,t,a=0,n=e.length){for(;a!==n;){for(;t(e[a]);)if(++a===n)return a;do{if(a===--n)return a}while(!t(e[n]));_e(e,a,n),a++}return a}(e,(e=>{let t=Math.floor(o.length*ge(l,f,e.center));return t===o.length&&(t=o.length-1),t<=c}),t,a)}}return o=f,r=Me(e,t,u),s=Me(e,u,a),{child0:r,child1:s,bounds:(new g).union(r.bounds).union(s.bounds),splitAxis:o}}var o,r,s}function Fe(e,t){const a=function(e,t){const a=[];for(let n=0;n<e.length;n++){const i=e[n],{material:o,geometry:r}=i,s=new g;r.computeBoundingBox(),s.copy(r.boundingBox).applyMatrix4(i.matrixWorld);const l={bounds:s,center:s.getCenter(new m),meshID:n,materialID:t.get(o),visible:Number(i.visible)};a.push(l)}return a}(e,t);return Me(a,0,a.length)}function Te(e){const t=function(e){const t=[];for(let a=0;a<e.length;a++){const n=[],i=e[a].geometry,o=i.getIndex?i.getIndex().array:i.index.array,r=i.getAttribute?i.getAttribute("position"):i.attributes.position,s=new m,l=new m,f=new m,u=new m,c=new m;for(let e=0;e<o.length;e+=3){const t=o[e],i=o[e+1],d=o[e+2],p=new g;r.getX?(s.fromBufferAttribute(r,t),l.fromBufferAttribute(r,i),f.fromBufferAttribute(r,d)):(s.x=r.array[t*r.itemSize],s.y=r.array[t*r.itemSize+1],s.z=r.array[t*r.itemSize+2],l.x=r.array[i*r.itemSize],l.y=r.array[i*r.itemSize+1],l.z=r.array[i*r.itemSize+2],f.x=r.array[d*r.itemSize],f.y=r.array[d*r.itemSize+1],f.z=r.array[d*r.itemSize+2]),p.expandByPoint(s),p.expandByPoint(l),p.expandByPoint(f),u.subVectors(f,s),c.subVectors(l,s);const L=(new m).crossVectors(c,u).normalize(),x={bounds:p,center:p.getCenter(new m),indices:[t,i,d],faceNormal:L,meshID:a};n.push(x)}t.push(n)}return t}(e),a=[];for(let n=0;n<t.length;n++){const e=t[n],i=Me(e,0,e.length);a.push(i)}return a}let Ge,Ie,Ne=[],Pe=0,ye=[];function Be(e,t){const a=[],n=[];let i=1;const o={x:1,y:2,z:3},r=(e,s=1)=>{if(i=Math.max(s,i),e.primitives)for(let t=0;t<e.primitives.length;t++){const i=e.primitives[t];if(void 0!==i.indices){const t=ye[i.meshID];a.push(i.indices[0]+t,i.indices[1]+t,i.indices[2]+t,e.primitives.length,i.faceNormal.x,i.faceNormal.y,i.faceNormal.z,i.meshID)}else a.push(Ne[i.meshID],i.materialID,i.meshID,0,i.visible,.1,.1,0);n.push(!1)}else{const i=e.bounds;a.push(i.min.x,i.min.y,i.min.z,o[e.splitAxis],i.max.x,i.max.y,i.max.z,null);const l=a.length-1;n.push(!0),r(e.child0,s+1),a[l]=a.length/4+t,r(e.child1,s+1)}};return r(e),{maxDepth:i,count:a.length/4,flatData:a,isBounds:n}}function Re(e,t){return Be(e,Pe)}function be(e,t,a,n){const i=function(e,t,a){const n=[];Ne=[],ye=[];let i=0,o=0,r=0,s=1;for(let l=0;l<e.length;l++){const a=e[l],f=t[l].geometry;ye.push(o);const u=Be(a,i);s=Math.max(u.maxDepth,s),Ne.push(i),i+=u.count,n.push(u),o+=f.getAttribute("position").count,r+=u.flatData.length}return{totalBLASDataNum:r,totalBLASCount:i,flatBVHInfos:n,maxDepth:s}}(e,a);Pe=i.totalBLASCount;const o=Re(t),{bvhBufferDataNum:r,buffer:s}=function(e,t){const a=e.totalBLASDataNum,n=e.flatBVHInfos,i=t,o=a+i.flatData.length,r=new ArrayBuffer(4*o),s=new Float32Array(r);for(let c=0;c<n.length;c++){const e=n[c],t=4*Ne[c],{flatData:a,isBounds:i}=e;for(let n=0;n<i.length;n++){let e=8*n,o=e+t;i[n]?(s[o]=a[e],s[o+1]=a[e+1],s[o+2]=a[e+2],s[o+3]=a[e+3]):(s[o]=a[e],s[o+1]=a[e+1],s[o+2]=a[e+2],s[o+3]=-a[e+3]),s[o+4]=a[e+4],s[o+5]=a[e+5],s[o+6]=a[e+6],s[o+7]=a[e+7]}}const{flatData:l,isBounds:f}=i,u=4*Pe;for(let c=0;c<f.length;c++){let e=8*c,t=e+u;f[c],s[t]=l[e],s[t+1]=l[e+1],s[t+2]=l[e+2],s[t+3]=l[e+3],s[t+4]=l[e+4],s[t+5]=l[e+5],s[t+6]=l[e+6],s[t+7]=l[e+7]}return{bvhBufferDataNum:o,buffer:s}}(i,o);return{maxDepth:i.maxDepth+o.maxDepth,count:r/4,buffer:s,tlasRootIndex:Pe}}function Ue(e){const t=e.getAttribute("position");if(!t)return void console.warn("No position attribute");const a=new Uint32Array(t.count);for(let n=0;n<a.length;n++)a[n]=n;return e.setIndex(new M(a,1,!1)),e}function Ee(e,t){return Fe(e,t)}function we(e){const t=new Float32Array(16*e.length);for(let a=0;a<e.length;a++){const n=e[a];n.updateMatrixWorld(!0);const i=n.matrixWorld.elements,o=16;for(let e=0;e<o;e++)t[a*o+e]=i[e]}return t}function De(){Ge=null,Ie=null,Ne=[],Pe=0,ye=[]}function ze(e,t){var a;let n=e;const{vertexTotalCount:i,blasBVHs:o}=function(e){let t=0,a=0;for(let n=0;n<e.length;n++){const i=e[n];i.geometry.isBufferGeometry||(i.geometry=(new S).fromGeometry(i.geometry));const o=i.geometry;o.getIndex()||Ue(o),o.getAttribute("normal")?o.normalizeNormals():o.computeVertexNormals(),t+=o.getAttribute("position").count,a+=o.getIndex().count}return{vertexTotalCount:t,indexCount:a,blasBVHs:Te(e)}}(e),r=Ee(n,t);Ge=be(o,r,e),Ie=Ge.tlasRootIndex;const s=new Float32Array(4*i),l=new Float32Array(4*i);let f=0;for(let c=0;c<e.length;c++){const t=e[c].geometry,n=t.getAttribute("position").array,i=t.getAttribute("normal").array,o=null==(a=t.getAttribute("uv"))?void 0:a.array,r=t.getAttribute("position").count;for(let e=0;e<r;e++)s[f+4*e+0]=n[3*e+0],s[f+4*e+1]=n[3*e+1],s[f+4*e+2]=n[3*e+2],s[f+4*e+3]=o?o[2*e+0]:0,l[f+4*e+0]=i[3*e+0],l[f+4*e+1]=i[3*e+1],l[f+4*e+2]=i[3*e+2],l[f+4*e+3]=o?o[2*e+1]:0;f+=4*r}const u=we(e);return{vertexTotalCount:i,bvhBufferInfo:Ge,positionBufferData:s,normalBufferData:l,transformBufferData:u,tlasRootIndex:Ie}}async function Xe({decomposedScene:e,fullscreenQuad:t,gl:a,materialBuffer:n,uvTransformBuffer:i,optionalExtensions:o,useWorker:r,loadingCallback:l}){l&&l.onProgress&&"function"==typeof l.onProgress&&l.onProgress("Building BVH...");const{OES_texture_float_linear:f}=o,{camera:u,meshLightsNum:c,isTextureEnv:d,meshes:p,materialIndexMap:m}=e,{uvTransformBufferTex:L,uvTransformBufferDataCount:x,wrappingRootIndex:v}=i,{vertexTotalCount:_,bvhBufferInfo:h,positionBufferData:A,normalBufferData:g,transformBufferData:S,tlasRootIndex:M}=await function(e,t){return new Promise((a=>{a(ze(e,t))}))}(p,m),F=h,T=Y(a,{defines:s({OES_texture_float_linear:f,BVH_COLUMNS:W(F.count).columnsLog,VERTEX_COLUMNS:W(_).columnsLog,TRANSFORM_COLUMNS:W(S.length/4).columnsLog,UVTRANSFORM_COLUMNS:W(x).columnsLog,SUPPORTED_MAPS:j.length,MAX_DEPTH:F.maxDepth,NUM_LIGHTS:c,CONST_COLOR_ENV:!d},n.defines),fragment:Le,vertex:t.vertexShader});return T.setTexture("diffuseMap",n.textures.diffuseMap),T.setTexture("normalMap",n.textures.normalMap),T.setTexture("pbrMap",n.textures.pbrMap),T.setTexture("pbrSGMap",n.textures.pbrSGMap),n.textures.emissiveMap&&T.setTexture("emissiveMap",n.textures.emissiveMap),T.setTexture("positionBuffer",q(a,A,4)),T.setTexture("normalBuffer",q(a,g,4)),T.setTexture("bvhBuffer",q(a,F.buffer,4)),T.setUniform("tlasIndex",M),T.setTexture("transformBuffer",q(a,S,4)),T.setUniform("wrappingIndex",v),T.setTexture("uvTransformBuffer",L),T}async function Ce(e,{bounces:t,decomposedScene:a,fullscreenQuad:n,materialBuffer:i,uvTransformBuffer:o,optionalExtensions:r,envMapIntensity:s,enviromentVisible:l,useWorker:f,loadingCallback:u}){let c;const d=await Xe({bounces:t,decomposedScene:a,fullscreenQuad:n,gl:e,materialBuffer:i,uvTransformBuffer:o,optionalExtensions:r,useWorker:f,loadingCallback:u}),p=[];function m(e){p.length=0,e=H(e,2,8);for(let t=1;t<=e;t++)p.push(2,2,2,2),t>=2&&p.push(1);d.setUniform("bounces",e),c&&(c.strataCount=-1)}function L(t){const{OES_texture_float_linear:a}=r,{environment:n,isTextureEnv:i}=t;if(i){const t=function(e){let t;return e&&e.data&&e.data.isTexture?t=pe(e):console.warn(`No support environment type: ${e.data}`),t}(n);if(t){const n=Z(e,{data:t.data,storage:t.dataFormat,minFilter:a?e.LINEAR:e.NEAREST,magFilter:a?e.LINEAR:e.NEAREST,width:t.width,height:t.height});d.setTexture("envMap",n);const i=me(t);d.setTexture("envMapDistribution",Z(e,{data:i.data,storage:"float",width:i.width,height:i.height})),d.setUniform("envMapIntensity",s)}}else{const e=n.data;e&&e.isColor?d.setUniform("backgroundColor",[e.r,e.g,e.b]):d.setUniform("backgroundColor",[0,0,0])}v(l)}function x(e){const{meshLights:t}=e;t&&(d.setUniform("lights.position[0]",t.position),d.setUniform("lights.emission[0]",t.emission),d.setUniform("lights.p1[0]",t.p1),d.setUniform("lights.p2[0]",t.p2),d.setUniform("lights.params[0]",t.params))}function v(e){d.setUniform("enviromentVisible",Number(e))}function _(){d.setUniform("stratifiedSamples[0]",c.next())}return m(t),L(a),x(a),c=ve(1,p),{bindTextures:function(){d.bindTextures()},draw:function(){d.useProgram(!1),n.draw()},outputLocs:d.outputLocs,textures:d.textures,setSize:function(e,t){d.setUniform("pixelSize",1/e,1/t)},setCamera:function(e){d.setUniform("camera.transform",e.matrixWorld.elements),d.setUniform("camera.aspect",e.aspect),d.setUniform("camera.fov",.5/Math.tan(.5*Math.PI*e.fov/180)),e.isLensCamera&&(d.setUniform("camera.aperture",e.aperture),d.setUniform("camera.focus",e.focus))},setGBuffers:function({position:e}){d.setTexture("gPosition",e)},setNoise:function(t){d.setTexture("noiseTex",Z(e,{data:t,wrapS:e.REPEAT,wrapT:e.REPEAT,storage:"halfFloat"}))},setJitter:function(e,t){d.setUniform("jitter",e,t)},setFrameCount:function(e){d.setUniform("frameCount",e)},setStrataCount:function(e){e>1&&e!==c.strataCount?c=ve(e,p):c.restart(),d.setUniform("strataSize",1/e),_()},nextSeed:_,setEnvMapIntensity:function(e){d.setUniform("envMapIntensity",e)},setEnviromentVisible:v,updateBounces:m,updateEnvLight:L,updateMeshLight:x,updateMeshTransform:function(t){const{meshes:a,materialIndexMap:n}=t,{bvhBufferInfo:i,transformBufferData:o}=function(e,t){const a=Re(Ee(e,t)),n=we(e),{flatData:i,isBounds:o}=a,{buffer:r}=Ge,s=4*Ie;for(let l=0;l<o.length;l++){let e=8*l,t=e+s;o[l],r[t]=i[e],r[t+1]=i[e+1],r[t+2]=i[e+2],r[t+3]=i[e+3],r[t+4]=i[e+4],r[t+5]=i[e+5],r[t+6]=i[e+6],r[t+7]=i[e+7]}return{bvhBufferInfo:Ge,transformBufferData:n}}(a,n),r=i.buffer;d.setTexture("transformBuffer",q(e,o,4)),d.setTexture("bvhBuffer",q(e,r,4))},updateMeshMaterial:function(e,t){d.setTexture("diffuseMap",e.textures.diffuseMap),d.setTexture("normalMap",e.textures.normalMap),d.setTexture("pbrMap",e.textures.pbrMap),d.setTexture("pbrSGMap",e.textures.pbrSGMap),e.textures.emissiveMap&&d.setTexture("emissiveMap",e.textures.emissiveMap);const{uvTransformBufferTex:a,wrappingRootIndex:n}=t;d.setUniform("wrappingIndex",n),d.setTexture("uvTransformBuffer",a)},dispose:function(){De(),d.dispose()}}}var Oe={source:"in vec3 aPosition;in vec3 aNormal;in vec2 aUv;uniform mat4 projView;uniform mat4 modelMat;uniform mat3 normalMat;out vec3 vPosition;out vec3 vNormal;out vec2 vUv;void main(){vec4 mPosition=modelMat*vec4(aPosition,1.);vPosition=mPosition.xyz;vNormal=normalize(normalMat*aNormal);vUv=aUv;gl_Position=projView*mPosition;}"},Ve={source:"\n#define PI 3.14159265359\n#define TWOPI 6.28318530718\n#define INVPI 0.31830988618\n#define INVPI2 0.10132118364\n#define EPS 0.0001\n#define ONE_MINUS_EPS 0.999999\n#define INF 1000000.0\n#define ROUGHNESS_MIN 0.001\nuniform sampler2D uvTransformBuffer;uniform int wrappingIndex;ivec2 LGL_Ah(int i,int LGL_Be){ivec2 u;u.y=i>>LGL_Be;u.x=i-(u.y<<LGL_Be);return u;}vec4 LGL_Ai(sampler2D s,int i,int LGL_Be){return texelFetch(s,LGL_Ah(i,LGL_Be),0);}ivec4 LGL_Ai(isampler2D s,int i,int LGL_Be){return texelFetch(s,LGL_Ah(i,LGL_Be),0);}uniform Materials{vec4 colorAndMaterialType[NUM_MATERIALS];vec4 roughnessMetalnessNormalScale[NUM_MATERIALS];vec4 alphaSpecularTintSheenSheenTint[NUM_MATERIALS];vec4 clearcoaRoughnessSubfaceTransmission[NUM_MATERIALS];vec4 iorAtDistanceAnisotropicWorkflow[NUM_MATERIALS];vec4 extinction[NUM_MATERIALS];vec4 specularColorGlossiness[NUM_MATERIALS];\n#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS) || defined(NUM_PBR_MAPS)\nivec4 diffuseNormalRoughnessMetalnessMapIndex[NUM_MATERIALS];\n#endif\n#if defined(NUM_EMISSIVE_MAPS) || defined(NUM_PBR_SG_MAPS)\nivec4 emissiveSpecularGlossinessMapIndex[NUM_MATERIALS];\n#endif\n#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS)\nvec4 diffuseNormalMapSize[NUM_DIFFUSE_NORMAL_MAPS];\n#endif\n#if defined(NUM_PBR_MAPS)\nvec2 pbrMapSize[NUM_PBR_MAPS];\n#else\n#if defined(NUM_PBR_SG_MAPS)\nvec2 pbrMapSize[NUM_PBR_SG_MAPS];\n#else\n#if defined(NUM_EMISSIVE_MAPS)\nvec2 pbrMapSize[NUM_EMISSIVE_MAPS];\n#endif\n#endif\n#endif\n}materials;\n#ifdef NUM_DIFFUSE_MAPS\nuniform mediump sampler2DArray diffuseMap;\n#endif\n#ifdef NUM_NORMAL_MAPS\nuniform mediump sampler2DArray normalMap;\n#endif\n#ifdef NUM_PBR_MAPS\nuniform mediump sampler2DArray pbrMap;\n#endif\n#ifdef NUM_PBR_SG_MAPS\nuniform mediump sampler2DArray pbrSGMap;\n#endif\n#ifdef NUM_EMISSIVE_MAPS\nuniform mediump sampler2DArray emissiveMap;\n#endif\nmat3 LGL_Bo(int materialIndex,int mapKey){int offset=materialIndex*SUPPORTED_MAPS*3;int mapOffset=mapKey*3;vec3 LGL_Bj=LGL_Ai(uvTransformBuffer,offset+mapOffset+0,UVTRANSFORM_COLUMNS).xyz;vec3 LGL_Bk=LGL_Ai(uvTransformBuffer,offset+mapOffset+1,UVTRANSFORM_COLUMNS).xyz;vec3 LGL_Bl=LGL_Ai(uvTransformBuffer,offset+mapOffset+2,UVTRANSFORM_COLUMNS).xyz;mat3 LGL_Bu=mat3(LGL_Bj,LGL_Bk,LGL_Bl);return LGL_Bu;}vec3 LGL_Bp(int materialIndex,int mapKey){int offset=wrappingIndex+materialIndex*SUPPORTED_MAPS;int mapOffset=mapKey;vec3 wrappingData=LGL_Ai(uvTransformBuffer,offset+mapOffset,UVTRANSFORM_COLUMNS).xyz;return wrappingData;}vec2 LGL_Bq(vec2 uv,vec3 LGL_Br){if(uv.x<=0.||uv.x>=1.){float LGL_Bs=LGL_Br.x;if(LGL_Bs==0.){uv.x=uv.x<=0. ? 0. : 1.;}else if(LGL_Bs==1.){uv.x=uv.x-floor(uv.x);}}if(uv.y<=0.||uv.y>=1.){float LGL_Bt=LGL_Br.y;if(LGL_Bt==0.){uv.y=uv.y<=0. ? 0. : 1.;}else if(LGL_Bt==1.){uv.y=uv.y-floor(uv.y);}}return uv;}float LGL_w(int materialIndex){return materials.colorAndMaterialType[materialIndex].w;}float LGL_x(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].w;}vec3 LGL_y(int materialIndex,vec2 uv){vec3 emissive=vec3(0.0);\n#ifdef NUM_EMISSIVE_MAPS\nint emissiveMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].x;if(emissiveMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,6);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,6);uv=LGL_Bq(uv,LGL_Br);uv=uv*materials.pbrMapSize[emissiveMapIndex].xy;emissive=texture(emissiveMap,vec3(uv,emissiveMapIndex)).rgb;}\n#endif\nreturn emissive;}vec3 LGL_z(int materialIndex,vec2 uv){vec3 specularColor=materials.specularColorGlossiness[materialIndex].rgb;\n#ifdef NUM_PBR_SG_MAPS\nint specularMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].y;if(specularMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,4);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,4);uv=LGL_Bq(uv,LGL_Br);uv=uv*materials.pbrMapSize[specularMapIndex].xy;vec3 LGL_AU=texture(pbrSGMap,vec3(uv,specularMapIndex)).rgb;LGL_AU=pow(LGL_AU,vec3(2.2));specularColor*=LGL_AU;}\n#endif\nreturn specularColor;}float LGL_AA(int materialIndex,vec2 uv){float glossiness=materials.specularColorGlossiness[materialIndex].a;\n#ifdef NUM_PBR_SG_MAPS\nint glossinessMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].z;if(glossinessMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,5);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,5);uv=LGL_Bq(uv,LGL_Br);uv=uv*materials.pbrMapSize[glossinessMapIndex].xy;float LGL_AV=texture(pbrSGMap,vec3(uv,glossinessMapIndex)).a;glossiness*=LGL_AV;}\n#endif\nreturn glossiness;}float LGL_AB(int materialIndex,vec2 uv){float LGL_BR=LGL_x(materialIndex);float roughness=0.0;if(LGL_BR>0.1){roughness=1.0-LGL_AA(materialIndex,uv);}else{roughness=materials.roughnessMetalnessNormalScale[materialIndex].x;\n#ifdef NUM_PBR_MAPS\nint roughnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].z;if(roughnessMapIndex>=0){uv=uv*materials.pbrMapSize[roughnessMapIndex].xy;mat3 LGL_Bu=LGL_Bo(materialIndex,2);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,2);uv=LGL_Bq(uv,LGL_Br);roughness*=texture(pbrMap,vec3(uv,roughnessMapIndex)).g;}\n#endif\n}return roughness*roughness;}float LGL_AC(const vec3 v){return max(v.x,max(v.y,v.z));}float LGL_AD(const vec3 specularColor){return LGL_AC(specularColor);}vec3 LGL_AE(const vec3 baseColor,float metallic){return baseColor*(1.0-metallic);}float LGL_AF(int materialIndex,vec2 uv){float LGL_BR=LGL_x(materialIndex);float metalness=0.0;if(LGL_BR>0.1){vec3 specularFactor=LGL_z(materialIndex,uv);metalness=LGL_AD(specularFactor);}else{metalness=materials.roughnessMetalnessNormalScale[materialIndex].y;\n#ifdef NUM_PBR_MAPS\nint metalnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].w;if(metalnessMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,3);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,3);uv=LGL_Bq(uv,LGL_Br);uv=uv*materials.pbrMapSize[metalnessMapIndex].xy;metalness*=texture(pbrMap,vec3(uv,metalnessMapIndex)).b;}\n#endif\n}return metalness;}vec4 LGL_AG(int materialIndex,vec2 uv){vec3 color=materials.colorAndMaterialType[materialIndex].rgb;float LGL_BO=1.0;\n#ifdef NUM_DIFFUSE_MAPS\nint diffuseMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].x;if(diffuseMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,0);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,0);uv=LGL_Bq(uv,LGL_Br);uv=uv*materials.diffuseNormalMapSize[diffuseMapIndex].xy;vec4 diffuse=texture(diffuseMap,vec3(uv,diffuseMapIndex));color*=diffuse.rgb;LGL_BO=diffuse.a;}\n#endif\nfloat LGL_BR=LGL_x(materialIndex);if(LGL_BR>0.1){vec3 specularFactor=LGL_z(materialIndex,uv);color=LGL_AE(color,LGL_AD(specularFactor));}return vec4(color,LGL_BO);}vec3 LGL_AH(int materialIndex,vec2 uv,vec3 normal,vec3 dp1,vec3 dp2,vec2 duv1,vec2 duv2,inout vec3 tangent,inout vec3 bitangent){vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 dpdu=dp2perp*duv1.x+dp1perp*duv2.x;vec3 dpdv=dp2perp*duv1.y+dp1perp*duv2.y;float invmax=inversesqrt(max(dot(dpdu,dpdu),dot(dpdv,dpdv)));dpdu*=invmax;dpdv*=invmax;tangent=normalize(dpdu);bitangent=normalize(dpdv);\n#ifdef NUM_NORMAL_MAPS\nint normalMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].y;if(normalMapIndex>=0){mat3 LGL_Bu=LGL_Bo(materialIndex,1);uv=(LGL_Bu*vec3(uv,1)).xy;vec3 LGL_Br=LGL_Bp(materialIndex,1);uv=LGL_Bq(uv,LGL_Br);vec3 n=2.0*texture(normalMap,vec3(uv*materials.diffuseNormalMapSize[normalMapIndex].zw,normalMapIndex)).rgb-1.0;n.xy*=materials.roughnessMetalnessNormalScale[materialIndex].zw;mat3 tbn=mat3(dpdu,dpdv,normal);return normalize(tbn*n);}else{return normal;}\n#endif\nreturn normal;}float LGL_AK(int materialIndex,vec2 uv){float alpha=materials.alphaSpecularTintSheenSheenTint[materialIndex].x;\n#ifdef NUM_DIFFUSE_MAPS\nint diffuseMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].x;if(diffuseMapIndex>=0){alpha*=texture(diffuseMap,vec3(uv*materials.diffuseNormalMapSize[diffuseMapIndex].xy,diffuseMapIndex)).a;}\n#endif\nreturn alpha;}float LGL_AI(int materialIndex){return materials.alphaSpecularTintSheenSheenTint[materialIndex].y;}float LGL_AJ(int materialIndex){return materials.alphaSpecularTintSheenSheenTint[materialIndex].z;}float LGL_AJTint(int materialIndex){return materials.alphaSpecularTintSheenSheenTint[materialIndex].w;}float LGL_AM(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].x;}float LGL_AMRoughness(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].y;}float LGL_AO(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].z;}float LGL_AP(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].w;}float LGL_AQ(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].x;}float LGL_AR(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].y;}float LGL_AS(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].z;}vec3 LGL_AT(int materialIndex){return materials.extinction[materialIndex].rgb;}layout(location=0)out vec4 out_position;layout(location=1)out vec4 out_normal;layout(location=2)out vec4 out_color;in vec3 vPosition;in vec3 vNormal;in vec2 vUv;uniform int meshIndex;uniform int materialIndex;vec3 LGL_BXs(vec3 pos){vec3 fdx=dFdx(pos);vec3 fdy=dFdy(pos);return cross(fdx,fdy);}void main(){vec2 uv=vUv;vec4 color=LGL_AG(materialIndex,uv);float LGL_BS=LGL_w(materialIndex);vec3 normal=normalize(vNormal);vec3 LGL_BX=normalize(LGL_BXs(vPosition));normal*=sign(dot(normal,LGL_BX));\n#ifdef NUM_NORMAL_MAPS\nvec3 dp1=dFdx(vPosition);vec3 dp2=dFdy(vPosition);vec2 duv1=dFdx(vUv);vec2 duv2=dFdy(vUv);vec3 tangent,bitangent;normal=LGL_AH(materialIndex,uv,normal,dp1,dp2,duv1,duv2,tangent,bitangent);\n#endif\nout_position=vec4(vPosition,float(meshIndex)+EPS);out_normal=vec4(normal,LGL_BS);out_color=color;}"};function Qe(e,t,a){if(void 0===t)return;const{itemSize:n,array:i}=a;if(e.enableVertexAttribArray(t),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,i,e.STATIC_DRAW),i instanceof Float32Array)e.vertexAttribPointer(t,n,e.FLOAT,!1,0,0);else{if(!(i instanceof Int32Array))throw"Unsupported buffer type";e.vertexAttribIPointer(t,n,e.INT,0,0)}}function Ye(e,t,a){const n=a.getAttribute("position").count,i=new M(new Float32Array(3*n),3,!1),o=new M(new Float32Array(2*n),2,!1);Qe(e,t.attribLocs.aPosition,a.getAttribute("position")),Qe(e,t.attribLocs.aNormal,a.getAttribute("normal")||i),Qe(e,t.attribLocs.aUv,a.getAttribute("uv")||o),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint32Array(a.getIndex().array),e.STATIC_DRAW)}function He(e,{materialBuffer:t,uvTransformBuffer:a,decomposedScene:n}){const{meshes:i,materialIndexMap:o}=n,{uvTransformBufferTex:r,wrappingRootIndex:s}=a,l=Y(e,{defines:t.defines,vertex:Oe,fragment:Ve});l.setTexture("diffuseMap",t.textures.diffuseMap),l.setTexture("normalMap",t.textures.normalMap),l.setUniform("wrappingIndex",s),l.setTexture("uvTransformBuffer",r);const f=[];for(let L=0;L<i.length;L++){const t=i[L].geometry,a=e.createVertexArray();e.bindVertexArray(a),Ye(e,l,t),e.bindVertexArray(null),f.push(a)}let u,c=0,d=0;let p=new F,m=new x;return{draw:function(){p.copy(u.projectionMatrix),p.elements[8]+=2*c,p.elements[9]+=2*d,p.multiply(u.matrixWorldInverse),l.setUniform("projView",p.elements),e.enable(e.DEPTH_TEST),e.disable(e.CULL_FACE);for(let t=0;t<i.length;t++){const a=i[t];if(!a.visible)continue;const n=a.geometry.getIndex().count;l.setUniform("modelMat",a.matrixWorld.elements),m.getNormalMatrix(a.matrixWorld),l.setUniform("normalMat",m.elements),l.setUniform("meshIndex",t);const r=o.get(a.material);l.setUniform("materialIndex",r);const s=f[t];e.bindVertexArray(s),l.useProgram(),e.drawElements(e.TRIANGLES,n,e.UNSIGNED_INT,0)}e.enable(e.CULL_FACE),e.disable(e.DEPTH_TEST)},outputLocs:l.outputLocs,setCamera:function(e){u=e},setJitter:function(e,t){c=e,d=t},updateMeshMaterial:function(e,t){l.setTexture("diffuseMap",e.textures.diffuseMap),l.setTexture("normalMap",e.textures.normalMap);const{uvTransformBufferTex:a,wrappingRootIndex:n}=t;l.setUniform("wrappingIndex",n),l.setTexture("uvTransformBuffer",a)},dispose:function(){l.dispose()}}}var We={source:"vec4 LGL_Ay(sampler2D map,vec2 uv){\n#ifdef OES_texture_float_linear\nreturn texture(map,uv);\n#else\nvec2 size=vec2(textureSize(map,0));vec2 texelSize=1.0/size;uv=uv*size-0.5;vec2 f=fract(uv);uv=floor(uv)+0.5;vec4 s1=texture(map,(uv+vec2(0,0))*texelSize);vec4 s2=texture(map,(uv+vec2(1,0))*texelSize);vec4 s3=texture(map,(uv+vec2(0,1))*texelSize);vec4 s4=texture(map,(uv+vec2(1,1))*texelSize);return mix(mix(s1,s2,f.x),mix(s3,s4,f.x),f.y);\n#endif\n}layout(location=0)out vec4 out_color;in vec2 vCoord;uniform sampler2D lightTex;uniform vec2 lightScale;uniform int toneMappingFun;vec3 linear(vec3 color){return color;}vec3 LGL_BG(vec3 color){return clamp(color/(vec3(1.0)+color),vec3(0.0),vec3(1.0));}vec3 LGL_BH(vec3 color){color=max(vec3(0.0),color-0.004);return pow((color*(6.2*color+0.5))/(color*(6.2*color+1.7)+0.06),vec3(2.2));}vec3 LGL_BI(vec3 color){return clamp((color*(2.51*color+0.03))/(color*(2.43*color+0.59)+0.14),vec3(0.0),vec3(1.0));}void main(){vec4 upscaledLight=texture(lightTex,lightScale*vCoord);vec3 light=upscaledLight.rgb/upscaledLight.a;if(toneMappingFun==0){light=linear(light);}if(toneMappingFun==1){light=LGL_BI(light);}if(toneMappingFun==2){light=LGL_BG(light);}if(toneMappingFun==3){light=LGL_BH(light);}light=pow(light,vec3(1.0/2.2));if(upscaledLight.a==0.){out_color=vec4(light,0.0);}else{out_color=vec4(light,1.0);}}"};const ke={[T]:0,[G]:1,[I]:2,[N]:3};function qe(e,t){const{fullscreenQuad:a,toneMapping:n}=t;let i;const o={gl:e,vertex:a.vertexShader,fragment:We},r=Y(e,o);r.setUniform("toneMappingFun",ke[n]);const s=new p(1,1);return{draw:function(t,n){let{light:o,lightScale:l}=t;if(l=l||s,r.setTexture("lightTex",o),r.setUniform("lightScale",l.x,l.y),n)return i.bind(),e.clear(e.COLOR_BUFFER_BIT),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),r.useProgram(),a.draw(),i.unbind(),i;r.useProgram(),a.draw()},setToneMapping:function(e){r.setUniform("toneMappingFun",ke[e])},setSize:function(t,a){i=E(e,{color:{0:Z(e,{width:t,height:a,storage:"byte",magFilter:e.LINEAR,minFilter:e.LINEAR})}})},dispose:function(){r.dispose()}}}var Ze={source:"layout(location=0)out vec4 out_color;uniform sampler2D inputBuffer;uniform vec2 resolution;in vec2 vCoord;\n#define FXAA_PC 1\n#define FXAA_GLSL_100 1\n#define FXAA_QUALITY_PRESET 12\n#define FXAA_GREEN_AS_LUMA 1\n#ifndef FXAA_PC_CONSOLE\n#define FXAA_PC_CONSOLE 0\n#endif\n#ifndef FXAA_GLSL_120\n#define FXAA_GLSL_120 0\n#endif\n#ifndef FXAA_GLSL_130\n#define FXAA_GLSL_130 0\n#endif\n#ifndef FXAA_HLSL_3\n#define FXAA_HLSL_3 0\n#endif\n#ifndef FXAA_HLSL_4\n#define FXAA_HLSL_4 0\n#endif\n#ifndef FXAA_HLSL_5\n#define FXAA_HLSL_5 0\n#endif\n#ifndef FXAA_GREEN_AS_LUMA\n#define FXAA_GREEN_AS_LUMA 0\n#endif\n#ifndef FXAA_EARLY_EXIT\n#define FXAA_EARLY_EXIT 1\n#endif\n#ifndef FXAA_DISCARD\n#define FXAA_DISCARD 0\n#endif\n#ifndef FXAA_FAST_PIXEL_OFFSET\n#ifdef GL_EXT_gpu_shader4\n#define FXAA_FAST_PIXEL_OFFSET 1\n#endif\n#ifdef GL_NV_gpu_shader5\n#define FXAA_FAST_PIXEL_OFFSET 1\n#endif\n#ifdef GL_ARB_gpu_shader5\n#define FXAA_FAST_PIXEL_OFFSET 1\n#endif\n#ifndef FXAA_FAST_PIXEL_OFFSET\n#define FXAA_FAST_PIXEL_OFFSET 0\n#endif\n#endif\n#ifndef FXAA_GATHER4_ALPHA\n#if (FXAA_HLSL_5 == 1)\n#define FXAA_GATHER4_ALPHA 1\n#endif\n#ifdef GL_ARB_gpu_shader5\n#define FXAA_GATHER4_ALPHA 1\n#endif\n#ifdef GL_NV_gpu_shader5\n#define FXAA_GATHER4_ALPHA 1\n#endif\n#ifndef FXAA_GATHER4_ALPHA\n#define FXAA_GATHER4_ALPHA 0\n#endif\n#endif\n/*============================================================================FXAA QUALITY-TUNING KNOBS------------------------------------------------------------------------------NOTE the other tuning knobs are now in the shader function inputs!============================================================================*/\n#ifndef FXAA_QUALITY_PRESET\n#define FXAA_QUALITY_PRESET 12\n#endif\n/*============================================================================FXAA QUALITY-PRESETS============================================================================*//*============================================================================FXAA QUALITY-MEDIUM DITHER PRESETS============================================================================*/\n#if (FXAA_QUALITY_PRESET == 10)\n#define FXAA_QUALITY_PS 3\n#define FXAA_QUALITY_P0 1.5\n#define FXAA_QUALITY_P1 3.0\n#define FXAA_QUALITY_P2 12.0\n#endif\n#if (FXAA_QUALITY_PRESET == 11)\n#define FXAA_QUALITY_PS 4\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 3.0\n#define FXAA_QUALITY_P3 12.0\n#endif\n#if (FXAA_QUALITY_PRESET == 12)\n#define FXAA_QUALITY_PS 5\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 4.0\n#define FXAA_QUALITY_P4 12.0\n#endif\n#if (FXAA_QUALITY_PRESET == 13)\n#define FXAA_QUALITY_PS 6\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 4.0\n#define FXAA_QUALITY_P5 12.0\n#endif\n#if (FXAA_QUALITY_PRESET == 14)\n#define FXAA_QUALITY_PS 7\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 4.0\n#define FXAA_QUALITY_P6 12.0\n#endif\n#if (FXAA_QUALITY_PRESET == 15)\n#define FXAA_QUALITY_PS 8\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 4.0\n#define FXAA_QUALITY_P7 12.0\n#endif\n/*============================================================================FXAA QUALITY-LOW DITHER PRESETS============================================================================*/\n#if (FXAA_QUALITY_PRESET == 20)\n#define FXAA_QUALITY_PS 3\n#define FXAA_QUALITY_P0 1.5\n#define FXAA_QUALITY_P1 2.0\n#define FXAA_QUALITY_P2 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 21)\n#define FXAA_QUALITY_PS 4\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 22)\n#define FXAA_QUALITY_PS 5\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 23)\n#define FXAA_QUALITY_PS 6\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 24)\n#define FXAA_QUALITY_PS 7\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 3.0\n#define FXAA_QUALITY_P6 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 25)\n#define FXAA_QUALITY_PS 8\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 4.0\n#define FXAA_QUALITY_P7 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 26)\n#define FXAA_QUALITY_PS 9\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 2.0\n#define FXAA_QUALITY_P7 4.0\n#define FXAA_QUALITY_P8 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 27)\n#define FXAA_QUALITY_PS 10\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 2.0\n#define FXAA_QUALITY_P7 2.0\n#define FXAA_QUALITY_P8 4.0\n#define FXAA_QUALITY_P9 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 28)\n#define FXAA_QUALITY_PS 11\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 2.0\n#define FXAA_QUALITY_P7 2.0\n#define FXAA_QUALITY_P8 2.0\n#define FXAA_QUALITY_P9 4.0\n#define FXAA_QUALITY_P10 8.0\n#endif\n#if (FXAA_QUALITY_PRESET == 29)\n#define FXAA_QUALITY_PS 12\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.5\n#define FXAA_QUALITY_P2 2.0\n#define FXAA_QUALITY_P3 2.0\n#define FXAA_QUALITY_P4 2.0\n#define FXAA_QUALITY_P5 2.0\n#define FXAA_QUALITY_P6 2.0\n#define FXAA_QUALITY_P7 2.0\n#define FXAA_QUALITY_P8 2.0\n#define FXAA_QUALITY_P9 2.0\n#define FXAA_QUALITY_P10 4.0\n#define FXAA_QUALITY_P11 8.0\n#endif\n/*============================================================================FXAA QUALITY-EXTREME QUALITY============================================================================*/\n#if (FXAA_QUALITY_PRESET == 39)\n#define FXAA_QUALITY_PS 12\n#define FXAA_QUALITY_P0 1.0\n#define FXAA_QUALITY_P1 1.0\n#define FXAA_QUALITY_P2 1.0\n#define FXAA_QUALITY_P3 1.0\n#define FXAA_QUALITY_P4 1.0\n#define FXAA_QUALITY_P5 1.5\n#define FXAA_QUALITY_P6 2.0\n#define FXAA_QUALITY_P7 2.0\n#define FXAA_QUALITY_P8 2.0\n#define FXAA_QUALITY_P9 2.0\n#define FXAA_QUALITY_P10 4.0\n#define FXAA_QUALITY_P11 8.0\n#endif\n/*============================================================================API PORTING============================================================================*/\n#if (FXAA_GLSL_100 == 1) || (FXAA_GLSL_120 == 1) || (FXAA_GLSL_130 == 1)\n#define FxaaBool bool\n#define FxaaDiscard discard\n#define FxaaFloat float\n#define FxaaFloat2 vec2\n#define FxaaFloat3 vec3\n#define FxaaFloat4 vec4\n#define FxaaHalf float\n#define FxaaHalf2 vec2\n#define FxaaHalf3 vec3\n#define FxaaHalf4 vec4\n#define FxaaInt2 ivec2\n#define FxaaSat(x) clamp(x, 0.0, 1.0)\n#define FxaaTex sampler2D\n#else\n#define FxaaBool bool\n#define FxaaDiscard clip(-1)\n#define FxaaFloat float\n#define FxaaFloat2 float2\n#define FxaaFloat3 float3\n#define FxaaFloat4 float4\n#define FxaaHalf half\n#define FxaaHalf2 half2\n#define FxaaHalf3 half3\n#define FxaaHalf4 half4\n#define FxaaSat(x) saturate(x)\n#endif\n#if (FXAA_GLSL_100 == 1)\n#define FxaaTexTop(t, p) texture(t, p, 0.0)\n#define FxaaTexOff(t, p, o, r) texture(t, p + (o * r), 0.0)\n#endif\n#if (FXAA_GLSL_120 == 1)\n#define FxaaTexTop(t, p) textureLod(t, p, 0.0)\n#if (FXAA_FAST_PIXEL_OFFSET == 1)\n#define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)\n#else\n#define FxaaTexOff(t, p, o, r) textureLod(t, p + (o * r), 0.0)\n#endif\n#if (FXAA_GATHER4_ALPHA == 1)\n#define FxaaTexAlpha4(t, p) textureGather(t, p, 3)\n#define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)\n#define FxaaTexGreen4(t, p) textureGather(t, p, 1)\n#define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)\n#endif\n#endif\n#if (FXAA_GLSL_130 == 1)\n#define FxaaTexTop(t, p) textureLod(t, p, 0.0)\n#define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)\n#if (FXAA_GATHER4_ALPHA == 1)\n#define FxaaTexAlpha4(t, p) textureGather(t, p, 3)\n#define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)\n#define FxaaTexGreen4(t, p) textureGather(t, p, 1)\n#define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)\n#endif\n#endif\n#if (FXAA_HLSL_3 == 1)\n#define FxaaInt2 float2\n#define FxaaTex sampler2D\n#define FxaaTexTop(t, p) tex2Dlod(t, float4(p, 0.0, 0.0))\n#define FxaaTexOff(t, p, o, r) tex2Dlod(t, float4(p + (o * r), 0, 0))\n#endif\n#if (FXAA_HLSL_4 == 1)\n#define FxaaInt2 int2\nstruct FxaaTex{SamplerState smpl;texture tex;};\n#define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)\n#define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)\n#endif\n#if (FXAA_HLSL_5 == 1)\n#define FxaaInt2 int2\nstruct FxaaTex{SamplerState smpl;texture tex;};\n#define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)\n#define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)\n#define FxaaTexAlpha4(t, p) t.tex.GatherAlpha(t.smpl, p)\n#define FxaaTexOffAlpha4(t, p, o) t.tex.GatherAlpha(t.smpl, p, o)\n#define FxaaTexGreen4(t, p) t.tex.GatherGreen(t.smpl, p)\n#define FxaaTexOffGreen4(t, p, o) t.tex.GatherGreen(t.smpl, p, o)\n#endif\n/*============================================================================GREEN AS LUMA OPTION SUPPORT FUNCTION============================================================================*/\n#if (FXAA_GREEN_AS_LUMA == 0)\nFxaaFloat FxaaLuma(FxaaFloat4 rgba){return rgba.w;}\n#else\nFxaaFloat FxaaLuma(FxaaFloat4 rgba){return rgba.y;}\n#endif\n/*============================================================================FXAA3 QUALITY-PC============================================================================*/\n#if (FXAA_PC == 1)\nFxaaFloat4 FxaaPixelShader(FxaaFloat2 pos,FxaaFloat4 fxaaConsolePosPos,FxaaTex tex,FxaaTex fxaaConsole360TexExpBiasNegOne,FxaaTex fxaaConsole360TexExpBiasNegTwo,FxaaFloat2 fxaaQualityRcpFrame,FxaaFloat4 fxaaConsoleRcpFrameOpt,FxaaFloat4 fxaaConsoleRcpFrameOpt2,FxaaFloat4 fxaaConsole360RcpFrameOpt2,FxaaFloat fxaaQualitySubpix,FxaaFloat fxaaQualityEdgeThreshold,FxaaFloat fxaaQualityEdgeThresholdMin,FxaaFloat fxaaConsoleEdgeSharpness,FxaaFloat fxaaConsoleEdgeThreshold,FxaaFloat fxaaConsoleEdgeThresholdMin,FxaaFloat4 fxaaConsole360ConstDir){FxaaFloat2 posM;posM.x=pos.x;posM.y=pos.y;\n#if (FXAA_GATHER4_ALPHA == 1)\n#if (FXAA_DISCARD == 0)\nFxaaFloat4 rgbyM=FxaaTexTop(tex,posM);\n#if (FXAA_GREEN_AS_LUMA == 0)\n#define lumaM rgbyM.w\n#else\n#define lumaM rgbyM.y\n#endif\n#endif\n#if (FXAA_GREEN_AS_LUMA == 0)\nFxaaFloat4 luma4A=FxaaTexAlpha4(tex,posM);FxaaFloat4 luma4B=FxaaTexOffAlpha4(tex,posM,FxaaInt2(-1,-1));\n#else\nFxaaFloat4 luma4A=FxaaTexGreen4(tex,posM);FxaaFloat4 luma4B=FxaaTexOffGreen4(tex,posM,FxaaInt2(-1,-1));\n#endif\n#if (FXAA_DISCARD == 1)\n#define lumaM luma4A.w\n#endif\n#define lumaE luma4A.z\n#define lumaS luma4A.x\n#define lumaSE luma4A.y\n#define lumaNW luma4B.w\n#define lumaN luma4B.z\n#define lumaW luma4B.x\n#else\nFxaaFloat4 rgbyM=FxaaTexTop(tex,posM);\n#if (FXAA_GREEN_AS_LUMA == 0)\n#define lumaM rgbyM.w\n#else\n#define lumaM rgbyM.y\n#endif\n#if (FXAA_GLSL_100 == 1)\nFxaaFloat lumaS=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(0.0,1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaE=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(1.0,0.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaN=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(0.0,-1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaW=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(-1.0,0.0),fxaaQualityRcpFrame.xy));\n#else\nFxaaFloat lumaS=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(0,1),fxaaQualityRcpFrame.xy));FxaaFloat lumaE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,0),fxaaQualityRcpFrame.xy));FxaaFloat lumaN=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(0,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,0),fxaaQualityRcpFrame.xy));\n#endif\n#endif\nFxaaFloat maxSM=max(lumaS,lumaM);FxaaFloat minSM=min(lumaS,lumaM);FxaaFloat maxESM=max(lumaE,maxSM);FxaaFloat minESM=min(lumaE,minSM);FxaaFloat maxWN=max(lumaN,lumaW);FxaaFloat minWN=min(lumaN,lumaW);FxaaFloat rangeMax=max(maxWN,maxESM);FxaaFloat rangeMin=min(minWN,minESM);FxaaFloat rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;FxaaFloat range=rangeMax-rangeMin;FxaaFloat rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);FxaaBool earlyExit=range<rangeMaxClamped;if(earlyExit)\n#if (FXAA_DISCARD == 1)\nFxaaDiscard;\n#else\nreturn rgbyM;\n#endif\n#if (FXAA_GATHER4_ALPHA == 0)\n#if (FXAA_GLSL_100 == 1)\nFxaaFloat lumaNW=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(-1.0,-1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaSE=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(1.0,1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaNE=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(1.0,-1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaSW=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(-1.0,1.0),fxaaQualityRcpFrame.xy));\n#else\nFxaaFloat lumaNW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaSE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,1),fxaaQualityRcpFrame.xy));FxaaFloat lumaNE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaSW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,1),fxaaQualityRcpFrame.xy));\n#endif\n#else\nFxaaFloat lumaNE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaSW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,1),fxaaQualityRcpFrame.xy));\n#endif\nFxaaFloat lumaNS=lumaN+lumaS;FxaaFloat lumaWE=lumaW+lumaE;FxaaFloat subpixRcpRange=1.0/range;FxaaFloat subpixNSWE=lumaNS+lumaWE;FxaaFloat edgeHorz1=(-2.0*lumaM)+lumaNS;FxaaFloat edgeVert1=(-2.0*lumaM)+lumaWE;FxaaFloat lumaNESE=lumaNE+lumaSE;FxaaFloat lumaNWNE=lumaNW+lumaNE;FxaaFloat edgeHorz2=(-2.0*lumaE)+lumaNESE;FxaaFloat edgeVert2=(-2.0*lumaN)+lumaNWNE;FxaaFloat lumaNWSW=lumaNW+lumaSW;FxaaFloat lumaSWSE=lumaSW+lumaSE;FxaaFloat edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);FxaaFloat edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);FxaaFloat edgeHorz3=(-2.0*lumaW)+lumaNWSW;FxaaFloat edgeVert3=(-2.0*lumaS)+lumaSWSE;FxaaFloat edgeHorz=abs(edgeHorz3)+edgeHorz4;FxaaFloat edgeVert=abs(edgeVert3)+edgeVert4;FxaaFloat subpixNWSWNESE=lumaNWSW+lumaNESE;FxaaFloat lengthSign=fxaaQualityRcpFrame.x;FxaaBool horzSpan=edgeHorz>=edgeVert;FxaaFloat subpixA=subpixNSWE*2.0+subpixNWSWNESE;if(!horzSpan)lumaN=lumaW;if(!horzSpan)lumaS=lumaE;if(horzSpan)lengthSign=fxaaQualityRcpFrame.y;FxaaFloat subpixB=(subpixA*(1.0/12.0))-lumaM;FxaaFloat gradientN=lumaN-lumaM;FxaaFloat gradientS=lumaS-lumaM;FxaaFloat lumaNN=lumaN+lumaM;FxaaFloat lumaSS=lumaS+lumaM;FxaaBool pairN=abs(gradientN)>=abs(gradientS);FxaaFloat gradient=max(abs(gradientN),abs(gradientS));if(pairN)lengthSign=-lengthSign;FxaaFloat subpixC=FxaaSat(abs(subpixB)*subpixRcpRange);FxaaFloat2 posB;posB.x=posM.x;posB.y=posM.y;FxaaFloat2 offNP;offNP.x=(!horzSpan)? 0.0 : fxaaQualityRcpFrame.x;offNP.y=(horzSpan)? 0.0 : fxaaQualityRcpFrame.y;if(!horzSpan)posB.x+=lengthSign*0.5;if(horzSpan)posB.y+=lengthSign*0.5;FxaaFloat2 posN;posN.x=posB.x-offNP.x*FXAA_QUALITY_P0;posN.y=posB.y-offNP.y*FXAA_QUALITY_P0;FxaaFloat2 posP;posP.x=posB.x+offNP.x*FXAA_QUALITY_P0;posP.y=posB.y+offNP.y*FXAA_QUALITY_P0;FxaaFloat subpixD=((-2.0)*subpixC)+3.0;FxaaFloat lumaEndN=FxaaLuma(FxaaTexTop(tex,posN));FxaaFloat subpixE=subpixC*subpixC;FxaaFloat lumaEndP=FxaaLuma(FxaaTexTop(tex,posP));if(!pairN)lumaNN=lumaSS;FxaaFloat gradientScaled=gradient*1.0/4.0;FxaaFloat lumaMM=lumaM-lumaNN*0.5;FxaaFloat subpixF=subpixD*subpixE;FxaaBool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;FxaaBool doneN=abs(lumaEndN)>=gradientScaled;FxaaBool doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P1;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P1;FxaaBool doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P1;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P1;if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P2;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P2;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P2;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P2;\n#if (FXAA_QUALITY_PS > 3)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P3;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P3;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P3;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P3;\n#if (FXAA_QUALITY_PS > 4)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P4;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P4;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P4;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P4;\n#if (FXAA_QUALITY_PS > 5)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P5;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P5;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P5;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P5;\n#if (FXAA_QUALITY_PS > 6)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P6;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P6;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P6;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P6;\n#if (FXAA_QUALITY_PS > 7)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P7;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P7;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P7;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P7;\n#if (FXAA_QUALITY_PS > 8)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P8;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P8;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P8;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P8;\n#if (FXAA_QUALITY_PS > 9)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P9;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P9;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P9;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P9;\n#if (FXAA_QUALITY_PS > 10)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P10;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P10;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P10;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P10;\n#if (FXAA_QUALITY_PS > 11)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P11;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P11;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P11;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P11;\n#if (FXAA_QUALITY_PS > 12)\nif(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P12;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P12;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P12;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P12;}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}\n#endif\n}FxaaFloat dstN=posM.x-posN.x;FxaaFloat dstP=posP.x-posM.x;if(!horzSpan)dstN=posM.y-posN.y;if(!horzSpan)dstP=posP.y-posM.y;FxaaBool goodSpanN=(lumaEndN<0.0)!=lumaMLTZero;FxaaFloat spanLength=(dstP+dstN);FxaaBool goodSpanP=(lumaEndP<0.0)!=lumaMLTZero;FxaaFloat spanLengthRcp=1.0/spanLength;FxaaBool directionN=dstN<dstP;FxaaFloat dst=min(dstN,dstP);FxaaBool goodSpan=directionN ? goodSpanN : goodSpanP;FxaaFloat subpixG=subpixF*subpixF;FxaaFloat pixelOffset=(dst*(-spanLengthRcp))+0.5;FxaaFloat subpixH=subpixG*fxaaQualitySubpix;FxaaFloat pixelOffsetGood=goodSpan ? pixelOffset : 0.0;FxaaFloat pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if(!horzSpan)posM.x+=pixelOffsetSubpix*lengthSign;if(horzSpan)posM.y+=pixelOffsetSubpix*lengthSign;\n#if (FXAA_DISCARD == 1)\nreturn FxaaTexTop(tex,posM);\n#else\nreturn FxaaFloat4(FxaaTexTop(tex,posM).xyz,lumaM);\n#endif\n}\n#endif\nvoid main(){out_color=FxaaPixelShader(vCoord,vec4(0.0),inputBuffer,inputBuffer,inputBuffer,resolution,vec4(0.0),vec4(0.0),vec4(0.0),0.75,0.166,0.0833,0.0,0.0,0.0,vec4(0.0));out_color.a=texture(inputBuffer,vCoord).a;}"};var Ke={source:"vec4 LGL_Ay(sampler2D map,vec2 uv){\n#ifdef OES_texture_float_linear\nreturn texture(map,uv);\n#else\nvec2 size=vec2(textureSize(map,0));vec2 texelSize=1.0/size;uv=uv*size-0.5;vec2 f=fract(uv);uv=floor(uv)+0.5;vec4 s1=texture(map,(uv+vec2(0,0))*texelSize);vec4 s2=texture(map,(uv+vec2(1,0))*texelSize);vec4 s3=texture(map,(uv+vec2(0,1))*texelSize);vec4 s4=texture(map,(uv+vec2(1,1))*texelSize);return mix(mix(s1,s2,f.x),mix(s3,s4,f.x),f.y);\n#endif\n}layout(location=0)out vec4 out_light;layout(location=1)out vec4 out_momentLengthVariance;in vec2 vCoord;uniform mediump sampler2D lightTex;uniform mediump sampler2D positionTex;uniform mediump sampler2D colorTex;uniform mediump sampler2D previousLightTex;uniform mediump sampler2D previousPositionTex;uniform mediump sampler2D previousColorTex;uniform mediump sampler2D previousMomentLengthVarianceTex;uniform mat4 historyCamera;uniform float colorBlendFactor;uniform float momentBlendFactor;uniform float demodulateAlbedo;vec2 LGL_BD(vec3 position){vec4 historyCoord=historyCamera*vec4(position,1.0);return 0.5*historyCoord.xy/historyCoord.w+0.5;}float LGL_BE(sampler2D meshIdTex,vec2 vCoord){return texture(meshIdTex,vCoord).w;}float LGL_BF(float histMeshId,float currentMeshId,ivec2 coord,ivec2 size){if(histMeshId!=currentMeshId){return 0.0;}if(any(greaterThanEqual(coord,size))){return 0.0;}return 1.0;}void main(){vec3 currentPosition=LGL_Ay(positionTex,vCoord).xyz;float currentMeshId=LGL_BE(positionTex,vCoord);vec4 accumulatedLight=texture(lightTex,vCoord);vec3 currentLight=accumulatedLight.rgb/accumulatedLight.a;vec2 hCoord=LGL_BD(currentPosition);vec2 hSizef=vec2(textureSize(previousLightTex,0));vec2 hSizeInv=1.0/hSizef;ivec2 hSize=ivec2(hSizef);vec2 hTexelf=hCoord*hSizef-0.5;ivec2 hTexel=ivec2(hTexelf);vec2 f=fract(hTexelf);ivec2 texel[]=ivec2[](hTexel+ivec2(0,0),hTexel+ivec2(1,0),hTexel+ivec2(0,1),hTexel+ivec2(1,1));float weights[]=float[]((1.0-f.x)*(1.0-f.y),f.x*(1.0-f.y),(1.0-f.x)*f.y,f.x*f.y);vec4 historyLight=vec4(0.);;vec2 historyMoment=vec2(0.);float historyLength=0.;float sum=0.;float LGL_Af=0.2126*currentLight.x+0.7152*currentLight.y+0.0722*currentLight.z;float N=texelFetch(previousMomentLengthVarianceTex,hTexel,0).b;if(N>0.0&&currentMeshId>0.0){for(int i=0;i<4;i++){vec2 gCoord=(vec2(texel[i])+0.5)*hSizeInv;float histMeshId=LGL_BE(previousPositionTex,gCoord);float isValid=LGL_BF(histMeshId,currentMeshId,texel[i],hSize);float weight=isValid*weights[i];historyLight+=weight*texelFetch(previousLightTex,texel[i],0);historyMoment+=weight*texelFetch(previousMomentLengthVarianceTex,texel[i],0).rg;sum+=weight;}if(sum>0.0){historyLight/=sum;historyMoment/=sum;}else{hTexel=ivec2(hTexelf+0.5);for(int x=-1;x<=1;x++){for(int y=-1;y<=1;y++){ivec2 texel=hTexel+ivec2(x,y);vec2 gCoord=(vec2(texel)+0.5)*hSizeInv;float histMeshId=LGL_BE(previousPositionTex,gCoord);float isValid=LGL_BF(histMeshId,currentMeshId,texel,hSize);float weight=isValid;historyLight+=weight*texelFetch(previousLightTex,texel,0);historyMoment+=weight*texelFetch(previousMomentLengthVarianceTex,texel,0).rg;sum+=weight;}}historyLight=sum>0.0 ? historyLight/sum : historyLight;historyMoment=sum>0.0 ? historyMoment/sum : historyMoment;}if(sum>0.0){historyLength=N+1.;float color_alpha_min=colorBlendFactor;float moment_alpha_min=momentBlendFactor;float color_alpha=max(1.0/historyLength,color_alpha_min);float moment_alpha=max(1.0/historyLength,moment_alpha_min);out_light=color_alpha*accumulatedLight+historyLight*(1.-color_alpha);float first_moment=moment_alpha*historyMoment.x+(1.0-moment_alpha)*LGL_Af;float second_moment=moment_alpha*historyMoment.y+(1.0-moment_alpha)*LGL_Af*LGL_Af;float variance=second_moment-first_moment*first_moment;out_momentLengthVariance=vec4(first_moment,second_moment,historyLength,variance);return;}}out_light=accumulatedLight;out_momentLengthVariance=vec4(LGL_Af,LGL_Af*LGL_Af,1.,100.);}"};var je={source:"vec4 LGL_Ay(sampler2D map,vec2 uv){\n#ifdef OES_texture_float_linear\nreturn texture(map,uv);\n#else\nvec2 size=vec2(textureSize(map,0));vec2 texelSize=1.0/size;uv=uv*size-0.5;vec2 f=fract(uv);uv=floor(uv)+0.5;vec4 s1=texture(map,(uv+vec2(0,0))*texelSize);vec4 s2=texture(map,(uv+vec2(1,0))*texelSize);vec4 s3=texture(map,(uv+vec2(0,1))*texelSize);vec4 s4=texture(map,(uv+vec2(1,1))*texelSize);return mix(mix(s1,s2,f.x),mix(s3,s4,f.x),f.y);\n#endif\n}layout(location=0)out vec4 out_color;in vec2 vCoord;uniform sampler2D lightTex;uniform sampler2D LGL_BDDataTex;uniform sampler2D gPosition;uniform sampler2D gNormal;uniform sampler2D gColor;uniform float colorFactor;uniform float normalFactor;uniform float positionFactor;uniform float stepwidth;uniform int level;uniform float useMomentVariance;uniform float demodulateAlbedo;float LGL_BA(float v){return acos(min(max(v,0.0),1.0));}float LGL_BB(vec2 uv){return max(texture(LGL_BDDataTex,uv).a,0.);}vec4 LGL_BC(){vec4 upscaledLight=texture(lightTex,vCoord);float sampleFrame=upscaledLight.a;float sf2=sampleFrame*sampleFrame;vec3 color=upscaledLight.rgb/upscaledLight.a;vec3 normal=texture(gNormal,vCoord).rgb;vec4 positionAndMeshIndex=texture(gPosition,vCoord);vec3 position=positionAndMeshIndex.rgb;float meshIndex=positionAndMeshIndex.w;bool isBG=meshIndex>0.0 ? false : true;if(isBG){return upscaledLight;}vec2 size=vec2(textureSize(lightTex,0));int kernelRadius=9;float dx=1./size.x;float dy=1./size.y;float kernel[9]=float[9](1.0/16.0,1.0/8.0,1.0/16.0,1.0/8.0,1.0/4.0,1.0/8.0,1.0/16.0,1.0/8.0,1.0/16.0);vec2 offset[9]=vec2[9](vec2(-dx,-dy),vec2(0,-dy),vec2(dx,-dy),vec2(-dx,0),vec2(0,0),vec2(dx,0),vec2(-dx,dy),vec2(0,dy),vec2(dx,dy));vec3 colorSum=vec3(0.);float weightSum=0.;float var;float varSum;float varSumWeight;if(useMomentVariance>0.){for(int i=0;i<kernelRadius;i++){vec2 uv=vCoord+offset[i];if(uv.x<0.0||uv.x>1.0||uv.y<0.0||uv.y>1.0){continue;}vec4 positionAndMeshIndex=texture(gPosition,uv);float meshIndex=positionAndMeshIndex.w;bool isBG=meshIndex>0.0 ? false : true;if(isBG){continue;}varSum+=kernel[i]*LGL_BB(uv);varSumWeight+=kernel[i];}if(varSumWeight>0.0){var=max(varSum/varSumWeight,0.0);}else{var=max(LGL_BB(vCoord),0.0);}}for(int i=0;i<kernelRadius;i++){vec2 uv=vCoord+offset[i]*float(stepwidth);if(uv.x<0.0||uv.x>1.0||uv.y<0.0||uv.y>1.0){continue;}vec4 positionAndMeshIndex=texture(gPosition,uv);float meshIndex=positionAndMeshIndex.w;bool isBG=meshIndex>0.0 ? false : true;if(isBG){continue;}vec4 upscaledLight=texture(lightTex,uv);vec3 kernelColor=upscaledLight.rgb/upscaledLight.a;float Dc=distance(color,kernelColor);float Wc;if(useMomentVariance>0.){Wc=min(exp(-Dc/((1.+sqrt(var))*colorFactor+1e-6)),1.0);}else{Wc=min(exp(-Dc/(colorFactor+1e-6)),1.0);}vec3 kernelNormal=texture(gNormal,uv).rgb;float Dn=distance(normal,kernelNormal);float dist2=max(Dn/(stepwidth*stepwidth+1e-6),0.0);float Wn=min(exp(-(dist2)/normalFactor+1e-6),1.0);vec3 kernelPosition=positionAndMeshIndex.rgb;float Dp=distance(position,kernelPosition);float Wp=min(exp(-Dp/(positionFactor+1e-6)),1.0);float weight=Wc*Wn*Wp*kernel[i];weightSum+=weight;colorSum+=kernelColor*weight;}colorSum=colorSum/weightSum;return vec4(colorSum*sampleFrame,sampleFrame);}void main(){vec4 light=LGL_BC();out_color=light;}"};function Je(e,t){const{fullscreenQuad:a}=t;let n,i;function o(){let e=i;i=n,n=e}const r={gl:e,vertex:a.vertexShader,fragment:je},s=Y(e,r);let l=.5,f=.02,u=.35;return{draw:function(t){let{light:r,reprojectData:c}=t;for(let d=0;d<3;d++)s.setUniform("level",d),s.setUniform("colorFactor",1/(1<<d)*l),s.setUniform("normalFactor",1/(1<<d)*f),s.setUniform("positionFactor",1/(1<<d)*u),s.setUniform("stepwidth",(1<<d+1)-1),0===d?s.setTexture("lightTex",r):s.setTexture("lightTex",n.color[0]),c?(s.setUniform("useMomentVariance",1),s.setTexture("reprojectDataTex",c)):(s.setUniform("useMomentVariance",0),s.setTexture("reprojectDataTex",null)),i.bind(),e.clear(e.COLOR_BUFFER_BIT),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),s.useProgram(),a.draw(),i.unbind(),o();return n},setGBuffers:function({position:e,normal:t,color:a}){s.setTexture("gPosition",e),s.setTexture("gNormal",t),s.setTexture("gColor",a)},setColorFactor:function(e){l=e},setNormalFactor:function(e){f=e},setPositionFactor:function(e){u=e},setDemodulateAlbedo:function(e){s.setUniform("demodulateAlbedo",e)},getDenoiseFactors:()=>({colorFactor:l,normalFactor:f,positionFactor:u}),setSize:function(t,a){!function(t,a){const o=()=>E(e,{color:{0:Z(e,{width:t,height:a,storage:"float",magFilter:e.NEAREST,minFilter:e.NEAREST})}});n=o(),i=o()}(t,a)},dispose:function(){s.dispose()}}}function $e(e){let t,a,n,i,o,r=-1,s=1,l=!1,f=0,u=0,c=function(e){const t=e.getParameter(e.MAX_RENDERBUFFER_SIZE);return t<=8192?2e5:16384===t?4e5:t>=32768?6e5:void 0}(e);function d(){const e=f/u;l?(t=Math.ceil(f/Math.sqrt(s)),a=Math.ceil(t/e),n=Math.ceil(f/t),i=Math.ceil(u/a),s=n*i):(t=Math.ceil(f/Math.round(f/Math.sqrt(c*e))),a=Math.ceil(t/e),n=Math.ceil(f/t),i=Math.ceil(u/a),s=n*i)}function p(){r=-1,o=NaN}return{nextTile:function(e){r++,o+=e,r%s==0&&(o&&(!function(){const e=21-o/s;c+=5e3*Math.sign(e)*Math.sqrt(Math.abs(e)),c=H(c,8192,f*u)}(),d()),o=0,r=0);const l=r===s-1,p=r%n,m=Math.floor(r/n)%i;return{x:p*t,y:m*a,tileWidth:t,tileHeight:a,isFirstTile:0===r,isLastTile:l}},reset:p,setSize:function(e,t){f=e,u=t,p(),d()},setTileSlicesNumber:function(e){e?(l=!0,s=e):l=!1}}}async function et({gl:e,optionalExtensions:t,scene:a,camera:n,toneMapping:i,bounces:o,envMapIntensity:r,enviromentVisible:s,movingDownsampling:l,enableDenoise:f,enableTemporalDenoise:u,enableSpatialDenoise:c,useWorker:d,loadingCallback:m}){const L=new P,x=function(e){let t,a,n,i,o=new p(1,1),r=function(e){const t=e.getParameter(e.MAX_RENDERBUFFER_SIZE);return t<=8192?8e4:16384===t?15e4:t>=32768?4e5:void 0}(e);function s(){const e=t/a;n=Math.round(H(Math.sqrt(r*e),1,t)),i=Math.round(H(n/e,1,a)),o.set(n/t,i/a)}return{adjustSize:function(e){e&&(r+=600*(20-e),r=H(r,8192,t*a),s())},setSize:function(e,n){t=e,a=n,s()},scale:o,get width(){return n},get height(){return i}}}(e),v=$e(e),_=ne(a,n),h=de(e,_),A=ie(e,_),g=function(e){const t=e.createVertexArray();return e.bindVertexArray(t),e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null),{draw:function(){e.bindVertexArray(t),e.drawArrays(e.TRIANGLES,0,6)},vertexShader:Q(e,{vertex:w})}}(e);let S,M,T=!1,G=0,I=!0,N=()=>{};const y=await Ce(e,{bounces:o,decomposedScene:_,fullscreenQuad:g,materialBuffer:h,uvTransformBuffer:A,optionalExtensions:t,scene:a,envMapIntensity:r,enviromentVisible:s,useWorker:d,loadingCallback:m}),B=He(e,{materialBuffer:h,uvTransformBuffer:A,decomposedScene:_}),R=qe(e,{fullscreenQuad:g,toneMapping:i}),b=function(e,t){const{fullscreenQuad:a}=t,n=Y(e,{gl:e,vertex:a.vertexShader,fragment:Ze});return{draw:function(e){let{light:t}=e;n.setTexture("inputBuffer",t),n.useProgram(),a.draw()},setSize:function(e,t){n.setUniform("resolution",1/e,1/t)},dispose:function(){n.dispose()}}}(e,{fullscreenQuad:g}),U=function(e,t){const{fullscreenQuad:a,maxReprojectedSamples:n}=t,i=Y(e,{defines:{MAX_SAMPLES:n.toFixed(1)},vertex:a.vertexShader,fragment:Ke}),o=new F;let r=.2,s=.2;return{draw:function(e){const{light:t,position:n,color:o,previousColor:l,previousLight:f,previousPosition:u,previousMomentLengthVariance:c}=e;i.setTexture("lightTex",t),i.setTexture("positionTex",n),i.setTexture("colorTex",o),i.setTexture("previousLightTex",f),i.setTexture("previousPositionTex",u),i.setTexture("previousColorTex",l),i.setTexture("previousMomentLengthVarianceTex",c),i.setUniform("colorBlendFactor",r),i.setUniform("momentBlendFactor",s),i.useProgram(),a.draw()},setJitter:function(e,t){i.setUniform("jitter",e,t)},setPreviousCamera:function(e){o.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),i.setUniform("historyCamera",o.elements)},setDenoiseColorBlendFactor:function(e){r=e},setDenoiseMomentBlendFactor:function(e){s=e},setDemodulateAlbedo:function(e){i.setUniform("demodulateAlbedo",e)},getDenoiseFactors:()=>({colorBlendFactor:r,momentBlendFactor:s}),dispose:function(){i.dispose()}}}(e,{fullscreenQuad:g,maxReprojectedSamples:20}),D=Je(e,{fullscreenQuad:g,toneMapping:i}),z=new Image;let X,C,O,V,W,k;function q(){let e=W;W=k,k=e}function K(){let e=X;X=C,C=e}function j(e=!0){const t=Number(e&&u&&c);U.setDemodulateAlbedo(t),D.setDemodulateAlbedo(t)}z.src="data:image/png;base64,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",z.onload=()=>{y.setNoise(z),T=!0},j(!1);let J=0,$=0;function ee(e,t){y.setCamera(e),B.setCamera(e),U.setPreviousCamera(t),t.copy(e)}function te(e,t,a=!0){y.setSize(e,t),y.setFrameCount(G);const n=a?(Math.random()-.5)/e:0,i=a?(Math.random()-.5)/t:0;f||y.setJitter(n,i),0===G?y.setStrataCount(1):4===G?y.setStrataCount(6):y.nextSeed()}function ae(e,t){return function(e,t,a=1e-4){for(let n=0;n<e.length;n++)if(Math.abs(e[n]-t[n])>a)return!1;return!0}(e.matrixWorld.elements,t.matrixWorld.elements)&&e.aspect===t.aspect&&e.fov===t.fov}function oe(t){t.bind(),e.clear(e.COLOR_BUFFER_BIT),t.unbind()}function re(t,a,n){t.bind(),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ONE),e.enable(e.BLEND),e.viewport(0,0,a,n),y.draw(),e.disable(e.BLEND),t.unbind()}function se(t,a){e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),R.draw({light:t,lightScale:a}),V=t}function le(e){let t=R.draw({light:e},!0);b.draw({light:t.color[0]})}function fe(){X.bind(),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.viewport(0,0,J,$),B.draw(),X.unbind(),D.setGBuffers({position:X.color[0],normal:X.color[1],color:X.color[2]})}function ue(){if(u&&(W.bind(),e.viewport(0,0,J,$),U.draw({light:O.color[0],position:X.color[0],color:X.color[2],previousLight:V,previousPosition:C.color[0],previousColor:C.color[2],previousMomentLengthVariance:k.color[1]}),W.unbind(),c||(le(W.color[0]),V=W.color[0])),c)if(u){le(D.draw({light:W.color[0],reprojectData:k.color[1]}).color[0]),V=W.color[0]}else{le(D.draw({light:O.color[0],reprojectData:null}).color[0]),V=O.color[0]}}function ce(t=!1){const{x:a,y:n,tileWidth:i,tileHeight:o,isFirstTile:r,isLastTile:s}=v.nextTile(M);r&&(0===G&&(oe(O),U.setPreviousCamera(L)),te(J,$,!0),f&&(u||c)&&fe(),y.bindTextures()),function(t,a,n,i,o){e.scissor(a,n,i,o),e.enable(e.SCISSOR_TEST),re(t,J,$),e.disable(e.SCISSOR_TEST)}(O,a,n,i,o),t&&!s&&se(O.color[0]),s&&(f&&(u||c)?(V=O.color[0],ue(),V=O.color[0]):se(O.color[0]),q(),K(),G++,N())}function pe(){var t,a,n;te(x.width,x.height,!1),y.bindTextures(),t=O,a=x.width,n=x.height,t.bind(),e.viewport(0,0,a,n),y.draw(),t.unbind(),se(O.color[0],x.scale),oe(O)}return{draw:function(e){T&&(ae(e,L)?ce():(ee(e,L),I?I=!1:pe(),G=0,v.reset()))},fullDraw:function(e){if(T){if(K(),q(),ae(e,L))G++;else{if(l)return ee(e,L),G=0,void pe();G=0,oe(O)}ee(e,L),te(J,$,!0),f&&(u||c)&&fe(),y.bindTextures(),re(O,J,$),f&&(u||c)?ue():se(O.color[0]),N()}},setSize:function(t,a){J=t,$=a,v.setSize(t,a),x.setSize(t,a),function(t,a){O=E(e,{color:{0:Z(e,{width:t,height:a,storage:"float",magFilter:e.LINEAR,minFilter:e.LINEAR})}}),V=O.color[0];const n=()=>E(e,{color:{0:Z(e,{width:t,height:a,storage:"float",magFilter:e.LINEAR,minFilter:e.LINEAR}),1:Z(e,{width:t,height:a,storage:"float",channels:4,magFilter:e.LINEAR,minFilter:e.LINEAR})}});W=n(),k=n();const i=Z(e,{width:t,height:a,storage:"halfFloat"}),o=Z(e,{width:t,height:a,storage:"float"}),r=function(e,t,a){const n=e.createRenderbuffer(),i=e.RENDERBUFFER;return e.bindRenderbuffer(i,n),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT24,t,a),e.bindRenderbuffer(i,null),{target:i,texture:n,dispose:function(){e.deleteRenderbuffer(n)}}}(e,t,a),s=()=>E(e,{color:{0:Z(e,{width:t,height:a,storage:"float"}),1:i,2:o},depth:r});X=s(),C=s()}(t,a),D.setSize(t,a),R.setSize(t,a),b.setSize(t,a),I=!0},time:function(e){M=e-S,S=e},reset:function(){G=0,v.reset(),oe(O),oe(W),oe(k)},getTotalSamplesRendered:()=>G,setfullSampleCallbackCallBack(e){N=e},setTileSlicesNumber:function(e){v.setTileSlicesNumber(e)},updateBounces:function(e){y.updateBounces(e)},updateEnvLight:function(){const e=ne(a,n);y.updateEnvLight(e)},updateMeshLight:function(){const e=ne(a,n);y.updateMeshLight(e)},setEnvMapIntensity:function(e){y.setEnvMapIntensity(e)},setEnviromentVisible:function(e){y.setEnviromentVisible(e)},setToneMapping:function(e){R.setToneMapping(e)},setMovingDownsampling:function(e){l=e},setDenoiseStatus:function(e){f=e},setTemporalDenoiseStatus:function(e){u=e,j()},setDenoiseColorBlendFactor:function(e){U.setDenoiseColorBlendFactor(e)},setDenoiseMomentBlendFactor:function(e){U.setDenoiseMomentBlendFactor(e)},setSpatialDenoiseStatus:function(e){c=e,j()},setDenoiseColorFactor:function(e){D.setColorFactor(e)},setDenoiseNormalFactor:function(e){D.setNormalFactor(e)},setDenoisePositionFactor:function(e){D.setPositionFactor(e)},getDenoiseFactors:function(){return Object.assign(D.getDenoiseFactors(),U.getDenoiseFactors())},setDemodulateAlbedo:j,updateMeshTransform:function(){const e=ne(a,n);y.updateMeshTransform(e)},updateMeshMaterial:function(){const t=ne(a,n),i=de(e,t),o=ie(e,t);y.updateMeshMaterial(i,o),B.updateMeshMaterial(i,o)},dispose:function(){y.dispose(),B.dispose(),R.dispose(),b.dispose(),U.dispose(),D.dispose(),X.dispose(),C.dispose(),O.dispose(),W.dispose(),k.dispose(),h.dispose(),A.dispose()}}}class tt{constructor(e={}){this.canvas=e.canvas||document.createElement("canvas"),this.gl=e.context||this.canvas.getContext("webgl2",{alpha:e.canvasAlpha||!1,depth:!0,stencil:!1,antialias:e.antialias||!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!0}),B(this.gl,b),this.optionalExtensions=B(this.gl,U),this._bounces=2,this._envMapIntensity=1,this._toneMapping=T,this._movingDownsampling=!1,this._enableDenoise=!1,this._enableTemporalDenoise=!0,this._enableSpatialDenoise=!0,this._fullSampleCallback=null,this._enviromentVisible=!0,this.useTileRender=!1,this.renderWhenOffFocus=!0,this.useWorker=e.useWorker||!0,this.tileSlicesNum=0,this.loadingCallback=e.loadingCallback||{onProgress:e=>console.log(e),onComplete:e=>console.log(e)},this._isBuilding=!0,this.needsUpdate=!1,this.size=new p(this.canvas.width,this.canvas.height),this.pixelRatio=1,this.pipeline=null,this.currentTime=NaN,this.isValidTime=1,this.lastFocus=!1,this.domElement=this.canvas}static isSupported(){const e=document.createElement("canvas").getContext("webgl2",{failIfMajorPerformanceCaveat:!0});if(!e)return!1;const t=B(e,b);for(let a in t)if(!t[a])return!1;return!0}async buildScene(e,t){const{gl:a,optionalExtensions:n,bounces:i,size:o,toneMapping:r,envMapIntensity:s,enviromentVisible:l,movingDownsampling:f,enableDenoise:u,enableTemporalDenoise:c,enableSpatialDenoise:d,useWorker:p,tileSlicesNum:m,loadingCallback:L}=this;this._isBuilding=!0,e.updateMatrixWorld(),this.pipeline=await et({gl:a,optionalExtensions:n,scene:e,camera:t,toneMapping:r,bounces:i,envMapIntensity:s,enviromentVisible:l,movingDownsampling:f,enableDenoise:u,enableTemporalDenoise:c,enableSpatialDenoise:d,useWorker:p,loadingCallback:L}),this.setSize(o.width,o.height),m&&this.setTileSlicesNumber(m),this._isBuilding=!1,L&&L.onComplete&&"function"==typeof L.onComplete&&L.onComplete("Complete!")}set bounces(e){this._bounces=e,this.pipeline&&this.pipeline.updateBounces(e)}get bounces(){return this._bounces}set envMapIntensity(e){e=Number(e),this._envMapIntensity=e,this.pipeline&&this.pipeline.setEnvMapIntensity(e)}get envMapIntensity(){return this._envMapIntensity}set toneMapping(e){this._toneMapping=e,this.pipeline&&this.pipeline.setToneMapping(e)}get toneMapping(){return this._toneMapping}set enviromentVisible(e){this._enviromentVisible=e,this.pipeline&&this.pipeline.setEnviromentVisible(e)}get enviromentVisible(){return this._enviromentVisible}set movingDownsampling(e){e=!!e,this._movingDownsampling=e,this.pipeline&&this.pipeline.setMovingDownsampling(e)}get movingDownsampling(){return this._movingDownsampling}set enableDenoise(e){e=!!e,this._enableDenoise=e,this.pipeline&&this.pipeline.setDenoiseStatus(e)}get enableDenoise(){return this._enableDenoise}set enableTemporalDenoise(e){e=!!e,this._enableTemporalDenoise=e,this.pipeline&&this.pipeline.setTemporalDenoiseStatus(e)}get enableTemporalDenoise(){return this._enableTemporalDenoise}set enableSpatialDenoise(e){e=!!e,this._enableSpatialDenoise=e,this.pipeline&&this.pipeline.setSpatialDenoiseStatus(e)}get enableSpatialDenoise(){return this._enableSpatialDenoise}set fullSampleCallback(e){e&&"function"==typeof e&&(this._fullSampleCallback=e,this.pipeline&&this.pipeline.setfullSampleCallbackCallBack(e))}get fullSampleCallback(){return this._fullSampleCallback}setTileSlicesNumber(e){e=Number(e),this.pipeline&&this.pipeline.setTileSlicesNumber(e)}getContext(){return this.gl}updateMeshMaterial(){this.pipeline&&this.pipeline.updateMeshMaterial()}updateMeshTransform(){this.pipeline&&this.pipeline.updateMeshTransform()}updateEnvLight(){this.pipeline&&this.pipeline.updateEnvLight()}updateMeshLight(){this.pipeline&&this.pipeline.updateMeshLight()}setDenoiseColorBlendFactor(e){this.pipeline&&this.pipeline.setDenoiseColorBlendFactor(e)}setDenoiseMomentBlendFactor(e){this.pipeline&&this.pipeline.setDenoiseMomentBlendFactor(e)}setDenoiseColorFactor(e){this.pipeline&&this.pipeline.setDenoiseColorFactor(e)}setDenoiseNormalFactor(e){this.pipeline&&this.pipeline.setDenoiseNormalFactor(e)}setDenoisePositionFactor(e){this.pipeline&&this.pipeline.setDenoisePositionFactor(e)}setDemodulateAlbedo(e){this.pipeline&&this.pipeline.setDemodulateAlbedo(e),this.needsUpdate=!0}getDenoiseFactors(){if(this.pipeline)return this.pipeline.getDenoiseFactors()}setSize(e,t,a=!0){const{size:n,canvas:i,pipeline:o,pixelRatio:r}=this;n.set(e,t),i.width=n.width*r,i.height=n.height*r,a&&(i.style.width=`${n.width}px`,i.style.height=`${n.height}px`),this.pipeline&&o.setSize(n.width*r,n.height*r)}getSize(e){const{size:t}=this;return e||(e=new p),e.copy(t)}setPixelRatio(e){const{size:t}=this;e&&(this.pixelRatio=e,this.setSize(t.width,t.height,!1))}getPixelRatio(){return this.pixelRatio}getTotalSamples(){if(this.pipeline)return this.pipeline.getTotalSamplesRendered()}restartTimer(){this.isValidTime=NaN}render(e,t){if(!this._isBuilding)if(this.pipeline){if(this.needsUpdate&&(this.needsUpdate=!1,this.pipeline.reset()),!this.renderWhenOffFocus){const e=document.hasFocus();if(!e)return void(this.lastFocus=e);e&&!this.lastFocus&&(this.lastFocus=e,this.restartTimer())}this.currentTime=performance.now(),this.pipeline.time(this.isValidTime*this.currentTime),this.isValidTime=1,this.currentTime=NaN,t.updateMatrixWorld(),this.useTileRender?this.pipeline.draw(t):this.pipeline.fullDraw(t)}else console.error("Pipeline not initialized, The scene needs to be built first!")}dispose(){this.pipeline&&this.pipeline.dispose(),this.pipeline=null}}class at extends y{constructor(e,t,a=10,n=10){super(e,t),this.type="RectAreaLight",this.width=a,this.height=n,this.target=new m}copy(e){super.copy(e),this.width=e.width,this.height=e.height}}class nt extends y{constructor(e,t,a,n){super(e,t),this.type="QuadLight",this.v1=a,this.v2=n}}class it extends y{constructor(e,t,a=1){super(e,t),this.type="SphereAreaLight",this.radius=a}}class ot extends y{constructor(e,t){super(e,t),this.type="PointLight"}}class rt extends y{constructor(e,t){super(e,t),this.type="DirectionalLight",this.target=new m}}export{rt as DirectionalLight,te as DisneyMaterial,tt as LGLTracerRenderer,ot as PointLight,nt as QuadLight,at as RectAreaLight,it as SphereAreaLight};
